!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app"],e):e((t=t||self).firebase)}(this,function(Pd){"use strict";try{(function(){var o,t;Pd=Pd&&Pd.hasOwnProperty("default")?Pd.default:Pd,(t=o=o||{})[t.DEBUG=0]="DEBUG",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.SILENT=5]="SILENT";function e(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!(e<t.logLevel)){var i=(new Date).toISOString();switch(e){case o.DEBUG:case o.VERBOSE:console.log.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case o.INFO:console.info.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case o.WARN:console.warn.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case o.ERROR:console.error.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+e+")")}}}var n=o.INFO,r=(Object.defineProperty(i.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){if(!(t in o))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"logHandler",{get:function(){return this._logHandler},set:function(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t},enumerable:!0,configurable:!0}),i.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.DEBUG].concat(t))},i.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.VERBOSE].concat(t))},i.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.INFO].concat(t))},i.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.WARN].concat(t))},i.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.ERROR].concat(t))},i);function i(t){this.name=t,this._logLevel=n,this._logHandler=e}var a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function s(t,e){function n(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var l=function(){return(l=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function p(o,a,s,u){return new(s=s||Promise)(function(t,e){function n(t){try{i(u.next(t))}catch(t){e(t)}}function r(t){try{i(u.throw(t))}catch(t){e(t)}}function i(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(n,r)}i((u=u.apply(o,a||[])).next())})}function d(n,r){var i,o,a,t,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(a=2&e[0]?o.return:e[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,e[1])).done)return a;switch(o=0,a&&(e=[2&e[0],a.value]),e[0]){case 0:case 1:a=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,o=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){s.label=e[1];break}if(6===e[0]&&s.label<a[1]){s.label=a[1],a=e;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(e);break}a[2]&&s.ops.pop(),s.trys.pop();continue}e=r.call(n,s)}catch(t){e=[6,t],o=0}finally{i=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}function u(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}var c,f=(s(h,c=Error),h);function h(t,e){var n=c.call(this,e)||this;return n.code=t,n.name="FirebaseError",Object.setPrototypeOf(n,h.prototype),Error.captureStackTrace&&Error.captureStackTrace(n,m.prototype.create),n}var m=(y.prototype.create=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r=e[0]||{},i=this.service+"/"+t,o=this.errors[t],a=o?function(t,r){return t.replace(v,function(t,e){var n=r[e];return null!=n?n.toString():"<"+e+"?>"})}(o,r):"Error",s=this.serviceName+": "+a+" ("+i+").",u=new f(i,s),c=0,h=Object.keys(r);c<h.length;c++){var l=h[c];"_"!==l.slice(-1)&&(l in u&&console.warn('Overwriting FirebaseError base field "'+l+'" can cause unexpected behavior.'),u[l]=r[l])}return u},y);function y(t,e,n){this.service=t,this.serviceName=e,this.errors=n}var g,v=/\{\$([^}]+)}/g,b="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},w=w||{},S=b;function E(t){return"string"==typeof t}function T(t){return"number"==typeof t}function I(t,e){t=t.split("."),e=e||S;for(var n=0;n<t.length;n++)if(null==(e=e[t[n]]))return null;return e}function C(){}function D(t){var e=typeof t;if("object"==e){if(!t)return"null";if(t instanceof Array)return"array";if(t instanceof Object)return e;var n=Object.prototype.toString.call(t);if("[object Window]"==n)return"object";if("[object Array]"==n||"number"==typeof t.length&&void 0!==t.splice&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("splice"))return"array";if("[object Function]"==n||void 0!==t.call&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("call"))return"function"}else if("function"==e&&void 0===t.call)return"object";return e}function N(t){return"array"==D(t)}function A(t){var e=D(t);return"array"==e||"object"==e&&"number"==typeof t.length}function k(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var R="closure_uid_"+(1e9*Math.random()>>>0),M=0;function _(t,e,n){return t.call.apply(t.bind,arguments)}function O(e,n,t){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var t=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(t,r),e.apply(n,t)}}return function(){return e.apply(n,arguments)}}function L(t,e,n){return(L=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?_:O).apply(null,arguments)}function P(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}var x=Date.now||function(){return+new Date};function q(t,o){function e(){}e.prototype=o.prototype,t.N=o.prototype,t.prototype=new e,(t.prototype.constructor=t).yb=function(t,e,n){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return o.prototype[e].apply(t,r)}}function F(){this.j=this.j,this.i=this.i}F.prototype.j=!1,F.prototype.la=function(){if(!this.j&&(this.j=!0,this.G(),0))this[R]||(this[R]=++M)},F.prototype.G=function(){if(this.i)for(;this.i.length;)this.i.shift()()};var V=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if(E(t))return E(e)&&1==e.length?t.indexOf(e,0):-1;for(var n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},B=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){for(var r=t.length,i=E(t)?t.split(""):t,o=0;o<r;o++)o in i&&e.call(n,i[o],o,t)};function U(t){return Array.prototype.concat.apply([],arguments)}function Q(t){var e=t.length;if(0<e){for(var n=Array(e),r=0;r<e;r++)n[r]=t[r];return n}return[]}function K(t){return/^[\s\xa0]*$/.test(t)}var j,W=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function G(t,e){return-1!=t.indexOf(e)}function z(t,e){return t<e?-1:e<t?1:0}t:{var H=S.navigator;if(H){var Y=H.userAgent;if(Y){j=Y;break t}}j=""}function X(t,e,n){for(var r in t)e.call(n,t[r],r,t)}function J(t){var e,n={};for(e in t)n[e]=t[e];return n}var $="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Z(t,e){for(var n,r,i=1;i<arguments.length;i++){for(n in r=arguments[i])t[n]=r[n];for(var o=0;o<$.length;o++)n=$[o],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function tt(t){return tt[" "](t),t}tt[" "]=C;var et,nt,rt=G(j,"Opera"),it=G(j,"Trident")||G(j,"MSIE"),ot=G(j,"Edge"),at=ot||it,st=G(j,"Gecko")&&!(G(j.toLowerCase(),"webkit")&&!G(j,"Edge"))&&!(G(j,"Trident")||G(j,"MSIE"))&&!G(j,"Edge"),ut=G(j.toLowerCase(),"webkit")&&!G(j,"Edge");function ct(){var t=S.document;return t?t.documentMode:void 0}t:{var ht="",lt=(nt=j,st?/rv:([^\);]+)(\)|;)/.exec(nt):ot?/Edge\/([\d\.]+)/.exec(nt):it?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(nt):ut?/WebKit\/(\S+)/.exec(nt):rt?/(?:Version)[ \/]?(\S+)/.exec(nt):void 0);if(lt&&(ht=lt?lt[1]:""),it){var ft=ct();if(null!=ft&&ft>parseFloat(ht)){et=String(ft);break t}}et=ht}var pt,dt={};function mt(s){return function(t,e){var n=dt;return Object.prototype.hasOwnProperty.call(n,t)?n[t]:n[t]=e(t)}(s,function(){for(var t=0,e=W(String(et)).split("."),n=W(String(s)).split("."),r=Math.max(e.length,n.length),i=0;0==t&&i<r;i++){var o=e[i]||"",a=n[i]||"";do{if(o=/(\d*)(\D*)(.*)/.exec(o)||["","","",""],a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],0==o[0].length&&0==a[0].length)break;t=z(0==o[1].length?0:parseInt(o[1],10),0==a[1].length?0:parseInt(a[1],10))||z(0==o[2].length,0==a[2].length)||z(o[2],a[2]),o=o[3],a=a[3]}while(0==t)}return 0<=t})}var yt=S.document;pt=yt&&it?ct()||("CSS1Compat"==yt.compatMode?parseInt(et,10):5):void 0;var gt=!it||9<=Number(pt),vt=it&&!mt("9"),bt=function(){if(!S.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{S.addEventListener("test",C,e),S.removeEventListener("test",C,e)}catch(t){}return t}();function wt(t,e){this.type=t,this.a=this.target=e,this.Ja=!0}function St(t,e){if(wt.call(this,t?t.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.c=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.a=e,e=t.relatedTarget){if(st){t:{try{tt(e.nodeName);var i=!0;break t}catch(t){}i=!1}i||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType=E(t.pointerType)?t.pointerType:Et[t.pointerType]||"",(this.c=t).defaultPrevented&&this.b()}}wt.prototype.b=function(){this.Ja=!1},q(St,wt);var Et={2:"touch",3:"pen",4:"mouse"};St.prototype.b=function(){St.N.b.call(this);var t=this.c;if(t.preventDefault)t.preventDefault();else if(t.returnValue=!1,vt)try{(t.ctrlKey||112<=t.keyCode&&t.keyCode<=123)&&(t.keyCode=-1)}catch(t){}};var Tt="closure_listenable_"+(1e6*Math.random()|0),It=0;function Ct(t,e,n,r,i){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.da=i,this.key=++It,this.X=this.Z=!1}function Dt(t){t.X=!0,t.listener=null,t.proxy=null,t.src=null,t.da=null}function Nt(t){this.src=t,this.a={},this.b=0}function At(t,e){var n=e.type;if(n in t.a){var r,i=t.a[n],o=V(i,e);(r=0<=o)&&Array.prototype.splice.call(i,o,1),r&&(Dt(e),0==t.a[n].length&&(delete t.a[n],t.b--))}}function kt(t,e,n,r){for(var i=0;i<t.length;++i){var o=t[i];if(!o.X&&o.listener==e&&o.capture==!!n&&o.da==r)return i}return-1}Nt.prototype.add=function(t,e,n,r,i){var o=t.toString();(t=this.a[o])||(t=this.a[o]=[],this.b++);var a=kt(t,e,r,i);return-1<a?(e=t[a],n||(e.Z=!1)):((e=new Ct(e,this.src,o,!!r,i)).Z=n,t.push(e)),e};var Rt="closure_lm_"+(1e6*Math.random()|0),Mt={};function _t(t,e,n,r,i){if(r&&r.once)return function t(e,n,r,i,o){if(N(n)){for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);return null}r=Bt(r);return e&&e[Tt]?e.Ba(n,r,k(i)?!!i.capture:!!i,o):Ot(e,n,r,!0,i,o)}(t,e,n,r,i);if(N(e)){for(var o=0;o<e.length;o++)_t(t,e[o],n,r,i);return null}return n=Bt(n),t&&t[Tt]?t.Aa(e,n,k(r)?!!r.capture:!!r,i):Ot(t,e,n,!1,r,i)}function Ot(t,e,n,r,i,o){if(!e)throw Error("Invalid event type");var a=k(i)?!!i.capture:!!i;if(a&&!gt)return null;var s=Ft(t);if(s||(t[Rt]=s=new Nt(t)),(n=s.add(e,n,r,a,o)).proxy)return n;if(r=function(){var e=qt,n=gt?function(t){return e.call(n.src,n.listener,t)}:function(t){if(!(t=e.call(n.src,n.listener,t)))return t};return n}(),(n.proxy=r).src=t,r.listener=n,t.addEventListener)bt||(i=a),void 0===i&&(i=!1),t.addEventListener(e.toString(),r,i);else if(t.attachEvent)t.attachEvent(Pt(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function Lt(t){if(!T(t)&&t&&!t.X){var e=t.src;if(e&&e[Tt])At(e.c,t);else{var n=t.type,r=t.proxy;e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(Pt(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=Ft(e))?(At(n,t),0==n.b&&(n.src=null,e[Rt]=null)):Dt(t)}}}function Pt(t){return t in Mt?Mt[t]:Mt[t]="on"+t}function xt(t,e){var n=t.listener,r=t.da||t.src;return t.Z&&Lt(t),n.call(r,e)}function qt(t,e){return!!t.X||(gt?xt(t,new St(e,this)):xt(t,e=new St(e||I("window.event"),this)))}function Ft(t){return(t=t[Rt])instanceof Nt?t:null}var Vt="__closure_events_fn_"+(1e9*Math.random()>>>0);function Bt(e){return"function"==D(e)?e:(e[Vt]||(e[Vt]=function(t){return e.handleEvent(t)}),e[Vt])}function Ut(){F.call(this),this.c=new Nt(this),(this.J=this).B=null}function Qt(t,e,n,r){if(!(e=t.c.a[String(e)]))return!0;e=e.concat();for(var i=!0,o=0;o<e.length;++o){var a=e[o];if(a&&!a.X&&a.capture==n){var s=a.listener,u=a.da||a.src;a.Z&&At(t.c,a),i=!1!==s.call(u,r)&&i}}return i&&0!=r.Ja}q(Ut,F),Ut.prototype[Tt]=!0,(g=Ut.prototype).addEventListener=function(t,e,n,r){_t(this,t,e,n,r)},g.removeEventListener=function(t,e,n,r){!function t(e,n,r,i,o){if(N(n))for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);else i=k(i)?!!i.capture:!!i,r=Bt(r),e&&e[Tt]?(e=e.c,(n=String(n).toString())in e.a&&-1<(r=kt(a=e.a[n],r,i,o))&&(Dt(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete e.a[n],e.b--))):(e=e&&Ft(e))&&(n=e.a[n.toString()],e=-1,n&&(e=kt(n,r,i,o)),(r=-1<e?n[e]:null)&&Lt(r))}(this,t,e,n,r)},g.dispatchEvent=function(t){var e,n=this.B;if(n)for(e=[];n;n=n.B)e.push(n);n=this.J;var r=t.type||t;if(E(t))t=new wt(t,n);else if(t instanceof wt)t.target=t.target||n;else{var i=t;Z(t=new wt(r,n),i)}if(i=!0,e)for(var o=e.length-1;0<=o;o--){var a=t.a=e[o];i=Qt(a,r,!0,t)&&i}if(i=Qt(a=t.a=n,r,!0,t)&&i,i=Qt(a,r,!1,t)&&i,e)for(o=0;o<e.length;o++)i=Qt(a=t.a=e[o],r,!1,t)&&i;return i},g.G=function(){if(Ut.N.G.call(this),this.c){var t,e=this.c;for(t in e.a){for(var n=e.a[t],r=0;r<n.length;r++)Dt(n[r]);delete e.a[t],e.b--}}this.B=null},g.Aa=function(t,e,n,r){return this.c.add(String(t),e,!1,n,r)},g.Ba=function(t,e,n,r){return this.c.add(String(t),e,!0,n,r)};var Kt=S.JSON.stringify;function jt(t,e){this.c=t,this.f=e,this.b=0,this.a=null}function Wt(){this.b=this.a=null}jt.prototype.get=function(){if(0<this.b){this.b--;var t=this.a;this.a=t.next,t.next=null}else t=this.c();return t};var Gt,zt=new jt(function(){return new Ht},function(t){t.reset()});function Ht(){this.next=this.b=this.a=null}function Yt(t){S.setTimeout(function(){throw t},0)}function Xt(t,e){Gt||function(){var t=S.Promise.resolve(void 0);Gt=function(){t.then(Zt)}}(),Jt||(Gt(),Jt=!0),$t.add(t,e)}Wt.prototype.add=function(t,e){var n=zt.get();n.set(t,e),this.b?this.b.next=n:this.a=n,this.b=n},Ht.prototype.set=function(t,e){this.a=t,this.b=e,this.next=null};var Jt=!(Ht.prototype.reset=function(){this.next=this.b=this.a=null}),$t=new Wt;function Zt(){for(var t;r=n=void 0,r=null,(n=$t).a&&(r=n.a,n.a=n.a.next,n.a||(n.b=null),r.next=null),t=r;){try{t.a.call(t.b)}catch(t){Yt(t)}var e=zt;e.f(t),e.b<100&&(e.b++,t.next=e.a,e.a=t)}var n,r;Jt=!1}function te(t,e){Ut.call(this),this.b=t||1,this.a=e||S,this.f=L(this.gb,this),this.g=x()}function ee(t){t.ba=!1,t.L&&(t.a.clearTimeout(t.L),t.L=null)}function ne(t,e,n){if("function"==D(t))n&&(t=L(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=L(t.handleEvent,t)}return 2147483647<Number(e)?-1:S.setTimeout(t,e||0)}function re(t,e,n){F.call(this),this.f=null!=n?L(t,n):t,this.c=e,this.b=L(this.ab,this),this.a=[]}function ie(t){t.U=ne(t.b,t.c),t.f.apply(null,t.a)}function oe(t){F.call(this),this.b=t,this.a={}}q(te,Ut),(g=te.prototype).ba=!1,g.L=null,g.gb=function(){if(this.ba){var t=x()-this.g;0<t&&t<.8*this.b?this.L=this.a.setTimeout(this.f,this.b-t):(this.L&&(this.a.clearTimeout(this.L),this.L=null),this.dispatchEvent("tick"),this.ba&&(ee(this),this.start()))}},g.start=function(){this.ba=!0,this.L||(this.L=this.a.setTimeout(this.f,this.b),this.g=x())},g.G=function(){te.N.G.call(this),ee(this),delete this.a},q(re,F),(g=re.prototype).ea=!1,g.U=null,g.Ua=function(t){this.a=arguments,this.U?this.ea=!0:ie(this)},g.G=function(){re.N.G.call(this),this.U&&(S.clearTimeout(this.U),this.U=null,this.ea=!1,this.a=[])},g.ab=function(){this.U=null,this.ea&&(this.ea=!1,ie(this))},q(oe,F);var ae=[];function se(t,e,n,r){N(n)||(n&&(ae[0]=n.toString()),n=ae);for(var i=0;i<n.length;i++){var o=_t(e,n[i],r||t.handleEvent,!1,t.b||t);if(!o)break;t.a[o.key]=o}}function ue(t){X(t.a,function(t,e){this.a.hasOwnProperty(e)&&Lt(t)},t),t.a={}}function ce(){}oe.prototype.G=function(){oe.N.G.call(this),ue(this)},oe.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var he=new Ut;function le(t){wt.call(this,"serverreachability",t)}function fe(t){he.dispatchEvent(new le(he,t))}function pe(t){wt.call(this,"statevent",t)}function de(t){he.dispatchEvent(new pe(he,t))}function me(t){wt.call(this,"timingevent",t)}function ye(t,e){if("function"!=D(t))throw Error("Fn must not be null and must be a function");return S.setTimeout(function(){t()},e)}q(le,wt),q(pe,wt),q(me,wt);var ge={NO_ERROR:0,hb:1,ob:2,nb:3,kb:4,mb:5,pb:6,Ma:7,TIMEOUT:8,sb:9},ve={jb:"complete",wb:"success",Na:"error",Ma:"abort",ub:"ready",vb:"readystatechange",TIMEOUT:"timeout",qb:"incrementaldata",tb:"progress",lb:"downloadprogress",xb:"uploadprogress"};function be(){}function we(t){var e;return(e=t.a)||(e=t.a={}),e}function Se(){}be.prototype.a=null;var Ee,Te={OPEN:"a",ib:"b",Na:"c",rb:"d"};function Ie(){wt.call(this,"d")}function Ce(){wt.call(this,"c")}function De(){}function Ne(t,e,n){this.g=t,this.W=e,this.V=n||1,this.I=new oe(this),this.O=Ae,t=at?125:void 0,this.P=new te(t),this.h=null,this.b=!1,this.l=this.D=this.f=this.F=this.v=this.R=this.i=null,this.j=[],this.a=null,this.A=0,this.c=this.w=null,this.o=-1,this.m=!1,this.J=0,this.B=null,this.s=this.S=this.H=!1}q(Ie,wt),q(Ce,wt),q(De,be),Ee=new De;var Ae=45e3,ke={},Re={};function Me(t,e,n){t.F=1,t.f=nn(Ye(e)),t.l=n,t.H=!0,Oe(t,null)}function _e(t,e,n,r){t.F=1,t.f=nn(Ye(e)),t.l=null,t.H=n,Oe(t,r)}function Oe(t,e){t.v=x(),xe(t),t.D=Ye(t.f),en(t.D,"t",t.V),t.A=0,t.a=t.g.$(t.g.Y()?e:null),0<t.J&&(t.B=new re(L(t.Ka,t,t.a),t.J)),se(t.I,t.a,"readystatechange",t.eb),e=t.h?J(t.h):{},t.l?(t.w||(t.w="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.a.ca(t.D,t.w,t.l,e)):(t.w="GET",t.a.ca(t.D,t.w,null,e)),fe(1)}function Le(t,e,n){for(var r=!0;!t.m&&t.A<n.length;){var i=Pe(t,n);if(i==Re){4==e&&(t.c=4,de(14),r=!1);break}if(i==ke){t.c=4,de(15),r=!1;break}Ue(t,i)}4==e&&0==n.length&&(t.c=1,de(16),r=!1),t.b=t.b&&r,r||(Be(t),Ve(t))}function Pe(t,e){var n=t.A,r=e.indexOf("\n",n);return-1==r?Re:(n=Number(e.substring(n,r)),isNaN(n)?ke:(r+=1)+n>e.length?Re:(e=e.substr(r,n),t.A=r+n,e))}function xe(t){t.R=x()+t.O,qe(t,t.O)}function qe(t,e){if(null!=t.i)throw Error("WatchDog timer not null");t.i=ye(L(t.bb,t),e)}function Fe(t){t.i&&(S.clearTimeout(t.i),t.i=null)}function Ve(t){t.g.Da()||t.m||t.g.na(t)}function Be(t){Fe(t);var e=t.B;e&&"function"==typeof e.la&&e.la(),t.B=null,ee(t.P),ue(t.I),t.a&&(e=t.a,t.a=null,e.abort(),e.la())}function Ue(t,e){try{t.g.Ga(t,e),fe(4)}catch(t){}}function Qe(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(A(t)||E(t))B(t,e,void 0);else{if(t.K&&"function"==typeof t.K)var n=t.K();else if(t.C&&"function"==typeof t.C)n=void 0;else if(A(t)||E(t)){n=[];for(var r=t.length,i=0;i<r;i++)n.push(i)}else for(i in n=[],r=0,t)n[r++]=i;i=(r=function(t){if(t.C&&"function"==typeof t.C)return t.C();if(E(t))return t.split("");if(A(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t)).length;for(var o=0;o<i;o++)e.call(void 0,r[o],n&&n[o],t)}}function Ke(t,e){this.b={},this.a=[],this.c=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(t)if(t instanceof Ke)for(n=t.K(),r=0;r<n.length;r++)this.set(n[r],t.get(n[r]));else for(r in t)this.set(r,t[r])}function je(t,e){Ge(t.b,e)&&(delete t.b[e],t.c--,t.a.length>2*t.c&&We(t))}function We(t){if(t.c!=t.a.length){for(var e=0,n=0;e<t.a.length;){var r=t.a[e];Ge(t.b,r)&&(t.a[n++]=r),e++}t.a.length=n}if(t.c!=t.a.length){var i={};for(n=e=0;e<t.a.length;)Ge(i,r=t.a[e])||(i[t.a[n++]=r]=1),e++;t.a.length=n}}function Ge(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(g=Ne.prototype).setTimeout=function(t){this.O=t},g.eb=function(t){t=t.target;var e=this.B;e&&3==Yn(t)?e.Ua():this.Ka(t)},g.Ka=function(t){try{if(t==this.a)t:{var e=Yn(this.a),n=this.a.ya(),r=this.a.T();if(!(e<3||3==e&&!at&&!this.a.aa())){this.m||4!=e||7==n||fe(8==n||r<=0?3:2),Fe(this);var i=this.a.T();this.o=i;var o=this.a.aa();if(this.b=200==i){if(this.S&&!this.s){e:{if(this.a){var a=Xn(this.a,"X-HTTP-Initial-Response");if(a&&!K(a)){var s=a;break e}}s=null}if(!s){this.b=!1,this.c=3,de(12),Be(this),Ve(this);break t}this.s=!0,Ue(this,s)}this.H?(Le(this,e,o),at&&this.b&&3==e&&(se(this.I,this.P,"tick",this.cb),this.P.start())):Ue(this,o),4==e&&Be(this),this.b&&!this.m&&(4==e?this.g.na(this):(this.b=!1,xe(this)))}else 400==i&&0<o.indexOf("Unknown SID")?(this.c=3,de(12)):(this.c=0,de(13)),Be(this),Ve(this)}}}catch(t){}},g.cb=function(){if(this.a){var t=Yn(this.a),e=this.a.aa();this.A<e.length&&(Fe(this),Le(this,t,e),this.b&&4!=t&&xe(this))}},g.cancel=function(){this.m=!0,Be(this)},g.bb=function(){this.i=null;var t=x();0<=t-this.R?(2!=this.F&&(fe(3),de(17)),Be(this),this.c=2,Ve(this)):qe(this,this.R-t)},(g=Ke.prototype).C=function(){We(this);for(var t=[],e=0;e<this.a.length;e++)t.push(this.b[this.a[e]]);return t},g.K=function(){return We(this),this.a.concat()},g.get=function(t,e){return Ge(this.b,t)?this.b[t]:e},g.set=function(t,e){Ge(this.b,t)||(this.c++,this.a.push(t)),this.b[t]=e},g.forEach=function(t,e){for(var n=this.K(),r=0;r<n.length;r++){var i=n[r],o=this.get(i);t.call(e,o,i,this)}};var ze=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function He(t,e){var n;this.b=this.j=this.f="",this.i=null,this.g=this.a="",this.h=!1,t instanceof He?(this.h=void 0!==e?e:t.h,Xe(this,t.f),this.j=t.j,Je(this,t.b),$e(this,t.i),this.a=t.a,Ze(this,gn(t.c)),this.g=t.g):t&&(n=String(t).match(ze))?(this.h=!!e,Xe(this,n[1]||"",!0),this.j=rn(n[2]||""),Je(this,n[3]||"",!0),$e(this,n[4]),this.a=rn(n[5]||"",!0),Ze(this,n[6]||"",!0),this.g=rn(n[7]||"")):(this.h=!!e,this.c=new fn(null,this.h))}function Ye(t){return new He(t)}function Xe(t,e,n){t.f=n?rn(e,!0):e,t.f&&(t.f=t.f.replace(/:$/,""))}function Je(t,e,n){t.b=n?rn(e,!0):e}function $e(t,e){if(e){if(e=Number(e),isNaN(e)||e<0)throw Error("Bad port number "+e);t.i=e}else t.i=null}function Ze(t,e,n){e instanceof fn?(t.c=e,function(t,e){e&&!t.f&&(pn(t),t.c=null,t.a.forEach(function(t,e){var n=e.toLowerCase();e!=n&&(dn(this,e),yn(this,n,t))},t)),t.f=e}(t.c,t.h)):(n||(e=on(e,hn)),t.c=new fn(e,t.h))}function tn(t,e,n){t.c.set(e,n)}function en(t,e,n){N(n)||(n=[String(n)]),yn(t.c,e,n)}function nn(t){return tn(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^x()).toString(36)),t}function rn(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function on(t,e,n){return E(t)?(t=encodeURI(t).replace(e,an),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function an(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}He.prototype.toString=function(){var t=[],e=this.f;e&&t.push(on(e,sn,!0),":");var n=this.b;return!n&&"file"!=e||(t.push("//"),(e=this.j)&&t.push(on(e,sn,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.i)&&t.push(":",String(n))),(n=this.a)&&(this.b&&"/"!=n.charAt(0)&&t.push("/"),t.push(on(n,"/"==n.charAt(0)?cn:un,!0))),(n=this.c.toString())&&t.push("?",n),(n=this.g)&&t.push("#",on(n,ln)),t.join("")},He.prototype.resolve=function(t){var e=Ye(this),n=!!t.f;n?Xe(e,t.f):n=!!t.j,n?e.j=t.j:n=!!t.b,n?Je(e,t.b):n=null!=t.i;var r=t.a;if(n)$e(e,t.i);else if(n=!!t.a){if("/"!=r.charAt(0))if(this.b&&!this.a)r="/"+r;else{var i=e.a.lastIndexOf("/");-1!=i&&(r=e.a.substr(0,i+1)+r)}if(".."==(i=r)||"."==i)r="";else if(G(i,"./")||G(i,"/.")){r=0==i.lastIndexOf("/",0),i=i.split("/");for(var o=[],a=0;a<i.length;){var s=i[a++];"."==s?r&&a==i.length&&o.push(""):".."==s?((1<o.length||1==o.length&&""!=o[0])&&o.pop(),r&&a==i.length&&o.push("")):(o.push(s),r=!0)}r=o.join("/")}else r=i}return n?e.a=r:n=""!==t.c.toString(),n?Ze(e,gn(t.c)):n=!!t.g,n&&(e.g=t.g),e};var sn=/[#\/\?@]/g,un=/[#\?:]/g,cn=/[#\?]/g,hn=/[#\?@]/g,ln=/#/g;function fn(t,e){this.b=this.a=null,this.c=t||null,this.f=!!e}function pn(n){n.a||(n.a=new Ke,n.b=0,n.c&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].indexOf("="),i=null;if(0<=r){var o=t[n].substring(0,r);i=t[n].substring(r+1)}else o=t[n];e(o,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(n.c,function(t,e){n.add(decodeURIComponent(t.replace(/\+/g," ")),e)}))}function dn(t,e){pn(t),e=vn(t,e),Ge(t.a.b,e)&&(t.c=null,t.b-=t.a.get(e).length,je(t.a,e))}function mn(t,e){return pn(t),e=vn(t,e),Ge(t.a.b,e)}function yn(t,e,n){dn(t,e),0<n.length&&(t.c=null,t.a.set(vn(t,e),Q(n)),t.b+=n.length)}function gn(t){var e=new fn;return e.c=t.c,t.a&&(e.a=new Ke(t.a),e.b=t.b),e}function vn(t,e){return e=String(e),t.f&&(e=e.toLowerCase()),e}function bn(t){this.a=t,this.b=this.h=null,this.g=!1,this.i=null,this.c=-1,this.l=this.f=null}function wn(t){var e=t.a.F.a;if(null!=e)de(4),e?(de(10),ur(t.a,t,!1)):(de(11),ur(t.a,t,!0));else{t.b=new Ne(t,void 0,void 0),t.b.h=t.h,e=pr(e=t.a,e.Y()?t.f:null,t.i),de(4),en(e,"TYPE","xmlhttp");var n=t.a.j,r=t.a.I;n&&r&&tn(e,n,r),_e(t.b,e,!1,t.f)}}function Sn(){this.a=this.b=null}function En(){this.a=new Ke}function Tn(t){var e=typeof t;return"object"==e&&t||"function"==e?"o"+(t[R]||(t[R]=++M)):e.charAt(0)+t}function In(t,e){this.b=t,this.a=e}function Cn(t){this.g=t||Dn,t=S.PerformanceNavigationTiming?0<(t=S.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(S.ka&&S.ka.Ea&&S.ka.Ea()&&S.ka.Ea().zb),this.f=t?this.g:1,this.a=null,1<this.f&&(this.a=new En),this.b=null,this.c=[]}(g=fn.prototype).add=function(t,e){pn(this),this.c=null,t=vn(this,t);var n=this.a.get(t);return n||this.a.set(t,n=[]),n.push(e),this.b+=1,this},g.forEach=function(n,r){pn(this),this.a.forEach(function(t,e){B(t,function(t){n.call(r,t,e,this)},this)},this)},g.K=function(){pn(this);for(var t=this.a.C(),e=this.a.K(),n=[],r=0;r<e.length;r++)for(var i=t[r],o=0;o<i.length;o++)n.push(e[r]);return n},g.C=function(t){pn(this);var e=[];if(E(t))mn(this,t)&&(e=U(e,this.a.get(vn(this,t))));else{t=this.a.C();for(var n=0;n<t.length;n++)e=U(e,t[n])}return e},g.set=function(t,e){return pn(this),this.c=null,mn(this,t=vn(this,t))&&(this.b-=this.a.get(t).length),this.a.set(t,[e]),this.b+=1,this},g.get=function(t,e){return t&&0<(t=this.C(t)).length?String(t[0]):e},g.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var t=[],e=this.a.K(),n=0;n<e.length;n++){var r=e[n],i=encodeURIComponent(String(r));r=this.C(r);for(var o=0;o<r.length;o++){var a=i;""!==r[o]&&(a+="="+encodeURIComponent(String(r[o]))),t.push(a)}}return this.c=t.join("&")},q(function(){},function(){}),(g=bn.prototype).M=null,g.$=function(t){return this.a.$(t)},g.abort=function(){this.b&&(this.b.cancel(),this.b=null),this.c=-1},g.Da=function(){return!1},g.Ga=function(t,e){if(this.c=t.o,0==this.M){if(!this.a.o&&(t=t.a)){var n=Xn(t,"X-Client-Wire-Protocol");this.l=n||null,this.a.j&&(t=Xn(t,"X-HTTP-Session-Id"))&&(this.a.I=t)}if(e){try{var r=this.a.ja.a.parse(e)}catch(t){return(e=this.a).m=this.c,void lr(e,2)}this.f=r[0]}else(e=this.a).m=this.c,lr(e,2)}else 1==this.M&&(this.g?de(6):"11111"==e?(de(5),this.g=!0,(!it||10<=Number(pt))&&(this.c=200,this.b.cancel(),de(11),ur(this.a,this,!0))):(de(7),this.g=!1))},g.na=function(){if(this.c=this.b.o,this.b.b)0==this.M?(this.M=1,wn(this)):1==this.M&&(this.g?(de(11),ur(this.a,this,!0)):(de(10),ur(this.a,this,!1)));else{0==this.M?de(8):1==this.M&&de(9);var t=this.a;t.m=this.c,lr(t,2)}},g.Y=function(){return this.a.Y()},g.ma=function(){return this.a.ma()},En.prototype.add=function(t){this.a.set(Tn(t),t)},En.prototype.C=function(){return this.a.C()};var Dn=10;function Nn(t,e){!t.a&&(G(e,"spdy")||G(e,"quic")||G(e,"h2"))&&(t.f=t.g,t.a=new En,t.b&&(Mn(t,t.b),t.b=null))}function An(t){return!!t.b||!!t.a&&t.a.a.c>=t.f}function kn(t){return t.b?1:t.a?t.a.a.c:0}function Rn(t,e){return t=t.b?t.b==e:!!t.a&&(e=Tn(e),Ge(t.a.a.b,e))}function Mn(t,e){t.a?t.a.add(e):t.b=e}function _n(t,e){var n;t.b&&t.b==e?t.b=null:((n=t.a)&&(n=Tn(e),n=Ge(t.a.a.b,n)),n&&je(t.a.a,Tn(e)))}function On(t){if(null!=t.b)return t.c.concat(t.b.j);if(null==t.a||0==t.a.a.c)return Q(t.c);var e=t.c;return B(t.a.C(),function(t){e=e.concat(t.j)}),e}function Ln(){}function Pn(){this.a=new Ln}function xn(t,r,e){var i=e||"";try{Qe(t,function(t,e){var n=t;k(t)&&(n=Kt(t)),r.push(i+e+"="+encodeURIComponent(n))})}catch(t){throw r.push(i+"type="+encodeURIComponent("_badmap")),t}}function qn(t,e,n,r,i){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,i(r)}catch(t){}}Cn.prototype.cancel=function(){this.c=On(this),this.b?(this.b.cancel(),this.b=null):this.a&&0!=this.a.a.c&&(B(this.a.C(),function(t){t.cancel()}),function(t){t.b={},t.a.length=0,t.c=0}(this.a.a))},Ln.prototype.stringify=function(t){return S.JSON.stringify(t,void 0)},Ln.prototype.parse=function(t){return S.JSON.parse(t,void 0)};var Fn=S.JSON.parse;function Vn(t){Ut.call(this),this.headers=new Ke,this.H=t||null,this.b=!1,this.s=this.a=null,this.A="",this.h=0,this.f="",this.g=this.w=this.l=this.v=!1,this.o=0,this.m=null,this.I=Bn,this.D=this.F=!1}q(Vn,Ut);var Bn="",Un=/^https?$/i,Qn=["POST","PUT"];function Kn(t){return"content-type"==t.toLowerCase()}function jn(t,e){t.b=!1,t.a&&(t.g=!0,t.a.abort(),t.g=!1),t.f=e,t.h=5,Wn(t),zn(t)}function Wn(t){t.v||(t.v=!0,t.dispatchEvent("complete"),t.dispatchEvent("error"))}function Gn(t){if(t.b&&void 0!==w&&(!t.s[1]||4!=Yn(t)||2!=t.T()))if(t.l&&4==Yn(t))ne(t.Fa,0,t);else if(t.dispatchEvent("readystatechange"),4==Yn(t)){t.b=!1;try{var e,n=t.T();t:switch(n){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var r=!0;break t;default:r=!1}if(!(e=r)){var i;if(i=0===n){var o=String(t.A).match(ze)[1]||null;if(!o&&S.self&&S.self.location){var a=S.self.location.protocol;o=a.substr(0,a.length-1)}i=!Un.test(o?o.toLowerCase():"")}e=i}e?(t.dispatchEvent("complete"),t.dispatchEvent("success")):(t.h=6,t.f=t.za()+" ["+t.T()+"]",Wn(t))}finally{zn(t)}}}function zn(t,e){if(t.a){Hn(t);var n=t.a,r=t.s[0]?C:null;t.a=null,t.s=null,e||t.dispatchEvent("ready");try{n.onreadystatechange=r}catch(t){}}}function Hn(t){t.a&&t.D&&(t.a.ontimeout=null),t.m&&(S.clearTimeout(t.m),t.m=null)}function Yn(t){return t.a?t.a.readyState:0}function Xn(t,e){return t.a?t.a.getResponseHeader(e):null}function Jn(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}if(r)return t;if(n=function(t){var n="";return X(t,function(t,e){n+=e,n+=":",n+=t,n+="\r\n"}),n}(n),E(t)){if(e=encodeURIComponent(String(e)),e+=n=null!=n?"="+encodeURIComponent(String(n)):""){if((n=t.indexOf("#"))<0&&(n=t.length),(r=t.indexOf("?"))<0||n<r){r=n;var i=""}else i=t.substring(r+1,n);n=(t=[t.substr(0,r),i,t.substr(n)])[1],t[1]=e?n?n+"&"+e:e:n,t=t[0]+(t[1]?"?"+t[1]:"")+t[2]}return t}return tn(t,e,n),t}function $n(t){this.f=[],this.F=new Sn,this.ga=this.pa=this.B=this.ha=this.a=this.I=this.j=this.V=this.g=this.J=this.i=null,this.Ra=this.P=0,this.Pa=!!I("internalChannelParams.failFast",t),this.ia=this.w=this.s=this.l=this.h=this.c=null,this.oa=!0,this.m=this.ra=this.O=-1,this.S=this.v=this.A=0,this.Oa=I("internalChannelParams.baseRetryDelayMs",t)||5e3,this.Sa=I("internalChannelParams.retryDelaySeedMs",t)||1e4,this.Qa=I("internalChannelParams.forwardChannelMaxRetries",t)||2,this.qa=I("internalChannelParams.forwardChannelRequestTimeoutMs",t)||2e4,this.La=t&&t.Ab||void 0,this.D=void 0,this.R=t&&t.supportsCrossDomainXhr||!1,this.H="",this.b=new Cn(t&&t.concurrentRequestLimit),this.ja=new Pn,this.o=!t||void 0===t.backgroundChannelTest||t.backgroundChannelTest,(this.W=t&&t.fastHandshake||!1)&&!this.o&&(this.o=!0),t&&t.forceLongPolling&&(this.oa=!1),this.fa=void 0}function Zn(t){if(tr(t),3==t.u){var e=t.P++,n=Ye(t.B);tn(n,"SID",t.H),tn(n,"RID",e),tn(n,"TYPE","terminate"),ir(t,n),(e=new Ne(t,e,void 0)).F=2,e.f=nn(Ye(n)),n=!1,S.navigator&&S.navigator.sendBeacon&&(n=S.navigator.sendBeacon(e.f.toString(),"")),!n&&S.Image&&((new Image).src=e.f,n=!0),n||(e.a=e.g.$(null),e.a.ca(e.f)),e.v=x(),xe(e)}fr(t)}function tr(t){t.w&&(t.w.abort(),t.w=null),t.a&&(t.a.cancel(),t.a=null),t.l&&(S.clearTimeout(t.l),t.l=null),cr(t),t.b.cancel(),t.h&&(T(t.h)&&S.clearTimeout(t.h),t.h=null)}function er(t,e){t.f.push(new In(t.Ra++,e)),3==t.u&&nr(t)}function nr(t){An(t.b)||t.h||(t.h=!0,Xt(t.Ia,t),t.A=0)}function rr(t,e){var n;n=e?e.W:t.P++;var r=Ye(t.B);tn(r,"SID",t.H),tn(r,"RID",n),tn(r,"AID",t.O),ir(t,r),t.g&&t.i&&Jn(r,t.g,t.i),n=new Ne(t,n,t.A+1),null===t.g&&(n.h=t.i),e&&(t.f=e.j.concat(t.f)),e=or(t,n,1e3),n.setTimeout(Math.round(.5*t.qa)+Math.round(.5*t.qa*Math.random())),Mn(t.b,n),Me(n,r,e)}function ir(t,n){t.c&&Qe({},function(t,e){tn(n,e,t)})}function or(t,e,n){n=Math.min(t.f.length,n);var r=t.c?L(t.c.Ta,t.c,t):null;t:for(var i=t.f,o=-1;;){var a=["count="+n];-1==o?0<n?(o=i[0].b,a.push("ofs="+o)):o=0:a.push("ofs="+o);for(var s=!0,u=0;u<n;u++){var c=i[u].b,h=i[u].a;if((c-=o)<0)o=Math.max(0,i[u].b-100),s=!1;else try{xn(h,a,"req"+c+"_")}catch(t){r&&r(h)}}if(s){r=a.join("&");break t}}return t=t.f.splice(0,n),e.j=t,r}function ar(t){t.a||t.l||(t.S=1,Xt(t.Ha,t),t.v=0)}function sr(t){return!(t.a||t.l||3<=t.v)&&(t.S++,t.l=ye(L(t.Ha,t),hr(t,t.v)),t.v++,!0)}function ur(t,e,n){var r=e.l;r&&Nn(t.b,r),t.ia=t.oa&&n,t.m=e.c,t.B=pr(t,null,t.ha),nr(t)}function cr(t){null!=t.s&&(S.clearTimeout(t.s),t.s=null)}function hr(t,e){var n=t.Oa+Math.floor(Math.random()*t.Sa);return t.ma()||(n*=2),n*e}function lr(t,e){if(2==e){var n=null;t.c&&(n=null);var r=L(t.fb,t);n||(n=new He("//www.google.com/images/cleardot.gif"),S.location&&"http"==S.location.protocol||Xe(n,"https"),nn(n)),function(t,e){var n=new ce;if(S.Image){var r=new Image;r.onload=P(qn,n,r,"TestLoadImage: loaded",!0,e),r.onerror=P(qn,n,r,"TestLoadImage: error",!1,e),r.onabort=P(qn,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=P(qn,n,r,"TestLoadImage: timeout",!1,e),S.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=t}else e(!1)}(n.toString(),r)}else de(2);t.u=0,t.c&&t.c.ta(e),fr(t),tr(t)}function fr(t){t.u=0,t.m=-1,t.c&&(0==On(t.b).length&&0==t.f.length||(t.b.c.length=0,Q(t.f),t.f.length=0),t.c.sa())}function pr(t,e,n){var r=function(t){return t instanceof He?Ye(t):new He(t,void 0)}(n);if(""!=r.b)e&&Je(r,e+"."+r.b),$e(r,r.i);else{var i,o=S.location;i=e?e+"."+o.hostname:o.hostname,r=function(t,e,n,r){var i=new He(null,void 0);return t&&Xe(i,t),e&&Je(i,e),n&&$e(i,n),r&&(i.a=r),i}(o.protocol,i,+o.port,n)}return t.V&&X(t.V,function(t,e){tn(r,e,t)}),e=t.j,n=t.I,e&&n&&tn(r,e,n),tn(r,"VER",t.wa),ir(t,r),r}function dr(){}function mr(){if(it&&!(10<=Number(pt)))throw Error("Environmental error: no available transport.")}function yr(t,e){Ut.call(this),this.a=new $n(e),this.g=t,this.m=e&&e.testUrl?e.testUrl:function(t){for(var e=t,n=1;n<arguments.length;n++){var r,i=arguments[n];if(0==i.lastIndexOf("/",0))e=i;else(r=""==e)||(r=0<=(r=e.length-1)&&e.indexOf("/",r)==r),e+=r?i:"/"+i}return e}(this.g,"test"),this.b=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.a.i=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.xa&&(t?t["X-WebChannel-Client-Profile"]=e.xa:t={"X-WebChannel-Client-Profile":e.xa}),this.a.J=t,(t=e&&e.httpHeadersOverwriteParam)&&!K(t)&&(this.a.g=t),this.l=e&&e.supportsCrossDomainXhr||!1,this.h=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!K(e)&&(this.a.j=e,null!==(t=this.b)&&e in t&&(e in(t=this.b)&&delete t[e])),this.f=new br(this)}function gr(t){Ie.call(this);var e=t.__sm__;if(e){t:{for(var n in e){t=n;break t}t=void 0}(this.c=t)?(t=this.c,this.data=null!==e&&t in e?e[t]:void 0):this.data=e}else this.data=t}function vr(){Ce.call(this),this.status=1}function br(t){this.a=t}(g=Vn.prototype).ca=function(t,e,n,r){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.A+"; newUri="+t);e=e?e.toUpperCase():"GET",this.A=t,this.f="",this.h=0,this.v=!1,this.b=!0,this.a=new XMLHttpRequest,this.s=this.H?we(this.H):we(Ee),this.a.onreadystatechange=L(this.Fa,this);try{this.w=!0,this.a.open(e,String(t),!0),this.w=!1}catch(t){return void jn(this,t)}t=n||"";var i=new Ke(this.headers);r&&Qe(r,function(t,e){i.set(e,t)}),r=function(t){t:{for(var e=Kn,n=t.length,r=E(t)?t.split(""):t,i=0;i<n;i++)if(i in r&&e.call(void 0,r[i],i,t)){e=i;break t}e=-1}return e<0?null:E(t)?t.charAt(e):t[e]}(i.K()),n=S.FormData&&t instanceof S.FormData,0<=V(Qn,e)&&!r&&!n&&i.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),i.forEach(function(t,e){this.a.setRequestHeader(e,t)},this),this.I&&(this.a.responseType=this.I),"withCredentials"in this.a&&this.a.withCredentials!==this.F&&(this.a.withCredentials=this.F);try{Hn(this),0<this.o&&((this.D=function(t){return it&&mt(9)&&T(t.timeout)&&void 0!==t.ontimeout}(this.a))?(this.a.timeout=this.o,this.a.ontimeout=L(this.Ca,this)):this.m=ne(this.Ca,this.o,this)),this.l=!0,this.a.send(t),this.l=!1}catch(t){jn(this,t)}},g.Ca=function(){void 0!==w&&this.a&&(this.f="Timed out after "+this.o+"ms, aborting",this.h=8,this.dispatchEvent("timeout"),this.abort(8))},g.abort=function(t){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=t||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),zn(this))},g.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),zn(this,!0)),Vn.N.G.call(this)},g.Fa=function(){this.j||(this.w||this.l||this.g?Gn(this):this.$a())},g.$a=function(){Gn(this)},g.T=function(){try{return 2<Yn(this)?this.a.status:-1}catch(t){return-1}},g.za=function(){try{return 2<Yn(this)?this.a.statusText:""}catch(t){return""}},g.aa=function(){try{return this.a?this.a.responseText:""}catch(t){return""}},g.Va=function(t){if(this.a){var e=this.a.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),Fn(e)}},g.ya=function(){return this.h},g.Ya=function(){return E(this.f)?this.f:String(this.f)},(g=$n.prototype).wa=8,g.u=1,g.Da=function(){return 0==this.u},g.Ia=function(t){if(this.h)if(this.h=null,1==this.u){if(!t){this.P=Math.floor(1e5*Math.random()),t=this.P++;var e,n=new Ne(this,t,void 0),r=this.i;if(this.J&&(r?Z(r=J(r),this.J):r=this.J),null===this.g&&(n.h=r),this.W)t:{for(var i=e=0;i<this.f.length;i++){var o=this.f[i];if(void 0===(o="__data__"in o.a&&E(o=o.a.__data__)?o.length:void 0))break;if(4096<(e+=o)){e=i;break t}if(4096===e||i===this.f.length-1){e=i+1;break t}}e=1e3}else e=1e3;e=or(this,n,e),tn(i=Ye(this.B),"RID",t),tn(i,"CVER",22),this.o&&this.j&&tn(i,"X-HTTP-Session-Id",this.j),ir(this,i),this.g&&r&&Jn(i,this.g,r),Mn(this.b,n),this.W?(tn(i,"$req",e),tn(i,"SID","null"),n.S=!0,Me(n,i,null)):Me(n,i,e),this.u=2}}else 3==this.u&&(t?rr(this,t):0==this.f.length||An(this.b)||rr(this))},g.Ha=function(){this.l=null,this.a=new Ne(this,"rpc",this.S),null===this.g&&(this.a.h=this.i),this.a.J=0;var t=Ye(this.pa);tn(t,"RID","rpc"),tn(t,"SID",this.H),tn(t,"CI",this.ia?"0":"1"),tn(t,"AID",this.O),ir(this,t),tn(t,"TYPE","xmlhttp"),this.g&&this.i&&Jn(t,this.g,this.i),this.D&&this.a.setTimeout(this.D),_e(this.a,t,!0,this.ga)},g.Ga=function(t,e){if(0!=this.u&&(this.a==t||Rn(this.b,t)))if(this.m=t.o,!t.s&&Rn(this.b,t)&&3==this.u){try{var n=this.ja.a.parse(e)}catch(t){n=null}if(N(n)&&3==n.length){if(0==(e=n)[0]){t:if(!this.l){if(this.a){if(!(this.a.v+3e3<t.v))break t;cr(this),this.a.cancel(),this.a=null}sr(this),de(18)}}else this.ra=e[1],0<this.ra-this.O&&e[2]<37500&&this.ia&&0==this.v&&!this.s&&(this.s=ye(L(this.Za,this),6e3));if(kn(this.b)<=1&&this.fa){try{this.fa()}catch(t){}this.fa=void 0}}else lr(this,11)}else if(!t.s&&this.a!=t||cr(this),!K(e))for(e=n=this.ja.a.parse(e),n=0;n<e.length;n++){var r=e[n];if(this.O=r[0],r=r[1],2==this.u)if("c"==r[0]){this.H=r[1],this.ga=r[2];var i=r[3];null!=i&&(this.wa=i),null!=(r=r[5])&&T(r)&&0<r&&(this.D=1.5*r),this.o&&(r=t.a)&&((i=Xn(r,"X-Client-Wire-Protocol"))&&Nn(this.b,i),this.j&&(r=Xn(r,"X-HTTP-Session-Id")))&&(this.I=r,tn(this.B,this.j,r)),this.u=3,this.c&&this.c.va(),r=t,this.pa=pr(this,this.Y()?this.ga:null,this.ha),r.s?(_n(this.b,r),(i=this.D)&&r.setTimeout(i),r.i&&(Fe(r),xe(r)),this.a=r):ar(this),0<this.f.length&&nr(this)}else"stop"!=r[0]&&"close"!=r[0]||lr(this,7);else 3==this.u&&("stop"==r[0]||"close"==r[0]?"stop"==r[0]?lr(this,7):Zn(this):"noop"!=r[0]&&this.c&&this.c.ua(r),this.v=0)}},g.Za=function(){null!=this.s&&(this.s=null,this.a.cancel(),this.a=null,sr(this),de(19))},g.na=function(t){var e=null;if(this.a==t){cr(this),this.a=null;var n=2}else{if(!Rn(this.b,t))return;e=t.j,_n(this.b,t),n=1}if(this.m=t.o,0!=this.u)if(t.b)1==n?(e=x()-t.v,he.dispatchEvent(new me(he,t.l?t.l.length:0,e,this.A)),nr(this)):ar(this);else{var r=t.c;if(3==r||0==r&&0<this.m||!(1==n&&function(t,e){return!(kn(t.b)>=t.b.f-(t.h?1:0))&&(t.h?(t.f=e.j.concat(t.f),!0):!(1==t.u||2==t.u||t.A>=(t.Pa?0:t.Qa))&&(t.h=ye(L(t.Ia,t,e),hr(t,t.A)),t.A++,!0))}(this,t)||2==n&&sr(this)))switch(e&&0<e.length&&(t=this.b,t.c=t.c.concat(e)),r){case 1:lr(this,5);break;case 4:lr(this,10);break;case 3:lr(this,6);break;default:lr(this,2)}}},g.fb=function(t){de(t?2:1)},g.$=function(t){if(t&&!this.R)throw Error("Can't create secondary domain capable XhrIo object.");return(t=new Vn(this.La)).F=this.R,t},g.ma=function(){return!!this.c&&!0},g.Y=function(){return this.R},(g=dr.prototype).va=function(){},g.ua=function(){},g.ta=function(){},g.sa=function(){},g.Ta=function(){},mr.prototype.a=function(t,e){return new yr(t,e)},q(yr,Ut),(g=yr.prototype).addEventListener=function(t,e,n,r){yr.N.addEventListener.call(this,t,e,n,r)},g.removeEventListener=function(t,e,n,r){yr.N.removeEventListener.call(this,t,e,n,r)},g.Wa=function(){this.a.c=this.f,this.l&&(this.a.R=!0);var t=this.a,e=this.m,n=this.g,r=this.b||void 0;de(0),t.ha=n,t.V=r||{},t.o&&(t.F.b=[],t.F.a=!1),t.w=new bn(t),null===t.g&&(t.w.h=t.i),n=e,t.g&&t.i&&(n=Jn(e,t.g,t.i)),(t=t.w).i=n,e=pr(t.a,null,t.i),de(3),null!=(n=t.a.F.b)?(t.f=n[0],t.M=1,wn(t)):(en(e,"MODE","init"),!t.a.o&&t.a.j&&en(e,"X-HTTP-Session-Id",t.a.j),t.b=new Ne(t,void 0,void 0),t.b.h=t.h,_e(t.b,e,!1,null),t.M=0)},g.close=function(){Zn(this.a)},g.Xa=function(t){if(E(t)){var e={};e.__data__=t,er(this.a,e)}else this.h?((e={}).__data__=Kt(t),er(this.a,e)):er(this.a,t)},g.G=function(){this.a.c=null,delete this.f,Zn(this.a),delete this.a,yr.N.G.call(this)},q(gr,Ie),q(vr,Ce),q(br,dr),br.prototype.va=function(){this.a.dispatchEvent("a")},br.prototype.ua=function(t){this.a.dispatchEvent(new gr(t))},br.prototype.ta=function(t){this.a.dispatchEvent(new vr(t))},br.prototype.sa=function(){this.a.dispatchEvent("b")};var wr=P(function(t,e){function n(){}n.prototype=t.prototype;var r=new n;return t.apply(r,Array.prototype.slice.call(arguments,1)),r},mr);mr.prototype.createWebChannel=mr.prototype.a,yr.prototype.send=yr.prototype.Xa,yr.prototype.open=yr.prototype.Wa,yr.prototype.close=yr.prototype.close,ge.NO_ERROR=0,ge.TIMEOUT=8,ge.HTTP_ERROR=6,ve.COMPLETE="complete",(Se.EventType=Te).OPEN="a",Te.CLOSE="b",Te.ERROR="c",Te.MESSAGE="d",Ut.prototype.listen=Ut.prototype.Aa,Vn.prototype.listenOnce=Vn.prototype.Ba,Vn.prototype.getLastError=Vn.prototype.Ya,Vn.prototype.getLastErrorCode=Vn.prototype.ya,Vn.prototype.getStatus=Vn.prototype.T,Vn.prototype.getStatusText=Vn.prototype.za,Vn.prototype.getResponseJson=Vn.prototype.Va,Vn.prototype.getResponseText=Vn.prototype.aa,Vn.prototype.send=Vn.prototype.ca;var Sr,Er,Tr={createWebChannelTransport:wr,ErrorCode:ge,EventType:ve,WebChannel:Se,XhrIo:Vn},Ir=Tr.createWebChannelTransport,Cr=Tr.ErrorCode,Dr=Tr.EventType,Nr=Tr.WebChannel,Ar=Tr.XhrIo,kr=Pd.SDK_VERSION,Rr=new r("@firebase/firestore");function Mr(){return Rr.logLevel===o.DEBUG?Sr.DEBUG:Rr.logLevel===o.SILENT?Sr.SILENT:Sr.ERROR}function _r(t){switch(t){case Sr.DEBUG:Rr.logLevel=o.DEBUG;break;case Sr.ERROR:Rr.logLevel=o.ERROR;break;case Sr.SILENT:Rr.logLevel=o.SILENT;break;default:Rr.error("Firestore ("+kr+"): Invalid value passed to `setLogLevel`")}}function Or(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(Rr.logLevel<=o.DEBUG){var i=n.map(Pr);Rr.debug.apply(Rr,["Firestore ("+kr+") ["+t+"]: "+e].concat(i))}}function Lr(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(Rr.logLevel<=o.ERROR){var r=e.map(Pr);Rr.error.apply(Rr,["Firestore ("+kr+"): "+t].concat(r))}}function Pr(e){if("string"==typeof e)return e;var t=Fr.getPlatform();try{return t.formatJSON(e)}catch(t){return e}}function xr(t){var e="FIRESTORE ("+kr+") INTERNAL ASSERTION FAILED: "+t;throw Lr(e),new Error(e)}function qr(t,e){t||xr(e)}(Er=Sr=Sr||{})[Er.DEBUG=0]="DEBUG",Er[Er.ERROR=1]="ERROR",Er[Er.SILENT=2]="SILENT";var Fr=(Vr.setPlatform=function(t){Vr.platform&&xr("Platform already defined"),Vr.platform=t},Vr.getPlatform=function(){return Vr.platform||xr("Platform not set"),Vr.platform},Vr);function Vr(){}function Br(){return Fr.getPlatform().emptyByteString}var Ur,Qr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},Kr=(s(jr,Ur=Error),jr);function jr(t,e){var n=Ur.call(this,e)||this;return n.code=t,n.message=e,n.name="FirebaseError",n.toString=function(){return n.name+": [code="+n.code+"]: "+n.message},n}function Wr(t,e){function n(){var t="This constructor is private.";throw e&&(t+=" ",t+=e),new Kr(Qr.INVALID_ARGUMENT,t)}for(var r in n.prototype=t.prototype,t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n}function Gr(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function zr(t,e){return void 0!==t?t:e}function Hr(t,e){for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var r=Number(n);isNaN(r)||e(r,t[n])}}function Yr(t,e){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function Xr(t){for(var e in qr(null!=t&&"object"==typeof t,"isEmpty() expects object parameter."),t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function Jr(t,e){if(0!==e.length)throw new Kr(Qr.INVALID_ARGUMENT,"Function "+t+"() does not support arguments, but was called with "+di(e.length,"argument")+".")}function $r(t,e,n){if(e.length!==n)throw new Kr(Qr.INVALID_ARGUMENT,"Function "+t+"() requires "+di(n,"argument")+", but was called with "+di(e.length,"argument")+".")}function Zr(t,e,n){if(e.length<n)throw new Kr(Qr.INVALID_ARGUMENT,"Function "+t+"() requires at least "+di(n,"argument")+", but was called with "+di(e.length,"argument")+".")}function ti(t,e,n,r){if(e.length<n||e.length>r)throw new Kr(Qr.INVALID_ARGUMENT,"Function "+t+"() requires between "+n+" and "+r+" arguments, but was called with "+di(e.length,"argument")+".")}function ei(t,e,n,r){si(t,e,pi(n)+" argument",r)}function ni(t,e,n,r){void 0!==r&&ei(t,e,n,r)}function ri(t,e,n,r){si(t,e,n+" option",r)}function ii(t,e,n,r){void 0!==r&&ri(t,e,n,r)}function oi(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){if(!(r instanceof Array))throw new Kr(Qr.INVALID_ARGUMENT,"Function "+t+"() requires its "+e+" option to be an array, but it was: "+ci(r));for(var o=0;o<r.length;++o)if(!i(r[o]))throw new Kr(Qr.INVALID_ARGUMENT,"Function "+t+"() requires all "+e+" elements to be "+n+", but the value at index "+o+" was: "+ci(r[o]))}(t,e,n,r,i)}function ai(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){for(var o=[],a=0,s=i;a<s.length;a++){var u=s[a];if(u===r)return;o.push(ci(u))}var c=ci(r);throw new Kr(Qr.INVALID_ARGUMENT,"Invalid value "+c+" provided to function "+t+'() for option "'+n+'". Acceptable values: '+o.join(", "))}(t,0,n,r,i)}function si(t,e,n,r){if(!("object"===e?ui(r):"non-empty string"===e?"string"==typeof r&&""!==r:typeof r===e)){var i=ci(r);throw new Kr(Qr.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" to be of type "+e+", but it was: "+i)}}function ui(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}function ci(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return 20<t.length&&(t=t.substring(0,20)+"..."),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"!=typeof t)return"function"==typeof t?"a function":xr("Unknown wrong type: "+typeof t);if(t instanceof Array)return"an array";var e=function(t){if(t.constructor){var e=/function\s+([^\s(]+)\s*\(/.exec(t.constructor.toString());if(e&&1<e.length)return e[1]}return null}(t);return e?"a custom "+e+" object":"an object"}function hi(t,e,n){if(void 0===n)throw new Kr(Qr.INVALID_ARGUMENT,"Function "+t+"() requires a valid "+pi(e)+" argument, but it was undefined.")}function li(n,t,r){Yr(t,function(t,e){if(r.indexOf(t)<0)throw new Kr(Qr.INVALID_ARGUMENT,"Unknown option '"+t+"' passed to function "+n+"(). Available options: "+r.join(", "))})}function fi(t,e,n,r){var i=ci(r);return new Kr(Qr.INVALID_ARGUMENT,"Function "+t+"() requires its "+pi(n)+" argument to be a "+e+", but it was: "+i)}function pi(t){switch(t){case 1:return"first";case 2:return"second";case 3:return"third";default:return t+"th"}}function di(t,e){return t+" "+e+(1===t?"":"s")}var mi=(yi.newId=function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="",n=0;n<20;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return qr(20===e.length,"Invalid auto ID: "+e),e},yi);function yi(){}function gi(t,e){return t<e?-1:e<t?1:0}function vi(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].isEqual(e[n]))return!1;return!0}function bi(t){return t+"\0"}function wi(){if("undefined"==typeof Uint8Array)throw new Kr(Qr.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function Si(){if(!Fr.getPlatform().base64Available)throw new Kr(Qr.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}var Ei=(Ti.fromBase64String=function(t){$r("Blob.fromBase64String",arguments,1),ei("Blob.fromBase64String","string",1,t),Si();try{return new Ti(Fr.getPlatform().atob(t))}catch(t){throw new Kr(Qr.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+t)}},Ti.fromUint8Array=function(t){if($r("Blob.fromUint8Array",arguments,1),wi(),!(t instanceof Uint8Array))throw fi("Blob.fromUint8Array","Uint8Array",1,t);return new Ti(Array.prototype.map.call(t,function(t){return String.fromCharCode(t)}).join(""))},Ti.prototype.toBase64=function(){return $r("Blob.toBase64",arguments,0),Si(),Fr.getPlatform().btoa(this._binaryString)},Ti.prototype.toUint8Array=function(){$r("Blob.toUint8Array",arguments,0),wi();for(var t=new Uint8Array(this._binaryString.length),e=0;e<this._binaryString.length;e++)t[e]=this._binaryString.charCodeAt(e);return t},Ti.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},Ti.prototype.isEqual=function(t){return this._binaryString===t._binaryString},Ti.prototype._compareTo=function(t){return gi(this._binaryString,t._binaryString)},Ti);function Ti(t){Si(),this._binaryString=t}var Ii=Wr(Ei,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),Ci=function(t,e,n,r,i){this.databaseId=t,this.persistenceKey=e,this.host=n,this.ssl=r,this.forceLongPolling=i},Di="(default)",Ni=(Object.defineProperty(Ai.prototype,"isDefaultDatabase",{get:function(){return this.database===Di},enumerable:!0,configurable:!0}),Ai.prototype.isEqual=function(t){return t instanceof Ai&&t.projectId===this.projectId&&t.database===this.database},Ai.prototype.compareTo=function(t){return gi(this.projectId,t.projectId)||gi(this.database,t.database)},Ai);function Ai(t,e){this.projectId=t,this.database=e||Di}var ki=(Ri.prototype.setPreviousValue=function(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue},Ri.prototype.next=function(){var t=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(t),t},Ri.INVALID=-1,Ri);function Ri(t,e){var n=this;this.previousValue=t,e&&(e.sequenceNumberHandler=function(t){return n.setPreviousValue(t)},this.writeNewSequenceNumber=function(t){return e.writeSequenceNumber(t)})}var Mi="__name__",_i=(Object.defineProperty(Oi.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),Oi.prototype.isEqual=function(t){return 0===Oi.comparator(this,t)},Oi.prototype.child=function(t){var e=this.segments.slice(this.offset,this.limit());return t instanceof Oi?t.forEach(function(t){e.push(t)}):e.push(t),this.construct(e)},Oi.prototype.limit=function(){return this.offset+this.length},Oi.prototype.popFirst=function(t){return t=void 0===t?1:t,qr(this.length>=t,"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+t,this.length-t)},Oi.prototype.popLast=function(){return qr(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},Oi.prototype.firstSegment=function(){return qr(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},Oi.prototype.lastSegment=function(){return this.get(this.length-1)},Oi.prototype.get=function(t){return qr(t<this.length,"Index out of range"),this.segments[this.offset+t]},Oi.prototype.isEmpty=function(){return 0===this.length},Oi.prototype.isPrefixOf=function(t){if(t.length<this.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},Oi.prototype.isImmediateParentOf=function(t){if(this.length+1!==t.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},Oi.prototype.forEach=function(t){for(var e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])},Oi.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},Oi.comparator=function(t,e){for(var n=Math.min(t.length,e.length),r=0;r<n;r++){var i=t.get(r),o=e.get(r);if(i<o)return-1;if(o<i)return 1}return t.length<e.length?-1:t.length>e.length?1:0},Oi);function Oi(t,e,n){void 0===e?e=0:e>t.length&&xr("offset "+e+" out of range "+t.length),void 0===n?n=t.length-e:n>t.length-e&&xr("length "+n+" out of range "+(t.length-e)),this.segments=t,this.offset=e,this.len=n}var Li,Pi=(s(xi,Li=_i),xi.prototype.construct=function(t,e,n){return new xi(t,e,n)},xi.prototype.canonicalString=function(){return this.toArray().join("/")},xi.prototype.toString=function(){return this.canonicalString()},xi.fromString=function(t){if(0<=t.indexOf("//"))throw new Kr(Qr.INVALID_ARGUMENT,"Invalid path ("+t+"). Paths must not contain // in them.");return new xi(t.split("/").filter(function(t){return 0<t.length}))},xi.EMPTY_PATH=new xi([]),xi);function xi(){return null!==Li&&Li.apply(this,arguments)||this}var qi,Fi=/^[_a-zA-Z][_a-zA-Z0-9]*$/,Vi=(s(Bi,qi=_i),Bi.prototype.construct=function(t,e,n){return new Bi(t,e,n)},Bi.isValidIdentifier=function(t){return Fi.test(t)},Bi.prototype.canonicalString=function(){return this.toArray().map(function(t){return t=t.replace("\\","\\\\").replace("`","\\`"),Bi.isValidIdentifier(t)||(t="`"+t+"`"),t}).join(".")},Bi.prototype.toString=function(){return this.canonicalString()},Bi.prototype.isKeyField=function(){return 1===this.length&&this.get(0)===Mi},Bi.keyField=function(){return new Bi([Mi])},Bi.fromServerFormat=function(t){for(var e=[],n="",r=0,i=function(){if(0===n.length)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");e.push(n),n=""},o=!1;r<t.length;){var a=t[r];if("\\"===a){if(r+1===t.length)throw new Kr(Qr.INVALID_ARGUMENT,"Path has trailing escape character: "+t);var s=t[r+1];if("\\"!==s&&"."!==s&&"`"!==s)throw new Kr(Qr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=s,r+=2}else"`"===a?o=!o:"."!==a||o?n+=a:i(),r++}if(i(),o)throw new Kr(Qr.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new Bi(e)},Bi.EMPTY_PATH=new Bi([]),Bi);function Bi(){return null!==qi&&qi.apply(this,arguments)||this}var Ui=(Qi.prototype.hasCollectionId=function(t){return 2<=this.path.length&&this.path.get(this.path.length-2)===t},Qi.prototype.isEqual=function(t){return null!==t&&0===Pi.comparator(this.path,t.path)},Qi.prototype.toString=function(){return this.path.toString()},Qi.comparator=function(t,e){return Pi.comparator(t.path,e.path)},Qi.isDocumentKey=function(t){return t.length%2==0},Qi.fromSegments=function(t){return new Qi(new Pi(t.slice()))},Qi.fromPathString=function(t){return new Qi(Pi.fromString(t))},Qi.EMPTY=new Qi(new Pi([])),Qi);function Qi(t){this.path=t,qr(Qi.isDocumentKey(t),"Invalid DocumentKey with an odd number of segments: "+t.toArray().join("/"))}var Ki,ji,Wi=function(){var n=this;this.promise=new Promise(function(t,e){n.resolve=t,n.reject=e})};(ji=Ki=Ki||{}).All="all",ji.ListenStreamIdle="listen_stream_idle",ji.ListenStreamConnectionBackoff="listen_stream_connection_backoff",ji.WriteStreamIdle="write_stream_idle",ji.WriteStreamConnectionBackoff="write_stream_connection_backoff",ji.OnlineStateTimeout="online_state_timeout",ji.ClientMetadataRefresh="client_metadata_refresh",ji.LruGarbageCollection="lru_garbage_collection",ji.RetryTransaction="retry_transaction";var Gi=(zi.createAndSchedule=function(t,e,n,r,i){var o=new zi(t,e,Date.now()+n,r,i);return o.start(n),o},zi.prototype.start=function(t){var e=this;this.timerHandle=setTimeout(function(){return e.handleDelayElapsed()},t)},zi.prototype.skipDelay=function(){return this.handleDelayElapsed()},zi.prototype.cancel=function(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Kr(Qr.CANCELLED,"Operation cancelled"+(t?": "+t:""))))},zi.prototype.handleDelayElapsed=function(){var e=this;this.asyncQueue.enqueueAndForget(function(){return null!==e.timerHandle?(e.clearTimeout(),e.op().then(function(t){return e.deferred.resolve(t)})):Promise.resolve()})},zi.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},zi);function zi(t,e,n,r,i){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Wi,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch(function(t){})}var Hi=(Object.defineProperty(Yi.prototype,"isShuttingDown",{get:function(){return this._isShuttingDown},enumerable:!0,configurable:!0}),Yi.prototype.enqueueAndForget=function(t){this.enqueue(t)},Yi.prototype.enqueueAndForgetEvenAfterShutdown=function(t){this.verifyNotFailed(),this.enqueueInternal(t)},Yi.prototype.enqueueEvenAfterShutdown=function(t){return this.verifyNotFailed(),this.enqueueInternal(t)},Yi.prototype.enqueueAndInitiateShutdown=function(e){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.verifyNotFailed(),this._isShuttingDown?[3,2]:(this._isShuttingDown=!0,[4,this.enqueueEvenAfterShutdown(e)]);case 1:t.sent(),t.label=2;case 2:return[2]}})})},Yi.prototype.enqueue=function(t){return this.verifyNotFailed(),this._isShuttingDown?new Promise(function(t){}):this.enqueueInternal(t)},Yi.prototype.enqueueInternal=function(t){var n=this,e=this.tail.then(function(){return n.operationInProgress=!0,t().catch(function(t){n.failure=t,n.operationInProgress=!1;var e=t.stack||t.message||"";throw Lr("INTERNAL UNHANDLED ERROR: ",e),e.indexOf("Firestore Test Simulated Error")<0&&setTimeout(function(){throw t},0),t}).then(function(t){return n.operationInProgress=!1,t})});return this.tail=e},Yi.prototype.enqueueAfterDelay=function(t,e,n){var r=this;this.verifyNotFailed(),qr(0<=e,"Attempted to schedule an operation with a negative delay of "+e),-1<this.timerIdsToSkip.indexOf(t)&&(e=0);var i=Gi.createAndSchedule(this,t,e,n,function(t){return r.removeDelayedOperation(t)});return this.delayedOperations.push(i),i},Yi.prototype.verifyNotFailed=function(){this.failure&&xr("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},Yi.prototype.verifyOperationInProgress=function(){qr(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},Yi.prototype.drain=function(){return this.enqueueEvenAfterShutdown(function(){return Promise.resolve()})},Yi.prototype.containsDelayedOperation=function(t){for(var e=0,n=this.delayedOperations;e<n.length;e++)if(n[e].timerId===t)return!0;return!1},Yi.prototype.runDelayedOperationsEarly=function(r){var i=this;return this.drain().then(function(){qr(r===Ki.All||i.containsDelayedOperation(r),"Attempted to drain to missing operation "+r),i.delayedOperations.sort(function(t,e){return t.targetTimeMs-e.targetTimeMs});for(var t=0,e=i.delayedOperations;t<e.length;t++){var n=e[t];if(n.skipDelay(),r!==Ki.All&&n.timerId===r)break}return i.drain()})},Yi.prototype.skipDelaysForTimerId=function(t){this.timerIdsToSkip.push(t)},Yi.prototype.removeDelayedOperation=function(t){var e=this.delayedOperations.indexOf(t);qr(0<=e,"Delayed operation not found."),this.delayedOperations.splice(e,1)},Yi);function Yi(){this.tail=Promise.resolve(),this._isShuttingDown=!1,this.delayedOperations=[],this.failure=null,this.operationInProgress=!1,this.timerIdsToSkip=[]}var Xi="",Ji="",$i="",Zi="";function to(t){for(var e="",n=0;n<t.length;n++)0<e.length&&(e=no(e)),e=eo(t.get(n),e);return no(e)}function eo(t,e){for(var n=e,r=t.length,i=0;i<r;i++){var o=t.charAt(i);switch(o){case"\0":n+=Xi+$i;break;case Xi:n+=Xi+Zi;break;default:n+=o}}return n}function no(t){return t+Xi+Ji}function ro(t){var e=t.length;if(qr(2<=e,"Invalid path "+t),2===e)return qr(t.charAt(0)===Xi&&t.charAt(1)===Ji,"Non-empty path "+t+" had length 2"),Pi.EMPTY_PATH;for(var n=e-2,r=[],i="",o=0;o<e;){var a=t.indexOf(Xi,o);switch((a<0||n<a)&&xr('Invalid encoded resource path: "'+t+'"'),t.charAt(a+1)){case Ji:var s=t.substring(o,a),u=void 0;0===i.length?u=s:(u=i+=s,i=""),r.push(u);break;case $i:i+=t.substring(o,a),i+="\0";break;case Zi:i+=t.substring(o,a+1);break;default:xr('Invalid encoded resource path: "'+t+'"')}o=a+2}return new Pi(r)}var io=(oo.now=function(){return oo.fromMillis(Date.now())},oo.fromDate=function(t){return oo.fromMillis(t.getTime())},oo.fromMillis=function(t){var e=Math.floor(t/1e3);return new oo(e,1e6*(t-1e3*e))},oo.prototype.toDate=function(){return new Date(this.toMillis())},oo.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},oo.prototype._compareTo=function(t){return this.seconds===t.seconds?gi(this.nanoseconds,t.nanoseconds):gi(this.seconds,t.seconds)},oo.prototype.isEqual=function(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds},oo.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},oo);function oo(t,e){if(this.seconds=t,(this.nanoseconds=e)<0)throw new Kr(Qr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(1e9<=e)throw new Kr(Qr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Kr(Qr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(253402300800<=t)throw new Kr(Qr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}var ao=(so.fromMicroseconds=function(t){var e=Math.floor(t/1e6);return new so(new io(e,t%1e6*1e3))},so.fromTimestamp=function(t){return new so(t)},so.forDeletedDoc=function(){return so.MIN},so.prototype.compareTo=function(t){return this.timestamp._compareTo(t.timestamp)},so.prototype.isEqual=function(t){return this.timestamp.isEqual(t.timestamp)},so.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},so.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},so.prototype.toTimestamp=function(){return this.timestamp},so.MIN=new so(new io(0,0)),so);function so(t){this.timestamp=t}var uo=(co.prototype.insert=function(t,e){return new co(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,fo.BLACK,null,null))},co.prototype.remove=function(t){return new co(this.comparator,this.root.remove(t,this.comparator).copy(null,null,fo.BLACK,null,null))},co.prototype.get=function(t){for(var e=this.root;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:0<n&&(e=e.right)}return null},co.prototype.indexOf=function(t){for(var e=0,n=this.root;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;n=r<0?n.left:(e+=n.left.size+1,n.right)}return-1},co.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(co.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),co.prototype.minKey=function(){return this.root.minKey()},co.prototype.maxKey=function(){return this.root.maxKey()},co.prototype.inorderTraversal=function(t){return this.root.inorderTraversal(t)},co.prototype.forEach=function(n){this.inorderTraversal(function(t,e){return n(t,e),!1})},co.prototype.toString=function(){var n=[];return this.inorderTraversal(function(t,e){return n.push(t+":"+e),!1}),"{"+n.join(", ")+"}"},co.prototype.reverseTraversal=function(t){return this.root.reverseTraversal(t)},co.prototype.getIterator=function(){return new ho(this.root,null,this.comparator,!1)},co.prototype.getIteratorFrom=function(t){return new ho(this.root,t,this.comparator,!1)},co.prototype.getReverseIterator=function(){return new ho(this.root,null,this.comparator,!0)},co.prototype.getReverseIteratorFrom=function(t){return new ho(this.root,t,this.comparator,!0)},co);function co(t,e){this.comparator=t,this.root=e||fo.EMPTY}var ho=(lo.prototype.getNext=function(){qr(0<this.nodeStack.length,"getNext() called on iterator when hasNext() is false.");var t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e},lo.prototype.hasNext=function(){return 0<this.nodeStack.length},lo.prototype.peek=function(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}},lo);function lo(t,e,n,r){this.isReverse=r,this.nodeStack=[];for(var i=1;!t.isEmpty();)if(i=e?n(t.key,e):1,r&&(i*=-1),i<0)t=this.isReverse?t.left:t.right;else{if(0===i){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}var fo=(po.prototype.copy=function(t,e,n,r,i){return new po(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)},po.prototype.isEmpty=function(){return!1},po.prototype.inorderTraversal=function(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)},po.prototype.reverseTraversal=function(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)},po.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},po.prototype.minKey=function(){return this.min().key},po.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},po.prototype.insert=function(t,e,n){var r=this,i=n(t,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n))).fixUp()},po.prototype.removeMin=function(){if(this.left.isEmpty())return po.EMPTY;var t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),(t=t.copy(null,null,null,t.left.removeMin(),null)).fixUp()},po.prototype.remove=function(t,e){var n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return po.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()},po.prototype.isRed=function(){return this.color},po.prototype.fixUp=function(){var t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t},po.prototype.moveRedLeft=function(){var t=this.colorFlip();return t.right.left.isRed()&&(t=(t=(t=t.copy(null,null,null,null,t.right.rotateRight())).rotateLeft()).colorFlip()),t},po.prototype.moveRedRight=function(){var t=this.colorFlip();return t.left.left.isRed()&&(t=(t=t.rotateRight()).colorFlip()),t},po.prototype.rotateLeft=function(){var t=this.copy(null,null,po.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)},po.prototype.rotateRight=function(){var t=this.copy(null,null,po.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)},po.prototype.colorFlip=function(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)},po.prototype.checkMaxDepth=function(){var t=this.check();return Math.pow(2,t)<=this.size+1},po.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw xr("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw xr("Right child of ("+this.key+","+this.value+") is red");var t=this.left.check();if(t!==this.right.check())throw xr("Black depths differ");return t+(this.isRed()?0:1)},po.EMPTY=null,po.RED=!0,po.BLACK=!1,po);function po(t,e,n,r,i){this.key=t,this.value=e,this.color=null!=n?n:po.RED,this.left=null!=r?r:po.EMPTY,this.right=null!=i?i:po.EMPTY,this.size=this.left.size+1+this.right.size}var mo=(Object.defineProperty(yo.prototype,"key",{get:function(){throw xr("LLRBEmptyNode has no key.")},enumerable:!0,configurable:!0}),Object.defineProperty(yo.prototype,"value",{get:function(){throw xr("LLRBEmptyNode has no value.")},enumerable:!0,configurable:!0}),Object.defineProperty(yo.prototype,"color",{get:function(){throw xr("LLRBEmptyNode has no color.")},enumerable:!0,configurable:!0}),Object.defineProperty(yo.prototype,"left",{get:function(){throw xr("LLRBEmptyNode has no left child.")},enumerable:!0,configurable:!0}),Object.defineProperty(yo.prototype,"right",{get:function(){throw xr("LLRBEmptyNode has no right child.")},enumerable:!0,configurable:!0}),yo.prototype.copy=function(t,e,n,r,i){return this},yo.prototype.insert=function(t,e,n){return new fo(t,e)},yo.prototype.remove=function(t,e){return this},yo.prototype.isEmpty=function(){return!0},yo.prototype.inorderTraversal=function(t){return!1},yo.prototype.reverseTraversal=function(t){return!1},yo.prototype.minKey=function(){return null},yo.prototype.maxKey=function(){return null},yo.prototype.isRed=function(){return!1},yo.prototype.checkMaxDepth=function(){return!0},yo.prototype.check=function(){return 0},yo);function yo(){this.size=0}fo.EMPTY=new mo;var go=(vo.fromMapKeys=function(t){var e=new vo(t.comparator);return t.forEach(function(t){e=e.add(t)}),e},vo.prototype.has=function(t){return null!==this.data.get(t)},vo.prototype.first=function(){return this.data.minKey()},vo.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(vo.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),vo.prototype.indexOf=function(t){return this.data.indexOf(t)},vo.prototype.forEach=function(n){this.data.inorderTraversal(function(t,e){return n(t),!1})},vo.prototype.forEachInRange=function(t,e){for(var n=this.data.getIteratorFrom(t[0]);n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,t[1]))return;e(r.key)}},vo.prototype.forEachWhile=function(t,e){var n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return},vo.prototype.firstAfterOrEqual=function(t){var e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null},vo.prototype.getIterator=function(){return new bo(this.data.getIterator())},vo.prototype.getIteratorFrom=function(t){return new bo(this.data.getIteratorFrom(t))},vo.prototype.add=function(t){return this.copy(this.data.remove(t).insert(t,!0))},vo.prototype.delete=function(t){return this.has(t)?this.copy(this.data.remove(t)):this},vo.prototype.isEmpty=function(){return this.data.isEmpty()},vo.prototype.unionWith=function(t){var e=this;return t.forEach(function(t){e=e.add(t)}),e},vo.prototype.isEqual=function(t){if(!(t instanceof vo))return!1;if(this.size!==t.size)return!1;for(var e=this.data.getIterator(),n=t.data.getIterator();e.hasNext();){var r=e.getNext().key,i=n.getNext().key;if(0!==this.comparator(r,i))return!1}return!0},vo.prototype.toArray=function(){var e=[];return this.forEach(function(t){e.push(t)}),e},vo.prototype.toString=function(){var e=[];return this.forEach(function(t){return e.push(t)}),"SortedSet("+e.toString()+")"},vo.prototype.copy=function(t){var e=new vo(this.comparator);return e.data=t,e},vo);function vo(t){this.comparator=t,this.data=new uo(this.comparator)}var bo=(wo.prototype.getNext=function(){return this.iter.getNext().key},wo.prototype.hasNext=function(){return this.iter.hasNext()},wo);function wo(t){this.iter=t}var So=new uo(Ui.comparator);function Eo(){return So}function To(){return Eo()}var Io=new uo(Ui.comparator);function Co(){return Io}var Do=new uo(Ui.comparator);function No(){return Do}var Ao=new go(Ui.comparator);function ko(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=Ao,r=0,i=t;r<i.length;r++){var o=i[r];n=n.add(o)}return n}var Ro=new go(gi);function Mo(){return Ro}var _o=(Oo.prototype.applyToRemoteDocument=function(t,e,n){e&&qr(e.key.isEqual(t),"applyToRemoteDocument: key "+t+" should match maybeDoc key\n        "+e.key);var r=n.mutationResults;qr(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var i=0;i<this.mutations.length;i++){var o=this.mutations[i];if(o.key.isEqual(t)){var a=r[i];e=o.applyToRemoteDocument(e,a)}}return e},Oo.prototype.applyToLocalView=function(t,e){e&&qr(e.key.isEqual(t),"applyToLocalDocument: key "+t+" should match maybeDoc key\n        "+e.key);for(var n=0,r=this.baseMutations;n<r.length;n++)(s=r[n]).key.isEqual(t)&&(e=s.applyToLocalView(e,e,this.localWriteTime));for(var i=e,o=0,a=this.mutations;o<a.length;o++){var s;(s=a[o]).key.isEqual(t)&&(e=s.applyToLocalView(e,i,this.localWriteTime))}return e},Oo.prototype.applyToLocalDocumentSet=function(n){var r=this,i=n;return this.mutations.forEach(function(t){var e=r.applyToLocalView(t.key,n.get(t.key));e&&(i=i.insert(t.key,e))}),i},Oo.prototype.keys=function(){return this.mutations.reduce(function(t,e){return t.add(e.key)},ko())},Oo.prototype.isEqual=function(t){return this.batchId===t.batchId&&vi(this.mutations,t.mutations)&&vi(this.baseMutations,t.baseMutations)},Oo);function Oo(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,qr(0<(this.mutations=r).length,"Cannot create an empty mutation batch")}var Lo=(Po.from=function(t,e,n,r){qr(t.mutations.length===n.length,"Mutations sent "+t.mutations.length+" must equal results received "+n.length);for(var i=No(),o=t.mutations,a=0;a<o.length;a++)i=i.insert(o[a].key,n[a].version);return new Po(t,e,n,r,i)},Po);function Po(t,e,n,r,i){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.streamToken=r,this.docVersions=i}var xo=(qo.prototype.catch=function(t){return this.next(void 0,t)},qo.prototype.next=function(r,i){var o=this;return this.callbackAttached&&xr("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(i,this.error):this.wrapSuccess(r,this.result):new qo(function(e,n){o.nextCallback=function(t){o.wrapSuccess(r,t).next(e,n)},o.catchCallback=function(t){o.wrapFailure(i,t).next(e,n)}})},qo.prototype.toPromise=function(){var n=this;return new Promise(function(t,e){n.next(t,e)})},qo.prototype.wrapUserFunction=function(t){try{var e=t();return e instanceof qo?e:qo.resolve(e)}catch(t){return qo.reject(t)}},qo.prototype.wrapSuccess=function(t,e){return t?this.wrapUserFunction(function(){return t(e)}):qo.resolve(e)},qo.prototype.wrapFailure=function(t,e){return t?this.wrapUserFunction(function(){return t(e)}):qo.reject(e)},qo.resolve=function(n){return new qo(function(t,e){t(n)})},qo.reject=function(n){return new qo(function(t,e){e(n)})},qo.waitFor=function(t){return new qo(function(e,n){var r=0,i=0,o=!1;t.forEach(function(t){++r,t.next(function(){++i,o&&i===r&&e()},function(t){return n(t)})}),o=!0,i===r&&e()})},qo.or=function(t){for(var n=qo.resolve(!1),e=function(e){n=n.next(function(t){return t?qo.resolve(t):e()})},r=0,i=t;r<i.length;r++)e(i[r]);return n},qo.forEach=function(t,n){var r=this,i=[];return t.forEach(function(t,e){i.push(n.call(r,t,e))}),this.waitFor(i)},qo);function qo(t){var e=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(function(t){e.isDone=!0,e.result=t,e.nextCallback&&e.nextCallback(t)},function(t){e.isDone=!0,e.error=t,e.catchCallback&&e.catchCallback(t)})}var Fo=(Vo.forUser=function(t,e,n,r){return qr(""!==t.uid,"UserID must not be an empty string."),new Vo(t.isAuthenticated()?t.uid:"",e,n,r)},Vo.prototype.checkEmpty=function(t){var r=!0,e=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Ko(t).iterate({index:du.userMutationsIndex,range:e},function(t,e,n){r=!1,n.done()}).next(function(){return r})},Vo.prototype.acknowledgeBatch=function(e,t,n){return this.getMutationQueueMetadata(e).next(function(t){return t.lastStreamToken=Qo(n),Wo(e).put(t)})},Vo.prototype.getLastStreamToken=function(t){return this.getMutationQueueMetadata(t).next(function(t){return t.lastStreamToken})},Vo.prototype.setLastStreamToken=function(e,n){return this.getMutationQueueMetadata(e).next(function(t){return t.lastStreamToken=Qo(n),Wo(e).put(t)})},Vo.prototype.addMutationBatch=function(u,c,h,l){var f=this,p=jo(u),d=Ko(u);return d.add({}).next(function(t){qr("number"==typeof t,"Auto-generated key is not a number");var e=new _o(t,c,h,l),n=f.serializer.toDbMutationBatch(f.userId,e);f.documentKeysByBatchId[t]=e.keys();for(var r=[],i=0,o=l;i<o.length;i++){var a=o[i],s=yu.key(f.userId,a.key.path,t);r.push(d.put(n)),r.push(p.put(s,yu.PLACEHOLDER)),r.push(f.indexManager.addToCollectionParentIndex(u,a.key.path.popLast()))}return xo.waitFor(r).next(function(){return e})})},Vo.prototype.lookupMutationBatch=function(t,e){var n=this;return Ko(t).get(e).next(function(t){return t?(qr(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),n.serializer.fromDbMutationBatch(t)):null})},Vo.prototype.lookupMutationKeys=function(t,n){var r=this;return this.documentKeysByBatchId[n]?xo.resolve(this.documentKeysByBatchId[n]):this.lookupMutationBatch(t,n).next(function(t){if(t){var e=t.keys();return r.documentKeysByBatchId[n]=e}return null})},Vo.prototype.getNextMutationBatchAfterBatchId=function(t,e){var r=this,i=e+1,n=IDBKeyRange.lowerBound([this.userId,i]),o=null;return Ko(t).iterate({index:du.userMutationsIndex,range:n},function(t,e,n){e.userId===r.userId&&(qr(e.batchId>=i,"Should have found mutation after "+i),o=r.serializer.fromDbMutationBatch(e)),n.done()}).next(function(){return o})},Vo.prototype.getHighestUnacknowledgedBatchId=function(t){var e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=-1;return Ko(t).iterate({index:du.userMutationsIndex,range:e,reverse:!0},function(t,e,n){r=e.batchId,n.done()}).next(function(){return r})},Vo.prototype.getAllMutationBatches=function(t){var e=this,n=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Ko(t).loadAll(du.userMutationsIndex,n).next(function(t){return t.map(function(t){return e.serializer.fromDbMutationBatch(t)})})},Vo.prototype.getAllMutationBatchesAffectingDocumentKey=function(s,u){var c=this,t=yu.prefixForPath(this.userId,u.path),e=IDBKeyRange.lowerBound(t),h=[];return jo(s).iterate({range:e},function(e,t,n){var r=e[0],i=e[1],o=e[2],a=ro(i);if(r===c.userId&&u.path.isEqual(a))return Ko(s).get(o).next(function(t){if(!t)throw xr("Dangling document-mutation reference found: "+e+" which points to "+o);qr(t.userId===c.userId,"Unexpected user '"+t.userId+"' for mutation batch "+o),h.push(c.serializer.fromDbMutationBatch(t))});n.done()}).next(function(){return h})},Vo.prototype.getAllMutationBatchesAffectingDocumentKeys=function(r,t){var u=this,c=new go(gi),i=[];return t.forEach(function(s){var t=yu.prefixForPath(u.userId,s.path),e=IDBKeyRange.lowerBound(t),n=jo(r).iterate({range:e},function(t,e,n){var r=t[0],i=t[1],o=t[2],a=ro(i);r===u.userId&&s.path.isEqual(a)?c=c.add(o):n.done()});i.push(n)}),xo.waitFor(i).next(function(){return u.lookupMutationBatches(r,c)})},Vo.prototype.getAllMutationBatchesAffectingQuery=function(t,e){var s=this;qr(!e.isDocumentQuery(),"Document queries shouldn't go down this path"),qr(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var u=e.path,c=u.length+1,n=yu.prefixForPath(this.userId,u),r=IDBKeyRange.lowerBound(n),h=new go(gi);return jo(t).iterate({range:r},function(t,e,n){var r=t[0],i=t[1],o=t[2],a=ro(i);r===s.userId&&u.isPrefixOf(a)?a.length===c&&(h=h.add(o)):n.done()}).next(function(){return s.lookupMutationBatches(t,h)})},Vo.prototype.lookupMutationBatches=function(t,e){var n=this,r=[],i=[];return e.forEach(function(e){i.push(Ko(t).get(e).next(function(t){if(null===t)throw xr("Dangling document-mutation reference found, which points to "+e);qr(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),r.push(n.serializer.fromDbMutationBatch(t))}))}),xo.waitFor(i).next(function(){return r})},Vo.prototype.removeMutationBatch=function(e,n){var r=this;return Uo(e.simpleDbTransaction,this.userId,n).next(function(t){return r.removeCachedMutationKeys(n.batchId),xo.forEach(t,function(t){return r.referenceDelegate.removeMutationReference(e,t)})})},Vo.prototype.removeCachedMutationKeys=function(t){delete this.documentKeysByBatchId[t]},Vo.prototype.performConsistencyCheck=function(n){var o=this;return this.checkEmpty(n).next(function(t){if(!t)return xo.resolve();var e=IDBKeyRange.lowerBound(yu.prefixForUser(o.userId)),i=[];return jo(n).iterate({range:e},function(t,e,n){if(t[0]===o.userId){var r=ro(t[1]);i.push(r)}else n.done()}).next(function(){qr(0===i.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+i.map(function(t){return t.canonicalString()}))})})},Vo.prototype.containsKey=function(t,e){return Bo(t,this.userId,e)},Vo.prototype.getMutationQueueMetadata=function(t){var e=this;return Wo(t).get(this.userId).next(function(t){return t||new fu(e.userId,-1,"")})},Vo);function Vo(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.documentKeysByBatchId={}}function Bo(t,o,e){var n=yu.prefixForPath(o,e.path),a=n[1],r=IDBKeyRange.lowerBound(n),s=!1;return jo(t).iterate({range:r,keysOnly:!0},function(t,e,n){var r=t[0],i=t[1];t[2];r===o&&i===a&&(s=!0),n.done()}).next(function(){return s})}function Uo(t,e,n){var r=t.store(du.store),i=t.store(yu.store),o=[],a=IDBKeyRange.only(n.batchId),s=0,u=r.iterate({range:a},function(t,e,n){return s++,n.delete()});o.push(u.next(function(){qr(1===s,"Dangling document-mutation reference found: Missing batch "+n.batchId)}));for(var c=[],h=0,l=n.mutations;h<l.length;h++){var f=l[h],p=yu.key(e,f.key.path,n.batchId);o.push(i.delete(p)),c.push(f.key)}return xo.waitFor(o).next(function(){return c})}function Qo(t){return t instanceof Uint8Array?(qr("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence."),t.toString()):t}function Ko(t){return cc.getStore(t,du.store)}function jo(t){return cc.getStore(t,yu.store)}function Wo(t){return cc.getStore(t,fu.store)}var Go,zo;(zo=Go=Go||{})[zo.QueryCache=0]="QueryCache",zo[zo.SyncEngine=1]="SyncEngine";var Ho=(Yo.prototype.next=function(){var t=this.nextId;return this.nextId+=2,t},Yo.prototype.after=function(t){return this.seek(t+2),this.next()},Yo.prototype.seek=function(t){qr((1&t)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=t},Yo.forQueryCache=function(){return new Yo(Go.QueryCache,2)},Yo.forSyncEngine=function(){return new Yo(Go.SyncEngine)},Yo);function Yo(t,e){qr((1&(this.generatorId=t))===t,"Generator ID "+t+" contains more than 1 reserved bits"),this.seek(void 0!==e?e:this.generatorId)}var Xo="SimpleDb",Jo=($o.openOrCreate=function(o,t,a){return qr($o.isAvailable(),"IndexedDB not supported in current environment."),Or(Xo,"Opening database:",o),new xo(function(n,r){var i=window.indexedDB.open(o,t);i.onsuccess=function(t){var e=t.target.result;n(new $o(e))},i.onblocked=function(){r(new Kr(Qr.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=function(t){var e=t.target.error;"VersionError"===e.name?r(new Kr(Qr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):r(e)},i.onupgradeneeded=function(t){Or(Xo,'Database "'+o+'" requires upgrade from version:',t.oldVersion);var e=t.target.result,n=new ea(i.transaction);a.createOrUpgrade(e,n,t.oldVersion,au).next(function(){Or(Xo,"Database upgrade to version "+au+" complete")})}}).toPromise()},$o.delete=function(t){return Or(Xo,"Removing database:",t),oa(window.indexedDB.deleteDatabase(t)).toPromise()},$o.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===process.env.USE_MOCK_PERSISTENCE;var t=u(),e=$o.getIOSVersion(t),n=0<e&&e<10,r=$o.getAndroidVersion(t),i=0<r&&r<4.5;return!(0<t.indexOf("MSIE ")||0<t.indexOf("Trident/")||0<t.indexOf("Edge/")||n||i)},$o.getStore=function(t,e){return t.store(e)},$o.getIOSVersion=function(t){var e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)},$o.getAndroidVersion=function(t){var e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)},$o.prototype.setVersionChangeListener=function(e){this.db.onversionchange=function(t){return e(t)}},$o.prototype.runTransaction=function(t,e,n){var r=ea.open(this.db,t,e),i=n(r).catch(function(t){return r.abort(t),xo.reject(t)}).toPromise();return i.catch(function(){}),r.completionPromise.then(function(){return i})},$o.prototype.close=function(){this.db.close()},$o);function $o(t){this.db=t,12.2===$o.getIOSVersion(u())&&Lr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}var Zo=(Object.defineProperty(ta.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(ta.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(ta.prototype,"cursor",{set:function(t){this.dbCursor=t},enumerable:!0,configurable:!0}),ta.prototype.done=function(){this.shouldStop=!0},ta.prototype.skip=function(t){this.nextKey=t},ta.prototype.delete=function(){return oa(this.dbCursor.delete())},ta);function ta(t){this.dbCursor=t,this.shouldStop=!1,this.nextKey=null}var ea=(na.open=function(t,e,n){return new na(t.transaction(n,e))},Object.defineProperty(na.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),na.prototype.abort=function(t){t&&this.completionDeferred.reject(t),this.aborted||(Or(Xo,"Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},na.prototype.store=function(t){var e=this.transaction.objectStore(t);return qr(!!e,"Object store not part of transaction: "+t),new ra(e)},na);function na(t){var n=this;this.transaction=t,this.aborted=!1,this.completionDeferred=new Wi,this.transaction.oncomplete=function(){n.completionDeferred.resolve()},this.transaction.onabort=function(){t.error?n.completionDeferred.reject(t.error):n.completionDeferred.resolve()},this.transaction.onerror=function(t){var e=sa(t.target.error);n.completionDeferred.reject(e)}}var ra=(ia.prototype.put=function(t,e){return oa(void 0!==e?(Or(Xo,"PUT",this.store.name,t,e),this.store.put(e,t)):(Or(Xo,"PUT",this.store.name,"<auto-key>",t),this.store.put(t)))},ia.prototype.add=function(t){return Or(Xo,"ADD",this.store.name,t,t),oa(this.store.add(t))},ia.prototype.get=function(e){var n=this;return oa(this.store.get(e)).next(function(t){return void 0===t&&(t=null),Or(Xo,"GET",n.store.name,e,t),t})},ia.prototype.delete=function(t){return Or(Xo,"DELETE",this.store.name,t),oa(this.store.delete(t))},ia.prototype.count=function(){return Or(Xo,"COUNT",this.store.name),oa(this.store.count())},ia.prototype.loadAll=function(t,e){var n=this.cursor(this.options(t,e)),r=[];return this.iterateCursor(n,function(t,e){r.push(e)}).next(function(){return r})},ia.prototype.deleteAll=function(t,e){Or(Xo,"DELETE ALL",this.store.name);var n=this.options(t,e);n.keysOnly=!1;var r=this.cursor(n);return this.iterateCursor(r,function(t,e,n){return n.delete()})},ia.prototype.iterate=function(t,e){var n;e?n=t:(n={},e=t);var r=this.cursor(n);return this.iterateCursor(r,e)},ia.prototype.iterateSerial=function(i){var t=this.cursor({});return new xo(function(n,r){t.onerror=function(t){var e=sa(t.target.error);r(e)},t.onsuccess=function(t){var e=t.target.result;e?i(e.primaryKey,e.value).next(function(t){t?e.continue():n()}):n()}})},ia.prototype.iterateCursor=function(t,a){var s=[];return new xo(function(o,e){t.onerror=function(t){e(t.target.error)},t.onsuccess=function(t){var e=t.target.result;if(e){var n=new Zo(e),r=a(e.primaryKey,e.value,n);if(r instanceof xo){var i=r.catch(function(t){return n.done(),xo.reject(t)});s.push(i)}n.isDone?o():null===n.skipToKey?e.continue():e.continue(n.skipToKey)}else o()}}).next(function(){return xo.waitFor(s)})},ia.prototype.options=function(t,e){var n=void 0;return void 0!==t&&("string"==typeof t?n=t:(qr(void 0===e,"3rd argument must not be defined if 2nd is a range."),e=t)),{index:n,range:e}},ia.prototype.cursor=function(t){var e="next";if(t.reverse&&(e="prev"),t.index){var n=this.store.index(t.index);return t.keysOnly?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)},ia);function ia(t){this.store=t}function oa(t){return new xo(function(n,r){t.onsuccess=function(t){var e=t.target.result;n(e)},t.onerror=function(t){var e=sa(t.target.error);r(e)}})}var aa=!1;function sa(t){var e=Jo.getIOSVersion(u());if(12.2<=e&&e<13){var n="An internal error was encountered in the Indexed Database server";if(0<=t.message.indexOf(n)){var r=new Kr("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '"+n+"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.");return aa||(aa=!0,setTimeout(function(){throw r},0)),r}}return t}var ua=(ca.prototype.allocateTargetId=function(e){var n=this;return this.retrieveMetadata(e).next(function(t){return t.highestTargetId=n.targetIdGenerator.after(t.highestTargetId),n.saveMetadata(e,t).next(function(){return t.highestTargetId})})},ca.prototype.getLastRemoteSnapshotVersion=function(t){return this.retrieveMetadata(t).next(function(t){return ao.fromTimestamp(new io(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))})},ca.prototype.getHighestSequenceNumber=function(t){return fa(t.simpleDbTransaction)},ca.prototype.setTargetsMetadata=function(e,n,r){var i=this;return this.retrieveMetadata(e).next(function(t){return t.highestListenSequenceNumber=n,r&&(t.lastRemoteSnapshotVersion=r.toTimestamp()),n>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=n),i.saveMetadata(e,t)})},ca.prototype.addQueryData=function(e,n){var r=this;return this.saveQueryData(e,n).next(function(){return r.retrieveMetadata(e).next(function(t){return t.targetCount+=1,r.updateMetadataFromQueryData(n,t),r.saveMetadata(e,t)})})},ca.prototype.updateQueryData=function(t,e){return this.saveQueryData(t,e)},ca.prototype.removeQueryData=function(e,t){var n=this;return this.removeMatchingKeysForTargetId(e,t.targetId).next(function(){return ha(e).delete(t.targetId)}).next(function(){return n.retrieveMetadata(e)}).next(function(t){return qr(0<t.targetCount,"Removing from an empty query cache"),t.targetCount-=1,n.saveMetadata(e,t)})},ca.prototype.removeTargets=function(r,i,o){var a=this,s=0,u=[];return ha(r).iterate(function(t,e){var n=a.serializer.fromDbTarget(e);n.sequenceNumber<=i&&void 0===o[n.targetId]&&(s++,u.push(a.removeQueryData(r,n)))}).next(function(){return xo.waitFor(u)}).next(function(){return s})},ca.prototype.forEachTarget=function(t,r){var i=this;return ha(t).iterate(function(t,e){var n=i.serializer.fromDbTarget(e);r(n)})},ca.prototype.retrieveMetadata=function(t){return la(t.simpleDbTransaction)},ca.prototype.saveMetadata=function(t,e){return function(t){return cc.getStore(t,Au.store)}(t).put(Au.key,e)},ca.prototype.saveQueryData=function(t,e){return ha(t).put(this.serializer.toDbTarget(e))},ca.prototype.updateMetadataFromQueryData=function(t,e){var n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n},ca.prototype.getQueryCount=function(t){return this.retrieveMetadata(t).next(function(t){return t.targetCount})},ca.prototype.getQueryData=function(t,i){var o=this,e=i.canonicalId(),n=IDBKeyRange.bound([e,Number.NEGATIVE_INFINITY],[e,Number.POSITIVE_INFINITY]),a=null;return ha(t).iterate({range:n,index:Iu.queryTargetsIndexName},function(t,e,n){var r=o.serializer.fromDbTarget(e);i.isEqual(r.query)&&(a=r,n.done())}).next(function(){return a})},ca.prototype.addMatchingKeys=function(n,t,r){var i=this,o=[],a=pa(n);return t.forEach(function(t){var e=to(t.path);o.push(a.put(new Du(r,e))),o.push(i.referenceDelegate.addReference(n,t))}),xo.waitFor(o)},ca.prototype.removeMatchingKeys=function(n,t,r){var i=this,o=pa(n);return xo.forEach(t,function(t){var e=to(t.path);return xo.waitFor([o.delete([r,e]),i.referenceDelegate.removeReference(n,t)])})},ca.prototype.removeMatchingKeysForTargetId=function(t,e){var n=pa(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)},ca.prototype.getMatchingKeysForTargetId=function(t,e){var n=IDBKeyRange.bound([e],[e+1],!1,!0),r=pa(t),o=ko();return r.iterate({range:n,keysOnly:!0},function(t,e,n){var r=ro(t[1]),i=new Ui(r);o=o.add(i)}).next(function(){return o})},ca.prototype.containsKey=function(t,e){var n=to(e.path),r=IDBKeyRange.bound([n],[bi(n)],!1,!0),i=0;return pa(t).iterate({index:Du.documentTargetsIndex,keysOnly:!0,range:r},function(t,e,n){var r=t[0];t[1],0!==r&&(i++,n.done())}).next(function(){return 0<i})},ca.prototype.getQueryDataForTarget=function(t,e){var n=this;return ha(t).get(e).next(function(t){return t?n.serializer.fromDbTarget(t):null})},ca);function ca(t,e){this.referenceDelegate=t,this.serializer=e,this.targetIdGenerator=Ho.forQueryCache()}function ha(t){return cc.getStore(t,Iu.store)}function la(t){return Jo.getStore(t,Au.store).get(Au.key).next(function(t){return qr(null!==t,"Missing metadata row."),t})}function fa(t){return la(t).next(function(t){return t.highestListenSequenceNumber})}function pa(t){return cc.getStore(t,Du.store)}var da=(ma.fromSet=function(t){return new ma(t)},ma.fromArray=function(t){var e=new go(Vi.comparator);return t.forEach(function(t){return e=e.add(t)}),new ma(e)},ma.prototype.covers=function(e){var n=!1;return this.fields.forEach(function(t){t.isPrefixOf(e)&&(n=!0)}),n},ma.prototype.isEqual=function(t){return this.fields.isEqual(t.fields)},ma);function ma(t){this.fields=t}var ya=(ga.prototype.isEqual=function(t){return this.field.isEqual(t.field)&&this.transform.isEqual(t.transform)},ga);function ga(t,e){this.field=t,this.transform=e}var va,ba,wa=function(t,e){this.version=t,this.transformResults=e};(ba=va=va||{})[ba.Set=0]="Set",ba[ba.Patch=1]="Patch",ba[ba.Transform=2]="Transform",ba[ba.Delete=3]="Delete";var Sa=(Ea.exists=function(t){return new Ea(void 0,t)},Ea.updateTime=function(t){return new Ea(t)},Object.defineProperty(Ea.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),Ea.prototype.isValidFor=function(t){return void 0!==this.updateTime?t instanceof Ls&&t.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===t instanceof Ls:(qr(this.isNone,"Precondition should be empty"),!0)},Ea.prototype.isEqual=function(t){return function(t,e){return null!=t?!(!e||!t.isEqual(e)):t===e}(this.updateTime,t.updateTime)&&this.exists===t.exists},Ea.NONE=new Ea,Ea);function Ea(t,e){this.updateTime=t,this.exists=e,qr(void 0===t||void 0===e,'Precondition can specify "exists" or "updateTime" but not both')}var Ta=(Ia.prototype.verifyKeyMatches=function(t){null!=t&&qr(t.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},Ia.getPostMutationVersion=function(t){return t instanceof Ls?t.version:ao.MIN},Ia);function Ia(){}var Ca,Da=(s(Na,Ca=Ta),Na.prototype.applyToRemoteDocument=function(t,e){this.verifyKeyMatches(t),qr(null==e.transformResults,"Transform results received by SetMutation.");var n=e.version;return new Ls(this.key,n,{hasCommittedMutations:!0},this.value)},Na.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=Ta.getPostMutationVersion(t);return new Ls(this.key,r,{hasLocalMutations:!0},this.value)},Na.prototype.extractBaseValue=function(t){return null},Na.prototype.isEqual=function(t){return t instanceof Na&&this.key.isEqual(t.key)&&this.value.isEqual(t.value)&&this.precondition.isEqual(t.precondition)},Na);function Na(t,e,n){var r=Ca.call(this)||this;return r.key=t,r.value=e,r.precondition=n,r.type=va.Set,r}var Aa,ka=(s(Ra,Aa=Ta),Ra.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),qr(null==e.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(t))return new Bs(this.key,e.version);var n=this.patchDocument(t);return new Ls(this.key,e.version,{hasCommittedMutations:!0},n)},Ra.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=Ta.getPostMutationVersion(t),i=this.patchDocument(t);return new Ls(this.key,r,{hasLocalMutations:!0},i)},Ra.prototype.extractBaseValue=function(t){return null},Ra.prototype.isEqual=function(t){return t instanceof Ra&&this.key.isEqual(t.key)&&this.fieldMask.isEqual(t.fieldMask)&&this.precondition.isEqual(t.precondition)},Ra.prototype.patchDocument=function(t){var e;return e=t instanceof Ls?t.data():Ds.EMPTY,this.patchObject(e)},Ra.prototype.patchObject=function(n){var r=this;return this.fieldMask.fields.forEach(function(t){if(!t.isEmpty()){var e=r.data.field(t);n=null!==e?n.set(t,e):n.delete(t)}}),n},Ra);function Ra(t,e,n,r){var i=Aa.call(this)||this;return i.key=t,i.data=e,i.fieldMask=n,i.precondition=r,i.type=va.Patch,i}var Ma,_a=(s(Oa,Ma=Ta),Oa.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),qr(null!=e.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(t))return new Bs(this.key,e.version);var n=this.requireDocument(t),r=this.serverTransformResults(t,e.transformResults),i=e.version,o=this.transformObject(n.data(),r);return new Ls(this.key,i,{hasCommittedMutations:!0},o)},Oa.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=this.requireDocument(t),i=this.localTransformResults(n,t,e),o=this.transformObject(r.data(),i);return new Ls(this.key,r.version,{hasLocalMutations:!0},o)},Oa.prototype.extractBaseValue=function(t){for(var e=null,n=0,r=this.fieldTransforms;n<r.length;n++){var i=r[n],o=t instanceof Ls?t.field(i.field):void 0,a=i.transform.computeBaseValue(o||null);null!=a&&(e=null==e?Ds.EMPTY.set(i.field,a):e.set(i.field,a))}return e},Oa.prototype.isEqual=function(t){return t instanceof Oa&&this.key.isEqual(t.key)&&vi(this.fieldTransforms,t.fieldTransforms)&&this.precondition.isEqual(t.precondition)},Oa.prototype.requireDocument=function(t){qr(t instanceof Ls,"Unknown MaybeDocument type "+t);var e=t;return qr(e.key.isEqual(this.key),"Can only transform a document with the same key"),e},Oa.prototype.serverTransformResults=function(t,e){var n=[];qr(this.fieldTransforms.length===e.length,"server transform result count ("+e.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var r=0;r<e.length;r++){var i=this.fieldTransforms[r],o=i.transform,a=null;t instanceof Ls&&(a=t.field(i.field)),n.push(o.applyToRemoteDocument(a,e[r]))}return n},Oa.prototype.localTransformResults=function(t,e,n){for(var r=[],i=0,o=this.fieldTransforms;i<o.length;i++){var a=o[i],s=a.transform,u=null;e instanceof Ls&&(u=e.field(a.field)),null===u&&n instanceof Ls&&(u=n.field(a.field)),r.push(s.applyToLocalView(u,t))}return r},Oa.prototype.transformObject=function(t,e){qr(e.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var n=0;n<this.fieldTransforms.length;n++){var r=this.fieldTransforms[n].field;t=t.set(r,e[n])}return t},Oa);function Oa(t,e){var n=Ma.call(this)||this;return n.key=t,n.fieldTransforms=e,n.type=va.Transform,n.precondition=Sa.exists(!0),n}var La,Pa,xa,qa,Fa,Va=(s(Ba,La=Ta),Ba.prototype.applyToRemoteDocument=function(t,e){return this.verifyKeyMatches(t),qr(null==e.transformResults,"Transform results received by DeleteMutation."),new qs(this.key,e.version,{hasCommittedMutations:!0})},Ba.prototype.applyToLocalView=function(t,e,n){return this.verifyKeyMatches(t),this.precondition.isValidFor(t)?(t&&qr(t.key.isEqual(this.key),"Can only apply mutation to document with same key"),new qs(this.key,ao.forDeletedDoc())):t},Ba.prototype.extractBaseValue=function(t){return null},Ba.prototype.isEqual=function(t){return t instanceof Ba&&this.key.isEqual(t.key)&&this.precondition.isEqual(t.precondition)},Ba);function Ba(t,e){var n=La.call(this)||this;return n.key=t,n.precondition=e,n.type=va.Delete,n}(xa=Pa=Pa||{})[xa.NullValue=0]="NullValue",xa[xa.BooleanValue=1]="BooleanValue",xa[xa.NumberValue=2]="NumberValue",xa[xa.TimestampValue=3]="TimestampValue",xa[xa.StringValue=4]="StringValue",xa[xa.BlobValue=5]="BlobValue",xa[xa.RefValue=6]="RefValue",xa[xa.GeoPointValue=7]="GeoPointValue",xa[xa.ArrayValue=8]="ArrayValue",xa[xa.ObjectValue=9]="ObjectValue",(Fa=qa=qa||{})[Fa.Default=0]="Default",Fa[Fa.Estimate=1]="Estimate",Fa[Fa.Previous=2]="Previous";var Ua=(Qa.fromSnapshotOptions=function(t,e){switch(t.serverTimestamps){case"estimate":return new Qa(qa.Estimate,e);case"previous":return new Qa(qa.Previous,e);case"none":case void 0:return new Qa(qa.Default,e);default:return xr("fromSnapshotOptions() called with invalid options.")}},Qa);function Qa(t,e){this.serverTimestampBehavior=t,this.timestampsInSnapshots=e}var Ka=(ja.prototype.toString=function(){var t=this.value();return null===t?"null":t.toString()},ja.prototype.defaultCompareTo=function(t){return qr(this.typeOrder!==t.typeOrder,"Default compareTo should not be used for values of same type."),gi(this.typeOrder,t.typeOrder)},ja);function ja(){}var Wa,Ga=(s(za,Wa=Ka),za.prototype.value=function(t){return null},za.prototype.isEqual=function(t){return t instanceof za},za.prototype.compareTo=function(t){return t instanceof za?0:this.defaultCompareTo(t)},za.INSTANCE=new za,za);function za(){var t=Wa.call(this)||this;return t.typeOrder=Pa.NullValue,t.internalValue=null,t}var Ha,Ya=(s(Xa,Ha=Ka),Xa.prototype.value=function(t){return this.internalValue},Xa.prototype.isEqual=function(t){return t instanceof Xa&&this.internalValue===t.internalValue},Xa.prototype.compareTo=function(t){return t instanceof Xa?gi(this,t):this.defaultCompareTo(t)},Xa.of=function(t){return t?Xa.TRUE:Xa.FALSE},Xa.TRUE=new Xa(!0),Xa.FALSE=new Xa(!1),Xa);function Xa(t){var e=Ha.call(this)||this;return e.internalValue=t,e.typeOrder=Pa.BooleanValue,e}var Ja,$a=(s(Za,Ja=Ka),Za.prototype.value=function(t){return this.internalValue},Za.prototype.compareTo=function(t){return t instanceof Za?function(t,e){return t<e?-1:e<t?1:t===e?0:isNaN(t)?isNaN(e)?0:-1:1}(this.internalValue,t.internalValue):this.defaultCompareTo(t)},Za);function Za(t){var e=Ja.call(this)||this;return e.internalValue=t,e.typeOrder=Pa.NumberValue,e}function ts(t,e){return t===e?0!==t||1/t==1/e:t!=t&&e!=e}var es,ns=(s(rs,es=$a),rs.prototype.isEqual=function(t){return t instanceof rs&&ts(this.internalValue,t.internalValue)},rs);function rs(){return null!==es&&es.apply(this,arguments)||this}var is,os=(s(as,is=$a),as.prototype.isEqual=function(t){return t instanceof as&&ts(this.internalValue,t.internalValue)},as.NAN=new as(NaN),as.POSITIVE_INFINITY=new as(1/0),as.NEGATIVE_INFINITY=new as(-1/0),as);function as(){return null!==is&&is.apply(this,arguments)||this}var ss,us=(s(cs,ss=Ka),cs.prototype.value=function(t){return this.internalValue},cs.prototype.isEqual=function(t){return t instanceof cs&&this.internalValue===t.internalValue},cs.prototype.compareTo=function(t){return t instanceof cs?gi(this.internalValue,t.internalValue):this.defaultCompareTo(t)},cs);function cs(t){var e=ss.call(this)||this;return e.internalValue=t,e.typeOrder=Pa.StringValue,e}var hs,ls=(s(fs,hs=Ka),fs.prototype.value=function(t){return!t||t.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},fs.prototype.isEqual=function(t){return t instanceof fs&&this.internalValue.isEqual(t.internalValue)},fs.prototype.compareTo=function(t){return t instanceof fs?this.internalValue._compareTo(t.internalValue):t instanceof ds?-1:this.defaultCompareTo(t)},fs);function fs(t){var e=hs.call(this)||this;return e.internalValue=t,e.typeOrder=Pa.TimestampValue,e}var ps,ds=(s(ms,ps=Ka),ms.prototype.value=function(t){return t&&t.serverTimestampBehavior===qa.Estimate?new ls(this.localWriteTime).value(t):t&&t.serverTimestampBehavior===qa.Previous&&this.previousValue?this.previousValue.value(t):null},ms.prototype.isEqual=function(t){return t instanceof ms&&this.localWriteTime.isEqual(t.localWriteTime)},ms.prototype.compareTo=function(t){return t instanceof ms?this.localWriteTime._compareTo(t.localWriteTime):t instanceof ls?1:this.defaultCompareTo(t)},ms.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},ms);function ms(t,e){var n=ps.call(this)||this;return n.localWriteTime=t,n.previousValue=e,n.typeOrder=Pa.TimestampValue,n}var ys,gs=(s(vs,ys=Ka),vs.prototype.value=function(t){return this.internalValue},vs.prototype.isEqual=function(t){return t instanceof vs&&this.internalValue.isEqual(t.internalValue)},vs.prototype.compareTo=function(t){return t instanceof vs?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},vs);function vs(t){var e=ys.call(this)||this;return e.internalValue=t,e.typeOrder=Pa.BlobValue,e}var bs,ws=(s(Ss,bs=Ka),Ss.prototype.value=function(t){return this.key},Ss.prototype.isEqual=function(t){return t instanceof Ss&&this.key.isEqual(t.key)&&this.databaseId.isEqual(t.databaseId)},Ss.prototype.compareTo=function(t){if(t instanceof Ss){var e=this.databaseId.compareTo(t.databaseId);return 0!==e?e:Ui.comparator(this.key,t.key)}return this.defaultCompareTo(t)},Ss);function Ss(t,e){var n=bs.call(this)||this;return n.databaseId=t,n.key=e,n.typeOrder=Pa.RefValue,n}var Es,Ts=(s(Is,Es=Ka),Is.prototype.value=function(t){return this.internalValue},Is.prototype.isEqual=function(t){return t instanceof Is&&this.internalValue.isEqual(t.internalValue)},Is.prototype.compareTo=function(t){return t instanceof Is?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},Is);function Is(t){var e=Es.call(this)||this;return e.internalValue=t,e.typeOrder=Pa.GeoPointValue,e}var Cs,Ds=(s(Ns,Cs=Ka),Ns.prototype.value=function(n){var r={};return this.internalValue.inorderTraversal(function(t,e){r[t]=e.value(n)}),r},Ns.prototype.forEach=function(t){this.internalValue.inorderTraversal(t)},Ns.prototype.isEqual=function(t){if(t instanceof Ns){for(var e=this.internalValue.getIterator(),n=t.internalValue.getIterator();e.hasNext()&&n.hasNext();){var r=e.getNext(),i=n.getNext();if(r.key!==i.key||!r.value.isEqual(i.value))return!1}return!e.hasNext()&&!n.hasNext()}return!1},Ns.prototype.compareTo=function(t){if(t instanceof Ns){for(var e=this.internalValue.getIterator(),n=t.internalValue.getIterator();e.hasNext()&&n.hasNext();){var r=e.getNext(),i=n.getNext(),o=gi(r.key,i.key)||r.value.compareTo(i.value);if(o)return o}return gi(e.hasNext(),n.hasNext())}return this.defaultCompareTo(t)},Ns.prototype.set=function(t,e){if(qr(!t.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===t.length)return this.setChild(t.firstSegment(),e);var n=this.child(t.firstSegment());n instanceof Ns||(n=Ns.EMPTY);var r=n.set(t.popFirst(),e);return this.setChild(t.firstSegment(),r)},Ns.prototype.delete=function(t){if(qr(!t.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===t.length)return new Ns(this.internalValue.remove(t.firstSegment()));var e=this.child(t.firstSegment());if(e instanceof Ns){var n=e.delete(t.popFirst());return new Ns(this.internalValue.insert(t.firstSegment(),n))}return this},Ns.prototype.contains=function(t){return null!==this.field(t)},Ns.prototype.field=function(t){qr(!t.isEmpty(),"Can't get field of empty path");var e=this;return t.forEach(function(t){e=e instanceof Ns?e.internalValue.get(t):null}),e},Ns.prototype.fieldMask=function(){var i=new go(Vi.comparator);return this.internalValue.forEach(function(t,e){var n=new Vi([t]);if(e instanceof Ns){var r=e.fieldMask().fields;r.isEmpty()?i=i.add(n):r.forEach(function(t){i=i.add(n.child(t))})}else i=i.add(n)}),da.fromSet(i)},Ns.prototype.toString=function(){return this.internalValue.toString()},Ns.prototype.child=function(t){return this.internalValue.get(t)||void 0},Ns.prototype.setChild=function(t,e){return new Ns(this.internalValue.insert(t,e))},Ns.EMPTY=new Ns(new uo(gi)),Ns);function Ns(t){var e=Cs.call(this)||this;return e.internalValue=t,e.typeOrder=Pa.ObjectValue,e}var As,ks=(s(Rs,As=Ka),Rs.prototype.value=function(e){return this.internalValue.map(function(t){return t.value(e)})},Rs.prototype.contains=function(t){for(var e=0,n=this.internalValue;e<n.length;e++)if(n[e].isEqual(t))return!0;return!1},Rs.prototype.forEach=function(t){this.internalValue.forEach(t)},Rs.prototype.isEqual=function(t){if(t instanceof Rs){if(this.internalValue.length!==t.internalValue.length)return!1;for(var e=0;e<this.internalValue.length;e++)if(!this.internalValue[e].isEqual(t.internalValue[e]))return!1;return!0}return!1},Rs.prototype.compareTo=function(t){if(t instanceof Rs){for(var e=Math.min(this.internalValue.length,t.internalValue.length),n=0;n<e;n++){var r=this.internalValue[n].compareTo(t.internalValue[n]);if(r)return r}return gi(this.internalValue.length,t.internalValue.length)}return this.defaultCompareTo(t)},Rs.prototype.toString=function(){return"["+this.internalValue.map(function(t){return t.toString()}).join(",")+"]"},Rs);function Rs(t){var e=As.call(this)||this;return e.internalValue=t,e.typeOrder=Pa.ArrayValue,e}var Ms=(_s.compareByKey=function(t,e){return Ui.comparator(t.key,e.key)},_s);function _s(t,e){this.key=t,this.version=e}var Os,Ls=(s(Ps,Os=Ms),Ps.prototype.field=function(t){if(this.objectValue)return this.objectValue.field(t);this.fieldValueCache||(this.fieldValueCache=new Map);var e=t.canonicalString(),n=this.fieldValueCache.get(e);if(void 0===n){var r=this.getProtoField(t);n=void 0===r?null:this.converter(r),this.fieldValueCache.set(e,n)}return n},Ps.prototype.data=function(){var n=this;if(!this.objectValue){var r=Ds.EMPTY;Yr(this.proto.fields||{},function(t,e){r=r.set(new Vi([t]),n.converter(e))}),this.objectValue=r,this.fieldValueCache=void 0}return this.objectValue},Ps.prototype.value=function(){return this.data().value()},Ps.prototype.isEqual=function(t){return t instanceof Ps&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.hasLocalMutations===t.hasLocalMutations&&this.hasCommittedMutations===t.hasCommittedMutations&&this.data().isEqual(t.data())},Ps.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data().toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(Ps.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),Ps.prototype.getProtoField=function(t){qr(void 0!==this.proto,"Can only call getProtoField() when proto is defined");for(var e=this.proto.fields?this.proto.fields[t.firstSegment()]:void 0,n=1;n<t.length;++n){if(!e||!e.mapValue||!e.mapValue.fields)return;e=e.mapValue.fields[t.get(n)]}return e},Ps.compareByField=function(t,e,n){var r=e.field(t),i=n.field(t);return null!==r&&null!==i?r.compareTo(i):xr("Trying to compare documents on fields that don't exist")},Ps);function Ps(t,e,n,r,i,o){var a=Os.call(this,t,e)||this;return a.objectValue=r,a.proto=i,a.converter=o,qr(void 0!==a.objectValue||void 0!==a.proto&&void 0!==a.converter,"If objectValue is not defined, proto and converter need to be set."),a.hasLocalMutations=!!n.hasLocalMutations,a.hasCommittedMutations=!!n.hasCommittedMutations,a}var xs,qs=(s(Fs,xs=Ms),Fs.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(Fs.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),Fs.prototype.isEqual=function(t){return t instanceof Fs&&t.hasCommittedMutations===this.hasCommittedMutations&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},Fs);function Fs(t,e,n){var r=xs.call(this,t,e)||this;return r.hasCommittedMutations=!(!n||!n.hasCommittedMutations),r}var Vs,Bs=(s(Us,Vs=Ms),Us.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(Us.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),Us.prototype.isEqual=function(t){return t instanceof Us&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},Us);function Us(){return null!==Vs&&Vs.apply(this,arguments)||this}var Qs=(Ks.prototype.get=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(var r=0,i=n;r<i.length;r++){var o=i[r],a=o[0],s=o[1];if(a.isEqual(t))return s}},Ks.prototype.has=function(t){return void 0!==this.get(t)},Ks.prototype.set=function(t,e){var n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(r[i][0].isEqual(t))return void(r[i]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]},Ks.prototype.delete=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(n[r][0].isEqual(t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1},Ks.prototype.forEach=function(s){Yr(this.inner,function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n],o=i[0],a=i[1];s(o,a)}})},Ks.prototype.isEmpty=function(){return Xr(this.inner)},Ks);function Ks(t){this.mapKeyFn=t,this.inner={}}var js=(Ws.prototype.addEntry=function(t){this.assertNotApplied(),this.changes.set(t.key,t)},Ws.prototype.removeEntry=function(t){this.assertNotApplied(),this.changes.set(t,null)},Ws.prototype.getEntry=function(t,e){this.assertNotApplied();var n=this.changes.get(e);return void 0!==n?xo.resolve(n):this.getFromCache(t,e)},Ws.prototype.getEntries=function(t,e){return this.getAllFromCache(t,e)},Ws.prototype.apply=function(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)},Ws.prototype.assertNotApplied=function(){qr(!this.changesApplied,"Changes have already been applied.")},Ws);function Ws(){this.changes=new Qs(function(t){return t.toString()}),this.changesApplied=!1}var Gs,zs="The remote document changelog no longer contains all changes for all local query views. It may be necessary to rebuild these views.",Hs=(Object.defineProperty(Ys.prototype,"lastProcessedDocumentChangeId",{get:function(){return this._lastProcessedDocumentChangeId},enumerable:!0,configurable:!0}),Ys.prototype.start=function(t){var e=Jo.getStore(t,Ou.store);return this.synchronizeLastDocumentChangeId(e)},Ys.prototype.addEntry=function(t,e,n){var r=this;return $s(t).put(tu(e),n).next(function(){r.indexManager.addToCollectionParentIndex(t,e.path.popLast())})},Ys.prototype.removeEntry=function(t,e){var n=$s(t),r=tu(e);return n.delete(r)},Ys.prototype.updateMetadata=function(e,n,r){var i=this;return this.getMetadata(e).next(function(t){return t.byteSize+=r,i.setMetadata(e,t).next(function(){if(i.keepDocumentChangeLog)return Zs(e).put({changes:i.serializer.toDbResourcePaths(n)})})})},Ys.prototype.getEntry=function(t,e){var n=this;return $s(t).get(tu(e)).next(function(t){return t?n.serializer.fromDbRemoteDocument(t):null})},Ys.prototype.getSizedEntry=function(t,e){var n=this;return $s(t).get(tu(e)).next(function(t){return t?{maybeDocument:n.serializer.fromDbRemoteDocument(t),size:eu(t)}:null})},Ys.prototype.getEntries=function(t,e){var n=this,r=To();return this.forEachDbEntry(t,e,function(t,e){r=e?r.insert(t,n.serializer.fromDbRemoteDocument(e)):r.insert(t,null)}).next(function(){return r})},Ys.prototype.getSizedEntries=function(t,e){var n=this,r=To(),i=new uo(Ui.comparator);return this.forEachDbEntry(t,e,function(t,e){i=e?(r=r.insert(t,n.serializer.fromDbRemoteDocument(e)),i.insert(t,eu(e))):(r=r.insert(t,null),i.insert(t,0))}).next(function(){return{maybeDocuments:r,sizeMap:i}})},Ys.prototype.forEachDbEntry=function(t,e,i){if(e.isEmpty())return xo.resolve();var n=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),o=e.getIterator(),a=o.getNext();return $s(t).iterate({range:n},function(t,e,n){for(var r=Ui.fromSegments(t);a&&Ui.comparator(a,r)<0;)i(a,null),a=o.getNext();a&&a.isEqual(r)&&(i(a,e),a=o.hasNext()?o.getNext():null),a?n.skip(a.path.toArray()):n.done()}).next(function(){for(;a;)i(a,null),a=o.hasNext()?o.getNext():null})},Ys.prototype.getDocumentsMatchingQuery=function(t,i){var o=this;qr(!i.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var a=Co(),s=i.path.length+1,e=i.path.toArray(),n=IDBKeyRange.lowerBound(e);return $s(t).iterate({range:n},function(t,e,n){if(t.length===s){var r=o.serializer.fromDbRemoteDocument(e);i.path.isPrefixOf(r.key.path)?r instanceof Ls&&i.matches(r)&&(a=a.insert(r.key,r)):n.done()}}).next(function(){return a})},Ys.prototype.getNewDocumentChanges=function(e){var r=this;qr(this.keepDocumentChangeLog,"Can only call getNewDocumentChanges() when document change log is enabled");var n=ko(),i=Eo(),t=IDBKeyRange.lowerBound(this._lastProcessedDocumentChangeId+1),o=!0,a=Zs(e);return a.iterate({range:t},function(t,e){if(o&&(o=!1,r._lastProcessedDocumentChangeId+1!==e.id))return r.synchronizeLastDocumentChangeId(a).next(function(){return xo.reject(new Kr(Qr.DATA_LOSS,zs))});n=n.unionWith(r.serializer.fromDbResourcePaths(e.changes)),r._lastProcessedDocumentChangeId=e.id}).next(function(){var t=[];return n.forEach(function(n){t.push(r.getEntry(e,n).next(function(t){var e=t||new qs(n,ao.forDeletedDoc());i=i.insert(n,e)}))}),xo.waitFor(t)}).next(function(){return i})},Ys.prototype.removeDocumentChangesThroughChangeId=function(t,e){var n=IDBKeyRange.upperBound(e);return Zs(t).delete(n)},Ys.prototype.synchronizeLastDocumentChangeId=function(t){var r=this;return this._lastProcessedDocumentChangeId=0,t.iterate({keysOnly:!0,reverse:!0},function(t,e,n){r._lastProcessedDocumentChangeId=t,n.done()})},Ys.prototype.newChangeBuffer=function(){return new Ys.RemoteDocumentChangeBuffer(this)},Ys.prototype.getSize=function(t){return this.getMetadata(t).next(function(t){return t.byteSize})},Ys.prototype.getMetadata=function(t){return Js(t).get(Eu.key).next(function(t){return qr(!!t,"Missing document cache metadata"),t})},Ys.prototype.setMetadata=function(t,e){return Js(t).put(Eu.key,e)},Ys.RemoteDocumentChangeBuffer=(s(Xs,Gs=js),Xs.prototype.applyChanges=function(o){var a=this,s=[],u=0,c=ko();return this.changes.forEach(function(t,e){var n=a.documentSizes.get(t);if(qr(void 0!==n,"Cannot modify a document that wasn't read (for "+t+")"),e){var r=a.documentCache.serializer.toDbRemoteDocument(e),i=eu(r);u+=i-n,s.push(a.documentCache.addEntry(o,t,r))}else u-=n,s.push(a.documentCache.removeEntry(o,t));c=c.add(t)}),s.push(this.documentCache.updateMetadata(o,c,u)),xo.waitFor(s)},Xs.prototype.getFromCache=function(t,e){var n=this;return this.documentCache.getSizedEntry(t,e).next(function(t){return null===t?(n.documentSizes.set(e,0),null):(n.documentSizes.set(e,t.size),t.maybeDocument)})},Xs.prototype.getAllFromCache=function(t,e){var n=this;return this.documentCache.getSizedEntries(t,e).next(function(t){var e=t.maybeDocuments;return t.sizeMap.forEach(function(t,e){n.documentSizes.set(t,e)}),e})},Xs),Ys);function Ys(t,e,n){this.serializer=t,this.indexManager=e,this.keepDocumentChangeLog=n,this._lastProcessedDocumentChangeId=0}function Xs(t){var e=Gs.call(this)||this;return e.documentCache=t,e.documentSizes=new Qs(function(t){return t.toString()}),e}function Js(t){return cc.getStore(t,Eu.store)}function $s(t){return cc.getStore(t,wu.store)}function Zs(t){return cc.getStore(t,Ou.store)}function tu(t){return t.path.toArray()}function eu(t){var e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw xr("Unknown remote document type");e=t.noDocument}return JSON.stringify(e).length}var nu=(ru.prototype.addToCollectionParentIndex=function(t,e){return this.collectionParentIndex.add(e),xo.resolve()},ru.prototype.getCollectionParents=function(t,e){return xo.resolve(this.collectionParentIndex.getEntries(e))},ru);function ru(){this.collectionParentIndex=new iu}var iu=(ou.prototype.add=function(t){qr(t.length%2==1,"Expected a collection path.");var e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new go(Pi.comparator),i=!r.has(n);return this.index[e]=r.add(n),i},ou.prototype.getEntries=function(t){return(this.index[t]||new go(Pi.comparator)).toArray()},ou);function ou(){this.index={}}var au=8,su=(uu.prototype.createOrUpgrade=function(t,e,n,r){var i=this;qr(n<r&&0<=n&&r<=au,"Unexpected schema upgrade from v"+n+" to v{toVersion}."),n<1&&1<=r&&(function(t){t.createObjectStore(hu.store)}(t),function(t){t.createObjectStore(fu.store,{keyPath:fu.keyPath}),t.createObjectStore(du.store,{keyPath:du.keyPath,autoIncrement:!0}).createIndex(du.userMutationsIndex,du.userMutationsKeyPath,{unique:!0}),t.createObjectStore(yu.store)}(t),_u(t),function(t){t.createObjectStore(wu.store)}(t));var o=xo.resolve();return n<3&&3<=r&&(0!==n&&(function(t){t.deleteObjectStore(Du.store),t.deleteObjectStore(Iu.store),t.deleteObjectStore(Au.store)}(t),_u(t)),o=o.next(function(){return function(t){var e=t.store(Au.store),n=new Au(0,0,ao.MIN.toTimestamp(),0);return e.put(Au.key,n)}(e)})),n<4&&4<=r&&(0!==n&&(o=o.next(function(){return function(r,i){return i.store(du.store).loadAll().next(function(t){r.deleteObjectStore(du.store),r.createObjectStore(du.store,{keyPath:du.keyPath,autoIncrement:!0}).createIndex(du.userMutationsIndex,du.userMutationsKeyPath,{unique:!0});var e=i.store(du.store),n=t.map(function(t){return e.put(t)});return xo.waitFor(n)})}(t,e)})),o=o.next(function(){!function(t){t.createObjectStore(Pu.store,{keyPath:Pu.keyPath})}(t),function(t){t.createObjectStore(Ou.store,{keyPath:"id",autoIncrement:!0})}(t)})),n<5&&5<=r&&(o=o.next(function(){return i.removeAcknowledgedMutations(e)})),n<6&&6<=r&&(o=o.next(function(){return function(t){t.createObjectStore(Eu.store)}(t),i.addDocumentGlobal(e)})),n<7&&7<=r&&(o=o.next(function(){return i.ensureSequenceNumbers(e)})),n<8&&8<=r&&(o=o.next(function(){return i.createCollectionParentIndex(t,e)})),o},uu.prototype.addDocumentGlobal=function(e){var n=0;return e.store(wu.store).iterate(function(t,e){n+=eu(e)}).next(function(){var t=new Eu(n);return e.store(Eu.store).put(Eu.key,t)})},uu.prototype.removeAcknowledgedMutations=function(r){var i=this,t=r.store(fu.store),e=r.store(du.store);return t.loadAll().next(function(t){return xo.forEach(t,function(n){var t=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return e.loadAll(du.userMutationsIndex,t).next(function(t){return xo.forEach(t,function(t){qr(t.userId===n.userId,"Cannot process batch "+t.batchId+" from unexpected user");var e=i.serializer.fromDbMutationBatch(t);return Uo(r,n.userId,e).next(function(){})})})})})},uu.prototype.ensureSequenceNumbers=function(t){var a=t.store(Du.store),e=t.store(wu.store);return fa(t).next(function(i){var o=[];return e.iterate(function(t,e){var n=new Pi(t),r=function(t){return[0,to(t)]}(n);o.push(a.get(r).next(function(t){return t?xo.resolve():function(t){return a.put(new Du(0,to(t),i))}(n)}))}).next(function(){return xo.waitFor(o)})})},uu.prototype.createCollectionParentIndex=function(t,e){function i(t){if(o.add(t)){var e=t.lastSegment(),n=t.popLast();return r.put({collectionId:e,parent:to(n)})}}t.createObjectStore(Ru.store,{keyPath:Ru.keyPath});var r=e.store(Ru.store),o=new iu;return e.store(wu.store).iterate({keysOnly:!0},function(t,e){var n=new Pi(t);return i(n.popLast())}).next(function(){return e.store(yu.store).iterate({keysOnly:!0},function(t,e){t[0];var n=t[1],r=(t[2],ro(n));return i(r.popLast())})})},uu);function uu(t){this.serializer=t}var cu=function(t,e){this.seconds=t,this.nanoseconds=e},hu=(lu.store="owner",lu.key="owner",lu);function lu(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}var fu=(pu.store="mutationQueues",pu.keyPath="userId",pu);function pu(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}var du=(mu.store="mutations",mu.keyPath="batchId",mu.userMutationsIndex="userMutationsIndex",mu.userMutationsKeyPath=["userId","batchId"],mu);function mu(t,e,n,r,i){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=i}var yu=(gu.prefixForUser=function(t){return[t]},gu.prefixForPath=function(t,e){return[t,to(e)]},gu.key=function(t,e,n){return[t,to(e),n]},gu.store="documentMutations",gu.PLACEHOLDER=new gu,gu);function gu(){}var vu=function(t,e){this.path=t,this.readTime=e},bu=function(t,e){this.path=t,this.version=e},wu=(Su.store="remoteDocuments",Su);function Su(t,e,n,r){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r}var Eu=(Tu.store="remoteDocumentGlobal",Tu.key="remoteDocumentGlobalKey",Tu);function Tu(t){this.byteSize=t}var Iu=(Cu.store="targets",Cu.keyPath="targetId",Cu.queryTargetsIndexName="queryTargetsIndex",Cu.queryTargetsKeyPath=["canonicalId","targetId"],Cu);function Cu(t,e,n,r,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.query=o}var Du=(Nu.store="targetDocuments",Nu.keyPath=["targetId","path"],Nu.documentTargetsIndex="documentTargetsIndex",Nu.documentTargetsKeyPath=["path","targetId"],Nu);function Nu(t,e,n){this.targetId=t,this.path=e,qr(0===t==(void 0!==(this.sequenceNumber=n)),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}var Au=(ku.key="targetGlobalKey",ku.store="targetGlobal",ku);function ku(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}var Ru=(Mu.store="collectionParents",Mu.keyPath=["collectionId","parent"],Mu);function Mu(t,e){this.collectionId=t,this.parent=e}function _u(t){t.createObjectStore(Du.store,{keyPath:Du.keyPath}).createIndex(Du.documentTargetsIndex,Du.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(Iu.store,{keyPath:Iu.keyPath}).createIndex(Iu.queryTargetsIndexName,Iu.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Au.store)}var Ou=(Lu.store="remoteDocumentChanges",Lu.keyPath="id",Lu);function Lu(t){this.changes=t}var Pu=(xu.store="clientMetadata",xu.keyPath="clientId",xu);function xu(t,e,n,r,i){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r,this.lastProcessedDocumentChangeId=i}var qu,Fu,Vu=[fu.store,du.store,yu.store,wu.store,Iu.store,hu.store,Au.store,Du.store].concat([Pu.store,Ou.store]).concat([Eu.store]).concat([Ru.store]),Bu=(Uu.prototype.addToCollectionParentIndex=function(t,e){if(qr(e.length%2==1,"Expected a collection path."),this.collectionParentsCache.add(e)){qr(1<=e.length,"Invalid collection path.");var n=e.lastSegment(),r=e.popLast();return Qu(t).put({collectionId:n,parent:to(r)})}return xo.resolve()},Uu.prototype.getCollectionParents=function(t,i){var o=[],e=IDBKeyRange.bound([i,""],[bi(i),""],!1,!0);return Qu(t).loadAll(e).next(function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];if(r.collectionId!==i)break;o.push(ro(r.parent))}return o})},Uu);function Uu(){this.collectionParentsCache=new iu}function Qu(t){return cc.getStore(t,Ru.store)}(Fu=qu=qu||{})[Fu.Listen=0]="Listen",Fu[Fu.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",Fu[Fu.LimboResolution=2]="LimboResolution";var Ku=(ju.prototype.withSequenceNumber=function(t){return new ju(this.query,this.targetId,this.purpose,t,this.snapshotVersion,this.resumeToken)},ju.prototype.withResumeToken=function(t,e){return new ju(this.query,this.targetId,this.purpose,this.sequenceNumber,e,t)},ju.prototype.isEqual=function(t){return this.targetId===t.targetId&&this.purpose===t.purpose&&this.sequenceNumber===t.sequenceNumber&&this.snapshotVersion.isEqual(t.snapshotVersion)&&this.resumeToken===t.resumeToken&&this.query.isEqual(t.query)},ju);function ju(t,e,n,r,i,o){void 0===i&&(i=ao.MIN),void 0===o&&(o=Br()),this.query=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.resumeToken=o}var Wu=(Gu.prototype.fromDbRemoteDocument=function(t){if(t.document)return this.remoteSerializer.fromDocument(t.document,!!t.hasCommittedMutations);if(t.noDocument){var e=Ui.fromSegments(t.noDocument.path),n=this.fromDbTimestamp(t.noDocument.readTime);return new qs(e,n,{hasCommittedMutations:!!t.hasCommittedMutations})}return t.unknownDocument?(e=Ui.fromSegments(t.unknownDocument.path),n=this.fromDbTimestamp(t.unknownDocument.version),new Bs(e,n)):xr("Unexpected DbRemoteDocument")},Gu.prototype.toDbRemoteDocument=function(t){if(t instanceof Ls){var e=t.proto?t.proto:this.remoteSerializer.toDocument(t),n=t.hasCommittedMutations;return new wu(null,null,e,n)}if(t instanceof qs){var r=t.key.path.toArray(),i=this.toDbTimestamp(t.version);return n=t.hasCommittedMutations,new wu(null,new vu(r,i),null,n)}return t instanceof Bs?(r=t.key.path.toArray(),i=this.toDbTimestamp(t.version),new wu(new bu(r,i),null,null,!0)):xr("Unexpected MaybeDocumment")},Gu.prototype.toDbTimestamp=function(t){var e=t.toTimestamp();return new cu(e.seconds,e.nanoseconds)},Gu.prototype.fromDbTimestamp=function(t){var e=new io(t.seconds,t.nanoseconds);return ao.fromTimestamp(e)},Gu.prototype.toDbMutationBatch=function(t,e){var n=this,r=e.baseMutations.map(function(t){return n.remoteSerializer.toMutation(t)}),i=e.mutations.map(function(t){return n.remoteSerializer.toMutation(t)});return new du(t,e.batchId,e.localWriteTime.toMillis(),r,i)},Gu.prototype.fromDbMutationBatch=function(t){var e=this,n=(t.baseMutations||[]).map(function(t){return e.remoteSerializer.fromMutation(t)}),r=t.mutations.map(function(t){return e.remoteSerializer.fromMutation(t)}),i=io.fromMillis(t.localWriteTimeMs);return new _o(t.batchId,i,n,r)},Gu.prototype.toDbResourcePaths=function(t){var e=[];return t.forEach(function(t){e.push(to(t.path))}),e},Gu.prototype.fromDbResourcePaths=function(t){for(var e=ko(),n=0,r=t;n<r.length;n++){var i=r[n];e=e.add(new Ui(ro(i)))}return e},Gu.prototype.fromDbTarget=function(t){var e,n=this.fromDbTimestamp(t.readTime);return e=function(t){return void 0!==t.documents}(t.query)?this.remoteSerializer.fromDocumentsTarget(t.query):this.remoteSerializer.fromQueryTarget(t.query),new Ku(e,t.targetId,qu.Listen,t.lastListenSequenceNumber,n,t.resumeToken)},Gu.prototype.toDbTarget=function(t){qr(qu.Listen===t.purpose,"Only queries with purpose "+qu.Listen+" may be stored, got "+t.purpose);var e,n,r=this.toDbTimestamp(t.snapshotVersion);return e=t.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(t.query):this.remoteSerializer.toQueryTarget(t.query),n=t.resumeToken instanceof Uint8Array?(qr("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence ."),t.resumeToken.toString()):t.resumeToken,new Iu(t.targetId,t.query.canonicalId(),r,n,t.sequenceNumber,e)},Gu);function Gu(t){this.remoteSerializer=t}function zu(t,e){var n=t[0],r=t[1],i=e[0],o=e[1],a=gi(n,i);return 0===a?gi(r,o):a}var Hu=(Yu.prototype.nextIndex=function(){return++this.previousIndex},Yu.prototype.addElement=function(t){var e=[t,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(e);else{var n=this.buffer.last();zu(e,n)<0&&(this.buffer=this.buffer.delete(n).add(e))}},Object.defineProperty(Yu.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),Yu);function Yu(t){this.maxElements=t,this.buffer=new go(zu),this.previousIndex=0}var Xu={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Ju=($u.withCacheSize=function(t){return new $u(t,$u.DEFAULT_COLLECTION_PERCENTILE,$u.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},$u.COLLECTION_DISABLED=-1,$u.MINIMUM_CACHE_SIZE_BYTES=1048576,$u.DEFAULT=new $u($u.DEFAULT_CACHE_SIZE_BYTES=41943040,$u.DEFAULT_COLLECTION_PERCENTILE=10,$u.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3),$u.DISABLED=new $u($u.COLLECTION_DISABLED,0,0),$u);function $u(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}var Zu=(tc.prototype.start=function(){qr(null===this.gcTask,"Cannot start an already started LruScheduler"),this.garbageCollector.params.cacheSizeCollectionThreshold!==Ju.COLLECTION_DISABLED&&this.scheduleGC()},tc.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(tc.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0}),tc.prototype.scheduleGC=function(){var t=this;qr(null===this.gcTask,"Cannot schedule GC while a task is pending");var e=this.hasRun?3e5:6e4;Or("LruGarbageCollector","Garbage collection scheduled in "+e+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay(Ki.LruGarbageCollection,e,function(){return t.gcTask=null,t.hasRun=!0,t.localStore.collectGarbage(t.garbageCollector).then(function(){return t.scheduleGC()}).catch(lc)})},tc);function tc(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.hasRun=!1,this.gcTask=null}var ec=(nc.prototype.calculateTargetCount=function(t,e){return this.delegate.getSequenceNumberCount(t).next(function(t){return Math.floor(e/100*t)})},nc.prototype.nthSequenceNumber=function(t,e){var n=this;if(0===e)return xo.resolve(ki.INVALID);var r=new Hu(e);return this.delegate.forEachTarget(t,function(t){return r.addElement(t.sequenceNumber)}).next(function(){return n.delegate.forEachOrphanedDocumentSequenceNumber(t,function(t){return r.addElement(t)})}).next(function(){return r.maxValue})},nc.prototype.removeTargets=function(t,e,n){return this.delegate.removeTargets(t,e,n)},nc.prototype.removeOrphanedDocuments=function(t,e){return this.delegate.removeOrphanedDocuments(t,e)},nc.prototype.collect=function(e,n){var r=this;return this.params.cacheSizeCollectionThreshold===Ju.COLLECTION_DISABLED?(Or("LruGarbageCollector","Garbage collection skipped; disabled"),xo.resolve(Xu)):this.getCacheSize(e).next(function(t){return t<r.params.cacheSizeCollectionThreshold?(Or("LruGarbageCollector","Garbage collection skipped; Cache size "+t+" is lower than threshold "+r.params.cacheSizeCollectionThreshold),Xu):r.runGarbageCollection(e,n)})},nc.prototype.getCacheSize=function(t){return this.delegate.getCacheSize(t)},nc.prototype.runGarbageCollection=function(e,n){var r,i,o,a,s,u,c,h=this,l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(function(t){return i=t>h.params.maximumSequenceNumbersToCollect?(Or("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+h.params.maximumSequenceNumbersToCollect+" from "+t),h.params.maximumSequenceNumbersToCollect):t,a=Date.now(),h.nthSequenceNumber(e,i)}).next(function(t){return r=t,s=Date.now(),h.removeTargets(e,r,n)}).next(function(t){return o=t,u=Date.now(),h.removeOrphanedDocuments(e,r)}).next(function(t){return c=Date.now(),Mr()<=Sr.DEBUG&&Or("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(a-l)+"ms\n\tDetermined least recently used "+i+" in "+(s-a)+"ms\n\tRemoved "+o+" targets in "+(u-s)+"ms\n\tRemoved "+t+" documents in "+(c-u)+"ms\nTotal Duration: "+(c-l)+"ms"),xo.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:o,documentsRemoved:t})})},nc);function nc(t,e){this.delegate=t,this.params=e}var rc,ic="IndexedDbPersistence",oc="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",ac="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `synchronizeTabs:true` in all tabs.",sc=(s(uc,rc=function(){}),uc);function uc(t,e){var n=rc.call(this)||this;return n.simpleDbTransaction=t,n.currentSequenceNumber=e,n}var cc=(hc.getStore=function(t,e){if(t instanceof sc)return Jo.getStore(t.simpleDbTransaction,e);throw xr("IndexedDbPersistence must use instances of IndexedDbTransaction")},hc.createIndexedDbPersistence=function(n){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:if(!hc.isAvailable())throw new Kr(Qr.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");return[4,(e=new hc(n.allowTabSynchronization,n.persistenceKey,n.clientId,n.platform,n.lruParams,n.queue,n.serializer,n.sequenceNumberSyncer)).start()];case 1:return t.sent(),[2,e]}})})},hc.prototype.start=function(){var e=this;return qr(!this.started,"IndexedDbPersistence double-started!"),qr(null!==this.window,"Expected 'window' to be defined"),Jo.openOrCreate(this.dbName,au,new su(this.serializer)).then(function(t){return e.simpleDb=t,e.updateClientMetadataAndTryBecomePrimary()}).then(function(){return e.attachVisibilityHandler(),e.attachWindowUnloadHook(),e.scheduleClientMetadataAndPrimaryLeaseRefreshes(),e.startRemoteDocumentCache()}).then(function(){return e.simpleDb.runTransaction("readonly",[Au.store],function(t){return fa(t).next(function(t){e.listenSequence=new ki(t,e.sequenceNumberSyncer)})})}).then(function(){e._started=!0}).catch(function(t){return e.simpleDb&&e.simpleDb.close(),Promise.reject(t)})},hc.prototype.startRemoteDocumentCache=function(){var e=this;return this.simpleDb.runTransaction("readonly",Vu,function(t){return e.remoteDocumentCache.start(t)})},hc.prototype.setPrimaryStateListener=function(n){var t=this;return this.primaryStateListener=function(e){return p(t,void 0,void 0,function(){return d(this,function(t){return this.started?[2,n(e)]:[2]})})},n(this.isPrimary)},hc.prototype.setDatabaseDeletedListener=function(n){var t=this;this.simpleDb.setVersionChangeListener(function(e){return p(t,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return null!==e.newVersion?[3,2]:[4,n()];case 1:t.sent(),t.label=2;case 2:return[2]}})})})},hc.prototype.setNetworkEnabled=function(t){var e=this;this.networkEnabled!==t&&(this.networkEnabled=t,this.queue.enqueueAndForget(function(){return p(e,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})}))},hc.prototype.updateClientMetadataAndTryBecomePrimary=function(){var r=this;return this.simpleDb.runTransaction("readwrite",Vu,function(n){return pc(n).put(new Pu(r.clientId,Date.now(),r.networkEnabled,r.inForeground,r.remoteDocumentCache.lastProcessedDocumentChangeId)).next(function(){if(r.isPrimary)return r.verifyPrimaryLease(n).next(function(t){t||(r.isPrimary=!1,r.queue.enqueueAndForget(function(){return r.primaryStateListener(!1)}))})}).next(function(){return r.canActAsPrimary(n)}).next(function(t){var e=r.isPrimary;return r.isPrimary=t,e!==r.isPrimary&&r.queue.enqueueAndForget(function(){return r.primaryStateListener(r.isPrimary)}),e&&!r.isPrimary?r.releasePrimaryLeaseIfHeld(n):r.isPrimary?r.acquireOrExtendPrimaryLease(n):void 0})})},hc.prototype.verifyPrimaryLease=function(t){var e=this;return fc(t).get(hu.key).next(function(t){return xo.resolve(e.isLocalClient(t))})},hc.prototype.removeClientMetadata=function(t){return pc(t).delete(this.clientId)},hc.prototype.maybeGarbageCollectMultiClientState=function(){return p(this,void 0,void 0,function(){var r,i,o=this;return d(this,function(t){switch(t.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),i=[],[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(n){var e=hc.getStore(n,Pu.store);return e.loadAll().next(function(t){r=o.filterActiveClients(t,18e5),i=t.filter(function(t){return-1===r.indexOf(t)})}).next(function(){return xo.forEach(i,function(t){return e.delete(t.clientId)})}).next(function(){if(0<(r=r.filter(function(t){return t.clientId!==o.clientId})).length){var t=r.map(function(t){return t.lastProcessedDocumentChangeId||0}),e=Math.min.apply(Math,t);return o.remoteDocumentCache.removeDocumentChangesThroughChangeId(n,e)}})})]);case 1:t.sent(),i.forEach(function(t){o.window.localStorage.removeItem(o.zombiedClientLocalStorageKey(t.clientId))}),t.label=2;case 2:return[2]}})})},hc.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var t=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(Ki.ClientMetadataRefresh,4e3,function(){return t.updateClientMetadataAndTryBecomePrimary().then(function(){return t.maybeGarbageCollectMultiClientState()}).then(function(){return t.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})},hc.prototype.isLocalClient=function(t){return!!t&&t.ownerId===this.clientId},hc.prototype.canActAsPrimary=function(e){var i=this;return fc(e).get(hu.key).next(function(t){if(null!==t&&i.isWithinAge(t.leaseTimestampMs,5e3)&&!i.isClientZombied(t.ownerId)){if(i.isLocalClient(t)&&i.networkEnabled)return!0;if(!i.isLocalClient(t)){if(!t.allowTabSynchronization)throw new Kr(Qr.FAILED_PRECONDITION,ac);return!1}}return!(!i.networkEnabled||!i.inForeground)||pc(e).loadAll().next(function(t){return void 0===i.filterActiveClients(t,5e3).find(function(t){if(i.clientId!==t.clientId){var e=!i.networkEnabled&&t.networkEnabled,n=!i.inForeground&&t.inForeground,r=i.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1})})}).next(function(t){return i.isPrimary!==t&&Or(ic,"Client "+(t?"is":"is not")+" eligible for a primary lease."),t})},hc.prototype.shutdown=function(){return p(this,void 0,void 0,function(){var e=this;return d(this,function(t){switch(t.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&(this.clientMetadataRefresher.cancel(),this.clientMetadataRefresher=null),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite",[hu.store,Pu.store],function(t){return e.releasePrimaryLeaseIfHeld(t).next(function(){return e.removeClientMetadata(t)})})];case 1:return t.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),[2]}})})},hc.prototype.filterActiveClients=function(t,e){var n=this;return t.filter(function(t){return n.isWithinAge(t.updateTimeMs,e)&&!n.isClientZombied(t.clientId)})},hc.prototype.getActiveClients=function(){var e=this;return this.simpleDb.runTransaction("readonly",[Pu.store],function(t){return pc(t).loadAll().next(function(t){return e.filterActiveClients(t,18e5).map(function(t){return t.clientId})})})},hc.clearPersistence=function(n){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:return hc.isAvailable()?(e=n+hc.MAIN_DATABASE,[4,Jo.delete(e)]):[2,Promise.resolve()];case 1:return t.sent(),[2]}})})},Object.defineProperty(hc.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),hc.prototype.getMutationQueue=function(t){return qr(this.started,"Cannot initialize MutationQueue before persistence is started."),Fo.forUser(t,this.serializer,this.indexManager,this.referenceDelegate)},hc.prototype.getQueryCache=function(){return qr(this.started,"Cannot initialize QueryCache before persistence is started."),this.queryCache},hc.prototype.getRemoteDocumentCache=function(){return qr(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},hc.prototype.getIndexManager=function(){return qr(this.started,"Cannot initialize IndexManager before persistence is started."),this.indexManager},hc.prototype.runTransaction=function(n,t,r){var i=this;return Or(ic,"Starting transaction:",n),this.simpleDb.runTransaction("readonly"===t?"readonly":"readwrite",Vu,function(e){return"readwrite-primary"===t?i.verifyPrimaryLease(e).next(function(t){if(!t)throw Lr("Failed to obtain primary lease for action '"+n+"'."),i.isPrimary=!1,i.queue.enqueueAndForget(function(){return i.primaryStateListener(!1)}),new Kr(Qr.FAILED_PRECONDITION,oc);return r(new sc(e,i.listenSequence.next()))}).next(function(t){return i.acquireOrExtendPrimaryLease(e).next(function(){return t})}):i.verifyAllowTabSynchronization(e).next(function(){return r(new sc(e,i.listenSequence.next()))})})},hc.prototype.verifyAllowTabSynchronization=function(t){var e=this;return fc(t).get(hu.key).next(function(t){if(null!==t&&e.isWithinAge(t.leaseTimestampMs,5e3)&&!e.isClientZombied(t.ownerId)&&!e.isLocalClient(t)&&!t.allowTabSynchronization)throw new Kr(Qr.FAILED_PRECONDITION,ac)})},hc.prototype.acquireOrExtendPrimaryLease=function(t){var e=new hu(this.clientId,this.allowTabSynchronization,Date.now());return fc(t).put(hu.key,e)},hc.isAvailable=function(){return Jo.isAvailable()},hc.buildStoragePrefix=function(t){var e=t.databaseId.projectId;return t.databaseId.isDefaultDatabase||(e+="."+t.databaseId.database),"firestore/"+t.persistenceKey+"/"+e+"/"},hc.prototype.releasePrimaryLeaseIfHeld=function(t){var e=this,n=fc(t);return n.get(hu.key).next(function(t){return e.isLocalClient(t)?(Or(ic,"Releasing primary lease."),n.delete(hu.key)):xo.resolve()})},hc.prototype.isWithinAge=function(t,e){var n=Date.now();return!(t<n-e||n<t&&(Lr("Detected an update time that is in the future: "+t+" > "+n),1))},hc.prototype.attachVisibilityHandler=function(){var t=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){t.queue.enqueueAndForget(function(){return t.inForeground="visible"===t.document.visibilityState,t.updateClientMetadataAndTryBecomePrimary()})},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},hc.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(qr(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},hc.prototype.attachWindowUnloadHook=function(){var t=this;"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){t.markClientZombied(),t.queue.enqueueAndForget(function(){return t.shutdown()})},this.window.addEventListener("unload",this.windowUnloadHandler))},hc.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(qr("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},hc.prototype.isClientZombied=function(t){try{var e=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(t));return Or(ic,"Client '"+t+"' "+(e?"is":"is not")+" zombied in LocalStorage"),e}catch(t){return Lr(ic,"Failed to get zombied client id.",t),!1}},hc.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(t){Lr("Failed to set zombie client id.",t)}},hc.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(t){}},hc.prototype.zombiedClientLocalStorageKey=function(t){return"firestore_zombie_"+this.persistenceKey+"_"+t},hc.MAIN_DATABASE="main",hc);function hc(t,e,n,r,i,o,a,s){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.queue=o,this.sequenceNumberSyncer=s,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.windowUnloadHandler=null,this.inForeground=!1,this.documentVisibilityHandler=null,this.clientMetadataRefresher=null,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(t){return Promise.resolve()},this.referenceDelegate=new dc(this,i),this.dbName=e+hc.MAIN_DATABASE,this.serializer=new Wu(a),this.document=r.document,this.queryCache=new ua(this.referenceDelegate,this.serializer),this.indexManager=new Bu,this.remoteDocumentCache=new Hs(this.serializer,this.indexManager,this.allowTabSynchronization),!r.window||!r.window.localStorage)throw new Kr(Qr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=r.window,this.webStorage=this.window.localStorage}function lc(e){return p(this,void 0,void 0,function(){return d(this,function(t){if(!function(t){return t.code===Qr.FAILED_PRECONDITION&&t.message===oc}(e))throw e;return Or(ic,"Unexpectedly lost primary lease"),[2]})})}function fc(t){return t.store(hu.store)}function pc(t){return t.store(Pu.store)}var dc=(mc.prototype.getSequenceNumberCount=function(t){var n=this.orphanedDocmentCount(t);return this.db.getQueryCache().getQueryCount(t).next(function(e){return n.next(function(t){return e+t})})},mc.prototype.orphanedDocmentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},mc.prototype.forEachTarget=function(t,e){return this.db.getQueryCache().forEachTarget(t,e)},mc.prototype.forEachOrphanedDocumentSequenceNumber=function(t,n){return this.forEachOrphanedDocument(t,function(t,e){return n(e)})},mc.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},mc.prototype.addReference=function(t,e){return yc(t,e)},mc.prototype.removeReference=function(t,e){return yc(t,e)},mc.prototype.removeTargets=function(t,e,n){return this.db.getQueryCache().removeTargets(t,e,n)},mc.prototype.removeMutationReference=function(t,e){return yc(t,e)},mc.prototype.isPinned=function(t,e){return this.inMemoryPins.containsKey(e)?xo.resolve(!0):function(e,n){var r=!1;return Wo(e).iterateSerial(function(t){return Bo(e,t,n).next(function(t){return t&&(r=!0),xo.resolve(!t)})}).next(function(){return r})}(t,e)},mc.prototype.removeOrphanedDocuments=function(r,i){var o=this,a=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[],u=0;return this.forEachOrphanedDocument(r,function(e,t){if(t<=i){var n=o.isPinned(r,e).next(function(t){if(!t)return u++,a.getEntry(r,e).next(function(){return a.removeEntry(e),pa(r).delete(function(t){return[0,to(t.path)]}(e))})});s.push(n)}}).next(function(){return xo.waitFor(s)}).next(function(){return a.apply(r)}).next(function(){return u})},mc.prototype.removeTarget=function(t,e){var n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getQueryCache().updateQueryData(t,n)},mc.prototype.updateLimboDocument=function(t,e){return yc(t,e)},mc.prototype.forEachOrphanedDocument=function(t,o){var a,e=pa(t),s=ki.INVALID;return e.iterate({index:Du.documentTargetsIndex},function(t,e){var n=t[0],r=(t[1],e.path),i=e.sequenceNumber;0===n?(s!==ki.INVALID&&o(new Ui(ro(a)),s),s=i,a=r):s=ki.INVALID}).next(function(){s!==ki.INVALID&&o(new Ui(ro(a)),s)})},mc.prototype.getCacheSize=function(t){return this.db.getRemoteDocumentCache().getSize(t)},mc);function mc(t,e){this.db=t,this.inMemoryPins=null,this.garbageCollector=new ec(this,e)}function yc(t,e){return pa(t).put(function(t,e){return new Du(0,to(t.path),e)}(e,t.currentSequenceNumber))}var gc=(vc.prototype.getDocument=function(e,n){var r=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(e,n).next(function(t){return r.getDocumentInternal(e,n,t)})},vc.prototype.getDocumentInternal=function(t,r,i){return this.remoteDocumentCache.getEntry(t,r).next(function(t){for(var e=0,n=i;e<n.length;e++)t=n[e].applyToLocalView(r,t);return t})},vc.prototype.applyLocalMutationsToDocuments=function(t,e,i){var o=To();return e.forEach(function(t,e){for(var n=0,r=i;n<r.length;n++)e=r[n].applyToLocalView(t,e);o=o.insert(t,e)}),o},vc.prototype.getDocuments=function(e,t){var n=this;return this.remoteDocumentCache.getEntries(e,t).next(function(t){return n.getLocalViewOfDocuments(e,t)})},vc.prototype.getLocalViewOfDocuments=function(r,i){var o=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(r,i).next(function(t){var e=o.applyLocalMutationsToDocuments(r,i,t),n=Eo();return e.forEach(function(t,e){e=e||new qs(t,ao.forDeletedDoc()),n=n.insert(t,e)}),n})},vc.prototype.getDocumentsMatchingQuery=function(t,e){return e.isDocumentQuery()?this.getDocumentsMatchingDocumentQuery(t,e.path):e.isCollectionGroupQuery()?this.getDocumentsMatchingCollectionGroupQuery(t,e):this.getDocumentsMatchingCollectionQuery(t,e)},vc.prototype.getDocumentsMatchingDocumentQuery=function(t,e){return this.getDocument(t,new Ui(e)).next(function(t){var e=Co();return t instanceof Ls&&(e=e.insert(t.key,t)),e})},vc.prototype.getDocumentsMatchingCollectionGroupQuery=function(n,r){var i=this;qr(r.path.isEmpty(),"Currently we only support collection group queries at the root.");var o=r.collectionGroup,a=Co();return this.indexManager.getCollectionParents(n,o).next(function(t){return xo.forEach(t,function(t){var e=r.asCollectionQueryAtPath(t.child(o));return i.getDocumentsMatchingCollectionQuery(n,e).next(function(t){t.forEach(function(t,e){a=a.insert(t,e)})})}).next(function(){return a})})},vc.prototype.getDocumentsMatchingCollectionQuery=function(e,n){var h,l,r=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(e,n).next(function(t){return h=t,r.mutationQueue.getAllMutationBatchesAffectingQuery(e,n)}).next(function(t){return l=t,r.addMissingBaseDocuments(e,l,h).next(function(t){h=t;for(var e=0,n=l;e<n.length;e++)for(var r=n[e],i=0,o=r.mutations;i<o.length;i++){var a=o[i],s=a.key,u=h.get(s),c=a.applyToLocalView(u,u,r.localWriteTime);h=c instanceof Ls?h.insert(s,c):h.remove(s)}})}).next(function(){return h.forEach(function(t,e){n.matches(e)||(h=h.remove(t))}),h})},vc.prototype.addMissingBaseDocuments=function(t,e,n){for(var r=ko(),i=0,o=e;i<o.length;i++)for(var a=0,s=o[i].mutations;a<s.length;a++){var u=s[a];u instanceof ka&&null===n.get(u.key)&&(r=r.add(u.key))}var c=n;return this.remoteDocumentCache.getEntries(t,r).next(function(t){return t.forEach(function(t,e){null!==e&&e instanceof Ls&&(c=c.insert(t,e))}),c})},vc);function vc(t,e,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.indexManager=n}var bc=(wc.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},wc.prototype.addReference=function(t,e){var n=new Sc(t,e);this.refsByKey=this.refsByKey.add(n),this.refsByTarget=this.refsByTarget.add(n)},wc.prototype.addReferences=function(t,e){var n=this;t.forEach(function(t){return n.addReference(t,e)})},wc.prototype.removeReference=function(t,e){this.removeRef(new Sc(t,e))},wc.prototype.removeReferences=function(t,e){var n=this;t.forEach(function(t){return n.removeReference(t,e)})},wc.prototype.removeReferencesForId=function(t){var e=this,n=Ui.EMPTY,r=new Sc(n,t),i=new Sc(n,t+1),o=[];return this.refsByTarget.forEachInRange([r,i],function(t){e.removeRef(t),o.push(t.key)}),o},wc.prototype.removeAllReferences=function(){var e=this;this.refsByKey.forEach(function(t){return e.removeRef(t)})},wc.prototype.removeRef=function(t){this.refsByKey=this.refsByKey.delete(t),this.refsByTarget=this.refsByTarget.delete(t)},wc.prototype.referencesForId=function(t){var e=Ui.EMPTY,n=new Sc(e,t),r=new Sc(e,t+1),i=ko();return this.refsByTarget.forEachInRange([n,r],function(t){i=i.add(t.key)}),i},wc.prototype.containsKey=function(t){var e=new Sc(t,0),n=this.refsByKey.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)},wc);function wc(){this.refsByKey=new go(Sc.compareByKey),this.refsByTarget=new go(Sc.compareByTargetId)}var Sc=(Ec.compareByKey=function(t,e){return Ui.comparator(t.key,e.key)||gi(t.targetOrBatchId,e.targetOrBatchId)},Ec.compareByTargetId=function(t,e){return gi(t.targetOrBatchId,e.targetOrBatchId)||Ui.comparator(t.key,e.key)},Ec);function Ec(t,e){this.key=t,this.targetOrBatchId=e}var Tc="LocalStore",Ic=(Cc.prototype.handleUserChange=function(e){var y=this;return this.persistence.runTransaction("Handle user change","readonly",function(d){var m;return y.mutationQueue.getAllMutationBatches(d).next(function(t){return m=t,y.mutationQueue=y.persistence.getMutationQueue(e),y.localDocuments=new gc(y.remoteDocuments,y.mutationQueue,y.persistence.getIndexManager()),y.mutationQueue.getAllMutationBatches(d)}).next(function(t){for(var e=[],n=[],r=ko(),i=0,o=m;i<o.length;i++){var a=o[i];e.push(a.batchId);for(var s=0,u=a.mutations;s<u.length;s++){var c=u[s];r=r.add(c.key)}}for(var h=0,l=t;h<l.length;h++){a=l[h],n.push(a.batchId);for(var f=0,p=a.mutations;f<p.length;f++)c=p[f],r=r.add(c.key)}return y.localDocuments.getDocuments(d,r).next(function(t){return{affectedDocuments:t,removedBatchIds:e,addedBatchIds:n}})})})},Cc.prototype.localWrite=function(s){var u=this,c=io.now(),t=s.reduce(function(t,e){return t.add(e.key)},ko());return this.persistence.runTransaction("Locally write mutations","readwrite",function(a){return u.localDocuments.getDocuments(a,t).next(function(n){for(var t=[],e=0,r=s;e<r.length;e++){var i=r[e],o=i.extractBaseValue(n.get(i.key));null!=o&&t.push(new ka(i.key,o,o.fieldMask(),Sa.exists(!0)))}return u.mutationQueue.addMutationBatch(a,c,t,s).next(function(t){var e=t.applyToLocalDocumentSet(n);return{batchId:t.batchId,changes:e}})})})},Cc.prototype.lookupMutationDocuments=function(t){var n=this;return this.persistence.runTransaction("Lookup mutation documents","readonly",function(e){return n.mutationQueue.lookupMutationKeys(e,t).next(function(t){return t?n.localDocuments.getDocuments(e,t):xo.resolve(null)})})},Cc.prototype.acknowledgeBatch=function(r){var i=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(t){var e=r.batch.keys(),n=i.remoteDocuments.newChangeBuffer();return i.mutationQueue.acknowledgeBatch(t,r.batch,r.streamToken).next(function(){return i.applyWriteToRemoteDocuments(t,r,n)}).next(function(){return n.apply(t)}).next(function(){return i.mutationQueue.performConsistencyCheck(t)}).next(function(){return i.localDocuments.getDocuments(t,e)})})},Cc.prototype.rejectBatch=function(t){var r=this;return this.persistence.runTransaction("Reject batch","readwrite-primary",function(e){var n;return r.mutationQueue.lookupMutationBatch(e,t).next(function(t){return qr(null!==t,"Attempt to reject nonexistent batch!"),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t)}).next(function(){return r.mutationQueue.performConsistencyCheck(e)}).next(function(){return r.localDocuments.getDocuments(e,n)})})},Cc.prototype.getHighestUnacknowledgedBatchId=function(){var e=this;return this.persistence.runTransaction("Get highest unacknowledged batch id","readonly",function(t){return e.mutationQueue.getHighestUnacknowledgedBatchId(t)})},Cc.prototype.getLastStreamToken=function(){var e=this;return this.persistence.runTransaction("Get last stream token","readonly",function(t){return e.mutationQueue.getLastStreamToken(t)})},Cc.prototype.setLastStreamToken=function(e){var n=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary",function(t){return n.mutationQueue.setLastStreamToken(t,e)})},Cc.prototype.getLastRemoteSnapshotVersion=function(){var e=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly",function(t){return e.queryCache.getLastRemoteSnapshotVersion(t)})},Cc.prototype.applyRemoteEvent=function(s){var u=this,c=this.remoteDocuments.newChangeBuffer(),h=s.snapshotVersion;return this.persistence.runTransaction("Apply remote event","readwrite-primary",function(o){var a=[];Hr(s.targetChanges,function(t,e){var n=u.queryDataByTarget[t];if(n){a.push(u.queryCache.removeMatchingKeys(o,e.removedDocuments,t).next(function(){return u.queryCache.addMatchingKeys(o,e.addedDocuments,t)}));var r=e.resumeToken;if(0<r.length){var i=n.withResumeToken(r,h);u.queryDataByTarget[t]=i,Cc.shouldPersistQueryData(n,i,e)&&a.push(u.queryCache.updateQueryData(o,i))}}});var i=Eo(),n=ko();if(s.documentUpdates.forEach(function(t,e){n=n.add(t)}),a.push(c.getEntries(o,n).next(function(r){s.documentUpdates.forEach(function(t,e){var n=r.get(t);e instanceof qs&&e.version.isEqual(ao.MIN)?(c.removeEntry(t),i=i.insert(t,e)):null==n||0<e.version.compareTo(n.version)||0===e.version.compareTo(n.version)&&n.hasPendingWrites?(ao.MIN.isEqual(s.snapshotVersion)&&Lr(Tc,"Cannot add a document when the remote version is zero"),c.addEntry(e),i=i.insert(t,e)):Or(Tc,"Ignoring outdated watch update for ",t,". Current version:",n.version," Watch version:",e.version),s.resolvedLimboDocuments.has(t)&&a.push(u.persistence.referenceDelegate.updateLimboDocument(o,t))})})),!h.isEqual(ao.MIN)){var t=u.queryCache.getLastRemoteSnapshotVersion(o).next(function(t){return qr(0<=h.compareTo(t),"Watch stream reverted to previous snapshot?? "+h+" < "+t),u.queryCache.setTargetsMetadata(o,o.currentSequenceNumber,h)});a.push(t)}return xo.waitFor(a).next(function(){return c.apply(o)}).next(function(){return u.localDocuments.getLocalViewOfDocuments(o,i)})})},Cc.shouldPersistQueryData=function(t,e,n){return qr(0<e.resumeToken.length,"Attempted to persist query data with no resume token"),0===t.resumeToken.length||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS||0<n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size},Cc.prototype.notifyLocalViewChanges=function(t){var n=this;return this.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(e){return xo.forEach(t,function(t){return n.localViewReferences.addReferences(t.addedKeys,t.targetId),n.localViewReferences.removeReferences(t.removedKeys,t.targetId),xo.forEach(t.removedKeys,function(t){return n.persistence.referenceDelegate.removeReference(e,t)})})})},Cc.prototype.nextMutationBatch=function(e){var n=this;return this.persistence.runTransaction("Get next mutation batch","readonly",function(t){return void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e)})},Cc.prototype.readDocument=function(e){var n=this;return this.persistence.runTransaction("read document","readonly",function(t){return n.localDocuments.getDocument(t,e)})},Cc.prototype.allocateQuery=function(r){var i=this;return this.persistence.runTransaction("Allocate query","readwrite",function(e){var n;return i.queryCache.getQueryData(e,r).next(function(t){return t?(n=t,xo.resolve()):i.queryCache.allocateTargetId(e).next(function(t){return n=new Ku(r,t,qu.Listen,e.currentSequenceNumber),i.queryCache.addQueryData(e,n)})}).next(function(){return qr(!i.queryDataByTarget[n.targetId],"Tried to allocate an already allocated query: "+r),i.queryDataByTarget[n.targetId]=n})})},Cc.prototype.releaseQuery=function(o,a){var s=this,t=a?"readwrite":"readwrite-primary";return this.persistence.runTransaction("Release query",t,function(i){return s.queryCache.getQueryData(i,o).next(function(t){qr(null!=t,"Tried to release nonexistent query: "+o);var e=t.targetId,n=s.queryDataByTarget[e],r=s.localViewReferences.removeReferencesForId(e);return delete s.queryDataByTarget[e],a?xo.resolve():xo.forEach(r,function(t){return s.persistence.referenceDelegate.removeReference(i,t)}).next(function(){return s.persistence.referenceDelegate.removeTarget(i,n)})})})},Cc.prototype.executeQuery=function(e){var n=this;return this.persistence.runTransaction("Execute query","readonly",function(t){return n.localDocuments.getDocumentsMatchingQuery(t,e)})},Cc.prototype.remoteDocumentKeys=function(e){var n=this;return this.persistence.runTransaction("Remote document keys","readonly",function(t){return n.queryCache.getMatchingKeysForTargetId(t,e)})},Cc.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},Cc.prototype.removeCachedMutationBatchMetadata=function(t){this.mutationQueue.removeCachedMutationKeys(t)},Cc.prototype.setNetworkEnabled=function(t){this.persistence.setNetworkEnabled(t)},Cc.prototype.applyWriteToRemoteDocuments=function(t,i,o){var e=this,a=i.batch,n=a.keys(),s=xo.resolve();return n.forEach(function(r){s=s.next(function(){return o.getEntry(t,r)}).next(function(t){var e=t,n=i.docVersions.get(r);qr(null!==n,"ackVersions should contain every doc in the write."),(!e||e.version.compareTo(n)<0)&&((e=a.applyToRemoteDocument(r,e,i))?o.addEntry(e):qr(!t,"Mutation batch "+a+" applied to document "+t+" resulted in null"))})}),s.next(function(){return e.mutationQueue.removeMutationBatch(t,a)})},Cc.prototype.collectGarbage=function(e){var n=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(t){return e.collect(t,n.queryDataByTarget)})},Cc.prototype.getQueryForTarget=function(e){var n=this;return this.queryDataByTarget[e]?Promise.resolve(this.queryDataByTarget[e].query):this.persistence.runTransaction("Get query data","readonly",function(t){return n.queryCache.getQueryDataForTarget(t,e).next(function(t){return t?t.query:null})})},Cc.prototype.getNewDocumentChanges=function(){var e=this;return this.persistence.runTransaction("Get new document changes","readonly",function(t){return e.remoteDocuments.getNewDocumentChanges(t)})},Cc.RESUME_TOKEN_MAX_AGE_MICROS=3e8,Cc);function Cc(t,e){this.persistence=t,this.localViewReferences=new bc,this.queryDataByTarget={},qr(t.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=t.getMutationQueue(e),this.remoteDocuments=t.getRemoteDocumentCache(),this.queryCache=t.getQueryCache(),this.localDocuments=new gc(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager())}var Dc=(Nc.prototype.checkEmpty=function(t){return xo.resolve(0===this.mutationQueue.length)},Nc.prototype.acknowledgeBatch=function(t,e,n){var r=e.batchId,i=this.indexOfExistingBatchId(r,"acknowledged");qr(0===i,"Can only acknowledge the first batch in the mutation queue");var o=this.mutationQueue[i];return qr(r===o.batchId,"Queue ordering failure: expected batch "+r+", got batch "+o.batchId),this.lastStreamToken=n,xo.resolve()},Nc.prototype.getLastStreamToken=function(t){return xo.resolve(this.lastStreamToken)},Nc.prototype.setLastStreamToken=function(t,e){return this.lastStreamToken=e,xo.resolve()},Nc.prototype.addMutationBatch=function(t,e,n,r){qr(0!==r.length,"Mutation batches should not be empty");var i=this.nextBatchId;this.nextBatchId++,0<this.mutationQueue.length&&qr(this.mutationQueue[this.mutationQueue.length-1].batchId<i,"Mutation batchIDs must be monotonically increasing order");var o=new _o(i,e,n,r);this.mutationQueue.push(o);for(var a=0,s=r;a<s.length;a++){var u=s[a];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new Sc(u.key,i)),this.indexManager.addToCollectionParentIndex(t,u.key.path.popLast())}return xo.resolve(o)},Nc.prototype.lookupMutationBatch=function(t,e){return xo.resolve(this.findMutationBatch(e))},Nc.prototype.lookupMutationKeys=function(t,e){var n=this.findMutationBatch(e);return qr(null!=n,"Failed to find local mutation batch."),xo.resolve(n.keys())},Nc.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=e+1,r=this.indexOfBatchId(n),i=r<0?0:r;return xo.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)},Nc.prototype.getHighestUnacknowledgedBatchId=function(){return xo.resolve(0===this.mutationQueue.length?-1:this.nextBatchId-1)},Nc.prototype.getAllMutationBatches=function(t){return xo.resolve(this.mutationQueue.slice())},Nc.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,n){var r=this,e=new Sc(n,0),i=new Sc(n,Number.POSITIVE_INFINITY),o=[];return this.batchesByDocumentKey.forEachInRange([e,i],function(t){qr(n.isEqual(t.key),"Should only iterate over a single key's batches");var e=r.findMutationBatch(t.targetOrBatchId);qr(null!==e,"Batches in the index must exist in the main table"),o.push(e)}),xo.resolve(o)},Nc.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var r=this,i=new go(gi);return e.forEach(function(e){var t=new Sc(e,0),n=new Sc(e,Number.POSITIVE_INFINITY);r.batchesByDocumentKey.forEachInRange([t,n],function(t){qr(e.isEqual(t.key),"For each key, should only iterate over a single key's batches"),i=i.add(t.targetOrBatchId)})}),xo.resolve(this.findMutationBatches(i))},Nc.prototype.getAllMutationBatchesAffectingQuery=function(t,e){qr(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var n=e.path,r=n.length+1,i=n;Ui.isDocumentKey(i)||(i=i.child(""));var o=new Sc(new Ui(i),0),a=new go(gi);return this.batchesByDocumentKey.forEachWhile(function(t){var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(a=a.add(t.targetOrBatchId)),!0)},o),xo.resolve(this.findMutationBatches(a))},Nc.prototype.findMutationBatches=function(t){var n=this,r=[];return t.forEach(function(t){var e=n.findMutationBatch(t);null!==e&&r.push(e)}),r},Nc.prototype.removeMutationBatch=function(n,r){var i=this;qr(0===this.indexOfExistingBatchId(r.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var o=this.batchesByDocumentKey;return xo.forEach(r.mutations,function(t){var e=new Sc(t.key,r.batchId);return o=o.delete(e),i.referenceDelegate.removeMutationReference(n,t.key)}).next(function(){i.batchesByDocumentKey=o})},Nc.prototype.removeCachedMutationKeys=function(t){},Nc.prototype.containsKey=function(t,e){var n=new Sc(e,0),r=this.batchesByDocumentKey.firstAfterOrEqual(n);return xo.resolve(e.isEqual(r&&r.key))},Nc.prototype.performConsistencyCheck=function(t){return 0===this.mutationQueue.length&&qr(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),xo.resolve()},Nc.prototype.indexOfExistingBatchId=function(t,e){var n=this.indexOfBatchId(t);return qr(0<=n&&n<this.mutationQueue.length,"Batches must exist to be "+e),n},Nc.prototype.indexOfBatchId=function(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId},Nc.prototype.findMutationBatch=function(t){var e=this.indexOfBatchId(t);if(e<0||e>=this.mutationQueue.length)return null;var n=this.mutationQueue[e];return qr(n.batchId===t,"If found batch must match"),n},Nc);function Nc(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.nextBatchId=1,this.lastStreamToken=Br(),this.batchesByDocumentKey=new go(Sc.compareByKey)}var Ac=(kc.prototype.getTargetCount=function(t){return xo.resolve(this.targetCount)},kc.prototype.forEachTarget=function(t,n){return this.queries.forEach(function(t,e){return n(e)}),xo.resolve()},kc.prototype.getLastRemoteSnapshotVersion=function(t){return xo.resolve(this.lastRemoteSnapshotVersion)},kc.prototype.getHighestSequenceNumber=function(t){return xo.resolve(this.highestSequenceNumber)},kc.prototype.allocateTargetId=function(t){var e=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=e,xo.resolve(e)},kc.prototype.setTargetsMetadata=function(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.highestSequenceNumber&&(this.highestSequenceNumber=e),xo.resolve()},kc.prototype.saveQueryData=function(t){this.queries.set(t.query,t);var e=t.targetId;e>this.highestTargetId&&(this.highestTargetId=e),t.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=t.sequenceNumber)},kc.prototype.addQueryData=function(t,e){return qr(!this.queries.has(e.query),"Adding a query that already exists"),this.saveQueryData(e),this.targetCount+=1,xo.resolve()},kc.prototype.updateQueryData=function(t,e){return qr(this.queries.has(e.query),"Updating a non-existent query"),this.saveQueryData(e),xo.resolve()},kc.prototype.removeQueryData=function(t,e){return qr(0<this.targetCount,"Removing a target from an empty cache"),qr(this.queries.has(e.query),"Removing a non-existent target from the cache"),this.queries.delete(e.query),this.references.removeReferencesForId(e.targetId),this.targetCount-=1,xo.resolve()},kc.prototype.removeTargets=function(n,r,i){var o=this,a=0,s=[];return this.queries.forEach(function(t,e){e.sequenceNumber<=r&&!i[e.targetId]&&(o.queries.delete(t),s.push(o.removeMatchingKeysForTargetId(n,e.targetId)),a++)}),xo.waitFor(s).next(function(){return a})},kc.prototype.getQueryCount=function(t){return xo.resolve(this.targetCount)},kc.prototype.getQueryData=function(t,e){var n=this.queries.get(e)||null;return xo.resolve(n)},kc.prototype.getQueryDataForTarget=function(t,e){return xr("Not yet implemented.")},kc.prototype.addMatchingKeys=function(e,t,n){this.references.addReferences(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(function(t){i.push(r.addReference(e,t))}),xo.waitFor(i)},kc.prototype.removeMatchingKeys=function(e,t,n){this.references.removeReferences(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(function(t){i.push(r.removeReference(e,t))}),xo.waitFor(i)},kc.prototype.removeMatchingKeysForTargetId=function(t,e){return this.references.removeReferencesForId(e),xo.resolve()},kc.prototype.getMatchingKeysForTargetId=function(t,e){var n=this.references.referencesForId(e);return xo.resolve(n)},kc.prototype.containsKey=function(t,e){return xo.resolve(this.references.containsKey(e))},kc);function kc(t){this.persistence=t,this.queries=new Qs(function(t){return t.canonicalId()}),this.lastRemoteSnapshotVersion=ao.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new bc,this.targetCount=0,this.targetIdGenerator=Ho.forQueryCache()}var Rc,Mc=(_c.prototype.addEntry=function(t,e){var n=e.key,r=this.docs.get(n),i=r?r.size:0,o=this.sizer(e);return this.docs=this.docs.insert(n,{maybeDocument:e,size:o}),this.newDocumentChanges=this.newDocumentChanges.add(n),this.size+=o-i,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())},_c.prototype.removeEntry=function(t){var e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)},_c.prototype.getEntry=function(t,e){var n=this.docs.get(e);return xo.resolve(n?n.maybeDocument:null)},_c.prototype.getEntries=function(t,e){var n=this,r=To();return e.forEach(function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null)}),xo.resolve(r)},_c.prototype.getDocumentsMatchingQuery=function(t,e){qr(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");for(var n=Co(),r=new Ui(e.path.child("")),i=this.docs.getIteratorFrom(r);i.hasNext();){var o=i.getNext(),a=o.key,s=o.value.maybeDocument;if(!e.path.isPrefixOf(a.path))break;s instanceof Ls&&e.matches(s)&&(n=n.insert(s.key,s))}return xo.resolve(n)},_c.prototype.forEachDocumentKey=function(t,e){return xo.forEach(this.docs,function(t){return e(t)})},_c.prototype.getNewDocumentChanges=function(t){var r=this,i=Eo();return this.newDocumentChanges.forEach(function(t){var e=r.docs.get(t),n=e?e.maybeDocument:new qs(t,ao.forDeletedDoc());i=i.insert(t,n)}),this.newDocumentChanges=ko(),xo.resolve(i)},_c.prototype.newChangeBuffer=function(){return new _c.RemoteDocumentChangeBuffer(this)},_c.prototype.getSize=function(t){return xo.resolve(this.size)},_c.RemoteDocumentChangeBuffer=(s(Oc,Rc=js),Oc.prototype.applyChanges=function(n){var r=this,i=[];return this.changes.forEach(function(t,e){e?i.push(r.documentCache.addEntry(n,e)):r.documentCache.removeEntry(t)}),xo.waitFor(i)},Oc.prototype.getFromCache=function(t,e){return this.documentCache.getEntry(t,e)},Oc.prototype.getAllFromCache=function(t,e){return this.documentCache.getEntries(t,e)},Oc),_c);function _c(t,e){this.indexManager=t,this.sizer=e,this.docs=new uo(Ui.comparator),this.newDocumentChanges=ko(),this.size=0}function Oc(t){var e=Rc.call(this)||this;return e.documentCache=t,e}var Lc=(Pc.createLruPersistence=function(t,e,n){return new Pc(t,function(t){return new Vc(t,new Wu(e),n)})},Pc.createEagerPersistence=function(t){return new Pc(t,function(t){return new qc(t)})},Pc.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(Pc.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),Pc.prototype.getActiveClients=function(){return p(this,void 0,void 0,function(){return d(this,function(t){return[2,[this.clientId]]})})},Pc.prototype.setPrimaryStateListener=function(t){return t(!0)},Pc.prototype.setDatabaseDeletedListener=function(){},Pc.prototype.setNetworkEnabled=function(t){},Pc.prototype.getIndexManager=function(){return this.indexManager},Pc.prototype.getMutationQueue=function(t){var e=this.mutationQueues[t.toKey()];return e||(e=new Dc(this.indexManager,this.referenceDelegate),this.mutationQueues[t.toKey()]=e),e},Pc.prototype.getQueryCache=function(){return this.queryCache},Pc.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},Pc.prototype.runTransaction=function(t,e,n){var r=this;Or("MemoryPersistence","Starting transaction:",t);var i=new xc(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),n(i).next(function(t){return r.referenceDelegate.onTransactionCommitted(i).next(function(){return t})}).toPromise()},Pc.prototype.mutationQueuesContainKey=function(e,n){return xo.or(function(t){var n=[];return Yr(t,function(t,e){return n.push(e)}),n}(this.mutationQueues).map(function(t){return function(){return t.containsKey(e,n)}}))},Pc);function Pc(t,e){var n=this;this.clientId=t,this.mutationQueues={},this.listenSequence=new ki(0),this._started=!1,this._started=!0,this.referenceDelegate=e(this),this.queryCache=new Ac(this);this.indexManager=new nu,this.remoteDocumentCache=new Mc(this.indexManager,function(t){return n.referenceDelegate.documentSize(t)})}var xc=function(t){this.currentSequenceNumber=t},qc=(Object.defineProperty(Fc.prototype,"orphanedDocuments",{get:function(){if(this._orphanedDocuments)return this._orphanedDocuments;throw xr("orphanedDocuments is only valid during a transaction.")},enumerable:!0,configurable:!0}),Fc.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},Fc.prototype.addReference=function(t,e){return this.orphanedDocuments.delete(e),xo.resolve()},Fc.prototype.removeReference=function(t,e){return this.orphanedDocuments.add(e),xo.resolve()},Fc.prototype.removeMutationReference=function(t,e){return this.orphanedDocuments.add(e),xo.resolve()},Fc.prototype.removeTarget=function(t,e){var n=this,r=this.persistence.getQueryCache();return r.getMatchingKeysForTargetId(t,e.targetId).next(function(t){t.forEach(function(t){return n.orphanedDocuments.add(t)})}).next(function(){return r.removeQueryData(t,e)})},Fc.prototype.onTransactionStarted=function(){this._orphanedDocuments=new Set},Fc.prototype.onTransactionCommitted=function(t){var n=this,r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return xo.forEach(this.orphanedDocuments,function(e){return n.isReferenced(t,e).next(function(t){t||r.removeEntry(e)})}).next(function(){return n._orphanedDocuments=null,r.apply(t)})},Fc.prototype.updateLimboDocument=function(t,e){var n=this;return this.isReferenced(t,e).next(function(t){t?n.orphanedDocuments.delete(e):n.orphanedDocuments.add(e)})},Fc.prototype.documentSize=function(t){return 0},Fc.prototype.isReferenced=function(t,e){var n=this;return xo.or([function(){return n.persistence.getQueryCache().containsKey(t,e)},function(){return n.persistence.mutationQueuesContainKey(t,e)},function(){return xo.resolve(n.inMemoryPins.containsKey(e))}])},Fc);function Fc(t){this.persistence=t,this.inMemoryPins=null,this._orphanedDocuments=null}var Vc=(Bc.prototype.onTransactionStarted=function(){},Bc.prototype.onTransactionCommitted=function(t){return xo.resolve()},Bc.prototype.forEachTarget=function(t,e){return this.persistence.getQueryCache().forEachTarget(t,e)},Bc.prototype.getSequenceNumberCount=function(t){var n=this.orphanedDocumentCount(t);return this.persistence.getQueryCache().getTargetCount(t).next(function(e){return n.next(function(t){return e+t})})},Bc.prototype.orphanedDocumentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},Bc.prototype.forEachOrphanedDocumentSequenceNumber=function(n,r){var i=this;return xo.forEach(this.orphanedSequenceNumbers,function(t,e){return i.isPinned(n,t,e).next(function(t){return t?xo.resolve():r(e)})})},Bc.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},Bc.prototype.removeTargets=function(t,e,n){return this.persistence.getQueryCache().removeTargets(t,e,n)},Bc.prototype.removeOrphanedDocuments=function(t,n){var r=this,i=0,e=this.persistence.getRemoteDocumentCache(),o=e.newChangeBuffer();return e.forEachDocumentKey(t,function(e){return r.isPinned(t,e,n).next(function(t){t||(i++,o.removeEntry(e))})}).next(function(){return o.apply(t)}).next(function(){return i})},Bc.prototype.removeMutationReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),xo.resolve()},Bc.prototype.removeTarget=function(t,e){var n=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getQueryCache().updateQueryData(t,n)},Bc.prototype.addReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),xo.resolve()},Bc.prototype.removeReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),xo.resolve()},Bc.prototype.updateLimboDocument=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),xo.resolve()},Bc.prototype.documentSize=function(t){var e,n=this.serializer.toDbRemoteDocument(t);if(n.document)e=n.document;else if(n.unknownDocument)e=n.unknownDocument;else{if(!n.noDocument)throw xr("Unknown remote document type");e=n.noDocument}return JSON.stringify(e).length},Bc.prototype.isPinned=function(t,e,n){var r=this;return xo.or([function(){return r.persistence.mutationQueuesContainKey(t,e)},function(){return xo.resolve(r.inMemoryPins.containsKey(e))},function(){return r.persistence.getQueryCache().containsKey(t,e)},function(){var t=r.orphanedSequenceNumbers.get(e);return xo.resolve(void 0!==t&&n<t)}])},Bc.prototype.getCacheSize=function(t){return this.persistence.getRemoteDocumentCache().getSize(t)},Bc);function Bc(t,e,n){this.persistence=t,this.serializer=e,this.inMemoryPins=null,this.orphanedSequenceNumbers=new Qs(function(t){return to(t.path)}),this.garbageCollector=new ec(this,n)}var Uc=Number,Qc=Uc.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),Kc=Uc.MAX_SAFE_INTEGER||Math.pow(2,53)-1,jc=Uc.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t};function Wc(t){return null==t}function Gc(t){return jc(t)&&t<=Kc&&Qc<=t}var zc=(Hc.prototype.reset=function(){this.currentBaseMs=0},Hc.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},Hc.prototype.backoffAndRun=function(t){var e=this;this.cancel();var n=Math.floor(this.currentBaseMs+this.jitterDelayMs()),r=Math.max(0,Date.now()-this.lastAttemptTime),i=Math.max(0,n-r);0<this.currentBaseMs&&Or("ExponentialBackoff","Backing off for "+i+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,i,function(){return e.lastAttemptTime=Date.now(),t()}),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},Hc.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},Hc.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},Hc);function Hc(t,e,n,r,i){void 0===n&&(n=1e3),void 0===r&&(r=1.5),void 0===i&&(i=6e4),this.queue=t,this.timerId=e,this.initialDelayMs=n,this.backoffFactor=r,this.maxDelayMs=i,this.currentBaseMs=0,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}var Yc,Xc,Jc="PersistentStream";(Xc=Yc=Yc||{})[Xc.Initial=0]="Initial",Xc[Xc.Starting=1]="Starting",Xc[Xc.Open=2]="Open",Xc[Xc.Error=3]="Error",Xc[Xc.Backoff=4]="Backoff";var $c=(Zc.prototype.isStarted=function(){return this.state===Yc.Starting||this.state===Yc.Open||this.state===Yc.Backoff},Zc.prototype.isOpen=function(){return this.state===Yc.Open},Zc.prototype.start=function(){this.state!==Yc.Error?(qr(this.state===Yc.Initial,"Already started"),this.auth()):this.performBackoff()},Zc.prototype.stop=function(){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.isStarted()?[4,this.close(Yc.Initial)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},Zc.prototype.inhibitBackoff=function(){qr(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=Yc.Initial,this.backoff.reset()},Zc.prototype.markIdle=function(){var t=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,function(){return t.handleIdleCloseTimer()}))},Zc.prototype.sendRequest=function(t){this.cancelIdleCheck(),this.stream.send(t)},Zc.prototype.handleIdleCloseTimer=function(){return p(this,void 0,void 0,function(){return d(this,function(t){return this.isOpen()?[2,this.close(Yc.Initial)]:[2]})})},Zc.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},Zc.prototype.close=function(e,n){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return qr(this.isStarted(),"Only started streams should be closed."),qr(e===Yc.Error||Wc(n),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,e!==Yc.Error?this.backoff.reset():n&&n.code===Qr.RESOURCE_EXHAUSTED?(Lr(n.toString()),Lr("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):n&&n.code===Qr.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=e,[4,this.listener.onClose(n)];case 1:return t.sent(),[2]}})})},Zc.prototype.tearDown=function(){},Zc.prototype.auth=function(){var n=this;qr(this.state===Yc.Initial,"Must be in initial state to auth"),this.state=Yc.Starting;var t=this.getCloseGuardedDispatcher(this.closeCount),e=this.closeCount;this.credentialsProvider.getToken().then(function(t){n.closeCount===e&&n.startStream(t)},function(e){t(function(){var t=new Kr(Qr.UNKNOWN,"Fetching auth token failed: "+e.message);return n.handleStreamClose(t)})})},Zc.prototype.startStream=function(t){var e=this;qr(this.state===Yc.Starting,"Trying to start stream in a non-starting state");var n=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(t),this.stream.onOpen(function(){n(function(){return qr(e.state===Yc.Starting,"Expected stream to be in state Starting, but was "+e.state),e.state=Yc.Open,e.listener.onOpen()})}),this.stream.onClose(function(t){n(function(){return e.handleStreamClose(t)})}),this.stream.onMessage(function(t){n(function(){return e.onMessage(t)})})},Zc.prototype.performBackoff=function(){var t=this;qr(this.state===Yc.Error,"Should only perform backoff when in Error state"),this.state=Yc.Backoff,this.backoff.backoffAndRun(function(){return p(t,void 0,void 0,function(){return d(this,function(t){return qr(this.state===Yc.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=Yc.Initial,this.start(),qr(this.isStarted(),"PersistentStream should have started"),[2]})})})},Zc.prototype.handleStreamClose=function(t){return qr(this.isStarted(),"Can't handle server close on non-started stream"),Or(Jc,"close with error: "+t),this.stream=null,this.close(Yc.Error,t)},Zc.prototype.getCloseGuardedDispatcher=function(e){var n=this;return function(t){n.queue.enqueueAndForget(function(){return n.closeCount===e?t():(Or(Jc,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},Zc);function Zc(t,e,n,r,i,o){this.queue=t,this.idleTimerId=n,this.connection=r,this.credentialsProvider=i,this.listener=o,this.state=Yc.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new zc(t,e)}var th,eh=(s(nh,th=$c),nh.prototype.startRpc=function(t){return this.connection.openStream("Listen",t)},nh.prototype.onMessage=function(t){this.backoff.reset();var e=this.serializer.fromWatchChange(t),n=this.serializer.versionFromListenResponse(t);return this.listener.onWatchChange(e,n)},nh.prototype.watch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.addTarget=this.serializer.toTarget(t);var n=this.serializer.toListenRequestLabels(t);n&&(e.labels=n),this.sendRequest(e)},nh.prototype.unwatch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.removeTarget=t,this.sendRequest(e)},nh);function nh(t,e,n,r,i){var o=th.call(this,t,Ki.ListenStreamConnectionBackoff,Ki.ListenStreamIdle,e,n,i)||this;return o.serializer=r,o}var rh,ih=(s(oh,rh=$c),Object.defineProperty(oh.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),oh.prototype.start=function(){this.handshakeComplete_=!1,rh.prototype.start.call(this)},oh.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},oh.prototype.startRpc=function(t){return this.connection.openStream("Write",t)},oh.prototype.onMessage=function(t){if(qr(!!t.streamToken,"Got a write response without a stream token"),this.lastStreamToken=t.streamToken,this.handshakeComplete_){this.backoff.reset();var e=this.serializer.fromWriteResults(t.writeResults,t.commitTime),n=this.serializer.fromVersion(t.commitTime);return this.listener.onMutationResult(n,e)}return qr(!t.writeResults||0===t.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},oh.prototype.writeHandshake=function(){qr(this.isOpen(),"Writing handshake requires an opened stream"),qr(!this.handshakeComplete_,"Handshake already completed");var t={};t.database=this.serializer.encodedDatabaseId,this.sendRequest(t)},oh.prototype.writeMutations=function(t){var e=this;qr(this.isOpen(),"Writing mutations requires an opened stream"),qr(this.handshakeComplete_,"Handshake must be complete before writing mutations"),qr(0<this.lastStreamToken.length,"Trying to write mutation without a token");var n={streamToken:this.lastStreamToken,writes:t.map(function(t){return e.serializer.toMutation(t)})};this.sendRequest(n)},oh);function oh(t,e,n,r,i){var o=rh.call(this,t,Ki.WriteStreamConnectionBackoff,Ki.WriteStreamIdle,e,n,i)||this;return o.serializer=r,o.handshakeComplete_=!1,o.lastStreamToken=Br(),o}var ah=(sh.prototype.newPersistentWriteStream=function(t){return new ih(this.queue,this.connection,this.credentials,this.serializer,t)},sh.prototype.newPersistentWatchStream=function(t){return new eh(this.queue,this.connection,this.credentials,this.serializer,t)},sh.prototype.commit=function(t){var e=this,n={database:this.serializer.encodedDatabaseId,writes:t.map(function(t){return e.serializer.toMutation(t)})};return this.invokeRPC("Commit",n).then(function(t){return e.serializer.fromWriteResults(t.writeResults,t.commitTime)})},sh.prototype.lookup=function(e){var i=this,t={database:this.serializer.encodedDatabaseId,documents:e.map(function(t){return i.serializer.toName(t)})};return this.invokeStreamingRPC("BatchGetDocuments",t).then(function(t){var n=Eo();t.forEach(function(t){var e=i.serializer.fromMaybeDocument(t);n=n.insert(e.key,e)});var r=[];return e.forEach(function(t){var e=n.get(t);qr(!!e,"Missing entity in write response for "+t),r.push(e)}),r})},sh.prototype.invokeRPC=function(e,n){var r=this;return this.credentials.getToken().then(function(t){return r.connection.invokeRPC(e,n,t)}).catch(function(t){throw t.code===Qr.UNAUTHENTICATED&&r.credentials.invalidateToken(),t})},sh.prototype.invokeStreamingRPC=function(e,n){var r=this;return this.credentials.getToken().then(function(t){return r.connection.invokeStreamingRPC(e,n,t)}).catch(function(t){throw t.code===Qr.UNAUTHENTICATED&&r.credentials.invalidateToken(),t})},sh);function sh(t,e,n,r){this.queue=t,this.connection=e,this.credentials=n,this.serializer=r}var uh,ch,hh,lh,fh=(ph.prototype.lookup=function(r){return p(this,void 0,void 0,function(){var e,n=this;return d(this,function(t){switch(t.label){case 0:if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Kr(Qr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");return[4,this.datastore.lookup(r)];case 1:return(e=t.sent()).forEach(function(t){t instanceof qs||t instanceof Ls?n.recordVersion(t):xr("Document in a transaction was a "+t.constructor.name)}),[2,e]}})})},ph.prototype.set=function(t,e){this.write(e.toMutations(t,this.precondition(t))),this.writtenDocs.add(t)},ph.prototype.update=function(t,e){try{this.write(e.toMutations(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t)},ph.prototype.delete=function(t){this.write([new Va(t,this.precondition(t))]),this.writtenDocs.add(t)},ph.prototype.commit=function(){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;if(e=this.readVersions,this.mutations.forEach(function(t){e=e.remove(t.key)}),!e.isEmpty())throw new Kr(Qr.INVALID_ARGUMENT,"Every document read in a transaction must also be written.");return[4,this.datastore.commit(this.mutations)];case 1:return t.sent(),this.committed=!0,[2]}})})},ph.prototype.recordVersion=function(t){var e;if(t instanceof Ls)e=t.version;else{if(!(t instanceof qs))throw xr("Document in a transaction was a "+t.constructor.name);e=ao.forDeletedDoc()}var n=this.readVersions.get(t.key);if(null!==n){if(!e.isEqual(n))throw new Kr(Qr.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(t.key,e)},ph.prototype.precondition=function(t){var e=this.readVersions.get(t);return!this.writtenDocs.has(t)&&e?Sa.updateTime(e):Sa.NONE},ph.prototype.preconditionForUpdate=function(t){var e=this.readVersions.get(t);if(this.writtenDocs.has(t)||!e)return Sa.exists(!0);if(e.isEqual(ao.forDeletedDoc()))throw new Kr(Qr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Sa.updateTime(e)},ph.prototype.write=function(t){this.ensureCommitNotCalled(),this.mutations=this.mutations.concat(t)},ph.prototype.ensureCommitNotCalled=function(){qr(!this.committed,"A transaction object cannot be used after its update callback has been invoked.")},ph);function ph(t){this.datastore=t,this.readVersions=No(),this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}(ch=uh=uh||{})[ch.Unknown=0]="Unknown",ch[ch.Online=1]="Online",ch[ch.Offline=2]="Offline",(lh=hh=hh||{})[lh.RemoteStore=0]="RemoteStore",lh[lh.SharedClientState=1]="SharedClientState";var dh,mh,yh=(gh.prototype.handleWatchStreamStart=function(){var t=this;0===this.watchStreamFailures&&(this.setAndBroadcast(uh.Unknown),qr(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(Ki.OnlineStateTimeout,1e4,function(){return t.onlineStateTimer=null,qr(t.state===uh.Unknown,"Timer should be canceled if we transitioned to a different state."),t.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),t.setAndBroadcast(uh.Offline),Promise.resolve()}))},gh.prototype.handleWatchStreamFailure=function(t){this.state===uh.Online?(this.setAndBroadcast(uh.Unknown),qr(0===this.watchStreamFailures,"watchStreamFailures must be 0"),qr(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,1<=this.watchStreamFailures&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+t.toString()),this.setAndBroadcast(uh.Offline)))},gh.prototype.set=function(t){this.clearOnlineStateTimer(),this.watchStreamFailures=0,t===uh.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(t)},gh.prototype.setAndBroadcast=function(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))},gh.prototype.logClientOfflineWarningIfNecessary=function(t){var e="Could not reach Cloud Firestore backend. "+t+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(Lr(e),this.shouldWarnClientIsOffline=!1):Or("OnlineStateTracker",e)},gh.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},gh);function gh(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state=uh.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}function vh(t){switch(t){case Qr.OK:return xr("Treated status OK as error");case Qr.CANCELLED:case Qr.UNKNOWN:case Qr.DEADLINE_EXCEEDED:case Qr.RESOURCE_EXHAUSTED:case Qr.INTERNAL:case Qr.UNAVAILABLE:case Qr.UNAUTHENTICATED:return!1;case Qr.INVALID_ARGUMENT:case Qr.NOT_FOUND:case Qr.ALREADY_EXISTS:case Qr.PERMISSION_DENIED:case Qr.FAILED_PRECONDITION:case Qr.ABORTED:case Qr.OUT_OF_RANGE:case Qr.UNIMPLEMENTED:case Qr.DATA_LOSS:return!0;default:return xr("Unknown status code: "+t)}}function bh(t){if(void 0===t)return Lr("GRPC error has no .code"),Qr.UNKNOWN;switch(t){case dh.OK:return Qr.OK;case dh.CANCELLED:return Qr.CANCELLED;case dh.UNKNOWN:return Qr.UNKNOWN;case dh.DEADLINE_EXCEEDED:return Qr.DEADLINE_EXCEEDED;case dh.RESOURCE_EXHAUSTED:return Qr.RESOURCE_EXHAUSTED;case dh.INTERNAL:return Qr.INTERNAL;case dh.UNAVAILABLE:return Qr.UNAVAILABLE;case dh.UNAUTHENTICATED:return Qr.UNAUTHENTICATED;case dh.INVALID_ARGUMENT:return Qr.INVALID_ARGUMENT;case dh.NOT_FOUND:return Qr.NOT_FOUND;case dh.ALREADY_EXISTS:return Qr.ALREADY_EXISTS;case dh.PERMISSION_DENIED:return Qr.PERMISSION_DENIED;case dh.FAILED_PRECONDITION:return Qr.FAILED_PRECONDITION;case dh.ABORTED:return Qr.ABORTED;case dh.OUT_OF_RANGE:return Qr.OUT_OF_RANGE;case dh.UNIMPLEMENTED:return Qr.UNIMPLEMENTED;case dh.DATA_LOSS:return Qr.DATA_LOSS;default:return xr("Unknown status code: "+t)}}(mh=dh=dh||{})[mh.OK=0]="OK",mh[mh.CANCELLED=1]="CANCELLED",mh[mh.UNKNOWN=2]="UNKNOWN",mh[mh.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",mh[mh.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",mh[mh.NOT_FOUND=5]="NOT_FOUND",mh[mh.ALREADY_EXISTS=6]="ALREADY_EXISTS",mh[mh.PERMISSION_DENIED=7]="PERMISSION_DENIED",mh[mh.UNAUTHENTICATED=16]="UNAUTHENTICATED",mh[mh.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",mh[mh.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",mh[mh.ABORTED=10]="ABORTED",mh[mh.OUT_OF_RANGE=11]="OUT_OF_RANGE",mh[mh.UNIMPLEMENTED=12]="UNIMPLEMENTED",mh[mh.INTERNAL=13]="INTERNAL",mh[mh.UNAVAILABLE=14]="UNAVAILABLE",mh[mh.DATA_LOSS=15]="DATA_LOSS";var wh,Sh,Eh,Th,Ih=(Ch.emptySet=function(t){return new Ch(t.comparator)},Ch.prototype.has=function(t){return null!=this.keyedMap.get(t)},Ch.prototype.get=function(t){return this.keyedMap.get(t)},Ch.prototype.first=function(){return this.sortedSet.minKey()},Ch.prototype.last=function(){return this.sortedSet.maxKey()},Ch.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},Ch.prototype.indexOf=function(t){var e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1},Object.defineProperty(Ch.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),Ch.prototype.forEach=function(n){this.sortedSet.inorderTraversal(function(t,e){return n(t),!1})},Ch.prototype.add=function(t){var e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))},Ch.prototype.delete=function(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this},Ch.prototype.isEqual=function(t){if(!(t instanceof Ch))return!1;if(this.size!==t.size)return!1;for(var e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();e.hasNext();){var r=e.getNext().key,i=n.getNext().key;if(!r.isEqual(i))return!1}return!0},Ch.prototype.toString=function(){var e=[];return this.forEach(function(t){e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"},Ch.prototype.copy=function(t,e){var n=new Ch;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n},Ch);function Ch(n){this.comparator=n?function(t,e){return n(t,e)||Ui.comparator(t.key,e.key)}:function(t,e){return Ui.comparator(t.key,e.key)},this.keyedMap=Co(),this.sortedSet=new uo(this.comparator)}(Sh=wh=wh||{})[Sh.Added=0]="Added",Sh[Sh.Removed=1]="Removed",Sh[Sh.Modified=2]="Modified",Sh[Sh.Metadata=3]="Metadata",(Th=Eh=Eh||{})[Th.Local=0]="Local",Th[Th.Synced=1]="Synced";var Dh=(Nh.prototype.track=function(t){var e=t.doc.key,n=this.changeMap.get(e);n?t.type!==wh.Added&&n.type===wh.Metadata?this.changeMap=this.changeMap.insert(e,t):t.type===wh.Metadata&&n.type!==wh.Removed?this.changeMap=this.changeMap.insert(e,{type:n.type,doc:t.doc}):t.type===wh.Modified&&n.type===wh.Modified?this.changeMap=this.changeMap.insert(e,{type:wh.Modified,doc:t.doc}):t.type===wh.Modified&&n.type===wh.Added?this.changeMap=this.changeMap.insert(e,{type:wh.Added,doc:t.doc}):t.type===wh.Removed&&n.type===wh.Added?this.changeMap=this.changeMap.remove(e):t.type===wh.Removed&&n.type===wh.Modified?this.changeMap=this.changeMap.insert(e,{type:wh.Removed,doc:n.doc}):t.type===wh.Added&&n.type===wh.Removed?this.changeMap=this.changeMap.insert(e,{type:wh.Modified,doc:t.doc}):xr("unsupported combination of changes: "+JSON.stringify(t)+" after "+JSON.stringify(n)):this.changeMap=this.changeMap.insert(e,t)},Nh.prototype.getChanges=function(){var n=[];return this.changeMap.inorderTraversal(function(t,e){n.push(e)}),n},Nh);function Nh(){this.changeMap=new uo(Ui.comparator)}var Ah=(kh.fromInitialDocuments=function(t,e,n,r){var i=[];return e.forEach(function(t){i.push({type:wh.Added,doc:t})}),new kh(t,e,Ih.emptySet(e),i,n,r,!0,!1)},Object.defineProperty(kh.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),kh.prototype.isEqual=function(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&this.query.isEqual(t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;var e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0},kh);function kh(t,e,n,r,i,o,a,s){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=s}var Rh=(Mh.createSynthesizedRemoteEventForCurrentChange=function(t,e){var n,r=((n={})[t]=_h.createSynthesizedTargetChangeForCurrentChange(t,e),n);return new Mh(ao.MIN,r,Mo(),Eo(),ko())},Mh);function Mh(t,e,n,r,i){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}var _h=(Oh.createSynthesizedTargetChangeForCurrentChange=function(t,e){return new Oh(Br(),e,ko(),ko(),ko())},Oh);function Oh(t,e,n,r,i){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}var Lh,Ph,xh=function(t,e,n,r){this.updatedTargetIds=t,this.removedTargetIds=e,this.key=n,this.newDoc=r},qh=function(t,e){this.targetId=t,this.existenceFilter=e};(Ph=Lh=Lh||{})[Ph.NoChange=0]="NoChange",Ph[Ph.Added=1]="Added",Ph[Ph.Removed=2]="Removed",Ph[Ph.Current=3]="Current",Ph[Ph.Reset=4]="Reset";var Fh=function(t,e,n,r){void 0===n&&(n=Br()),void 0===r&&(r=null),this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r},Vh=(Object.defineProperty(Bh.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(Bh.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(Bh.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(Bh.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),Bh.prototype.updateResumeToken=function(t){0<t.length&&(this._hasPendingChanges=!0,this._resumeToken=t)},Bh.prototype.toTargetChange=function(){var n=ko(),r=ko(),i=ko();return this.documentChanges.forEach(function(t,e){switch(e){case wh.Added:n=n.add(t);break;case wh.Modified:r=r.add(t);break;case wh.Removed:i=i.add(t);break;default:xr("Encountered invalid change type: "+e)}}),new _h(this._resumeToken,this._current,n,r,i)},Bh.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=jh()},Bh.prototype.addDocumentChange=function(t,e){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(t,e)},Bh.prototype.removeDocumentChange=function(t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(t)},Bh.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},Bh.prototype.recordTargetResponse=function(){this.pendingResponses-=1},Bh.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},Bh);function Bh(){this.pendingResponses=0,this.documentChanges=jh(),this._resumeToken=Br(),this._current=!1,this._hasPendingChanges=!0}var Uh=(Qh.prototype.handleDocumentChange=function(t){for(var e=0,n=t.updatedTargetIds;e<n.length;e++){var r=n[e];t.newDoc instanceof Ls?this.addDocumentToTarget(r,t.newDoc):t.newDoc instanceof qs&&this.removeDocumentFromTarget(r,t.key,t.newDoc)}for(var i=0,o=t.removedTargetIds;i<o.length;i++)r=o[i],this.removeDocumentFromTarget(r,t.key,t.newDoc)},Qh.prototype.handleTargetChange=function(n){var r=this;this.forEachTarget(n,function(t){var e=r.ensureTargetState(t);switch(n.state){case Lh.NoChange:r.isActiveTarget(t)&&e.updateResumeToken(n.resumeToken);break;case Lh.Added:e.recordTargetResponse(),e.isPending||e.clearPendingChanges(),e.updateResumeToken(n.resumeToken);break;case Lh.Removed:e.recordTargetResponse(),e.isPending||r.removeTarget(t),qr(!n.cause,"WatchChangeAggregator does not handle errored targets");break;case Lh.Current:r.isActiveTarget(t)&&(e.markCurrent(),e.updateResumeToken(n.resumeToken));break;case Lh.Reset:r.isActiveTarget(t)&&(r.resetTarget(t),e.updateResumeToken(n.resumeToken));break;default:xr("Unknown target watch change state: "+n.state)}})},Qh.prototype.forEachTarget=function(t,e){0<t.targetIds.length?t.targetIds.forEach(e):Hr(this.targetStates,e)},Qh.prototype.handleExistenceFilter=function(t){var e=t.targetId,n=t.existenceFilter.count,r=this.queryDataForActiveTarget(e);if(r){var i=r.query;if(i.isDocumentQuery())if(0===n){var o=new Ui(i.path);this.removeDocumentFromTarget(e,o,new qs(o,ao.forDeletedDoc()))}else qr(1===n,"Single document existence filter with count: "+n);else this.getCurrentDocumentCountForTarget(e)!==n&&(this.resetTarget(e),this.pendingTargetResets=this.pendingTargetResets.add(e))}},Qh.prototype.createRemoteEvent=function(i){var o=this,a={};Hr(this.targetStates,function(t,e){var n=o.queryDataForActiveTarget(t);if(n){if(e.current&&n.query.isDocumentQuery()){var r=new Ui(n.query.path);null!==o.pendingDocumentUpdates.get(r)||o.targetContainsDocument(t,r)||o.removeDocumentFromTarget(t,r,new qs(r,i))}e.hasPendingChanges&&(a[t]=e.toTargetChange(),e.clearPendingChanges())}});var r=ko();this.pendingDocumentTargetMapping.forEach(function(t,e){var n=!0;e.forEachWhile(function(t){var e=o.queryDataForActiveTarget(t);return!e||e.purpose===qu.LimboResolution||(n=!1)}),n&&(r=r.add(t))});var t=new Rh(i,a,this.pendingTargetResets,this.pendingDocumentUpdates,r);return this.pendingDocumentUpdates=Eo(),this.pendingDocumentTargetMapping=Kh(),this.pendingTargetResets=new go(gi),t},Qh.prototype.addDocumentToTarget=function(t,e){if(this.isActiveTarget(t)){var n=this.targetContainsDocument(t,e.key)?wh.Modified:wh.Added;this.ensureTargetState(t).addDocumentChange(e.key,n),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e.key,e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e.key,this.ensureDocumentTargetMapping(e.key).add(t))}},Qh.prototype.removeDocumentFromTarget=function(t,e,n){if(this.isActiveTarget(t)){var r=this.ensureTargetState(t);this.targetContainsDocument(t,e)?r.addDocumentChange(e,wh.Removed):r.removeDocumentChange(e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e,this.ensureDocumentTargetMapping(e).delete(t)),n&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e,n))}},Qh.prototype.removeTarget=function(t){delete this.targetStates[t]},Qh.prototype.getCurrentDocumentCountForTarget=function(t){var e=this.ensureTargetState(t).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size},Qh.prototype.recordPendingTargetRequest=function(t){this.ensureTargetState(t).recordPendingTargetRequest()},Qh.prototype.ensureTargetState=function(t){return this.targetStates[t]||(this.targetStates[t]=new Vh),this.targetStates[t]},Qh.prototype.ensureDocumentTargetMapping=function(t){var e=this.pendingDocumentTargetMapping.get(t);return e||(e=new go(gi),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,e)),e},Qh.prototype.isActiveTarget=function(t){var e=null!==this.queryDataForActiveTarget(t);return e||Or("WatchChangeAggregator","Detected inactive target",t),e},Qh.prototype.queryDataForActiveTarget=function(t){var e=this.targetStates[t];return e&&e.isPending?null:this.metadataProvider.getQueryDataForTarget(t)},Qh.prototype.resetTarget=function(e){var n=this;qr(!this.targetStates[e].isPending,"Should only reset active targets"),this.targetStates[e]=new Vh,this.metadataProvider.getRemoteKeysForTarget(e).forEach(function(t){n.removeDocumentFromTarget(e,t,null)})},Qh.prototype.targetContainsDocument=function(t,e){return this.metadataProvider.getRemoteKeysForTarget(t).has(e)},Qh);function Qh(t){this.metadataProvider=t,this.targetStates={},this.pendingDocumentUpdates=Eo(),this.pendingDocumentTargetMapping=Kh(),this.pendingTargetResets=new go(gi)}function Kh(){return new uo(Ui.comparator)}function jh(){return new uo(Ui.comparator)}var Wh="RemoteStore",Gh=(zh.prototype.start=function(){return this.enableNetwork()},zh.prototype.enableNetwork=function(){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(e=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return e.lastStreamToken=t.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(uh.Unknown),[4,this.fillWritePipeline()];case 2:t.sent(),t.label=3;case 3:return[2]}})})},zh.prototype.disableNetwork=function(){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(uh.Offline),[2]}})})},zh.prototype.disableNetworkInternal=function(){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return[4,this.writeStream.stop()];case 1:return t.sent(),[4,this.watchStream.stop()];case 2:return t.sent(),0<this.writePipeline.length&&(Or(Wh,"Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}})})},zh.prototype.shutdown=function(){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return Or(Wh,"RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.connectivityMonitor.shutdown(),this.onlineStateTracker.set(uh.Unknown),[2]}})})},zh.prototype.listen=function(t){qr(!Gr(this.listenTargets,t.targetId),"listen called with duplicate targetId!"),this.listenTargets[t.targetId]=t,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(t)},zh.prototype.unlisten=function(t){qr(Gr(this.listenTargets,t),"unlisten called without assigned target ID!"),delete this.listenTargets[t],this.watchStream.isOpen()&&this.sendUnwatchRequest(t),Xr(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(uh.Unknown))},zh.prototype.getQueryDataForTarget=function(t){return this.listenTargets[t]||null},zh.prototype.getRemoteKeysForTarget=function(t){return this.syncEngine.getRemoteKeysForTarget(t)},zh.prototype.sendWatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t.targetId),this.watchStream.watch(t)},zh.prototype.sendUnwatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t),this.watchStream.unwatch(t)},zh.prototype.startWatchStream=function(){qr(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new Uh(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},zh.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!Xr(this.listenTargets)},zh.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},zh.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},zh.prototype.onWatchStreamOpen=function(){return p(this,void 0,void 0,function(){var n=this;return d(this,function(t){return Hr(this.listenTargets,function(t,e){n.sendWatchRequest(e)}),[2]})})},zh.prototype.onWatchStreamClose=function(e){return p(this,void 0,void 0,function(){return d(this,function(t){return void 0===e&&qr(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(e),this.startWatchStream()):this.onlineStateTracker.set(uh.Unknown),[2]})})},zh.prototype.onWatchStreamChange=function(n,r){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:return this.onlineStateTracker.set(uh.Online),n instanceof Fh&&n.state===Lh.Removed&&n.cause?[2,this.handleTargetError(n)]:(n instanceof xh?this.watchChangeAggregator.handleDocumentChange(n):n instanceof qh?this.watchChangeAggregator.handleExistenceFilter(n):(qr(n instanceof Fh,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(n)),r.isEqual(ao.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return e=t.sent(),0<=r.compareTo(e)?[4,this.raiseWatchSnapshot(r)]:[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}})})},zh.prototype.raiseWatchSnapshot=function(r){var i=this;qr(!r.isEqual(ao.MIN),"Can't raise event for unknown SnapshotVersion");var t=this.watchChangeAggregator.createRemoteEvent(r);return Hr(t.targetChanges,function(t,e){if(0<e.resumeToken.length){var n=i.listenTargets[t];n&&(i.listenTargets[t]=n.withResumeToken(e.resumeToken,r))}}),t.targetMismatches.forEach(function(t){var e=i.listenTargets[t];if(e){i.listenTargets[t]=e.withResumeToken(Br(),e.snapshotVersion),i.sendUnwatchRequest(t);var n=new Ku(e.query,t,qu.ExistenceFilterMismatch,e.sequenceNumber);i.sendWatchRequest(n)}}),this.syncEngine.applyRemoteEvent(t)},zh.prototype.handleTargetError=function(t){var n=this;qr(!!t.cause,"Handling target error without a cause");var r=t.cause,i=Promise.resolve();return t.targetIds.forEach(function(e){i=i.then(function(){return p(n,void 0,void 0,function(){return d(this,function(t){return Gr(this.listenTargets,e)?(delete this.listenTargets[e],this.watchChangeAggregator.removeTarget(e),[2,this.syncEngine.rejectListen(e,r)]):[2]})})})}),i},zh.prototype.fillWritePipeline=function(){return p(this,void 0,void 0,function(){var e,n;return d(this,function(t){switch(t.label){case 0:return this.canAddToWritePipeline()?(e=0<this.writePipeline.length?this.writePipeline[this.writePipeline.length-1].batchId:-1,[4,this.localStore.nextMutationBatch(e)]):[3,4];case 1:return null!==(n=t.sent())?[3,2]:(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]);case 2:return this.addToWritePipeline(n),[4,this.fillWritePipeline()];case 3:t.sent(),t.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}})})},zh.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<10},zh.prototype.outstandingWrites=function(){return this.writePipeline.length},zh.prototype.addToWritePipeline=function(t){qr(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(t),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(t.mutations)},zh.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&0<this.writePipeline.length},zh.prototype.startWriteStream=function(){qr(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start()},zh.prototype.onWriteStreamOpen=function(){return p(this,void 0,void 0,function(){return d(this,function(t){return this.writeStream.writeHandshake(),[2]})})},zh.prototype.onWriteHandshakeComplete=function(){var r=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var t=0,e=r.writePipeline;t<e.length;t++){var n=e[t];r.writeStream.writeMutations(n.mutations)}}).catch(lc)},zh.prototype.onMutationResult=function(t,e){var n=this;qr(0<this.writePipeline.length,"Got result for empty write pipeline");var r=this.writePipeline.shift(),i=Lo.from(r,t,e,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(i).then(function(){return n.fillWritePipeline()})},zh.prototype.onWriteStreamClose=function(n){return p(this,void 0,void 0,function(){var e=this;return d(this,function(t){return void 0===n&&qr(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),n&&0<this.writePipeline.length?[2,(this.writeStream.handshakeComplete?this.handleWriteError(n):this.handleHandshakeError(n)).then(function(){e.shouldStartWriteStream()&&e.startWriteStream()})]:[2]})})},zh.prototype.handleHandshakeError=function(e){return p(this,void 0,void 0,function(){return d(this,function(t){return vh(e.code)?(Or(Wh,"RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=Br(),[2,this.localStore.setLastStreamToken(Br()).catch(lc)]):[2]})})},zh.prototype.handleWriteError=function(r){return p(this,void 0,void 0,function(){var e,n=this;return d(this,function(t){return function(t){return vh(t)&&t!==Qr.ABORTED}(r.code)?(e=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(e.batchId,r).then(function(){return n.fillWritePipeline()})]):[2]})})},zh.prototype.createTransaction=function(){return new fh(this.datastore)},zh.prototype.restartNetwork=function(){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(uh.Unknown),[4,this.enableNetwork()];case 2:return t.sent(),[2]}})})},zh.prototype.handleCredentialChange=function(){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.canUseNetwork()?(Or(Wh,"RemoteStore restarting streams for new credential"),[4,this.restartNetwork()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},zh.prototype.applyPrimaryState=function(e){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return(this.isPrimary=e)&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return t.sent(),[3,4];case 2:return e?[3,4]:[4,this.disableNetworkInternal()];case 3:t.sent(),this.onlineStateTracker.set(uh.Unknown),t.label=4;case 4:return[2]}})})},zh);function zh(t,e,n,r,i){var o=this;this.localStore=t,this.datastore=e,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.connectivityMonitor=i,this.connectivityMonitor.addCallback(function(t){n.enqueueAndForget(function(){return p(o,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.canUseNetwork()?(Or(Wh,"Restarting streams for network reachability change."),[4,this.restartNetwork()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})})}),this.onlineStateTracker=new yh(n,r),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}var Hh=(Object.defineProperty(Yh.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(Yh.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),Yh.prototype.isEqual=function(t){return this._lat===t._lat&&this._long===t._long},Yh.prototype._compareTo=function(t){return gi(this._lat,t._lat)||gi(this._long,t._long)},Yh);function Yh(t,e){if($r("GeoPoint",arguments,2),ei("GeoPoint","number",1,t),ei("GeoPoint","number",2,e),!isFinite(t)||t<-90||90<t)throw new Kr(Qr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||180<e)throw new Kr(Qr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}var Xh=(Jh.atPath=function(t){return new Jh(t)},Object.defineProperty(Jh.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var t=this.getInequalityFilterField(),e=this.getFirstOrderByField();if(null!==t&&null===e)t.isKeyField()?this.memoizedOrderBy=[Cl]:this.memoizedOrderBy=[new Tl(t),Cl];else{qr(null===t||null!==e&&t.isEqual(e),"First orderBy should match inequality field.");for(var n=!(this.memoizedOrderBy=[]),r=0,i=this.explicitOrderBy;r<i.length;r++){var o=i[r];this.memoizedOrderBy.push(o),o.field.isKeyField()&&(n=!0)}if(!n){var a=0<this.explicitOrderBy.length?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:bl.ASCENDING;this.memoizedOrderBy.push(a===bl.ASCENDING?Cl:Dl)}}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),Jh.prototype.addFilter=function(t){qr(null==this.getInequalityFilterField()||!(t instanceof nl)||!t.isInequality()||t.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),qr(!this.isDocumentQuery(),"No filtering allowed for document query");var e=this.filters.concat([t]);return new Jh(this.path,this.collectionGroup,this.explicitOrderBy.slice(),e,this.limit,this.startAt,this.endAt)},Jh.prototype.addOrderBy=function(t){qr(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var e=this.explicitOrderBy.concat([t]);return new Jh(this.path,this.collectionGroup,e,this.filters.slice(),this.limit,this.startAt,this.endAt)},Jh.prototype.withLimit=function(t){return new Jh(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),t,this.startAt,this.endAt)},Jh.prototype.withStartAt=function(t){return new Jh(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,t,this.endAt)},Jh.prototype.withEndAt=function(t){return new Jh(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,t)},Jh.prototype.asCollectionQueryAtPath=function(t){return new Jh(t,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,this.endAt)},Jh.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var t=this.path.canonicalString();this.isCollectionGroupQuery()&&(t+="|cg:"+this.collectionGroup),t+="|f:";for(var e=0,n=this.filters;e<n.length;e++)t+=n[e].canonicalId(),t+=",";t+="|ob:";for(var r=0,i=this.orderBy;r<i.length;r++)t+=i[r].canonicalId(),t+=",";Wc(this.limit)||(t+="|l:",t+=this.limit),this.startAt&&(t+="|lb:",t+=this.startAt.canonicalId()),this.endAt&&(t+="|ub:",t+=this.endAt.canonicalId()),this.memoizedCanonicalId=t}return this.memoizedCanonicalId},Jh.prototype.toString=function(){var t="Query("+this.path.canonicalString();return this.isCollectionGroupQuery()&&(t+=" collectionGroup="+this.collectionGroup),0<this.filters.length&&(t+=", filters: ["+this.filters.join(", ")+"]"),Wc(this.limit)||(t+=", limit: "+this.limit),0<this.explicitOrderBy.length&&(t+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"),this.startAt&&(t+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(t+=", endAt: "+this.endAt.canonicalId()),t+")"},Jh.prototype.isEqual=function(t){if(this.limit!==t.limit)return!1;if(this.orderBy.length!==t.orderBy.length)return!1;for(var e=0;e<this.orderBy.length;e++)if(!this.orderBy[e].isEqual(t.orderBy[e]))return!1;if(this.filters.length!==t.filters.length)return!1;for(e=0;e<this.filters.length;e++)if(!this.filters[e].isEqual(t.filters[e]))return!1;return this.collectionGroup===t.collectionGroup&&!!this.path.isEqual(t.path)&&!(null!==this.startAt?!this.startAt.isEqual(t.startAt):null!==t.startAt)&&(null!==this.endAt?this.endAt.isEqual(t.endAt):null===t.endAt)},Jh.prototype.docComparator=function(t,e){for(var n=!1,r=0,i=this.orderBy;r<i.length;r++){var o=i[r],a=o.compare(t,e);if(0!==a)return a;n=n||o.field.isKeyField()}return qr(n,"orderBy used that doesn't compare on key field"),0},Jh.prototype.matches=function(t){return this.matchesPathAndCollectionGroup(t)&&this.matchesOrderBy(t)&&this.matchesFilters(t)&&this.matchesBounds(t)},Jh.prototype.hasLimit=function(){return!Wc(this.limit)},Jh.prototype.getFirstOrderByField=function(){return 0<this.explicitOrderBy.length?this.explicitOrderBy[0].field:null},Jh.prototype.getInequalityFilterField=function(){for(var t=0,e=this.filters;t<e.length;t++){var n=e[t];if(n instanceof nl&&n.isInequality())return n.field}return null},Jh.prototype.findFilterOperator=function(t){for(var e=0,n=this.filters;e<n.length;e++){var r=n[e];if(r instanceof nl&&0<=t.indexOf(r.op))return r.op}return null},Jh.prototype.isDocumentQuery=function(){return Ui.isDocumentKey(this.path)&&null===this.collectionGroup&&0===this.filters.length},Jh.prototype.isCollectionGroupQuery=function(){return null!==this.collectionGroup},Jh.prototype.matchesPathAndCollectionGroup=function(t){var e=t.key.path;return null!==this.collectionGroup?t.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(e):Ui.isDocumentKey(this.path)?this.path.isEqual(e):this.path.isImmediateParentOf(e)},Jh.prototype.matchesOrderBy=function(t){for(var e=0,n=this.explicitOrderBy;e<n.length;e++){var r=n[e];if(!r.field.isKeyField()&&null===t.field(r.field))return!1}return!0},Jh.prototype.matchesFilters=function(t){for(var e=0,n=this.filters;e<n.length;e++)if(!n[e].matches(t))return!1;return!0},Jh.prototype.matchesBounds=function(t){return!(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,t)||this.endAt&&this.endAt.sortsBeforeDocument(this.orderBy,t))},Jh.prototype.assertValidBound=function(t){qr(t.position.length<=this.orderBy.length,"Bound is longer than orderBy")},Jh);function Jh(t,e,n,r,i,o,a){void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=null),void 0===a&&(a=null),this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.startAt=o,this.endAt=a,this.memoizedCanonicalId=null,this.memoizedOrderBy=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}function $h(){}var Zh=(tl.fromString=function(t){switch(t){case"<":return tl.LESS_THAN;case"<=":return tl.LESS_THAN_OR_EQUAL;case"==":return tl.EQUAL;case">=":return tl.GREATER_THAN_OR_EQUAL;case">":return tl.GREATER_THAN;case"array-contains":return tl.ARRAY_CONTAINS;case"in":return tl.IN;case"array-contains-any":return tl.ARRAY_CONTAINS_ANY;default:return xr("Unknown FieldFilter operator: "+t)}},tl.prototype.toString=function(){return this.name},tl.prototype.isEqual=function(t){return this.name===t.name},tl.LESS_THAN=new tl("<"),tl.LESS_THAN_OR_EQUAL=new tl("<="),tl.EQUAL=new tl("=="),tl.GREATER_THAN=new tl(">"),tl.GREATER_THAN_OR_EQUAL=new tl(">="),tl.ARRAY_CONTAINS=new tl("array-contains"),tl.IN=new tl("in"),tl.ARRAY_CONTAINS_ANY=new tl("array-contains-any"),tl);function tl(t){this.name=t}var el,nl=(s(rl,el=$h),rl.create=function(t,e,n){if(t.isKeyField())return e===Zh.IN?(qr(n instanceof ks,"Comparing on key with IN, but filter value not an ArrayValue"),qr(n.internalValue.every(function(t){return t instanceof ws}),"Comparing on key with IN, but an array value was not a RefValue"),new ul(t,n)):(qr(n instanceof ws,"Comparing on key, but filter value not a RefValue"),qr(e!==Zh.ARRAY_CONTAINS&&e!==Zh.ARRAY_CONTAINS_ANY,"'"+e.toString()+"' queries don't make sense on document keys."),new ol(t,e,n));if(n.isEqual(Ga.INSTANCE)){if(e!==Zh.EQUAL)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. Null supports only equality comparisons.");return new rl(t,e,n)}if(n.isEqual(os.NAN)){if(e!==Zh.EQUAL)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. NaN supports only equality comparisons.");return new rl(t,e,n)}return e===Zh.ARRAY_CONTAINS?new ll(t,n):e===Zh.IN?(qr(n instanceof ks,"IN filter has invalid value: "+n.toString()),new dl(t,n)):e===Zh.ARRAY_CONTAINS_ANY?(qr(n instanceof ks,"ARRAY_CONTAINS_ANY filter has invalid value: "+n.toString()),new gl(t,n)):new rl(t,e,n)},rl.prototype.matches=function(t){var e=t.field(this.field);return null!==e&&this.value.typeOrder===e.typeOrder&&this.matchesComparison(e.compareTo(this.value))},rl.prototype.matchesComparison=function(t){switch(this.op){case Zh.LESS_THAN:return t<0;case Zh.LESS_THAN_OR_EQUAL:return t<=0;case Zh.EQUAL:return 0===t;case Zh.GREATER_THAN:return 0<t;case Zh.GREATER_THAN_OR_EQUAL:return 0<=t;default:return xr("Unknown FieldFilter operator: "+this.op)}},rl.prototype.isInequality=function(){return 0<=[Zh.LESS_THAN,Zh.LESS_THAN_OR_EQUAL,Zh.GREATER_THAN,Zh.GREATER_THAN_OR_EQUAL].indexOf(this.op)},rl.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},rl.prototype.isEqual=function(t){return t instanceof rl&&this.op.isEqual(t.op)&&this.field.isEqual(t.field)&&this.value.isEqual(t.value)},rl.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},rl);function rl(t,e,n){var r=el.call(this)||this;return r.field=t,r.op=e,r.value=n,r}var il,ol=(s(al,il=nl),al.prototype.matches=function(t){var e=this.value,n=Ui.comparator(t.key,e.key);return this.matchesComparison(n)},al);function al(){return null!==il&&il.apply(this,arguments)||this}var sl,ul=(s(cl,sl=nl),cl.prototype.matches=function(e){return this.value.internalValue.some(function(t){return e.key.isEqual(t.key)})},cl);function cl(t,e){var n=sl.call(this,t,Zh.IN,e)||this;return n.value=e,n}var hl,ll=(s(fl,hl=nl),fl.prototype.matches=function(t){var e=t.field(this.field);return e instanceof ks&&e.contains(this.value)},fl);function fl(t,e){return hl.call(this,t,Zh.ARRAY_CONTAINS,e)||this}var pl,dl=(s(ml,pl=nl),ml.prototype.matches=function(t){var e=this.value,n=t.field(this.field);return null!==n&&e.contains(n)},ml);function ml(t,e){var n=pl.call(this,t,Zh.IN,e)||this;return n.value=e,n}var yl,gl=(s(vl,yl=nl),vl.prototype.matches=function(t){var e=this,n=t.field(this.field);return n instanceof ks&&n.internalValue.some(function(t){return e.value.contains(t)})},vl);function vl(t,e){var n=yl.call(this,t,Zh.ARRAY_CONTAINS_ANY,e)||this;return n.value=e,n}var bl=(wl.prototype.toString=function(){return this.name},wl.ASCENDING=new wl("asc"),wl.DESCENDING=new wl("desc"),wl);function wl(t){this.name=t}var Sl=(El.prototype.canonicalId=function(){for(var t=this.before?"b:":"a:",e=0,n=this.position;e<n.length;e++)t+=n[e].toString();return t},El.prototype.sortsBeforeDocument=function(t,e){qr(this.position.length<=t.length,"Bound has more components than query's orderBy");for(var n=0,r=0;r<this.position.length;r++){var i=t[r],o=this.position[r];if(i.field.isKeyField())qr(o instanceof ws,"Bound has a non-key value where the key path is being used."),n=Ui.comparator(o.key,e.key);else{var a=e.field(i.field);qr(null!==a,"Field should exist since document matched the orderBy already."),n=o.compareTo(a)}if(i.dir===bl.DESCENDING&&(n*=-1),0!==n)break}return this.before?n<=0:n<0},El.prototype.isEqual=function(t){if(null===t)return!1;if(this.before!==t.before||this.position.length!==t.position.length)return!1;for(var e=0;e<this.position.length;e++){var n=this.position[e],r=t.position[e];if(!n.isEqual(r))return!1}return!0},El);function El(t,e){this.position=t,this.before=e}var Tl=(Il.prototype.compare=function(t,e){var n=this.isKeyOrderBy?Ls.compareByKey(t,e):Ls.compareByField(this.field,t,e);switch(this.dir){case bl.ASCENDING:return n;case bl.DESCENDING:return-1*n;default:return xr("Unknown direction: "+this.dir)}},Il.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},Il.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},Il.prototype.isEqual=function(t){return this.dir===t.dir&&this.field.isEqual(t.field)},Il);function Il(t,e){this.field=t,void 0===e&&(e=bl.ASCENDING),this.dir=e,this.isKeyOrderBy=t.isKeyField()}var Cl=new Tl(Vi.keyField(),bl.ASCENDING),Dl=new Tl(Vi.keyField(),bl.DESCENDING),Nl=(Al.prototype.applyToLocalView=function(t,e){return new ds(e,t)},Al.prototype.applyToRemoteDocument=function(t,e){return e},Al.prototype.computeBaseValue=function(t){return null},Al.prototype.isEqual=function(t){return t instanceof Al},Al.instance=new Al,Al);function Al(){}var kl=(Rl.prototype.applyToLocalView=function(t,e){return this.apply(t)},Rl.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},Rl.prototype.apply=function(t){for(var n=Pl(t),e=function(e){n.find(function(t){return t.isEqual(e)})||n.push(e)},r=0,i=this.elements;r<i.length;r++)e(i[r]);return new ks(n)},Rl.prototype.computeBaseValue=function(t){return null},Rl.prototype.isEqual=function(t){return t instanceof Rl&&vi(t.elements,this.elements)},Rl);function Rl(t){this.elements=t}var Ml=(_l.prototype.applyToLocalView=function(t,e){return this.apply(t)},_l.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},_l.prototype.apply=function(t){for(var n=Pl(t),e=function(e){n=n.filter(function(t){return!t.isEqual(e)})},r=0,i=this.elements;r<i.length;r++)e(i[r]);return new ks(n)},_l.prototype.computeBaseValue=function(t){return null},_l.prototype.isEqual=function(t){return t instanceof _l&&vi(t.elements,this.elements)},_l);function _l(t){this.elements=t}var Ol=(Ll.prototype.applyToLocalView=function(t,e){var n=this.computeBaseValue(t);if(n instanceof ns&&this.operand instanceof ns){var r=n.internalValue+this.operand.internalValue;return new ns(r)}return r=n.internalValue+this.operand.internalValue,new os(r)},Ll.prototype.applyToRemoteDocument=function(t,e){return qr(null!==e,"Didn't receive transformResult for NUMERIC_ADD transform"),e},Ll.prototype.computeBaseValue=function(t){return t instanceof $a?t:new ns(0)},Ll.prototype.isEqual=function(t){return t instanceof Ll&&this.operand.isEqual(t.operand)},Ll);function Ll(t){this.operand=t}function Pl(t){return t instanceof ks?t.internalValue.slice():[]}var xl=(ql.prototype.isEqual=function(t){return t&&t.count===this.count},ql);function ql(t){this.count=t}var Fl,Vl,Bl=((Fl={})[bl.ASCENDING.name]="ASCENDING",Fl[bl.DESCENDING.name]="DESCENDING",Fl),Ul=((Vl={})[Zh.LESS_THAN.name]="LESS_THAN",Vl[Zh.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",Vl[Zh.GREATER_THAN.name]="GREATER_THAN",Vl[Zh.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",Vl[Zh.EQUAL.name]="EQUAL",Vl[Zh.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",Vl[Zh.IN.name]="IN",Vl[Zh.ARRAY_CONTAINS_ANY.name]="ARRAY_CONTAINS_ANY",Vl),Ql=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Kl(t,e){qr(!Wc(t),e+" is missing")}function jl(t){return"number"==typeof t?t:"string"==typeof t?Number(t):xr("can't parse "+t)}var Wl=(Gl.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},Gl.prototype.unsafeCastProtoByteString=function(t){return t},Gl.prototype.fromRpcStatus=function(t){var e=void 0===t.code?Qr.UNKNOWN:bh(t.code);return new Kr(e,t.message||"")},Gl.prototype.toInt32Value=function(t){return Wc(t)?void 0:{value:t}},Gl.prototype.fromInt32Value=function(t){var e;return Wc(e="object"==typeof t?t.value:t)?null:e},Gl.prototype.toTimestamp=function(t){return{seconds:""+t.seconds,nanos:t.nanoseconds}},Gl.prototype.fromTimestamp=function(t){if("string"==typeof t)return this.fromIso8601String(t);qr(!!t,"Cannot deserialize null or undefined timestamp.");var e=jl(t.seconds||"0"),n=t.nanos||0;return new io(e,n)},Gl.prototype.fromIso8601String=function(t){var e=0,n=Ql.exec(t);if(qr(!!n,"invalid timestamp: "+t),n[1]){var r=n[1];r=(r+"000000000").substr(0,9),e=Number(r)}var i=new Date(t),o=Math.floor(i.getTime()/1e3);return new io(o,e)},Gl.prototype.toBytes=function(t){return this.options.useProto3Json?t.toBase64():this.unsafeCastProtoByteString(t.toUint8Array())},Gl.prototype.fromBlob=function(t){return"string"==typeof t?(qr(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Ei.fromBase64String(t)):(qr(!this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Ei.fromUint8Array(t))},Gl.prototype.toVersion=function(t){return this.toTimestamp(t.toTimestamp())},Gl.prototype.fromVersion=function(t){return qr(!!t,"Trying to deserialize version that isn't set"),ao.fromTimestamp(this.fromTimestamp(t))},Gl.prototype.toResourceName=function(t,e){return this.fullyQualifiedPrefixPath(t).child("documents").child(e).canonicalString()},Gl.prototype.fromResourceName=function(t){var e=Pi.fromString(t);return qr(this.isValidResourceName(e),"Tried to deserialize invalid key "+e.toString()),e},Gl.prototype.toName=function(t){return this.toResourceName(this.databaseId,t.path)},Gl.prototype.fromName=function(t){var e=this.fromResourceName(t);return qr(e.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+e.get(1)+" vs "+this.databaseId.projectId),qr(!e.get(3)&&!this.databaseId.database||e.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+e.get(3)+" vs "+this.databaseId.database),new Ui(this.extractLocalPathFromResourceName(e))},Gl.prototype.toQueryPath=function(t){return this.toResourceName(this.databaseId,t)},Gl.prototype.fromQueryPath=function(t){var e=this.fromResourceName(t);return 4===e.length?Pi.EMPTY_PATH:this.extractLocalPathFromResourceName(e)},Object.defineProperty(Gl.prototype,"encodedDatabaseId",{get:function(){return new Pi(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),Gl.prototype.fullyQualifiedPrefixPath=function(t){return new Pi(["projects",t.projectId,"databases",t.database])},Gl.prototype.extractLocalPathFromResourceName=function(t){return qr(4<t.length&&"documents"===t.get(4),"tried to deserialize invalid key "+t.toString()),t.popFirst(5)},Gl.prototype.isValidResourceName=function(t){return 4<=t.length&&"projects"===t.get(0)&&"databases"===t.get(2)},Gl.prototype.toValue=function(t){if(t instanceof Ga)return{nullValue:"NULL_VALUE"};if(t instanceof Ya)return{booleanValue:t.value()};if(t instanceof ns)return{integerValue:""+t.value()};if(t instanceof os){var e=t.value();if(this.options.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:t.value()}}return t instanceof us?{stringValue:t.value()}:t instanceof Ds?{mapValue:this.toMapValue(t)}:t instanceof ks?{arrayValue:this.toArrayValue(t)}:t instanceof ls?{timestampValue:this.toTimestamp(t.internalValue)}:t instanceof Ts?{geoPointValue:{latitude:t.value().latitude,longitude:t.value().longitude}}:t instanceof gs?{bytesValue:this.toBytes(t.value())}:t instanceof ws?{referenceValue:this.toResourceName(t.databaseId,t.key.path)}:xr("Unknown FieldValue "+JSON.stringify(t))},Gl.prototype.fromValue=function(t){var e=this;if("nullValue"in t)return Ga.INSTANCE;if("booleanValue"in t)return Ya.of(t.booleanValue);if("integerValue"in t)return new ns(jl(t.integerValue));if("doubleValue"in t){if(this.options.useProto3Json){if("NaN"===t.doubleValue)return os.NAN;if("Infinity"===t.doubleValue)return os.POSITIVE_INFINITY;if("-Infinity"===t.doubleValue)return os.NEGATIVE_INFINITY}return new os(t.doubleValue)}if("stringValue"in t)return new us(t.stringValue);if("mapValue"in t)return this.fromFields(t.mapValue.fields||{});if("arrayValue"in t){Kl(t.arrayValue,"arrayValue");var n=t.arrayValue.values||[];return new ks(n.map(function(t){return e.fromValue(t)}))}if("timestampValue"in t)return Kl(t.timestampValue,"timestampValue"),new ls(this.fromTimestamp(t.timestampValue));if("geoPointValue"in t){Kl(t.geoPointValue,"geoPointValue");var r=t.geoPointValue.latitude||0,i=t.geoPointValue.longitude||0;return new Ts(new Hh(r,i))}if("bytesValue"in t){Kl(t.bytesValue,"bytesValue");var o=this.fromBlob(t.bytesValue);return new gs(o)}if("referenceValue"in t){Kl(t.referenceValue,"referenceValue");var a=this.fromResourceName(t.referenceValue),s=new Ni(a.get(1),a.get(3)),u=new Ui(this.extractLocalPathFromResourceName(a));return new ws(s,u)}return xr("Unknown Value proto "+JSON.stringify(t))},Gl.prototype.toMutationDocument=function(t,e){return{name:this.toName(t),fields:this.toFields(e)}},Gl.prototype.toDocument=function(t){return qr(!t.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(t.key),fields:this.toFields(t.data()),updateTime:this.toTimestamp(t.version.toTimestamp())}},Gl.prototype.fromDocument=function(t,e){var n=this,r=this.fromName(t.name),i=this.fromVersion(t.updateTime);return new Ls(r,i,{hasCommittedMutations:!!e},void 0,t,function(t){return n.fromValue(t)})},Gl.prototype.toFields=function(t){var n=this,r={};return t.forEach(function(t,e){r[t]=n.toValue(e)}),r},Gl.prototype.fromFields=function(t){var n=this,e=t,r=Ds.EMPTY;return Yr(e,function(t,e){r=r.set(new Vi([t]),n.fromValue(e))}),r},Gl.prototype.toMapValue=function(t){return{fields:this.toFields(t)}},Gl.prototype.toArrayValue=function(t){var e=this,n=[];return t.forEach(function(t){n.push(e.toValue(t))}),{values:n}},Gl.prototype.fromFound=function(t){var e=this;qr(!!t.found,"Tried to deserialize a found document from a missing document."),Kl(t.found.name,"doc.found.name"),Kl(t.found.updateTime,"doc.found.updateTime");var n=this.fromName(t.found.name),r=this.fromVersion(t.found.updateTime);return new Ls(n,r,{},void 0,t.found,function(t){return e.fromValue(t)})},Gl.prototype.fromMissing=function(t){qr(!!t.missing,"Tried to deserialize a missing document from a found document."),qr(!!t.readTime,"Tried to deserialize a missing document without a read time.");var e=this.fromName(t.missing),n=this.fromVersion(t.readTime);return new qs(e,n)},Gl.prototype.fromMaybeDocument=function(t){return"found"in t?this.fromFound(t):"missing"in t?this.fromMissing(t):xr("invalid batch get response: "+JSON.stringify(t))},Gl.prototype.toWatchTargetChangeState=function(t){switch(t){case Lh.Added:return"ADD";case Lh.Current:return"CURRENT";case Lh.NoChange:return"NO_CHANGE";case Lh.Removed:return"REMOVE";case Lh.Reset:return"RESET";default:return xr("Unknown WatchTargetChangeState: "+t)}},Gl.prototype.toTestWatchChange=function(t){if(t instanceof qh)return{filter:{count:t.existenceFilter.count,targetId:t.targetId}};if(t instanceof xh){if(t.newDoc instanceof Ls){var e=t.newDoc;return{documentChange:{document:{name:this.toName(e.key),fields:this.toFields(e.data()),updateTime:this.toVersion(e.version)},targetIds:t.updatedTargetIds,removedTargetIds:t.removedTargetIds}}}if(t.newDoc instanceof qs)return e=t.newDoc,{documentDelete:{document:this.toName(e.key),readTime:this.toVersion(e.version),removedTargetIds:t.removedTargetIds}};if(null===t.newDoc)return{documentRemove:{document:this.toName(t.key),removedTargetIds:t.removedTargetIds}}}if(t instanceof Fh){var n=void 0;return t.cause&&(n={code:function(t){if(void 0===t)return dh.OK;switch(t){case Qr.OK:return dh.OK;case Qr.CANCELLED:return dh.CANCELLED;case Qr.UNKNOWN:return dh.UNKNOWN;case Qr.DEADLINE_EXCEEDED:return dh.DEADLINE_EXCEEDED;case Qr.RESOURCE_EXHAUSTED:return dh.RESOURCE_EXHAUSTED;case Qr.INTERNAL:return dh.INTERNAL;case Qr.UNAVAILABLE:return dh.UNAVAILABLE;case Qr.UNAUTHENTICATED:return dh.UNAUTHENTICATED;case Qr.INVALID_ARGUMENT:return dh.INVALID_ARGUMENT;case Qr.NOT_FOUND:return dh.NOT_FOUND;case Qr.ALREADY_EXISTS:return dh.ALREADY_EXISTS;case Qr.PERMISSION_DENIED:return dh.PERMISSION_DENIED;case Qr.FAILED_PRECONDITION:return dh.FAILED_PRECONDITION;case Qr.ABORTED:return dh.ABORTED;case Qr.OUT_OF_RANGE:return dh.OUT_OF_RANGE;case Qr.UNIMPLEMENTED:return dh.UNIMPLEMENTED;case Qr.DATA_LOSS:return dh.DATA_LOSS;default:return xr("Unknown status code: "+t)}}(t.cause.code),message:t.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(t.state),targetIds:t.targetIds,resumeToken:this.unsafeCastProtoByteString(t.resumeToken),cause:n}}}return xr("Unrecognized watch change: "+JSON.stringify(t))},Gl.prototype.fromWatchChange=function(t){var e,n=this;if("targetChange"in t){Kl(t.targetChange,"targetChange");var r=this.fromWatchTargetChangeState(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],o=t.targetChange.resumeToken||this.emptyByteString(),a=t.targetChange.cause,s=a&&this.fromRpcStatus(a);e=new Fh(r,i,o,s||null)}else if("documentChange"in t){Kl(t.documentChange,"documentChange"),Kl(t.documentChange.document,"documentChange.name"),Kl(t.documentChange.document.name,"documentChange.document.name"),Kl(t.documentChange.document.updateTime,"documentChange.document.updateTime");var u=t.documentChange,c=this.fromName(u.document.name),h=this.fromVersion(u.document.updateTime),l=new Ls(c,h,{},void 0,u.document,function(t){return n.fromValue(t)}),f=u.targetIds||[],p=u.removedTargetIds||[];e=new xh(f,p,l.key,l)}else if("documentDelete"in t){Kl(t.documentDelete,"documentDelete"),Kl(t.documentDelete.document,"documentDelete.document");var d=t.documentDelete;c=this.fromName(d.document),h=d.readTime?this.fromVersion(d.readTime):ao.forDeletedDoc(),l=new qs(c,h),p=d.removedTargetIds||[],e=new xh([],p,l.key,l)}else if("documentRemove"in t){Kl(t.documentRemove,"documentRemove"),Kl(t.documentRemove.document,"documentRemove");var m=t.documentRemove;c=this.fromName(m.document),p=m.removedTargetIds||[],e=new xh([],p,c,null)}else{if(!("filter"in t))return xr("Unknown change type "+JSON.stringify(t));Kl(t.filter,"filter"),Kl(t.filter.targetId,"filter.targetId");var y=t.filter,g=y.count||0,v=new xl(g),b=y.targetId;e=new qh(b,v)}return e},Gl.prototype.fromWatchTargetChangeState=function(t){return"NO_CHANGE"===t?Lh.NoChange:"ADD"===t?Lh.Added:"REMOVE"===t?Lh.Removed:"CURRENT"===t?Lh.Current:"RESET"===t?Lh.Reset:xr("Got unexpected TargetChange.state: "+t)},Gl.prototype.versionFromListenResponse=function(t){if(!("targetChange"in t))return ao.MIN;var e=t.targetChange;return e.targetIds&&e.targetIds.length?ao.MIN:e.readTime?this.fromVersion(e.readTime):ao.MIN},Gl.prototype.toMutation=function(t){var e,n=this;if(t instanceof Da)e={update:this.toMutationDocument(t.key,t.value)};else if(t instanceof Va)e={delete:this.toName(t.key)};else if(t instanceof ka)e={update:this.toMutationDocument(t.key,t.data),updateMask:this.toDocumentMask(t.fieldMask)};else{if(!(t instanceof _a))return xr("Unknown mutation type "+t.type);e={transform:{document:this.toName(t.key),fieldTransforms:t.fieldTransforms.map(function(t){return n.toFieldTransform(t)})}}}return t.precondition.isNone||(e.currentDocument=this.toPrecondition(t.precondition)),e},Gl.prototype.fromMutation=function(t){var e=this,n=t.currentDocument?this.fromPrecondition(t.currentDocument):Sa.NONE;if(t.update){Kl(t.update.name,"name");var r=this.fromName(t.update.name),i=this.fromFields(t.update.fields||{});if(t.updateMask){var o=this.fromDocumentMask(t.updateMask);return new ka(r,i,o,n)}return new Da(r,i,n)}if(t.delete)return r=this.fromName(t.delete),new Va(r,n);if(t.transform){r=this.fromName(t.transform.document);var a=t.transform.fieldTransforms.map(function(t){return e.fromFieldTransform(t)});return qr(!0===n.exists,'Transforms only support precondition "exists == true"'),new _a(r,a)}return xr("unknown mutation proto: "+JSON.stringify(t))},Gl.prototype.toPrecondition=function(t){return qr(!t.isNone,"Can't serialize an empty precondition"),void 0!==t.updateTime?{updateTime:this.toVersion(t.updateTime)}:void 0!==t.exists?{exists:t.exists}:xr("Unknown precondition")},Gl.prototype.fromPrecondition=function(t){return void 0!==t.updateTime?Sa.updateTime(this.fromVersion(t.updateTime)):void 0!==t.exists?Sa.exists(t.exists):Sa.NONE},Gl.prototype.fromWriteResult=function(t,e){var n=this,r=t.updateTime?this.fromVersion(t.updateTime):this.fromVersion(e),i=null;return t.transformResults&&0<t.transformResults.length&&(i=t.transformResults.map(function(t){return n.fromValue(t)})),new wa(r,i)},Gl.prototype.fromWriteResults=function(t,e){var n=this;return t&&0<t.length?(qr(void 0!==e,"Received a write result without a commit time"),t.map(function(t){return n.fromWriteResult(t,e)})):[]},Gl.prototype.toFieldTransform=function(t){var e=this,n=t.transform;if(n instanceof Nl)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof kl)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof Ml)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof Ol)return{fieldPath:t.field.canonicalString(),increment:this.toValue(n.operand)};throw xr("Unknown transform: "+t.transform)},Gl.prototype.fromFieldTransform=function(t){var e=this,n=null;if("setToServerValue"in t)qr("REQUEST_TIME"===t.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(t)),n=Nl.instance;else if("appendMissingElements"in t){var r=t.appendMissingElements.values||[];n=new kl(r.map(function(t){return e.fromValue(t)}))}else if("removeAllFromArray"in t)r=t.removeAllFromArray.values||[],n=new Ml(r.map(function(t){return e.fromValue(t)}));else if("increment"in t){var i=this.fromValue(t.increment);qr(i instanceof $a,"NUMERIC_ADD transform requires a NumberValue"),n=new Ol(i)}else xr("Unknown transform proto: "+JSON.stringify(t));var o=Vi.fromServerFormat(t.fieldPath);return new ya(o,n)},Gl.prototype.toDocumentsTarget=function(t){return{documents:[this.toQueryPath(t.path)]}},Gl.prototype.fromDocumentsTarget=function(t){var e=t.documents.length;qr(1===e,"DocumentsTarget contained other than 1 document: "+e);var n=t.documents[0];return Xh.atPath(this.fromQueryPath(n))},Gl.prototype.toQueryTarget=function(t){var e={structuredQuery:{}},n=t.path;null!==t.collectionGroup?(qr(n.length%2==0,"Collection Group queries should be within a document path or root."),e.parent=this.toQueryPath(n),e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(qr(n.length%2!=0,"Document queries with filters are not supported."),e.parent=this.toQueryPath(n.popLast()),e.structuredQuery.from=[{collectionId:n.lastSegment()}]);var r=this.toFilter(t.filters);r&&(e.structuredQuery.where=r);var i=this.toOrder(t.orderBy);i&&(e.structuredQuery.orderBy=i);var o=this.toInt32Value(t.limit);return void 0!==o&&(e.structuredQuery.limit=o),t.startAt&&(e.structuredQuery.startAt=this.toCursor(t.startAt)),t.endAt&&(e.structuredQuery.endAt=this.toCursor(t.endAt)),e},Gl.prototype.fromQueryTarget=function(t){var e=this.fromQueryPath(t.parent),n=t.structuredQuery,r=n.from?n.from.length:0,i=null;if(0<r){qr(1===r,"StructuredQuery.from with more than one collection is not supported.");var o=n.from[0];o.allDescendants?i=o.collectionId:e=e.child(o.collectionId)}var a=[];n.where&&(a=this.fromFilter(n.where));var s=[];n.orderBy&&(s=this.fromOrder(n.orderBy));var u=null;n.limit&&(u=this.fromInt32Value(n.limit));var c=null;n.startAt&&(c=this.fromCursor(n.startAt));var h=null;return n.endAt&&(h=this.fromCursor(n.endAt)),new Xh(e,i,s,a,u,c,h)},Gl.prototype.toListenRequestLabels=function(t){var e=this.toLabel(t.purpose);return null==e?null:{"goog-listen-tags":e}},Gl.prototype.toLabel=function(t){switch(t){case qu.Listen:return null;case qu.ExistenceFilterMismatch:return"existence-filter-mismatch";case qu.LimboResolution:return"limbo-document";default:return xr("Unrecognized query purpose: "+t)}},Gl.prototype.toTarget=function(t){var e,n=t.query;return(e=n.isDocumentQuery()?{documents:this.toDocumentsTarget(n)}:{query:this.toQueryTarget(n)}).targetId=t.targetId,0<t.resumeToken.length&&(e.resumeToken=this.unsafeCastProtoByteString(t.resumeToken)),e},Gl.prototype.toFilter=function(t){var e=this;if(0!==t.length){var n=t.map(function(t){return t instanceof nl?e.toUnaryOrFieldFilter(t):xr("Unrecognized filter: "+JSON.stringify(t))});return 1===n.length?n[0]:{compositeFilter:{op:"AND",filters:n}}}},Gl.prototype.fromFilter=function(t){var e=this;return t?void 0!==t.unaryFilter?[this.fromUnaryFilter(t)]:void 0!==t.fieldFilter?[this.fromFieldFilter(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(function(t){return e.fromFilter(t)}).reduce(function(t,e){return t.concat(e)}):xr("Unknown filter: "+JSON.stringify(t)):[]},Gl.prototype.toOrder=function(t){var e=this;if(0!==t.length)return t.map(function(t){return e.toPropertyOrder(t)})},Gl.prototype.fromOrder=function(t){var e=this;return t.map(function(t){return e.fromPropertyOrder(t)})},Gl.prototype.toCursor=function(t){var e=this;return{before:t.before,values:t.position.map(function(t){return e.toValue(t)})}},Gl.prototype.fromCursor=function(t){var e=this,n=!!t.before,r=t.values.map(function(t){return e.fromValue(t)});return new Sl(r,n)},Gl.prototype.toDirection=function(t){return Bl[t.name]},Gl.prototype.fromDirection=function(t){switch(t){case"ASCENDING":return bl.ASCENDING;case"DESCENDING":return bl.DESCENDING;default:return}},Gl.prototype.toOperatorName=function(t){return Ul[t.name]},Gl.prototype.fromOperatorName=function(t){switch(t){case"EQUAL":return Zh.EQUAL;case"GREATER_THAN":return Zh.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return Zh.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return Zh.LESS_THAN;case"LESS_THAN_OR_EQUAL":return Zh.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return Zh.ARRAY_CONTAINS;case"IN":return Zh.IN;case"ARRAY_CONTAINS_ANY":return Zh.ARRAY_CONTAINS_ANY;case"OPERATOR_UNSPECIFIED":return xr("Unspecified operator");default:return xr("Unknown operator")}},Gl.prototype.toFieldPathReference=function(t){return{fieldPath:t.canonicalString()}},Gl.prototype.fromFieldPathReference=function(t){return Vi.fromServerFormat(t.fieldPath)},Gl.prototype.toPropertyOrder=function(t){return{field:this.toFieldPathReference(t.field),direction:this.toDirection(t.dir)}},Gl.prototype.fromPropertyOrder=function(t){return new Tl(this.fromFieldPathReference(t.field),this.fromDirection(t.direction))},Gl.prototype.fromFieldFilter=function(t){return nl.create(this.fromFieldPathReference(t.fieldFilter.field),this.fromOperatorName(t.fieldFilter.op),this.fromValue(t.fieldFilter.value))},Gl.prototype.toUnaryOrFieldFilter=function(t){if(t.op===Zh.EQUAL){if(t.value.isEqual(os.NAN))return{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NAN"}};if(t.value.isEqual(Ga.INSTANCE))return{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NULL"}}}return{fieldFilter:{field:this.toFieldPathReference(t.field),op:this.toOperatorName(t.op),value:this.toValue(t.value)}}},Gl.prototype.fromUnaryFilter=function(t){switch(t.unaryFilter.op){case"IS_NAN":var e=this.fromFieldPathReference(t.unaryFilter.field);return nl.create(e,Zh.EQUAL,os.NAN);case"IS_NULL":var n=this.fromFieldPathReference(t.unaryFilter.field);return nl.create(n,Zh.EQUAL,Ga.INSTANCE);case"OPERATOR_UNSPECIFIED":return xr("Unspecified filter");default:return xr("Unknown filter")}},Gl.prototype.toDocumentMask=function(t){var e=[];return t.fields.forEach(function(t){return e.push(t.canonicalString())}),{fieldPaths:e}},Gl.prototype.fromDocumentMask=function(t){var e=(t.fieldPaths||[]).map(function(t){return Vi.fromServerFormat(t)});return da.fromArray(e)},Gl);function Gl(t,e){this.databaseId=t,this.options=e}var zl=function(){this.viewSnap=null,this.targetId=0,this.listeners=[]},Hl=(Yl.prototype.listen=function(t){var e=t.query,n=!1,r=this.queries.get(e);return r||(n=!0,r=new zl,this.queries.set(e,r)),r.listeners.push(t),qr(!t.applyOnlineStateChange(this.onlineState),"applyOnlineStateChange() shouldn't raise an event for brand-new listeners."),!r.viewSnap||t.onViewSnapshot(r.viewSnap)&&this.raiseSnapshotsInSyncEvent(),n?this.syncEngine.listen(e).then(function(t){return r.targetId=t}):Promise.resolve(r.targetId)},Yl.prototype.unlisten=function(o){return p(this,void 0,void 0,function(){var e,n,r,i;return d(this,function(t){return e=o.query,n=!1,(r=this.queries.get(e))&&0<=(i=r.listeners.indexOf(o))&&(r.listeners.splice(i,1),n=0===r.listeners.length),n?(this.queries.delete(e),[2,this.syncEngine.unlisten(e)]):[2]})})},Yl.prototype.onWatchChange=function(t){for(var e=!1,n=0,r=t;n<r.length;n++){var i=r[n],o=i.query,a=this.queries.get(o);if(a){for(var s=0,u=a.listeners;s<u.length;s++)u[s].onViewSnapshot(i)&&(e=!0);a.viewSnap=i}}e&&this.raiseSnapshotsInSyncEvent()},Yl.prototype.onWatchError=function(t,e){var n=this.queries.get(t);if(n)for(var r=0,i=n.listeners;r<i.length;r++)i[r].onError(e);this.queries.delete(t)},Yl.prototype.onOnlineStateChange=function(i){this.onlineState=i;var o=!1;this.queries.forEach(function(t,e){for(var n=0,r=e.listeners;n<r.length;n++)r[n].applyOnlineStateChange(i)&&(o=!0)}),o&&this.raiseSnapshotsInSyncEvent()},Yl.prototype.addSnapshotsInSyncListener=function(t){this.snapshotsInSyncListeners.add(t),t.next()},Yl.prototype.removeSnapshotsInSyncListener=function(t){this.snapshotsInSyncListeners.delete(t)},Yl.prototype.raiseSnapshotsInSyncEvent=function(){this.snapshotsInSyncListeners.forEach(function(t){t.next()})},Yl);function Yl(t){this.syncEngine=t,this.queries=new Qs(function(t){return t.canonicalId()}),this.onlineState=uh.Unknown,this.snapshotsInSyncListeners=new Set,this.syncEngine.subscribe(this)}var Xl=(Jl.prototype.onViewSnapshot=function(t){if(qr(0<t.docChanges.length||t.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var e=[],n=0,r=t.docChanges;n<r.length;n++){var i=r[n];i.type!==wh.Metadata&&e.push(i)}t=new Ah(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}var o=!1;return this.raisedInitialEvent?this.shouldRaiseEvent(t)&&(this.queryObserver.next(t),o=!0):this.shouldRaiseInitialEvent(t,this.onlineState)&&(this.raiseInitialEvent(t),o=!0),this.snap=t,o},Jl.prototype.onError=function(t){this.queryObserver.error(t)},Jl.prototype.applyOnlineStateChange=function(t){this.onlineState=t;var e=!1;return this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,t)&&(this.raiseInitialEvent(this.snap),e=!0),e},Jl.prototype.shouldRaiseInitialEvent=function(t,e){if(qr(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!t.fromCache)return!0;var n=e!==uh.Offline;return this.options.waitForSyncWhenOnline&&n?(qr(t.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!t.docs.isEmpty()||e===uh.Offline},Jl.prototype.shouldRaiseEvent=function(t){if(0<t.docChanges.length)return!0;var e=this.snap&&this.snap.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges},Jl.prototype.raiseInitialEvent=function(t){qr(!this.raisedInitialEvent,"Trying to raise initial events for second time"),t=Ah.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(t)},Jl);function Jl(t,e,n){this.query=t,this.queryObserver=e,this.raisedInitialEvent=!1,this.snap=null,this.onlineState=uh.Unknown,this.options=n||{}}var $l=(Zl.fromSnapshot=function(t,e){for(var n=ko(),r=ko(),i=0,o=e.docChanges;i<o.length;i++){var a=o[i];switch(a.type){case wh.Added:n=n.add(a.doc.key);break;case wh.Removed:r=r.add(a.doc.key)}}return new Zl(t,n,r)},Zl);function Zl(t,e,n){this.targetId=t,this.addedKeys=e,this.removedKeys=n}var tf=function(t){this.key=t},ef=function(t){this.key=t},nf=(Object.defineProperty(rf.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),rf.prototype.computeDocChanges=function(t,e){var s=this,u=e?e.changeSet:new Dh,c=e?e.documentSet:this.documentSet,h=e?e.mutatedKeys:this.mutatedKeys,l=c,f=!1,p=this.query.hasLimit()&&c.size===this.query.limit?c.last():null;if(t.inorderTraversal(function(t,e){var n=c.get(t),r=e instanceof Ls?e:null;r&&(qr(t.isEqual(r.key),"Mismatching keys found in document changes: "+t+" != "+r.key),r=s.query.matches(r)?r:null);var i=!!n&&s.mutatedKeys.has(n.key),o=!!r&&(r.hasLocalMutations||s.mutatedKeys.has(r.key)&&r.hasCommittedMutations),a=!1;n&&r?n.data().isEqual(r.data())?i!==o&&(u.track({type:wh.Metadata,doc:r}),a=!0):s.shouldWaitForSyncedDocument(n,r)||(u.track({type:wh.Modified,doc:r}),a=!0,p&&0<s.query.docComparator(r,p)&&(f=!0)):!n&&r?(u.track({type:wh.Added,doc:r}),a=!0):n&&!r&&(u.track({type:wh.Removed,doc:n}),a=!0,p&&(f=!0)),a&&(h=r?(l=l.add(r),o?h.add(t):h.delete(t)):(l=l.delete(t),h.delete(t)))}),this.query.hasLimit())for(;l.size>this.query.limit;){var n=l.last();l=l.delete(n.key),h=h.delete(n.key),u.track({type:wh.Removed,doc:n})}return qr(!f||!e,"View was refilled using docs that themselves needed refilling."),{documentSet:l,changeSet:u,needsRefill:f,mutatedKeys:h}},rf.prototype.shouldWaitForSyncedDocument=function(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations},rf.prototype.applyChanges=function(t,e,n){var r=this;qr(!t.needsRefill,"Cannot apply changes that need a refill");var i=this.documentSet;this.documentSet=t.documentSet,this.mutatedKeys=t.mutatedKeys;var o=t.changeSet.getChanges();o.sort(function(t,e){return function(t,e){function n(t){switch(t){case wh.Added:return 1;case wh.Modified:case wh.Metadata:return 2;case wh.Removed:return 0;default:return xr("Unknown ChangeType: "+t)}}return n(t)-n(e)}(t.type,e.type)||r.query.docComparator(t.doc,e.doc)}),this.applyTargetChange(n);var a=e?this.updateLimboDocuments():[],s=0===this.limboDocuments.size&&this.current?Eh.Synced:Eh.Local,u=s!==this.syncState;return this.syncState=s,0!==o.length||u?{snapshot:new Ah(this.query,t.documentSet,i,o,t.mutatedKeys,s===Eh.Local,u,!1),limboChanges:a}:{limboChanges:a}},rf.prototype.applyOnlineStateChange=function(t){return this.current&&t===uh.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new Dh,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},rf.prototype.shouldBeInLimbo=function(t){return!this._syncedDocuments.has(t)&&!!this.documentSet.has(t)&&!this.documentSet.get(t).hasLocalMutations},rf.prototype.applyTargetChange=function(t){var e=this;t&&(t.addedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.add(t)}),t.modifiedDocuments.forEach(function(t){return qr(e._syncedDocuments.has(t),"Modified document "+t+" not found in view.")}),t.removedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.delete(t)}),this.current=t.current)},rf.prototype.updateLimboDocuments=function(){var e=this;if(!this.current)return[];var n=this.limboDocuments;this.limboDocuments=ko(),this.documentSet.forEach(function(t){e.shouldBeInLimbo(t.key)&&(e.limboDocuments=e.limboDocuments.add(t.key))});var r=[];return n.forEach(function(t){e.limboDocuments.has(t)||r.push(new ef(t))}),this.limboDocuments.forEach(function(t){n.has(t)||r.push(new tf(t))}),r},rf.prototype.synchronizeWithPersistedState=function(t,e){this._syncedDocuments=e,this.limboDocuments=ko();var n=this.computeDocChanges(t);return this.applyChanges(n,!0)},rf.prototype.computeInitialSnapshot=function(){return Ah.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===Eh.Local)},rf);function rf(t,e){this.query=t,this._syncedDocuments=e,this.syncState=null,this.current=!1,this.limboDocuments=ko(),this.mutatedKeys=ko(),this.documentSet=new Ih(t.docComparator.bind(t))}var of=(af.prototype.run=function(){this.runWithBackOff()},af.prototype.runWithBackOff=function(){var t=this;this.backoff.backoffAndRun(function(){return p(t,void 0,void 0,function(){var e,n,r=this;return d(this,function(t){return e=this.remoteStore.createTransaction(),(n=this.tryRunUpdateFunction(e))&&n.then(function(t){r.asyncQueue.enqueueAndForget(function(){return e.commit().then(function(){r.deferred.resolve(t)}).catch(function(t){r.handleTransactionError(t)})})}).catch(function(t){r.handleTransactionError(t)}),[2]})})})},af.prototype.tryRunUpdateFunction=function(t){try{var e=this.updateFunction(t);return!Wc(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}},af.prototype.handleTransactionError=function(t){var e=this;0<this.retries&&this.isRetryableTransactionError(t)?(this.retries-=1,this.asyncQueue.enqueueAndForget(function(){return e.runWithBackOff(),Promise.resolve()})):this.deferred.reject(t)},af.prototype.isRetryableTransactionError=function(t){if("FirebaseError"!==t.name)return!1;var e=t.code;return"aborted"===e||"failed-precondition"===e||!vh(e)},af);function af(t,e,n,r){this.asyncQueue=t,this.remoteStore=e,this.updateFunction=n,this.deferred=r,this.retries=5,this.backoff=new zc(this.asyncQueue,Ki.RetryTransaction)}var sf="SyncEngine",uf=function(t,e,n){this.query=t,this.targetId=e,this.view=n},cf=function(t){this.key=t,this.receivedDocument=!1},hf=(Object.defineProperty(lf.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),lf.prototype.subscribe=function(t){qr(null!==t,"SyncEngine listener cannot be null"),qr(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=t},lf.prototype.listen=function(a){return p(this,void 0,void 0,function(){var e,n,r,i,o;return d(this,function(t){switch(t.label){case 0:return this.assertSubscribed("listen()"),(r=this.queryViewsByQuery.get(a))?(e=r.targetId,this.sharedClientState.addLocalQueryTarget(e),n=r.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateQuery(a)];case 2:return i=t.sent(),o=this.sharedClientState.addLocalQueryTarget(i.targetId),e=i.targetId,[4,this.initializeViewAndComputeSnapshot(i,"current"===o)];case 3:n=t.sent(),this.isPrimary&&this.remoteStore.listen(i),t.label=4;case 4:return this.syncEngineListener.onWatchChange([n]),[2,e]}})})},lf.prototype.initializeViewAndComputeSnapshot=function(c,h){return p(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u;return d(this,function(t){switch(t.label){case 0:return e=c.query,[4,this.localStore.executeQuery(e)];case 1:return n=t.sent(),[4,this.localStore.remoteDocumentKeys(c.targetId)];case 2:return r=t.sent(),i=new nf(e,r),o=i.computeDocChanges(n),a=_h.createSynthesizedTargetChangeForCurrentChange(c.targetId,h&&this.onlineState!==uh.Offline),qr(0===(s=i.applyChanges(o,!0===this.isPrimary,a)).limboChanges.length,"View returned limbo docs before target ack from the server."),qr(!!s.snapshot,"applyChanges for new view should always return a snapshot"),u=new uf(e,c.targetId,i),this.queryViewsByQuery.set(e,u),this.queryViewsByTarget[c.targetId]=u,[2,s.snapshot]}})})},lf.prototype.synchronizeViewAndComputeSnapshot=function(i){return p(this,void 0,void 0,function(){var e,n,r;return d(this,function(t){switch(t.label){case 0:return[4,this.localStore.executeQuery(i.query)];case 1:return e=t.sent(),[4,this.localStore.remoteDocumentKeys(i.targetId)];case 2:return n=t.sent(),r=i.view.synchronizeWithPersistedState(e,n),this.isPrimary&&this.updateTrackedLimbos(i.targetId,r.limboChanges),[2,r]}})})},lf.prototype.unlisten=function(r){return p(this,void 0,void 0,function(){var e,n=this;return d(this,function(t){switch(t.label){case 0:return this.assertSubscribed("unlisten()"),qr(!!(e=this.queryViewsByQuery.get(r)),"Trying to unlisten on query not found:"+r),this.isPrimary?(this.sharedClientState.removeLocalQueryTarget(e.targetId),this.sharedClientState.isActiveQueryTarget(e.targetId)?[3,2]:[4,this.localStore.releaseQuery(r,!1).then(function(){n.sharedClientState.clearQueryState(e.targetId),n.remoteStore.unlisten(e.targetId),n.removeAndCleanupQuery(e)}).catch(lc)]):[3,3];case 1:t.sent(),t.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupQuery(e),[4,this.localStore.releaseQuery(r,!0)];case 4:t.sent(),t.label=5;case 5:return[2]}})})},lf.prototype.write=function(n,r){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:return this.assertSubscribed("write()"),[4,this.localStore.localWrite(n)];case 1:return e=t.sent(),this.sharedClientState.addPendingMutation(e.batchId),this.addMutationCallback(e.batchId,r),[4,this.emitNewSnapsAndNotifyLocalStore(e.changes)];case 2:return t.sent(),[4,this.remoteStore.fillWritePipeline()];case 3:return t.sent(),[2]}})})},lf.prototype.runTransaction=function(t,e,n){new of(t,this.remoteStore,e,n).run()},lf.prototype.applyRemoteEvent=function(n){return p(this,void 0,void 0,function(){var e,r=this;return d(this,function(t){switch(t.label){case 0:this.assertSubscribed("applyRemoteEvent()"),t.label=1;case 1:return t.trys.push([1,4,,6]),[4,this.localStore.applyRemoteEvent(n)];case 2:return e=t.sent(),Yr(n.targetChanges,function(t,e){var n=r.limboResolutionsByTarget[Number(t)];n&&(qr(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),0<e.addedDocuments.size?n.receivedDocument=!0:0<e.modifiedDocuments.size?qr(n.receivedDocument,"Received change for limbo target document without add."):0<e.removedDocuments.size&&(qr(n.receivedDocument,"Received remove for limbo target document without add."),n.receivedDocument=!1))}),[4,this.emitNewSnapsAndNotifyLocalStore(e,n)];case 3:return t.sent(),[3,6];case 4:return[4,lc(t.sent())];case 5:return t.sent(),[3,6];case 6:return[2]}})})},lf.prototype.applyOnlineStateChange=function(r,t){if(this.isPrimary&&t===hh.RemoteStore||!this.isPrimary&&t===hh.SharedClientState){this.assertSubscribed("applyOnlineStateChange()");var i=[];this.queryViewsByQuery.forEach(function(t,e){var n=e.view.applyOnlineStateChange(r);qr(0===n.limboChanges.length,"OnlineState should not affect limbo documents."),n.snapshot&&i.push(n.snapshot)}),this.syncEngineListener.onOnlineStateChange(r),this.syncEngineListener.onWatchChange(i),this.onlineState=r,this.isPrimary&&this.sharedClientState.setOnlineState(r)}},lf.prototype.rejectListen=function(u,c){return p(this,void 0,void 0,function(){var e,n,r,i,o,a,s=this;return d(this,function(t){switch(t.label){case 0:return this.assertSubscribed("rejectListens()"),this.sharedClientState.updateQueryState(u,"rejected",c),e=this.limboResolutionsByTarget[u],(n=e&&e.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(n),delete this.limboResolutionsByTarget[u],r=(r=new uo(Ui.comparator)).insert(n,new qs(n,ao.forDeletedDoc())),i=ko().add(n),o=new Rh(ao.MIN,{},new go(gi),r,i),[2,this.applyRemoteEvent(o)]):[3,1];case 1:return qr(!!(a=this.queryViewsByTarget[u]),"Unknown targetId: "+u),[4,this.localStore.releaseQuery(a.query,!1).then(function(){return s.removeAndCleanupQuery(a)}).catch(lc)];case 2:t.sent(),this.syncEngineListener.onWatchError(a.query,c),t.label=3;case 3:return[2]}})})},lf.prototype.applyBatchState=function(n,r,i){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(n)];case 1:return null===(e=t.sent())?(Or(sf,"Cannot apply mutation batch with id: "+n),[2]):"pending"!==r?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return t.sent(),[3,4];case 3:"acknowledged"===r||"rejected"===r?(this.processUserCallback(n,i||null),this.localStore.removeCachedMutationBatchMetadata(n)):xr("Unknown batchState: "+r),t.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(e)];case 5:return t.sent(),[2]}})})},lf.prototype.applySuccessfulWrite=function(r){return p(this,void 0,void 0,function(){var e,n;return d(this,function(t){switch(t.label){case 0:this.assertSubscribed("applySuccessfulWrite()"),e=r.batch.batchId,this.processUserCallback(e,null),this.triggerPendingWritesCallbacks(e),t.label=1;case 1:return t.trys.push([1,4,,6]),[4,this.localStore.acknowledgeBatch(r)];case 2:return n=t.sent(),this.sharedClientState.updateMutationState(e,"acknowledged"),[4,this.emitNewSnapsAndNotifyLocalStore(n)];case 3:return t.sent(),[3,6];case 4:return[4,lc(t.sent())];case 5:return t.sent(),[3,6];case 6:return[2]}})})},lf.prototype.rejectFailedWrite=function(n,r){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(n,r),this.triggerPendingWritesCallbacks(n),t.label=1;case 1:return t.trys.push([1,4,,6]),[4,this.localStore.rejectBatch(n)];case 2:return e=t.sent(),this.sharedClientState.updateMutationState(n,"rejected",r),[4,this.emitNewSnapsAndNotifyLocalStore(e)];case 3:return t.sent(),[3,6];case 4:return[4,lc(t.sent())];case 5:return t.sent(),[3,6];case 6:return[2]}})})},lf.prototype.registerPendingWritesCallback=function(r){return p(this,void 0,void 0,function(){var e,n;return d(this,function(t){switch(t.label){case 0:return this.remoteStore.canUseNetwork()||Or(sf,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled."),[4,this.localStore.getHighestUnacknowledgedBatchId()];case 1:return-1===(e=t.sent())?r.resolve():((n=this.pendingWritesCallbacks.get(e)||[]).push(r),this.pendingWritesCallbacks.set(e,n)),[2]}})})},lf.prototype.triggerPendingWritesCallbacks=function(t){(this.pendingWritesCallbacks.get(t)||[]).forEach(function(t){t.resolve()}),this.pendingWritesCallbacks.delete(t)},lf.prototype.rejectOutstandingPendingWritesCallbacks=function(e){this.pendingWritesCallbacks.forEach(function(t){t.forEach(function(t){t.reject(new Kr(Qr.CANCELLED,e))})}),this.pendingWritesCallbacks.clear()},lf.prototype.addMutationCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];n=(n=n||new uo(gi)).insert(t,e),this.mutationUserCallbacks[this.currentUser.toKey()]=n},lf.prototype.processUserCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];if(n){var r=n.get(t);r&&(qr(t===n.minKey(),"Mutation callbacks processed out-of-order?"),e?r.reject(e):r.resolve(),n=n.remove(t)),this.mutationUserCallbacks[this.currentUser.toKey()]=n}},lf.prototype.removeAndCleanupQuery=function(t){var e=this;if(this.sharedClientState.removeLocalQueryTarget(t.targetId),this.queryViewsByQuery.delete(t.query),delete this.queryViewsByTarget[t.targetId],this.isPrimary){var n=this.limboDocumentRefs.referencesForId(t.targetId);this.limboDocumentRefs.removeReferencesForId(t.targetId),n.forEach(function(t){e.limboDocumentRefs.containsKey(t)||e.removeLimboTarget(t)})}},lf.prototype.removeLimboTarget=function(t){var e=this.limboTargetsByKey.get(t);null!==e&&(this.remoteStore.unlisten(e),this.limboTargetsByKey=this.limboTargetsByKey.remove(t),delete this.limboResolutionsByTarget[e])},lf.prototype.updateTrackedLimbos=function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n];i instanceof tf?(this.limboDocumentRefs.addReference(i.key,t),this.trackLimboChange(i)):i instanceof ef?(Or(sf,"Document no longer in limbo: "+i.key),this.limboDocumentRefs.removeReference(i.key,t),this.limboDocumentRefs.containsKey(i.key)||this.removeLimboTarget(i.key)):xr("Unknown limbo change: "+JSON.stringify(i))}},lf.prototype.trackLimboChange=function(t){var e=t.key;if(!this.limboTargetsByKey.get(e)){Or(sf,"New document in limbo: "+e);var n=this.limboTargetIdGenerator.next(),r=Xh.atPath(e.path);this.limboResolutionsByTarget[n]=new cf(e),this.remoteStore.listen(new Ku(r,n,qu.LimboResolution,ki.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(e,n)}},lf.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},lf.prototype.emitNewSnapsAndNotifyLocalStore=function(n,u){return p(this,void 0,void 0,function(){var o,a,e,s=this;return d(this,function(t){switch(t.label){case 0:return o=[],a=[],e=[],this.queryViewsByQuery.forEach(function(t,i){e.push(Promise.resolve().then(function(){var e=i.view.computeDocChanges(n);return e.needsRefill?s.localStore.executeQuery(i.query).then(function(t){return i.view.computeDocChanges(t,e)}):e}).then(function(t){var e=u&&u.targetChanges[i.targetId],n=i.view.applyChanges(t,!0===s.isPrimary,e);if(s.updateTrackedLimbos(i.targetId,n.limboChanges),n.snapshot){s.isPrimary&&s.sharedClientState.updateQueryState(i.targetId,n.snapshot.fromCache?"not-current":"current"),o.push(n.snapshot);var r=$l.fromSnapshot(i.targetId,n.snapshot);a.push(r)}}))}),[4,Promise.all(e)];case 1:return t.sent(),this.syncEngineListener.onWatchChange(o),[4,this.localStore.notifyLocalViewChanges(a)];case 2:return t.sent(),[2]}})})},lf.prototype.assertSubscribed=function(t){qr(null!==this.syncEngineListener,"Trying to call "+t+" before calling subscribe().")},lf.prototype.handleCredentialChange=function(r){return p(this,void 0,void 0,function(){var e,n;return d(this,function(t){switch(t.label){case 0:return e=!this.currentUser.isEqual(r),this.currentUser=r,e?(this.rejectOutstandingPendingWritesCallbacks("'waitForPendingWrites' promise is rejected due to a user change."),[4,this.localStore.handleUserChange(r)]):[3,3];case 1:return n=t.sent(),this.sharedClientState.handleUserChange(r,n.removedBatchIds,n.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(n.affectedDocuments)];case 2:t.sent(),t.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return t.sent(),[2]}})})},lf.prototype.applyPrimaryState=function(c){return p(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u=this;return d(this,function(t){switch(t.label){case 0:return!0!==c||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return t.sent(),e=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e.toArray())];case 2:for(n=t.sent(),r=0,i=n;r<i.length;r++)o=i[r],this.remoteStore.listen(o);return[3,7];case 3:return!1!==c||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,a=[],s=Promise.resolve(),Hr(this.queryViewsByTarget,function(t,e){u.sharedClientState.isLocalQueryTarget(t)?a.push(t):s=s.then(function(){return u.unlisten(e.query)}),u.remoteStore.unlisten(e.targetId)}),[4,s]);case 4:return t.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(a)];case 5:return t.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:t.sent(),t.label=7;case 7:return[2]}})})},lf.prototype.resetLimboDocuments=function(){var e=this;Hr(this.limboResolutionsByTarget,function(t){e.remoteStore.unlisten(t)}),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new uo(Ui.comparator)},lf.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(h){return p(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u,c;return d(this,function(t){switch(t.label){case 0:e=[],n=[],r=0,i=h,t.label=1;case 1:return r<i.length?(o=i[r],a=void 0,(s=this.queryViewsByTarget[o])?[4,this.localStore.releaseQuery(s.query,!0)]:[3,5]):[3,11];case 2:return t.sent(),[4,this.localStore.allocateQuery(s.query)];case 3:return a=t.sent(),[4,this.synchronizeViewAndComputeSnapshot(s)];case 4:return(u=t.sent()).snapshot&&n.push(u.snapshot),[3,9];case 5:return qr(!0===this.isPrimary,"A secondary tab should never have an active query without an active view."),[4,this.localStore.getQueryForTarget(o)];case 6:return qr(!!(c=t.sent()),"Query data for target "+o+" not found"),[4,this.localStore.allocateQuery(c)];case 7:return a=t.sent(),[4,this.initializeViewAndComputeSnapshot(a,!1)];case 8:t.sent(),t.label=9;case 9:e.push(a),t.label=10;case 10:return r++,[3,1];case 11:return this.syncEngineListener.onWatchChange(n),[2,e]}})})},lf.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},lf.prototype.applyTargetState=function(a,s,u){return p(this,void 0,void 0,function(){var e,n,r,i,o;return d(this,function(t){switch(t.label){case 0:if(this.isPrimary)return Or(sf,"Ignoring unexpected query state notification."),[2];if(!this.queryViewsByTarget[a])return[3,11];switch(s){case"current":case"not-current":return[3,1];case"rejected":return[3,8]}return[3,10];case 1:return t.trys.push([1,4,,8]),[4,this.localStore.getNewDocumentChanges()];case 2:return e=t.sent(),n=Rh.createSynthesizedRemoteEventForCurrentChange(a,"current"===s),[4,this.emitNewSnapsAndNotifyLocalStore(e,n)];case 3:return t.sent(),[3,11];case 4:return function(t){return t.code===Qr.DATA_LOSS&&t.message===zs}(r=t.sent())?(i=[],Hr(this.queryViewsByTarget,function(t){return i.push(t)}),[4,this.synchronizeQueryViewsAndRaiseSnapshots(i)]):[3,6];case 5:return t.sent(),[3,7];case 6:throw r;case 7:return[3,8];case 8:return o=this.queryViewsByTarget[a],this.removeAndCleanupQuery(o),[4,this.localStore.releaseQuery(o.query,!0)];case 9:return t.sent(),this.syncEngineListener.onWatchError(o.query,u),[3,11];case 10:xr("Unexpected target state: "+s),t.label=11;case 11:return[2]}})})},lf.prototype.applyActiveTargetsChange=function(l,f){return p(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u,c,h=this;return d(this,function(t){switch(t.label){case 0:if(!this.isPrimary)return[2];e=0,n=l,t.label=1;case 1:return e<n.length?(c=n[e],qr(!this.queryViewsByTarget[c],"Trying to add an already active target"),[4,this.localStore.getQueryForTarget(c)]):[3,6];case 2:return qr(!!(r=t.sent()),"Query data for active target "+c+" not found"),[4,this.localStore.allocateQuery(r)];case 3:return i=t.sent(),[4,this.initializeViewAndComputeSnapshot(i,!1)];case 4:t.sent(),this.remoteStore.listen(i),t.label=5;case 5:return e++,[3,1];case 6:o=function(e){var n;return d(this,function(t){switch(t.label){case 0:return(n=a.queryViewsByTarget[e])?[4,a.localStore.releaseQuery(n.query,!1).then(function(){h.remoteStore.unlisten(e),h.removeAndCleanupQuery(n)}).catch(lc)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})},a=this,s=0,u=f,t.label=7;case 7:return s<u.length?(c=u[s],[5,o(c)]):[3,10];case 8:t.sent(),t.label=9;case 9:return s++,[3,7];case 10:return[2]}})})},lf.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},lf.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},lf.prototype.getRemoteKeysForTarget=function(t){var e=this.limboResolutionsByTarget[t];return e&&e.receivedDocument?ko().add(e.key):this.queryViewsByTarget[t]?this.queryViewsByTarget[t].view.syncedDocuments:ko()},lf);function lf(t,e,n,r){this.localStore=t,this.remoteStore=e,this.sharedClientState=n,this.currentUser=r,this.syncEngineListener=null,this.queryViewsByQuery=new Qs(function(t){return t.canonicalId()}),this.queryViewsByTarget={},this.limboTargetsByKey=new uo(Ui.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new bc,this.mutationUserCallbacks={},this.pendingWritesCallbacks=new Map,this.limboTargetIdGenerator=Ho.forSyncEngine(),this.isPrimary=void 0,this.onlineState=uh.Unknown}var ff=(pf.prototype.isAuthenticated=function(){return null!=this.uid},pf.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},pf.prototype.isEqual=function(t){return t.uid===this.uid},pf.UNAUTHENTICATED=new pf(null),pf.GOOGLE_CREDENTIALS=new pf("google-credentials-uid"),pf.FIRST_PARTY=new pf("first-party-uid"),pf);function pf(t){this.uid=t}var df="SharedClientState",mf="firestore_clients",yf="firestore_mutations",gf="firestore_targets",vf=(bf.fromWebStorageEntry=function(t,e,n){var r=JSON.parse(n),i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),o=void 0;return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(o=new Kr(r.error.code,r.error.message)),i?new bf(t,e,r.state,o):(Lr(df,"Failed to parse mutation state for ID '"+e+"': "+n),null)},bf.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},bf);function bf(t,e,n,r){this.user=t,this.batchId=e,this.state=n,qr(void 0!==(this.error=r)==("rejected"===n),"MutationMetadata must contain an error iff state is 'rejected'")}var wf=(Sf.fromWebStorageEntry=function(t,e){var n=JSON.parse(e),r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error),i=void 0;return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(i=new Kr(n.error.code,n.error.message)),r?new Sf(t,n.state,i):(Lr(df,"Failed to parse target state for ID '"+t+"': "+e),null)},Sf.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},Sf);function Sf(t,e,n){this.targetId=t,this.state=e,qr(void 0!==(this.error=n)==("rejected"===e),"QueryTargetMetadata must contain an error iff state is 'rejected'")}var Ef=(Tf.fromWebStorageEntry=function(t,e){for(var n=JSON.parse(e),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=Mo(),o=0;r&&o<n.activeTargetIds.length;++o)r=Gc(n.activeTargetIds[o]),i=i.add(n.activeTargetIds[o]);return r?new Tf(t,i):(Lr(df,"Failed to parse client data for instance '"+t+"': "+e),null)},Tf);function Tf(t,e){this.clientId=t,this.activeTargetIds=e}var If=(Cf.fromWebStorageEntry=function(t){var e=JSON.parse(t);return"object"==typeof e&&e.onlineState in uh&&"string"==typeof e.clientId?new Cf(e.clientId,uh[e.onlineState]):(Lr(df,"Failed to parse online state: "+t),null)},Cf);function Cf(t,e){this.clientId=t,this.onlineState=e}var Df=(Nf.prototype.addQueryTarget=function(t){qr(!this.activeTargetIds.has(t),"Target with ID '"+t+"' already active."),this.activeTargetIds=this.activeTargetIds.add(t)},Nf.prototype.removeQueryTarget=function(t){this.activeTargetIds=this.activeTargetIds.delete(t)},Nf.prototype.toWebStorageJSON=function(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)},Nf);function Nf(){this.activeTargetIds=Mo()}var Af=(kf.isAvailable=function(t){return!(!t.window||null==t.window.localStorage)},kf.prototype.start=function(){return p(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u,c,h,l,f=this;return d(this,function(t){switch(t.label){case 0:return qr(!this.started,"WebStorageSharedClientState already started"),qr(null!==this.syncEngine,"syncEngine property must be set before calling start()"),qr(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(e=t.sent(),n=0,r=e;n<r.length;n++)(i=r[n])!==this.localClientId&&(o=this.getItem(this.toWebStorageClientStateKey(i)))&&(a=Ef.fromWebStorageEntry(i,o))&&(this.activeClients[a.clientId]=a);for(this.persistClientState(),(s=this.storage.getItem(this.onlineStateKey))&&(u=this.fromWebStorageOnlineState(s))&&this.handleOnlineStateEvent(u),c=0,h=this.earlyEvents;c<h.length;c++)l=h[c],this.handleWebStorageEvent(l);return this.earlyEvents=[],this.platform.window.addEventListener("unload",function(){return f.shutdown()}),this.started=!0,[2]}})})},kf.prototype.writeSequenceNumber=function(t){this.setItem(this.sequenceNumberKey,JSON.stringify(t))},kf.prototype.getAllActiveQueryTargets=function(){var n=Mo();return Yr(this.activeClients,function(t,e){n=n.unionWith(e.activeTargetIds)}),n},kf.prototype.isActiveQueryTarget=function(t){for(var e in this.activeClients)if(this.activeClients.hasOwnProperty(e)&&this.activeClients[e].activeTargetIds.has(t))return!0;return!1},kf.prototype.addPendingMutation=function(t){this.persistMutationState(t,"pending")},kf.prototype.updateMutationState=function(t,e,n){this.persistMutationState(t,e,n),this.removeMutationState(t)},kf.prototype.addLocalQueryTarget=function(t){var e="not-current";if(this.isActiveQueryTarget(t)){var n=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(t));if(n){var r=wf.fromWebStorageEntry(t,n);r&&(e=r.state)}}return this.localClientState.addQueryTarget(t),this.persistClientState(),e},kf.prototype.removeLocalQueryTarget=function(t){this.localClientState.removeQueryTarget(t),this.persistClientState()},kf.prototype.isLocalQueryTarget=function(t){return this.localClientState.activeTargetIds.has(t)},kf.prototype.clearQueryState=function(t){this.removeItem(this.toWebStorageQueryTargetMetadataKey(t))},kf.prototype.updateQueryState=function(t,e,n){this.persistQueryTargetState(t,e,n)},kf.prototype.handleUserChange=function(t,e,n){var r=this;e.forEach(function(t){r.removeMutationState(t)}),this.currentUser=t,n.forEach(function(t){r.addPendingMutation(t)})},kf.prototype.setOnlineState=function(t){this.persistOnlineState(t)},kf.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},kf.prototype.getItem=function(t){var e=this.storage.getItem(t);return Or(df,"READ",t,e),e},kf.prototype.setItem=function(t,e){Or(df,"SET",t,e),this.storage.setItem(t,e)},kf.prototype.removeItem=function(t){Or(df,"REMOVE",t),this.storage.removeItem(t)},kf.prototype.handleWebStorageEvent=function(s){var t=this;if(s.storageArea===this.storage){if(Or(df,"EVENT",s.key,s.newValue),s.key===this.localClientStorageKey)return void Lr("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueAndForget(function(){return p(t,void 0,void 0,function(){var e,n,r,i,o,a;return d(this,function(t){if(!this.started)return this.earlyEvents.push(s),[2];if(null===s.key)return[2];if(this.clientStateKeyRe.test(s.key)){if(null==s.newValue)return n=this.fromWebStorageClientStateKey(s.key),[2,this.handleClientStateEvent(n,null)];if(e=this.fromWebStorageClientState(s.key,s.newValue))return[2,this.handleClientStateEvent(e.clientId,e)]}else if(this.mutationBatchKeyRe.test(s.key)){if(null!==s.newValue&&(r=this.fromWebStorageMutationMetadata(s.key,s.newValue)))return[2,this.handleMutationBatchEvent(r)]}else if(this.queryTargetKeyRe.test(s.key)){if(null!==s.newValue&&(i=this.fromWebStorageQueryTargetMetadata(s.key,s.newValue)))return[2,this.handleQueryTargetEvent(i)]}else if(s.key===this.onlineStateKey){if(null!==s.newValue&&(o=this.fromWebStorageOnlineState(s.newValue)))return[2,this.handleOnlineStateEvent(o)]}else s.key===this.sequenceNumberKey&&(qr(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(a=function(t){var e=ki.INVALID;if(null!=t)try{var n=JSON.parse(t);qr("number"==typeof n,"Found non-numeric sequence number"),e=n}catch(t){Lr(df,"Failed to read sequence number from WebStorage",t)}return e}(s.newValue))!==ki.INVALID&&this.sequenceNumberHandler(a));return[2]})})})}},Object.defineProperty(kf.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),kf.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},kf.prototype.persistMutationState=function(t,e,n){var r=new vf(this.currentUser,t,e,n),i=this.toWebStorageMutationBatchKey(t);this.setItem(i,r.toWebStorageJSON())},kf.prototype.removeMutationState=function(t){var e=this.toWebStorageMutationBatchKey(t);this.removeItem(e)},kf.prototype.persistOnlineState=function(t){var e={clientId:this.localClientId,onlineState:uh[t]};this.storage.setItem(this.onlineStateKey,JSON.stringify(e))},kf.prototype.persistQueryTargetState=function(t,e,n){var r=this.toWebStorageQueryTargetMetadataKey(t),i=new wf(t,e,n);this.setItem(r,i.toWebStorageJSON())},kf.prototype.toWebStorageClientStateKey=function(t){return qr(-1===t.indexOf("_"),"Client key cannot contain '_', but was '"+t+"'"),mf+"_"+this.persistenceKey+"_"+t},kf.prototype.toWebStorageQueryTargetMetadataKey=function(t){return gf+"_"+this.persistenceKey+"_"+t},kf.prototype.toWebStorageMutationBatchKey=function(t){var e=yf+"_"+this.persistenceKey+"_"+t;return this.currentUser.isAuthenticated()&&(e+="_"+this.currentUser.uid),e},kf.prototype.fromWebStorageClientStateKey=function(t){var e=this.clientStateKeyRe.exec(t);return e?e[1]:null},kf.prototype.fromWebStorageClientState=function(t,e){var n=this.fromWebStorageClientStateKey(t);return qr(null!==n,"Cannot parse client state key '"+t+"'"),Ef.fromWebStorageEntry(n,e)},kf.prototype.fromWebStorageMutationMetadata=function(t,e){var n=this.mutationBatchKeyRe.exec(t);qr(null!==n,"Cannot parse mutation batch key '"+t+"'");var r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return vf.fromWebStorageEntry(new ff(i),r,e)},kf.prototype.fromWebStorageQueryTargetMetadata=function(t,e){var n=this.queryTargetKeyRe.exec(t);qr(null!==n,"Cannot parse query target key '"+t+"'");var r=Number(n[1]);return wf.fromWebStorageEntry(r,e)},kf.prototype.fromWebStorageOnlineState=function(t){return If.fromWebStorageEntry(t)},kf.prototype.handleMutationBatchEvent=function(e){return p(this,void 0,void 0,function(){return d(this,function(t){return e.user.uid!==this.currentUser.uid?(Or(df,"Ignoring mutation for non-active user "+e.user.uid),[2]):[2,this.syncEngine.applyBatchState(e.batchId,e.state,e.error)]})})},kf.prototype.handleQueryTargetEvent=function(t){return this.syncEngine.applyTargetState(t.targetId,t.state,t.error)},kf.prototype.handleClientStateEvent=function(t,e){var n=this,r=this.getAllActiveQueryTargets();e?this.activeClients[t]=e:delete this.activeClients[t];var i=this.getAllActiveQueryTargets(),o=[],a=[];return i.forEach(function(e){return p(n,void 0,void 0,function(){return d(this,function(t){return r.has(e)||o.push(e),[2]})})}),r.forEach(function(e){return p(n,void 0,void 0,function(){return d(this,function(t){return i.has(e)||a.push(e),[2]})})}),this.syncEngine.applyActiveTargetsChange(o,a)},kf.prototype.handleOnlineStateEvent=function(t){this.activeClients[t.clientId]&&this.onlineStateHandler(t.onlineState)},kf);function kf(t,e,n,r,i){if(this.queue=t,this.platform=e,this.persistenceKey=n,this.localClientId=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!kf.isAvailable(this.platform))throw new Kr(Qr.UNIMPLEMENTED,"LocalStorage is not available on this platform.");var o=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=i,this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId),this.sequenceNumberKey="firestore_sequence_number_"+n,this.activeClients[this.localClientId]=new Df,this.clientStateKeyRe=new RegExp("^"+mf+"_"+o+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+yf+"_"+o+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+gf+"_"+o+"_(\\d+)$"),this.onlineStateKey="firestore_online_state_"+n,this.platform.window.addEventListener("storage",this.storageListener)}var Rf=(Mf.prototype.addPendingMutation=function(t){},Mf.prototype.updateMutationState=function(t,e,n){},Mf.prototype.addLocalQueryTarget=function(t){return this.localState.addQueryTarget(t),this.queryState[t]||"not-current"},Mf.prototype.updateQueryState=function(t,e,n){this.queryState[t]=e},Mf.prototype.removeLocalQueryTarget=function(t){this.localState.removeQueryTarget(t)},Mf.prototype.isLocalQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},Mf.prototype.clearQueryState=function(t){delete this.queryState[t]},Mf.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},Mf.prototype.isActiveQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},Mf.prototype.start=function(){return this.localState=new Df,Promise.resolve()},Mf.prototype.handleUserChange=function(t,e,n){},Mf.prototype.setOnlineState=function(t){},Mf.prototype.shutdown=function(){},Mf.prototype.writeSequenceNumber=function(t){},Mf);function Mf(){this.localState=new Df,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}var _f="FirestoreClient",Of=(Lf.prototype.lruParams=function(){return Ju.withCacheSize(this.cacheSizeBytes)},Lf);function Lf(t,e){this.cacheSizeBytes=t,this.synchronizeTabs=e}var Pf=function(){},xf=(qf.prototype.start=function(t){var n=this;this.verifyNotTerminated();var r=new Wi,i=new Wi,o=!1;return this.credentials.setChangeListener(function(e){o?n.asyncQueue.enqueueAndForget(function(){return n.handleCredentialChange(e)}):(o=!0,n.initializePersistence(t,i,e).then(function(t){return n.initializeRest(e,t)}).then(r.resolve,r.reject))}),this.asyncQueue.enqueueAndForget(function(){return r.promise}),i.promise},qf.prototype.enableNetwork=function(){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue(function(){return t.syncEngine.enableNetwork()})},qf.prototype.initializePersistence=function(t,e,n){var r=this;return t instanceof Of?this.startIndexedDbPersistence(n,t).then(function(t){return e.resolve(),t}).catch(function(t){if(e.reject(t),!r.canFallback(t))throw t;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),r.startMemoryPersistence()}):(e.resolve(),this.startMemoryPersistence())},qf.prototype.canFallback=function(t){return t instanceof Kr?t.code===Qr.FAILED_PRECONDITION||t.code===Qr.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code},qf.prototype.verifyNotTerminated=function(){if(this.asyncQueue.isShuttingDown)throw new Kr(Qr.FAILED_PRECONDITION,"The client has already been terminated.")},qf.prototype.startIndexedDbPersistence=function(r,i){var t=this,o=cc.buildStoragePrefix(this.databaseInfo),a=new Wl(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then(function(){return p(t,void 0,void 0,function(){var e,n;return d(this,function(t){switch(t.label){case 0:if(i.synchronizeTabs&&!Af.isAvailable(this.platform))throw new Kr(Qr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return e=i.lruParams(),this.sharedClientState=i.synchronizeTabs?new Af(this.asyncQueue,this.platform,o,this.clientId,r):new Rf,[4,cc.createIndexedDbPersistence({allowTabSynchronization:i.synchronizeTabs,persistenceKey:o,clientId:this.clientId,platform:this.platform,queue:this.asyncQueue,serializer:a,lruParams:e,sequenceNumberSyncer:this.sharedClientState})];case 1:return n=t.sent(),[2,(this.persistence=n).referenceDelegate.garbageCollector]}})})})},qf.prototype.startMemoryPersistence=function(){return this.persistence=Lc.createEagerPersistence(this.clientId),this.sharedClientState=new Rf,Promise.resolve(null)},qf.prototype.initializeRest=function(u,c){var t=this;return Or(_f,"Initializing. user=",u.uid),this.platform.loadConnection(this.databaseInfo).then(function(s){return p(t,void 0,void 0,function(){var e,n,r,i,o,a=this;return d(this,function(t){switch(t.label){case 0:return this.localStore=new Ic(this.persistence,u),c&&(this.lruScheduler=new Zu(c,this.asyncQueue,this.localStore)),e=this.platform.newConnectivityMonitor(),n=this.platform.newSerializer(this.databaseInfo.databaseId),r=new ah(this.asyncQueue,s,this.credentials,n),i=function(t){return a.syncEngine.applyOnlineStateChange(t,hh.RemoteStore)},o=function(t){return a.syncEngine.applyOnlineStateChange(t,hh.SharedClientState)},this.remoteStore=new Gh(this.localStore,r,this.asyncQueue,i,e),this.syncEngine=new hf(this.localStore,this.remoteStore,this.sharedClientState,u),this.sharedClientState.onlineStateHandler=o,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new Hl(this.syncEngine),[4,this.sharedClientState.start()];case 1:return t.sent(),[4,this.remoteStore.start()];case 2:return t.sent(),[4,this.persistence.setPrimaryStateListener(function(e){return p(a,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return[4,this.syncEngine.applyPrimaryState(e)];case 1:return t.sent(),this.lruScheduler&&(e&&!this.lruScheduler.started?this.lruScheduler.start():e||this.lruScheduler.stop()),[2]}})})})];case 3:return t.sent(),[4,this.persistence.setDatabaseDeletedListener(function(){return p(a,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return[4,this.terminate()];case 1:return t.sent(),[2]}})})})];case 4:return t.sent(),[2]}})})})},qf.prototype.handleCredentialChange=function(t){return this.asyncQueue.verifyOperationInProgress(),Or(_f,"Credential Changed. Current user: "+t.uid),this.syncEngine.handleCredentialChange(t)},qf.prototype.disableNetwork=function(){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue(function(){return t.syncEngine.disableNetwork()})},qf.prototype.terminate=function(){var t=this;return this.asyncQueue.enqueueAndInitiateShutdown(function(){return p(t,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.lruScheduler&&this.lruScheduler.stop(),[4,this.remoteStore.shutdown()];case 1:return t.sent(),[4,this.sharedClientState.shutdown()];case 2:return t.sent(),[4,this.persistence.shutdown()];case 3:return t.sent(),this.credentials.removeChangeListener(),[2]}})})})},qf.prototype.waitForPendingWrites=function(){var t=this;this.verifyNotTerminated();var e=new Wi;return this.asyncQueue.enqueueAndForget(function(){return t.syncEngine.registerPendingWritesCallback(e)}),e.promise},qf.prototype.listen=function(t,e,n){var r=this;this.verifyNotTerminated();var i=new Xl(t,e,n);return this.asyncQueue.enqueueAndForget(function(){return r.eventMgr.listen(i)}),i},qf.prototype.unlisten=function(t){var e=this;this.clientTerminated||this.asyncQueue.enqueueAndForget(function(){return e.eventMgr.unlisten(t)})},qf.prototype.getDocumentFromLocalCache=function(t){var e=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue(function(){return e.localStore.readDocument(t)}).then(function(t){if(t instanceof Ls)return t;if(t instanceof qs)return null;throw new Kr(Qr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")})},qf.prototype.getDocumentsFromLocalCache=function(i){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue(function(){return t.localStore.executeQuery(i)}).then(function(t){var e=ko(),n=new nf(i,e),r=n.computeDocChanges(t);return n.applyChanges(r,!1).snapshot})},qf.prototype.write=function(t){var e=this;this.verifyNotTerminated();var n=new Wi;return this.asyncQueue.enqueueAndForget(function(){return e.syncEngine.write(t,n)}),n.promise},qf.prototype.databaseId=function(){return this.databaseInfo.databaseId},qf.prototype.addSnapshotsInSyncListener=function(t){var e=this;this.verifyNotTerminated(),this.asyncQueue.enqueueAndForget(function(){return e.eventMgr.addSnapshotsInSyncListener(t),Promise.resolve()})},qf.prototype.removeSnapshotsInSyncListener=function(t){this.clientTerminated||this.eventMgr.removeSnapshotsInSyncListener(t)},Object.defineProperty(qf.prototype,"clientTerminated",{get:function(){return this.asyncQueue.isShuttingDown},enumerable:!0,configurable:!0}),qf.prototype.transaction=function(t){var e=this;this.verifyNotTerminated();var n=new Wi;return this.asyncQueue.enqueueAndForget(function(){return e.syncEngine.runTransaction(e.asyncQueue,t,n),Promise.resolve()}),n.promise},qf);function qf(t,e,n,r){this.platform=t,this.databaseInfo=e,this.credentials=n,this.asyncQueue=r,this.clientId=mi.newId()}var Ff=(Vf.prototype.next=function(t){this.scheduleEvent(this.observer.next,t)},Vf.prototype.error=function(t){this.scheduleEvent(this.observer.error,t)},Vf.prototype.mute=function(){this.muted=!0},Vf.prototype.scheduleEvent=function(t,e){var n=this;this.muted||setTimeout(function(){n.muted||t(e)},0)},Vf);function Vf(t){this.observer=t,this.muted=!1}var Bf=(Uf.documentId=function(){return Uf._DOCUMENT_ID},Uf.prototype.isEqual=function(t){if(!(t instanceof Uf))throw fi("isEqual","FieldPath",1,t);return this._internalPath.isEqual(t._internalPath)},Uf._DOCUMENT_ID=new Uf(Vi.keyField().canonicalString()),Uf);function Uf(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];!function(t,e,n,r){if(!(e instanceof Array)||e.length<r)throw new Kr(Qr.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" argument to be an array with at least "+di(r,"element")+".")}("FieldPath",t,"fieldNames",1);for(var n=0;n<t.length;++n)if(ei("FieldPath","string",n,t[n]),0===t[n].length)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Vi(t)}var Qf=new RegExp("[~\\*/\\[\\]]");var Kf=function(t,e){this.user=e,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+t}},jf=(Wf.prototype.getToken=function(){return Promise.resolve(null)},Wf.prototype.invalidateToken=function(){},Wf.prototype.setChangeListener=function(t){qr(!this.changeListener,"Can only call setChangeListener() once."),(this.changeListener=t)(ff.UNAUTHENTICATED)},Wf.prototype.removeChangeListener=function(){qr(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},Wf);function Wf(){this.changeListener=null}var Gf=(zf.prototype.getToken=function(){var e=this;qr(null!=this.tokenListener,"getToken cannot be called after listener removed.");var n=this.tokenCounter,t=this.forceRefresh;return this.forceRefresh=!1,this.app.INTERNAL.getToken(t).then(function(t){if(e.tokenCounter!==n)throw new Kr(Qr.ABORTED,"getToken aborted due to token change.");return t?(qr("string"==typeof t.accessToken,"Invalid tokenData returned from getToken():"+t),new Kf(t.accessToken,e.currentUser)):null})},zf.prototype.invalidateToken=function(){this.forceRefresh=!0},zf.prototype.setChangeListener=function(t){qr(!this.changeListener,"Can only call setChangeListener() once."),(this.changeListener=t)(this.currentUser)},zf.prototype.removeChangeListener=function(){qr(null!=this.tokenListener,"removeChangeListener() called twice"),qr(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},zf.prototype.getUser=function(){var t=this.app.INTERNAL.getUid();return qr(null===t||"string"==typeof t,"Received invalid UID: "+t),new ff(t)},zf);function zf(t){var e=this;this.app=t,this.tokenListener=null,this.currentUser=ff.UNAUTHENTICATED,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){e.tokenCounter++,e.currentUser=e.getUser(),e.changeListener&&e.changeListener(e.currentUser)},this.currentUser=this.getUser(),this.tokenCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}var Hf=(Object.defineProperty(Yf.prototype,"authHeaders",{get:function(){var t={"X-Goog-AuthUser":this.sessionIndex},e=this.gapi.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),t},enumerable:!0,configurable:!0}),Yf);function Yf(t,e){this.gapi=t,this.sessionIndex=e,this.type="FirstParty",this.user=ff.FIRST_PARTY}var Xf=(Jf.prototype.getToken=function(){return Promise.resolve(new Hf(this.gapi,this.sessionIndex))},Jf.prototype.setChangeListener=function(t){t(ff.FIRST_PARTY)},Jf.prototype.removeChangeListener=function(){},Jf.prototype.invalidateToken=function(){},Jf);function Jf(t,e){this.gapi=t,this.sessionIndex=e}function $f(t){return function(t,e){if("object"!=typeof t||null===t)return!1;for(var n=t,r=0,i=e;r<i.length;r++){var o=i[r];if(o in n&&"function"==typeof n[o])return!0}return!1}(t,["next","error","complete"])}var Zf=(tp.delete=function(){return Jr("FieldValue.delete",arguments),np.instance},tp.serverTimestamp=function(){return Jr("FieldValue.serverTimestamp",arguments),op.instance},tp.arrayUnion=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return Zr("FieldValue.arrayUnion",arguments,1),new up(t)},tp.arrayRemove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return Zr("FieldValue.arrayRemove",arguments,1),new lp(t)},tp.increment=function(t){return ei("FieldValue.increment","number",1,t),$r("FieldValue.increment",arguments,1),new dp(t)},tp.prototype.isEqual=function(t){return this===t},tp);function tp(t){this._methodName=t}var ep,np=(s(rp,ep=Zf),rp.instance=new rp,rp);function rp(){return ep.call(this,"FieldValue.delete")||this}var ip,op=(s(ap,ip=Zf),ap.instance=new ap,ap);function ap(){return ip.call(this,"FieldValue.serverTimestamp")||this}var sp,up=(s(cp,sp=Zf),cp);function cp(t){var e=sp.call(this,"FieldValue.arrayUnion")||this;return e._elements=t,e}var hp,lp=(s(fp,hp=Zf),fp);function fp(t){var e=hp.call(this,"FieldValue.arrayRemove")||this;return e._elements=t,e}var pp,dp=(s(mp,pp=Zf),mp);function mp(t){var e=pp.call(this,"FieldValue.increment")||this;return e._operand=t,e}var yp=Wr(Zf,"Use FieldValue.<field>() instead."),gp=/^__.*__$/,vp=(bp.prototype.toMutations=function(t,e){var n=[];return null!==this.fieldMask?n.push(new ka(t,this.data,this.fieldMask,e)):n.push(new Da(t,this.data,e)),0<this.fieldTransforms.length&&n.push(new _a(t,this.fieldTransforms)),n},bp);function bp(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}var wp,Sp,Ep=(Tp.prototype.toMutations=function(t,e){var n=[new ka(t,this.data,this.fieldMask,e)];return 0<this.fieldTransforms.length&&n.push(new _a(t,this.fieldTransforms)),n},Tp);function Tp(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}function Ip(t){switch(t){case wp.Set:case wp.MergeSet:case wp.Update:return!0;case wp.Argument:return!1;default:throw xr("Unexpected case for UserDataSource: "+t)}}(Sp=wp=wp||{})[Sp.Set=0]="Set",Sp[Sp.Update=1]="Update",Sp[Sp.MergeSet=2]="MergeSet",Sp[Sp.Argument=3]="Argument";var Cp=(Dp.prototype.childContextForField=function(t){var e=null==this.path?null:this.path.child(t),n=new Dp(this.dataSource,this.methodName,e,!1,this.fieldTransforms,this.fieldMask);return n.validatePathSegment(t),n},Dp.prototype.childContextForFieldPath=function(t){var e=null==this.path?null:this.path.child(t),n=new Dp(this.dataSource,this.methodName,e,!1,this.fieldTransforms,this.fieldMask);return n.validatePath(),n},Dp.prototype.childContextForArray=function(t){return new Dp(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},Dp.prototype.createError=function(t){var e=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new Kr(Qr.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+t+e)},Dp.prototype.contains=function(e){return void 0!==this.fieldMask.find(function(t){return e.isPrefixOf(t)})||void 0!==this.fieldTransforms.find(function(t){return e.isPrefixOf(t.field)})},Dp.prototype.validatePath=function(){if(null!==this.path)for(var t=0;t<this.path.length;t++)this.validatePathSegment(this.path.get(t))},Dp.prototype.validatePathSegment=function(t){if(Ip(this.dataSource)&&gp.test(t))throw this.createError("Document fields cannot begin and end with __")},Dp);function Dp(t,e,n,r,i,o){this.dataSource=t,this.methodName=e,this.path=n,this.arrayElement=r,void 0===i&&this.validatePath(),this.arrayElement=void 0!==r&&r,this.fieldTransforms=i||[],this.fieldMask=o||[]}var Np=function(t,e){this.databaseId=t,this.key=e},Ap=(kp.prototype.parseSetData=function(t,e){var n=new Cp(wp.Set,t,Vi.EMPTY_PATH);Mp("Data must be an object, but it was:",n,e);var r=this.parseData(e,n);return new vp(r,null,n.fieldTransforms)},kp.prototype.parseMergeData=function(t,e,n){var r=new Cp(wp.MergeSet,t,Vi.EMPTY_PATH);Mp("Data must be an object, but it was:",r,e);var i,o,a=this.parseData(e,r);if(n){for(var s=new go(Vi.comparator),u=0,c=n;u<c.length;u++){var h=c[u],l=void 0;if(h instanceof Bf)l=h._internalPath;else{if("string"!=typeof h)throw xr("Expected stringOrFieldPath to be a string or a FieldPath");l=Op(t,h)}if(!r.contains(l))throw new Kr(Qr.INVALID_ARGUMENT,"Field '"+l+"' is specified in your field mask but missing from your input data.");s=s.add(l)}i=da.fromSet(s),o=r.fieldTransforms.filter(function(t){return i.covers(t.field)})}else i=da.fromArray(r.fieldMask),o=r.fieldTransforms;return new vp(a,i,o)},kp.prototype.parseUpdateData=function(o,t){var a=this,s=new Cp(wp.Update,o,Vi.EMPTY_PATH);Mp("Data must be an object, but it was:",s,t);var u=new go(Vi.comparator),c=Ds.EMPTY;Yr(t,function(t,e){var n=Op(o,t),r=s.childContextForFieldPath(n);if((e=a.runPreConverter(e,r))instanceof np)u=u.add(n);else{var i=a.parseData(e,r);null!=i&&(u=u.add(n),c=c.set(n,i))}});var e=da.fromSet(u);return new Ep(c,e,s.fieldTransforms)},kp.prototype.parseUpdateVarargs=function(t,e,n,r){var i=new Cp(wp.Update,t,Vi.EMPTY_PATH),o=[_p(t,e)],a=[n];if(r.length%2!=0)throw new Kr(Qr.INVALID_ARGUMENT,"Function "+t+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var s=0;s<r.length;s+=2)o.push(_p(t,r[s])),a.push(r[s+1]);var u=new go(Vi.comparator),c=Ds.EMPTY;for(s=0;s<o.length;++s){var h=o[s],l=i.childContextForFieldPath(h),f=this.runPreConverter(a[s],l);if(f instanceof np)u=u.add(h);else{var p=this.parseData(f,l);null!=p&&(u=u.add(h),c=c.set(h,p))}}var d=da.fromSet(u);return new Ep(c,d,i.fieldTransforms)},kp.prototype.parseQueryValue=function(t,e){var n=new Cp(wp.Argument,t,Vi.EMPTY_PATH),r=this.parseData(e,n);return qr(null!=r,"Parsed data should not be null."),qr(0===n.fieldTransforms.length,"Field transforms should have been disallowed."),r},kp.prototype.runPreConverter=function(t,e){try{return this.preConverter(t)}catch(t){var n=Lp(t);throw e.createError(n)}},kp.prototype.parseData=function(t,e){if(Rp(t=this.runPreConverter(t,e)))return Mp("Unsupported field value:",e,t),this.parseObject(t,e);if(t instanceof Zf)return this.parseSentinelFieldValue(t,e),null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.arrayElement)throw e.createError("Nested arrays are not supported");return this.parseArray(t,e)}return this.parseScalarValue(t,e)},kp.prototype.parseObject=function(t,r){var i=this,o=new uo(gi);return Xr(t)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):Yr(t,function(t,e){var n=i.parseData(e,r.childContextForField(t));null!=n&&(o=o.insert(t,n))}),new Ds(o)},kp.prototype.parseArray=function(t,e){for(var n=[],r=0,i=0,o=t;i<o.length;i++){var a=o[i],s=this.parseData(a,e.childContextForArray(r));null==s&&(s=Ga.INSTANCE),n.push(s),r++}return new ks(n)},kp.prototype.parseSentinelFieldValue=function(t,e){if(!Ip(e.dataSource))throw e.createError(t._methodName+"() can only be used with update() and set()");if(null===e.path)throw e.createError(t._methodName+"() is not currently supported inside arrays");if(t instanceof np){if(e.dataSource!==wp.MergeSet)throw e.dataSource===wp.Update?(qr(0<e.path.length,"FieldValue.delete() at the top level should have already been handled."),e.createError("FieldValue.delete() can only appear at the top level of your update data")):e.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");e.fieldMask.push(e.path)}else if(t instanceof op)e.fieldTransforms.push(new ya(e.path,Nl.instance));else if(t instanceof up){var n=this.parseArrayTransformElements(t._methodName,t._elements),r=new kl(n);e.fieldTransforms.push(new ya(e.path,r))}else if(t instanceof lp){n=this.parseArrayTransformElements(t._methodName,t._elements);var i=new Ml(n);e.fieldTransforms.push(new ya(e.path,i))}else if(t instanceof dp){var o=this.parseQueryValue("FieldValue.increment",t._operand),a=new Ol(o);e.fieldTransforms.push(new ya(e.path,a))}else xr("Unknown FieldValue type: "+t)},kp.prototype.parseScalarValue=function(t,e){if(null===t)return Ga.INSTANCE;if("number"==typeof t)return Gc(t)?new ns(t):new os(t);if("boolean"==typeof t)return Ya.of(t);if("string"==typeof t)return new us(t);if(t instanceof Date)return new ls(io.fromDate(t));if(t instanceof io)return new ls(new io(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)));if(t instanceof Hh)return new Ts(t);if(t instanceof Ei)return new gs(t);if(t instanceof Np)return new ws(t.databaseId,t.key);throw e.createError("Unsupported field value: "+ci(t))},kp.prototype.parseArrayTransformElements=function(r,t){var i=this;return t.map(function(t,e){var n=new Cp(wp.Argument,r,Vi.EMPTY_PATH);return i.parseData(t,n.childContextForArray(e))})},kp);function kp(t){this.preConverter=t}function Rp(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof io||t instanceof Hh||t instanceof Ei||t instanceof Np||t instanceof Zf)}function Mp(t,e,n){if(!Rp(n)||!ui(n)){var r=ci(n);throw"an object"===r?e.createError(t+" a custom object"):e.createError(t+" "+r)}}function _p(t,e){if(e instanceof Bf)return e._internalPath;if("string"==typeof e)return Op(t,e);throw new Kr(Qr.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function Op(e,t){try{return function(e){if(0<=e.search(Qf))throw new Kr(Qr.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(Bf.bind.apply(Bf,[void 0].concat(e.split("."))))}catch(t){throw new Kr(Qr.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}(t)._internalPath}catch(t){var n=Lp(t);throw new Kr(Qr.INVALID_ARGUMENT,"Function "+e+"() called with invalid data. "+n)}}function Lp(t){return t instanceof Error?t.message:t.toString()}var Pp=Ju.COLLECTION_DISABLED,xp=(qp.prototype.isEqual=function(t){return this.host===t.host&&this.ssl===t.ssl&&this.timestampsInSnapshots===t.timestampsInSnapshots&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.forceLongPolling===t.forceLongPolling},qp);function qp(t){if(void 0===t.host){if(void 0!==t.ssl)throw new Kr(Qr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else ri("settings","non-empty string","host",t.host),this.host=t.host,ii("settings","boolean","ssl",t.ssl),this.ssl=zr(t.ssl,!0);if(li("settings",t,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes","experimentalForceLongPolling"]),ii("settings","object","credentials",t.credentials),this.credentials=t.credentials,ii("settings","boolean","timestampsInSnapshots",t.timestampsInSnapshots),!0===t.timestampsInSnapshots?Lr("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===t.timestampsInSnapshots&&Lr("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=zr(t.timestampsInSnapshots,!0),ii("settings","number","cacheSizeBytes",t.cacheSizeBytes),void 0===t.cacheSizeBytes)this.cacheSizeBytes=Ju.DEFAULT_CACHE_SIZE_BYTES;else{if(t.cacheSizeBytes!==Pp&&t.cacheSizeBytes<Ju.MINIMUM_CACHE_SIZE_BYTES)throw new Kr(Qr.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+Ju.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=t.cacheSizeBytes}ii("settings","boolean","experimentalForceLongPolling",t.experimentalForceLongPolling),this.forceLongPolling=void 0!==t.experimentalForceLongPolling&&t.experimentalForceLongPolling}var Fp=(Vp.prototype.settings=function(t){if($r("Firestore.settings",arguments,1),ei("Firestore.settings","object",1,t),Gr(t,"persistence"))throw new Kr(Qr.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var e=new xp(t);if(this._firestoreClient&&!this._settings.isEqual(e))throw new Kr(Qr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");void 0!==(this._settings=e).credentials&&(this._credentials=function(t){if(!t)return new jf;switch(t.type){case"gapi":var e=t.client;return qr(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty),"unexpected gapi interface"),new Xf(e,t.sessionIndex||"0");case"provider":return t.client;default:throw new Kr(Qr.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(e.credentials))},Vp.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},Vp.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},Vp.prototype.enablePersistence=function(t){if(this._firestoreClient)throw new Kr(Qr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");var e=!1;return t&&(void 0!==t.experimentalTabSynchronization&&Lr("The 'experimentalTabSynchronization' setting has been renamed to 'synchronizeTabs'. In a future release, the setting will be removed and it is recommended that you update your firestore.enablePersistence() call to use 'synchronizeTabs'."),e=zr(void 0!==t.synchronizeTabs?t.synchronizeTabs:t.experimentalTabSynchronization,!1)),this.configureClient(new Of(this._settings.cacheSizeBytes,e))},Vp.prototype.clearPersistence=function(){var t=this,n=cc.buildStoragePrefix(this.makeDatabaseInfo()),r=new Wi;return this._queue.enqueueAndForgetEvenAfterShutdown(function(){return p(t,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:if(t.trys.push([0,2,,3]),void 0!==this._firestoreClient&&!this._firestoreClient.clientTerminated)throw new Kr(Qr.FAILED_PRECONDITION,"Persistence cannot be cleared after this Firestore instance is initialized.");return[4,cc.clearPersistence(n)];case 1:return t.sent(),r.resolve(),[3,3];case 2:return e=t.sent(),r.reject(e),[3,3];case 3:return[2]}})})}),r.promise},Vp.prototype.terminate=function(){return this.app._removeServiceInstance("firestore"),this.INTERNAL.delete()},Object.defineProperty(Vp.prototype,"_isTerminated",{get:function(){return this.ensureClientConfigured(),this._firestoreClient.clientTerminated},enumerable:!0,configurable:!0}),Vp.prototype.waitForPendingWrites=function(){return this.ensureClientConfigured(),this._firestoreClient.waitForPendingWrites()},Vp.prototype.onSnapshotsInSync=function(t){if(this.ensureClientConfigured(),$f(t))return this.onSnapshotsInSyncInternal(t);ei("Firestore.onSnapshotsInSync","function",1,t);var e={next:t};return this.onSnapshotsInSyncInternal(e)},Vp.prototype.onSnapshotsInSyncInternal=function(t){var e=this,n=new Ff({next:function(){t.next&&t.next()},error:function(t){throw xr("Uncaught Error in onSnapshotsInSync")}});return this._firestoreClient.addSnapshotsInSyncListener(n),function(){n.mute(),e._firestoreClient.removeSnapshotsInSyncListener(n)}},Vp.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new Pf),this._firestoreClient},Vp.prototype.makeDatabaseInfo=function(){return new Ci(this._databaseId,this._persistenceKey,this._settings.host,this._settings.ssl,this._settings.forceLongPolling)},Vp.prototype.configureClient=function(t){qr(!!this._settings.host,"FirestoreSettings.host is not set"),qr(!this._firestoreClient,"configureClient() called multiple times");var e=this.makeDatabaseInfo();return this._firestoreClient=new xf(Fr.getPlatform(),e,this._credentials,this._queue),this._firestoreClient.start(t)},Vp.prototype.createDataConverter=function(r){return new Ap(function(t){if(t instanceof jp){var e=r,n=t.firestore._databaseId;if(!n.isEqual(e))throw new Kr(Qr.INVALID_ARGUMENT,"Document reference is for database "+n.projectId+"/"+n.database+" but should be for database "+e.projectId+"/"+e.database);return new Np(r,t._key)}return t})},Vp.databaseIdFromApp=function(t){var e=t.options;if(!Gr(e,"projectId"))throw new Kr(Qr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');var n=e.projectId;if(!n||"string"!=typeof n)throw new Kr(Qr.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new Ni(n)},Object.defineProperty(Vp.prototype,"app",{get:function(){if(!this._firebaseApp)throw new Kr(Qr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._firebaseApp},enumerable:!0,configurable:!0}),Vp.prototype.collection=function(t){return $r("Firestore.collection",arguments,1),ei("Firestore.collection","non-empty string",1,t),this.ensureClientConfigured(),new id(Pi.fromString(t),this)},Vp.prototype.doc=function(t){return $r("Firestore.doc",arguments,1),ei("Firestore.doc","non-empty string",1,t),this.ensureClientConfigured(),jp.forPath(Pi.fromString(t),this)},Vp.prototype.collectionGroup=function(t){if($r("Firestore.collectionGroup",arguments,1),ei("Firestore.collectionGroup","non-empty string",1,t),0<=t.indexOf("/"))throw new Kr(Qr.INVALID_ARGUMENT,"Invalid collection ID '"+t+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.ensureClientConfigured(),new Zp(new Xh(Pi.EMPTY_PATH,t),this)},Vp.prototype.runTransaction=function(e){var n=this;return $r("Firestore.runTransaction",arguments,1),ei("Firestore.runTransaction","function",1,e),this.ensureClientConfigured().transaction(function(t){return e(new Bp(n,t))})},Vp.prototype.batch=function(){return this.ensureClientConfigured(),new Qp(this)},Object.defineProperty(Vp,"logLevel",{get:function(){switch(Mr()){case Sr.DEBUG:return"debug";case Sr.ERROR:return"error";case Sr.SILENT:return"silent";default:return xr("Unknown log level: "+Mr())}},enumerable:!0,configurable:!0}),Vp.setLogLevel=function(t){switch($r("Firestore.setLogLevel",arguments,1),ei("Firestore.setLogLevel","non-empty string",1,t),t){case"debug":_r(Sr.DEBUG);break;case"error":_r(Sr.ERROR);break;case"silent":_r(Sr.SILENT);break;default:throw new Kr(Qr.INVALID_ARGUMENT,"Invalid log level: "+t)}},Vp.prototype._areTimestampsInSnapshotsEnabled=function(){return this._settings.timestampsInSnapshots},Vp);function Vp(t){var e=this;if(this._firebaseApp=null,this._queue=new Hi,this.INTERNAL={delete:function(){return p(e,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.ensureClientConfigured(),[4,this._firestoreClient.terminate()];case 1:return t.sent(),[2]}})})}},"object"==typeof t.options){var n=t;this._firebaseApp=n,this._databaseId=Vp.databaseIdFromApp(n),this._persistenceKey=n.name,this._credentials=new Gf(n)}else{var r=t;if(!r.projectId)throw new Kr(Qr.INVALID_ARGUMENT,"Must provide projectId");this._databaseId=new Ni(r.projectId,r.database),this._persistenceKey="[DEFAULT]",this._credentials=new jf}this._settings=new xp({}),this._dataConverter=this.createDataConverter(this._databaseId)}var Bp=(Up.prototype.get=function(t){var n=this;$r("Transaction.get",arguments,1);var r=cd("Transaction.get",t,this._firestore);return this._transaction.lookup([r._key]).then(function(t){if(!t||1!==t.length)return xr("Mismatch in docs returned from document lookup.");var e=t[0];if(e instanceof qs)return new Hp(n._firestore,r._key,null,!1,!1);if(e instanceof Ls)return new Hp(n._firestore,r._key,e,!1,!1);throw xr("BatchGetDocumentsRequest returned unexpected document type: "+e.constructor.name)})},Up.prototype.set=function(t,e,n){ti("Transaction.set",arguments,2,3);var r=cd("Transaction.set",t,this._firestore),i=(n=ad("Transaction.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",e);return this._transaction.set(r._key,i),this},Up.prototype.update=function(t,e,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return i="string"==typeof e||e instanceof Bf?(Zr("Transaction.update",arguments,3),r=cd("Transaction.update",t,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",e,n,o)):($r("Transaction.update",arguments,2),r=cd("Transaction.update",t,this._firestore),this._firestore._dataConverter.parseUpdateData("Transaction.update",e)),this._transaction.update(r._key,i),this},Up.prototype.delete=function(t){$r("Transaction.delete",arguments,1);var e=cd("Transaction.delete",t,this._firestore);return this._transaction.delete(e._key),this},Up);function Up(t,e){this._firestore=t,this._transaction=e}var Qp=(Kp.prototype.set=function(t,e,n){ti("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();var r=cd("WriteBatch.set",t,this._firestore),i=(n=ad("WriteBatch.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",e);return this._mutations=this._mutations.concat(i.toMutations(r._key,Sa.NONE)),this},Kp.prototype.update=function(t,e,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return this.verifyNotCommitted(),i="string"==typeof e||e instanceof Bf?(Zr("WriteBatch.update",arguments,3),r=cd("WriteBatch.update",t,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",e,n,o)):($r("WriteBatch.update",arguments,2),r=cd("WriteBatch.update",t,this._firestore),this._firestore._dataConverter.parseUpdateData("WriteBatch.update",e)),this._mutations=this._mutations.concat(i.toMutations(r._key,Sa.exists(!0))),this},Kp.prototype.delete=function(t){$r("WriteBatch.delete",arguments,1),this.verifyNotCommitted();var e=cd("WriteBatch.delete",t,this._firestore);return this._mutations=this._mutations.concat(new Va(e._key,Sa.NONE)),this},Kp.prototype.commit=function(){return p(this,void 0,void 0,function(){return d(this,function(t){return this.verifyNotCommitted(),this._committed=!0,0<this._mutations.length?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]})})},Kp.prototype.verifyNotCommitted=function(){if(this._committed)throw new Kr(Qr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},Kp);function Kp(t){this._firestore=t,this._mutations=[],this._committed=!1}var jp=(Wp.forPath=function(t,e){if(t.length%2!=0)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+t.canonicalString()+" has "+t.length);return new Wp(new Ui(t),e)},Object.defineProperty(Wp.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(Wp.prototype,"parent",{get:function(){return new id(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(Wp.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),Wp.prototype.collection=function(t){if($r("DocumentReference.collection",arguments,1),ei("DocumentReference.collection","non-empty string",1,t),!t)throw new Kr(Qr.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var e=Pi.fromString(t);return new id(this._key.path.child(e),this.firestore)},Wp.prototype.isEqual=function(t){if(!(t instanceof Wp))throw fi("isEqual","DocumentReference",1,t);return this.firestore===t.firestore&&this._key.isEqual(t._key)},Wp.prototype.set=function(t,e){ti("DocumentReference.set",arguments,1,2);var n=(e=ad("DocumentReference.set",e)).merge||e.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",t,e.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",t);return this._firestoreClient.write(n.toMutations(this._key,Sa.NONE))},Wp.prototype.update=function(t,e){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return n="string"==typeof t||t instanceof Bf?(Zr("DocumentReference.update",arguments,2),this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",t,e,r)):($r("DocumentReference.update",arguments,1),this.firestore._dataConverter.parseUpdateData("DocumentReference.update",t)),this._firestoreClient.write(n.toMutations(this._key,Sa.exists(!0)))},Wp.prototype.delete=function(){return $r("DocumentReference.delete",arguments,0),this._firestoreClient.write([new Va(this._key,Sa.NONE)])},Wp.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];ti("DocumentReference.onSnapshot",arguments,1,4);var n,r={includeMetadataChanges:!1},i=0;"object"!=typeof t[i]||$f(t[i])||(li("DocumentReference.onSnapshot",r=t[i],["includeMetadataChanges"]),ii("DocumentReference.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++);var o={includeMetadataChanges:r.includeMetadataChanges};return n=$f(t[i])?t[i]:(ei("DocumentReference.onSnapshot","function",i,t[i]),ni("DocumentReference.onSnapshot","function",i+1,t[i+1]),ni("DocumentReference.onSnapshot","function",i+2,t[i+2]),{next:t[i],error:t[i+1],complete:t[i+2]}),this.onSnapshotInternal(o,n)},Wp.prototype.onSnapshotInternal=function(t,n){var r=this,e=function(t){console.error("Uncaught Error in onSnapshot:",t)};n.error&&(e=n.error.bind(n));var i=new Ff({next:function(t){if(n.next){qr(t.docs.size<=1,"Too many documents returned on a document query");var e=t.docs.get(r._key);n.next(new Hp(r.firestore,r._key,e,t.fromCache,t.hasPendingWrites))}},error:e}),o=this._firestoreClient.listen(Xh.atPath(this._key.path),i,t);return function(){i.mute(),r._firestoreClient.unlisten(o)}},Wp.prototype.get=function(n){var r=this;return ti("DocumentReference.get",arguments,0,1),ud("DocumentReference.get",n),new Promise(function(e,t){n&&"cache"===n.source?r.firestore.ensureClientConfigured().getDocumentFromLocalCache(r._key).then(function(t){e(new Hp(r.firestore,r._key,t,!0,t instanceof Ls&&t.hasLocalMutations))},t):r.getViaSnapshotListener(e,t,n)})},Wp.prototype.getViaSnapshotListener=function(e,n,r){var i=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(t){i(),!t.exists&&t.metadata.fromCache?n(new Kr(Qr.UNAVAILABLE,"Failed to get document because the client is offline.")):t.exists&&t.metadata.fromCache&&r&&"server"===r.source?n(new Kr(Qr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):e(t)},error:n})},Wp);function Wp(t,e){this._key=t,this.firestore=e,this._firestoreClient=this.firestore.ensureClientConfigured()}var Gp=(zp.prototype.isEqual=function(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache},zp);function zp(t,e){this.hasPendingWrites=t,this.fromCache=e}var Hp=(Yp.prototype.data=function(t){return ti("DocumentSnapshot.data",arguments,0,1),t=sd("DocumentSnapshot.data",t),this._document?this.convertObject(this._document.data(),Ua.fromSnapshotOptions(t,this._firestore._areTimestampsInSnapshotsEnabled())):void 0},Yp.prototype.get=function(t,e){if(ti("DocumentSnapshot.get",arguments,1,2),e=sd("DocumentSnapshot.get",e),this._document){var n=this._document.data().field(_p("DocumentSnapshot.get",t));if(null!==n)return this.convertValue(n,Ua.fromSnapshotOptions(e,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(Yp.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(Yp.prototype,"ref",{get:function(){return new jp(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(Yp.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(Yp.prototype,"metadata",{get:function(){return new Gp(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),Yp.prototype.isEqual=function(t){if(!(t instanceof Yp))throw fi("isEqual","DocumentSnapshot",1,t);return this._firestore===t._firestore&&this._fromCache===t._fromCache&&this._key.isEqual(t._key)&&(null===this._document?null===t._document:this._document.isEqual(t._document))},Yp.prototype.convertObject=function(t,n){var r=this,i={};return t.forEach(function(t,e){i[t]=r.convertValue(e,n)}),i},Yp.prototype.convertValue=function(t,e){if(t instanceof Ds)return this.convertObject(t,e);if(t instanceof ks)return this.convertArray(t,e);if(t instanceof ws){var n=t.value(e),r=this._firestore.ensureClientConfigured().databaseId();return t.databaseId.isEqual(r)||Lr("Document "+this._key.path+" contains a document reference within a different database ("+t.databaseId.projectId+"/"+t.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+r.projectId+"/"+r.database+") instead."),new jp(n,this._firestore)}return t.value(e)},Yp.prototype.convertArray=function(t,e){var n=this;return t.internalValue.map(function(t){return n.convertValue(t,e)})},Yp);function Yp(t,e,n,r,i){this._firestore=t,this._key=e,this._document=n,this._fromCache=r,this._hasPendingWrites=i}var Xp,Jp=(s($p,Xp=Hp),$p.prototype.data=function(t){var e=Xp.prototype.data.call(this,t);return qr("object"==typeof e,"Document in a QueryDocumentSnapshot should exist"),e},$p);function $p(){return null!==Xp&&Xp.apply(this,arguments)||this}var Zp=(td.prototype.where=function(t,e,n){$r("Query.where",arguments,3),hi("Query.where",3,n),"in"!==e&&"array-contains-any"!==e&&function(t,e,n,r){if(!e.some(function(t){return t===r}))throw new Kr(Qr.INVALID_ARGUMENT,"Invalid value "+ci(r)+" provided to function "+t+"() for its "+pi(n)+" argument. Acceptable values: "+e.join(", "))}("Query.where",["<","<=","==",">=",">","array-contains"],2,e);var r,i=_p("Query.where",t),o=Zh.fromString(e);if(i.isKeyField()){if(o===Zh.ARRAY_CONTAINS||o===Zh.ARRAY_CONTAINS_ANY)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid Query. You can't perform '"+o.toString()+"' queries on FieldPath.documentId().");if(o===Zh.IN){this.validateDisjunctiveFilterElements(n,o);for(var a=[],s=0,u=n;s<u.length;s++){var c=u[s];a.push(this.parseDocumentIdValue(c))}r=new ks(a)}else r=this.parseDocumentIdValue(n)}else o!==Zh.IN&&o!==Zh.ARRAY_CONTAINS_ANY||this.validateDisjunctiveFilterElements(n,o),r=this.firestore._dataConverter.parseQueryValue("Query.where",n);var h=nl.create(i,o,r);return this.validateNewFilter(h),new td(this._query.addFilter(h),this.firestore)},td.prototype.orderBy=function(t,e){var n;if(ti("Query.orderBy",arguments,1,2),ni("Query.orderBy","non-empty string",2,e),void 0===e||"asc"===e)n=bl.ASCENDING;else{if("desc"!==e)throw new Kr(Qr.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+e+"', expected 'asc' or 'desc'.");n=bl.DESCENDING}if(null!==this._query.startAt)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var r=_p("Query.orderBy",t),i=new Tl(r,n);return this.validateNewOrderBy(i),new td(this._query.addOrderBy(i),this.firestore)},td.prototype.limit=function(t){if($r("Query.limit",arguments,1),ei("Query.limit","number",1,t),t<=0)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid Query. Query limit ("+t+") is invalid. Limit must be positive.");return new td(this._query.withLimit(t),this.firestore)},td.prototype.startAt=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];Zr("Query.startAt",arguments,1);var r=this.boundFromDocOrFields("Query.startAt",t,e,!0);return new td(this._query.withStartAt(r),this.firestore)},td.prototype.startAfter=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];Zr("Query.startAfter",arguments,1);var r=this.boundFromDocOrFields("Query.startAfter",t,e,!1);return new td(this._query.withStartAt(r),this.firestore)},td.prototype.endBefore=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];Zr("Query.endBefore",arguments,1);var r=this.boundFromDocOrFields("Query.endBefore",t,e,!0);return new td(this._query.withEndAt(r),this.firestore)},td.prototype.endAt=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];Zr("Query.endAt",arguments,1);var r=this.boundFromDocOrFields("Query.endAt",t,e,!1);return new td(this._query.withEndAt(r),this.firestore)},td.prototype.isEqual=function(t){if(!(t instanceof td))throw fi("isEqual","Query",1,t);return this.firestore===t.firestore&&this._query.isEqual(t._query)},td.prototype.boundFromDocOrFields=function(t,e,n,r){if(hi(t,1,e),e instanceof Hp){if(0<n.length)throw new Kr(Qr.INVALID_ARGUMENT,"Too many arguments provided to "+t+"().");var i=e;if(!i.exists)throw new Kr(Qr.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+t+"().");return this.boundFromDocument(t,i._document,r)}var o=[e].concat(n);return this.boundFromFields(t,o,r)},td.prototype.boundFromDocument=function(t,e,n){for(var r=[],i=0,o=this._query.orderBy;i<o.length;i++){var a=o[i];if(a.field.isKeyField())r.push(new ws(this.firestore._databaseId,e.key));else{var s=e.field(a.field);if(s instanceof ds)throw new Kr(Qr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===s){var u=a.field.canonicalString();throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+u+"' (used as the orderBy) does not exist.")}r.push(s)}}return new Sl(r,n)},td.prototype.boundFromFields=function(t,e,n){var r=this._query.explicitOrderBy;if(e.length>r.length)throw new Kr(Qr.INVALID_ARGUMENT,"Too many arguments provided to "+t+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var i=[],o=0;o<e.length;o++){var a=e[o];if(r[o].field.isKeyField()){if("string"!=typeof a)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+t+"(), but got a "+typeof a);if(!this._query.isCollectionGroupQuery()&&-1!==a.indexOf("/"))throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+t+"() must be a plain document ID, but '"+a+"' contains a slash.");var s=this._query.path.child(Pi.fromString(a));if(!Ui.isDocumentKey(s))throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+t+"() must result in a valid document path, but '"+s+"' is not because it contains an odd number of segments.");var u=new Ui(s);i.push(new ws(this.firestore._databaseId,u))}else{var c=this.firestore._dataConverter.parseQueryValue(t,a);i.push(c)}}return new Sl(i,n)},td.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];ti("Query.onSnapshot",arguments,1,4);var n,r={},i=0;return"object"!=typeof t[i]||$f(t[i])||(li("Query.onSnapshot",r=t[i],["includeMetadataChanges"]),ii("Query.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++),n=$f(t[i])?t[i]:(ei("Query.onSnapshot","function",i,t[i]),ni("Query.onSnapshot","function",i+1,t[i+1]),ni("Query.onSnapshot","function",i+2,t[i+2]),{next:t[i],error:t[i+1],complete:t[i+2]}),this.onSnapshotInternal(r,n)},td.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new Ff({next:function(t){e.next&&e.next(new ed(n.firestore,n._query,t))},error:r}),o=this.firestore.ensureClientConfigured(),a=o.listen(this._query,i,t);return function(){i.mute(),o.unlisten(a)}},td.prototype.get=function(n){var r=this;return ti("Query.get",arguments,0,1),ud("Query.get",n),new Promise(function(e,t){n&&"cache"===n.source?r.firestore.ensureClientConfigured().getDocumentsFromLocalCache(r._query).then(function(t){e(new ed(r.firestore,r._query,t))},t):r.getViaSnapshotListener(e,t,n)})},td.prototype.getViaSnapshotListener=function(e,n,r){var i=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(t){i(),t.metadata.fromCache&&r&&"server"===r.source?n(new Kr(Qr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):e(t)},error:n})},td.prototype.parseDocumentIdValue=function(t){if("string"==typeof t){if(""===t)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!this._query.isCollectionGroupQuery()&&-1!==t.indexOf("/"))throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '"+t+"' contains a '/' character.");var e=this._query.path.child(Pi.fromString(t));if(!Ui.isDocumentKey(e))throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+e+"' is not because it has an odd number of segments ("+e.length+").");return new ws(this.firestore._databaseId,new Ui(e))}if(t instanceof jp){var n=t;return new ws(this.firestore._databaseId,n._key)}throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: "+ci(t)+".")},td.prototype.validateDisjunctiveFilterElements=function(t,e){if(!Array.isArray(t)||0===t.length)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '"+e.toString()+"' filters.");if(10<t.length)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters support a maximum of 10 elements in the value array.");if(0<=t.indexOf(null))throw new Kr(Qr.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters cannot contain 'null' in the value array.");if(0<t.filter(function(t){return Number.isNaN(t)}).length)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters cannot contain 'NaN' in the value array.")},td.prototype.validateNewFilter=function(t){if(t instanceof nl){var e=[Zh.ARRAY_CONTAINS,Zh.ARRAY_CONTAINS_ANY],n=[Zh.IN,Zh.ARRAY_CONTAINS_ANY],r=0<=e.indexOf(t.op),i=0<=n.indexOf(t.op);if(t.isInequality()){var o=this._query.getInequalityFilterField();if(null!==o&&!o.isEqual(t.field))throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+o.toString()+"' and '"+t.field.toString()+"'");var a=this._query.getFirstOrderByField();null!==a&&this.validateOrderByAndInequalityMatch(t.field,a)}else if(i||r){var s=null;if(i&&(s=this._query.findFilterOperator(n)),null===s&&r&&(s=this._query.findFilterOperator(e)),null!=s)throw s===t.op?new Kr(Qr.INVALID_ARGUMENT,"Invalid query. You cannot use more than one '"+t.op.toString()+"' filter."):new Kr(Qr.INVALID_ARGUMENT,"Invalid query. You cannot use '"+t.op.toString()+"' filters with '"+s.toString()+"' filters.")}}},td.prototype.validateNewOrderBy=function(t){if(null===this._query.getFirstOrderByField()){var e=this._query.getInequalityFilterField();null!==e&&this.validateOrderByAndInequalityMatch(e,t.field)}},td.prototype.validateOrderByAndInequalityMatch=function(t,e){if(!e.isEqual(t))throw new Kr(Qr.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+t.toString()+"' and so you must also use '"+t.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+e.toString()+"' instead.")},td);function td(t,e){this._query=t,this.firestore=e}var ed=(Object.defineProperty(nd.prototype,"docs",{get:function(){var e=[];return this.forEach(function(t){return e.push(t)}),e},enumerable:!0,configurable:!0}),Object.defineProperty(nd.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(nd.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),nd.prototype.forEach=function(e,n){var r=this;ti("QuerySnapshot.forEach",arguments,1,2),ei("QuerySnapshot.forEach","function",1,e),this._snapshot.docs.forEach(function(t){e.call(n,r.convertToDocumentImpl(t))})},Object.defineProperty(nd.prototype,"query",{get:function(){return new Zp(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),nd.prototype.docChanges=function(t){t&&(li("QuerySnapshot.docChanges",t,["includeMetadataChanges"]),ii("QuerySnapshot.docChanges","boolean","includeMetadataChanges",t.includeMetadataChanges));var e=!(!t||!t.includeMetadataChanges);if(e&&this._snapshot.excludesMetadataChanges)throw new Kr(Qr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,e,o){if(o.oldDocs.isEmpty()){var n,r=0;return o.docChanges.map(function(t){var e=new Jp(i,t.doc.key,t.doc,o.fromCache,o.mutatedKeys.has(t.doc.key));return qr(t.type===wh.Added,"Invalid event type for first snapshot"),qr(!n||o.query.docComparator(n,t.doc)<0,"Got added events in wrong order"),n=t.doc,{type:"added",doc:e,oldIndex:-1,newIndex:r++}})}var a=o.oldDocs;return o.docChanges.filter(function(t){return e||t.type!==wh.Metadata}).map(function(t){var e=new Jp(i,t.doc.key,t.doc,o.fromCache,o.mutatedKeys.has(t.doc.key)),n=-1,r=-1;return t.type!==wh.Added&&(qr(0<=(n=a.indexOf(t.doc.key)),"Index for document not found"),a=a.delete(t.doc.key)),t.type!==wh.Removed&&(r=(a=a.add(t.doc)).indexOf(t.doc.key)),{type:function(t){switch(t){case wh.Added:return"added";case wh.Modified:case wh.Metadata:return"modified";case wh.Removed:return"removed";default:return xr("Unknown change type: "+t)}}(t.type),doc:e,oldIndex:n,newIndex:r}})}(this._firestore,e,this._snapshot),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges},nd.prototype.isEqual=function(t){if(!(t instanceof nd))throw fi("isEqual","QuerySnapshot",1,t);return this._firestore===t._firestore&&this._originalQuery.isEqual(t._originalQuery)&&this._snapshot.isEqual(t._snapshot)},nd.prototype.convertToDocumentImpl=function(t){return new Jp(this._firestore,t.key,t,this.metadata.fromCache,this._snapshot.mutatedKeys.has(t.key))},nd);function nd(t,e,n){this._firestore=t,this._originalQuery=e,this._snapshot=n,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new Gp(n.hasPendingWrites,n.fromCache)}["length","forEach","map"].concat("undefined"!=typeof Symbol?[Symbol.iterator]:[]).forEach(function(t){try{Object.defineProperty(ed.prototype.docChanges,t,{get:function(){return function(){throw new Kr(Qr.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}()}})}catch(t){}});var rd,id=(s(od,rd=Zp),Object.defineProperty(od.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(od.prototype,"parent",{get:function(){var t=this._query.path.popLast();return t.isEmpty()?null:new jp(new Ui(t),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(od.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),od.prototype.doc=function(t){if(ti("CollectionReference.doc",arguments,0,1),0===arguments.length&&(t=mi.newId()),ei("CollectionReference.doc","non-empty string",1,t),""===t)throw new Kr(Qr.INVALID_ARGUMENT,"Document path must be a non-empty string");var e=Pi.fromString(t);return jp.forPath(this._query.path.child(e),this.firestore)},od.prototype.add=function(t){$r("CollectionReference.add",arguments,1),ei("CollectionReference.add","object",1,t);var e=this.doc();return e.set(t).then(function(){return e})},od);function od(t,e){var n=rd.call(this,Xh.atPath(t),e)||this;if(t.length%2!=1)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+t.canonicalString()+" has "+t.length);return n}function ad(t,e){if(void 0===e)return{merge:!1};if(li(t,e,["merge","mergeFields"]),ii(t,"boolean","merge",e.merge),oi(t,"mergeFields","a string or a FieldPath",e.mergeFields,function(t){return"string"==typeof t||t instanceof Bf}),void 0!==e.mergeFields&&void 0!==e.merge)throw new Kr(Qr.INVALID_ARGUMENT,"Invalid options passed to function "+t+'(): You cannot specify both "merge" and "mergeFields".');return e}function sd(t,e){return void 0===e?{}:(li(t,e,["serverTimestamps"]),ai(t,0,"serverTimestamps",e.serverTimestamps,["estimate","previous","none"]),e)}function ud(t,e){ni(t,"object",1,e),e&&(li(t,e,["source"]),ai(t,0,"source",e.source,["default","server","cache"]))}function cd(t,e,n){if(e instanceof jp){if(e.firestore!==n)throw new Kr(Qr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}throw fi(t,"DocumentReference",1,e)}var hd=Wr(Fp,"Use firebase.firestore() instead."),ld=Wr(Bp,"Use firebase.firestore().runTransaction() instead."),fd=Wr(Qp,"Use firebase.firestore().batch() instead."),pd=Wr(jp,"Use firebase.firestore().doc() instead."),dd=Wr(Hp),md=Wr(Jp),yd=Wr(Zp),gd=Wr(ed),vd=Wr(id,"Use firebase.firestore().collection() instead."),bd={Firestore:hd,GeoPoint:Hh,Timestamp:io,Blob:Ii,Transaction:ld,WriteBatch:fd,DocumentReference:pd,DocumentSnapshot:dd,Query:yd,QueryDocumentSnapshot:md,QuerySnapshot:gd,CollectionReference:vd,FieldPath:Bf,FieldValue:yp,setLogLevel:Fp.setLogLevel,CACHE_SIZE_UNLIMITED:Pp};function wd(t){t.INTERNAL.registerService("firestore",function(t){return new Fp(t)},function(t){qr(t&&"object"==typeof t,"shallowCopy() expects object parameter.");var e={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}(bd))}var Sd=(Ed.prototype.addCallback=function(t){},Ed.prototype.shutdown=function(){},Ed);function Ed(){}var Td="ConnectivityMonitor",Id=(Cd.prototype.addCallback=function(t){this.callbacks.push(t)},Cd.prototype.shutdown=function(){window.removeEventListener("online",this.networkAvailableListener),window.removeEventListener("offline",this.networkUnavailableListener)},Cd.prototype.configureNetworkMonitoring=function(){window.addEventListener("online",this.networkAvailableListener),window.addEventListener("offline",this.networkUnavailableListener)},Cd.prototype.onNetworkAvailable=function(){Or(Td,"Network connectivity changed: AVAILABLE");for(var t=0,e=this.callbacks;t<e.length;t++)(0,e[t])(0)},Cd.prototype.onNetworkUnavailable=function(){Or(Td,"Network connectivity changed: UNAVAILABLE");for(var t=0,e=this.callbacks;t<e.length;t++)(0,e[t])(1)},Cd.isAvailable=function(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener},Cd);function Cd(){var t=this;this.networkAvailableListener=function(){return t.onNetworkAvailable()},this.networkUnavailableListener=function(){return t.onNetworkUnavailable()},this.callbacks=[],this.configureNetworkMonitoring()}var Dd=(Nd.prototype.onOpen=function(t){qr(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=t},Nd.prototype.onClose=function(t){qr(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=t},Nd.prototype.onMessage=function(t){qr(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=t},Nd.prototype.close=function(){this.closeFn()},Nd.prototype.send=function(t){this.sendFn(t)},Nd.prototype.callOnOpen=function(){qr(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},Nd.prototype.callOnClose=function(t){qr(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(t)},Nd.prototype.callOnMessage=function(t){qr(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(t)},Nd);function Nd(t){this.sendFn=t.sendFn,this.closeFn=t.closeFn}var Ad="Connection",kd={BatchGetDocuments:"batchGet",Commit:"commit"},Rd="gl-js/ fire/"+kr,Md=(_d.prototype.modifyHeadersForRequest=function(t,e){if(e)for(var n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n]);t["X-Goog-Api-Client"]=Rd},_d.prototype.invokeRPC=function(s,r,u){var c=this,h=this.makeUrl(s);return new Promise(function(i,o){var a=new Ar;a.listenOnce(Dr.COMPLETE,function(){try{switch(a.getLastErrorCode()){case Cr.NO_ERROR:var t=a.getResponseJson();Or(Ad,"XHR received:",JSON.stringify(t)),i(t);break;case Cr.TIMEOUT:Or(Ad,'RPC "'+s+'" timed out'),o(new Kr(Qr.DEADLINE_EXCEEDED,"Request time out"));break;case Cr.HTTP_ERROR:var e=a.getStatus();if(Or(Ad,'RPC "'+s+'" failed with status:',e,"response text:",a.getResponseText()),0<e){var n=a.getResponseJson().error;if(n&&n.status&&n.message){var r=function(t){var e=t.toLowerCase().replace("_","-");return 0<=Object.values(Qr).indexOf(e)?e:Qr.UNKNOWN}(n.status);o(new Kr(r,n.message))}else o(new Kr(Qr.UNKNOWN,"Server responded with status "+a.getStatus()))}else Or(Ad,'RPC "'+s+'" failed'),o(new Kr(Qr.UNAVAILABLE,"Connection failed."));break;default:xr('RPC "'+s+'" failed with unanticipated webchannel error '+a.getLastErrorCode()+": "+a.getLastError()+", giving up.")}}finally{Or(Ad,'RPC "'+s+'" completed.')}});var t=l({},r);delete t.database;var e=JSON.stringify(t);Or(Ad,"XHR sending: ",h+" "+e);var n={"Content-Type":"text/plain"};c.modifyHeadersForRequest(n,u),a.send(h,"POST",e,n,15)})},_d.prototype.invokeStreamingRPC=function(t,e,n){return this.invokeRPC(t,e,n)},_d.prototype.openStream=function(t,e){var n=[this.baseUrl,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=Ir(),i={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling};this.modifyHeadersForRequest(i.initMessageHeaders,e),"object"==typeof navigator&&"ReactNative"===navigator.product||(i.httpHeadersOverwriteParam="$httpHeaders");var o=n.join("");function a(t,e){s.listen(t,function(t){try{e(t)}catch(t){setTimeout(function(){throw t},0)}})}Or(Ad,"Creating WebChannel: "+o+" "+i);var s=r.createWebChannel(o,i),u=!1,c=!1,h=new Dd({sendFn:function(t){c?Or(Ad,"Not sending because WebChannel is closed:",t):(u||(Or(Ad,"Opening WebChannel transport."),s.open(),u=!0),Or(Ad,"WebChannel sending:",t),s.send(t))},closeFn:function(){return s.close()}});return a(Nr.EventType.OPEN,function(){c||Or(Ad,"WebChannel transport opened.")}),a(Nr.EventType.CLOSE,function(){c||(c=!0,Or(Ad,"WebChannel transport closed"),h.callOnClose())}),a(Nr.EventType.ERROR,function(t){c||(c=!0,Or(Ad,"WebChannel transport errored:",t),h.callOnClose(new Kr(Qr.UNAVAILABLE,"The operation could not be completed")))}),a(Nr.EventType.MESSAGE,function(t){if(!c){var e=t.data[0];qr(!!e,"Got a webchannel message without data.");var n=e,r=n.error||n[0]&&n[0].error;if(r){Or(Ad,"WebChannel received error:",r);var i=r.status,o=function(t){var e=dh[t];if(void 0!==e)return bh(e)}(i),a=r.message;void 0===o&&(o=Qr.INTERNAL,a="Unknown error status: "+i+" with message "+r.message),c=!0,h.callOnClose(new Kr(o,a)),s.close()}else Or(Ad,"WebChannel received:",e),h.callOnMessage(e)}}),setTimeout(function(){h.callOnOpen()},0),h},_d.prototype.makeUrl=function(t){var e=kd[t];qr(void 0!==e,"Unknown REST mapping for: "+t);var n=[this.baseUrl,"/","v1"];return n.push("/projects/"),n.push(this.databaseId.projectId),n.push("/databases/"),n.push(this.databaseId.database),n.push("/documents"),n.push(":"),n.push(e),n.join("")},_d);function _d(t){this.databaseId=t.databaseId;var e=t.ssl?"https":"http";this.baseUrl=e+"://"+t.host,this.forceLongPolling=t.forceLongPolling}var Od=(Object.defineProperty(Ld.prototype,"document",{get:function(){return"undefined"!=typeof document?document:null},enumerable:!0,configurable:!0}),Object.defineProperty(Ld.prototype,"window",{get:function(){return"undefined"!=typeof window?window:null},enumerable:!0,configurable:!0}),Ld.prototype.loadConnection=function(t){return Promise.resolve(new Md(t))},Ld.prototype.newConnectivityMonitor=function(){return Id.isAvailable()?new Id:new Sd},Ld.prototype.newSerializer=function(t){return new Wl(t,{useProto3Json:!0})},Ld.prototype.formatJSON=function(t){return JSON.stringify(t)},Ld.prototype.atob=function(t){return atob(t)},Ld.prototype.btoa=function(t){return btoa(t)},Ld);function Ld(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}Fr.setPlatform(new Od),wd(Pd)}).apply(this,arguments)}catch(t){throw console.error(t),new Error("Cannot instantiate firebase-firestore - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore.js.map
