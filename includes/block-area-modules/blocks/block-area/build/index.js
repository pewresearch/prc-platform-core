(()=>{"use strict";const e=window.wp.blocks,t=window.React,l=window.wp.element,o=(0,l.forwardRef)((function({icon:e,size:t=24,...o},a){return(0,l.cloneElement)(e,{width:t,height:t,...o,ref:a})})),a=window.wp.primitives,n=(0,t.createElement)(a.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},(0,t.createElement)(a.Path,{d:"M21.3 10.8l-5.6-5.6c-.7-.7-1.8-.7-2.5 0l-5.6 5.6c-.7.7-.7 1.8 0 2.5l5.6 5.6c.3.3.8.5 1.2.5s.9-.2 1.2-.5l5.6-5.6c.8-.7.8-1.9.1-2.5zm-17.6 1L10 5.5l-1-1-6.3 6.3c-.7.7-.7 1.8 0 2.5L9 19.5l1.1-1.1-6.3-6.3c-.2 0-.2-.2-.1-.3z"}));function r({color:e="#02b5d5"}){return(0,t.createElement)(o,{icon:n,style:{color:e}})}const c=window.prcComponents,s=window.wp.i18n,i=window.wp.blockEditor,u=window.wp.data,d=window.wp.coreData,m="block_area",g="Block Area",y="block_area",b="block_module",p="Block Module",k=window.prcHooks,S=window.wp.components;function E({attributes:e,setAttributes:l,blockArea:o,postStatus:a,setPostStatus:n}){const{metadata:r,ref:c}=e,{id:i,name:u,slug:y}=o,[b,p]=(0,d.useEntityProp)("taxonomy",m,"name",i);return(0,t.useEffect)((()=>{!r?.name&&b&&l({metadata:{...r,name:b}})}),[r,b]),i?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(S.FlexBlock,null,(0,t.createElement)(S.TextControl,{label:(0,s.__)(`${g} Name`),value:b,onChange:p})),(0,t.createElement)(S.FlexBlock,null,(0,t.createElement)(S.ToggleControl,{label:(0,s.__)("Preview Latest Draft Module","prc-platform-core"),checked:"draft"===a,help:(0,s.__)("This will allow you to preview and edit the latest draft module in the block area. This will not be visible on the front end, the latest published module will always be visible.","prc-platform-core"),onChange:e=>{n(e?"draft":"publish")}})),(0,t.createElement)(S.FlexBlock,null,(0,t.createElement)(S.Button,{isDestructive:!0,variant:"secondary",onClick:()=>{l({ref:null,blockAreaSlug:null,categorySlug:null,inheritCategory:null})}},(0,s.__)("Reset Block Area")))):null}const h=window.wp.url;async function f(e,t,l,o="publish"){const a={title:e,status:o};t&&(a[y]=[t]),l&&(a.categories=[l]);const{saveEntityRecord:n}=(0,u.dispatch)(d.store),r=await n("postType",b,a);return!!r&&(console.log("onCreateBlockModule",r),r)}function C({blockAreaId:e,categoryId:l,setAttributes:o}){const[a,n]=(0,t.useState)(!1);return(0,t.createElement)(t.Fragment,null,(0,t.createElement)(S.Button,{variant:"secondary",onClick:()=>{n(!a)}},"Create New Block Module"),a&&(0,t.createElement)(c.EntityCreateNewModal,{defaultTitle:"Block Module",onClose:()=>{n(!1)},onSubmit:t=>{f(t,e,l,"publish").then((e=>{console.log("then...",e),o({ref:e.id})}))}}))}function w({setAttributes:e,blockArea:l,category:o,blockModule:a}){const{id:n,name:r,slug:c}=a,i=l?.id,u=o?.id,[m,g]=(0,d.useEntityProp)("postType",b,"title",n),[y]=(0,d.useEntityProp)("postType",b,"link",n);return n?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(S.FlexBlock,null,(0,t.createElement)(S.TextControl,{__nextHasNoMarginBottom:!0,label:(0,s.__)(`${p} Title`),value:m,onChange:g})),(0,t.createElement)(S.FlexBlock,null,(0,t.createElement)(C,{blockAreaId:i,categoryId:u,setAttributes:e}))):null}function A({attributes:e,setAttributes:l,category:o}){const{id:a,name:n,slug:r}=o,{inheritCategory:i,categorySlug:u}=e,d=(0,t.useMemo)((()=>a?[{value:r,title:n}]:[]),[a,n,r]);return(0,t.createElement)(S.FlexBlock,null,(0,t.createElement)(S.ToggleControl,{label:(0,s.__)("Inherit Category","prc-platform-core"),checked:i,onChange:e=>{l({inheritCategory:e,categorySlug:!0===e?null:u})}}),!i&&(0,t.createElement)(c.TermSelect,{onChange:e=>{console.log("onChange...",e),l(e?{categorySlug:e.slug}:{categorySlug:null})},taxonomy:"category",value:d,maxTerms:1}))}function _({attributes:e,setAttributes:l,clientId:o,blockArea:a,category:n,blockModule:r,postStatus:c,setPostStatus:u}){const{ref:d}=e;return(0,t.createElement)(i.InspectorControls,null,!d&&(0,t.createElement)(t.Fragment,null,(0,t.createElement)(S.PanelBody,{title:(0,s.__)("Block Area"),initialOpen:!0},(0,t.createElement)(S.Flex,{direction:"column",gap:"10px"},(0,t.createElement)(E,{attributes:e,setAttributes:l,blockArea:a,blockModule:r,postStatus:c,setPostStatus:u}))),(0,t.createElement)(S.PanelBody,{title:(0,s.__)("Category"),initialOpen:!0},(0,t.createElement)(S.Flex,{direction:"column",gap:"10px"},(0,t.createElement)(A,{attributes:e,setAttributes:l,category:n})))),(0,t.createElement)(S.PanelBody,{title:(0,s.__)("Block Module"),initialOpen:!0},(0,t.createElement)(S.Flex,{direction:"column",gap:"10px"},(0,t.createElement)(w,{setAttributes:l,blockArea:a,category:n,blockModule:r}))))}function x(e){return(0,t.createElement)("div",{className:"block-area-edit__step"},e.children)}function B({isResolving:e,blockModules:l=[],setNextStep:o}){return(0,t.createElement)(x,null,(0,t.createElement)("p",null,"You can configure a block area to dynamically query the latest module. You can also restrict it by category. Alternatively, you can choose an existing block module or create a new one."),e&&(0,t.createElement)(S.Spinner,null),!e&&(0,t.createElement)(S.Button,{variant:"primary",onClick:()=>o("query-a")},(0,s.__)("Configure Area")),!e&&!!l.length&&(0,t.createElement)(S.Button,{variant:"secondary",onClick:()=>o("select-a")},(0,s.__)("Choose Module")),!e&&(0,t.createElement)(S.Button,{variant:"secondary",onClick:()=>o("create-a")},(0,s.__)("Start Blank Module")))}const v=({setButtonState:e,buttonState:l,setCreateNewBlockArea:o})=>((0,t.useEffect)((()=>{e({...l,text:"Create New Block Area",disabled:!1,onClick:()=>o(!0)})}),[]),(0,t.createElement)("span",null,"No Block Area could be found with that name, please create a new one.")),N=({setNewBlockAreaName:e,setNextStep:l,setButtonState:o,buttonState:a})=>{const[n,r]=(0,t.useState)(""),c=(0,k.useDebounce)(n,500);return(0,t.useEffect)((()=>{c.length<3?o({...a,disabled:!0}):o({...a,text:"Continue...",disabled:!1,onClick:()=>{e(c),l("query-b")}})}),[c]),(0,t.createElement)(S.TextControl,{label:(0,s.__)("New Block Area Name","prc-platform-core"),value:n,onChange:e=>r(e)})};function I({blockAreaSlug:e,setBlockAreaSlug:l,setNewBlockAreaName:o,setNextStep:a,buttonState:n,setButtonState:r}){const[i,u]=(0,t.useState)(e),[d,y]=(0,k.useTaxonomy)(m,e),[b,p]=(0,t.useState)(!1);return(0,t.useEffect)((()=>{const e={...n,text:"Next",disabled:!0,onClick:()=>{l(i),a("query-b")}};i&&i.length>0&&(e.disabled=!1),r(e)}),[i]),(0,t.createElement)(x,null,!1===b&&(0,t.createElement)(c.WPEntitySearch,{placeholder:(0,s.__)("Search for an existing block area, or create a new one","prc-platform-core"),searchLabel:(0,s.__)(`Search for ${g}`),entityType:"taxonomy",entitySubType:m,entityId:d||!1,searchValue:y||"",onSelect:e=>{console.log("Block Area Entity: ",e),u(e.slug)},onKeyEnter:()=>{console.log("Enter Key Pressed")},onKeyESC:()=>{console.log("ESC Key Pressed")},perPage:10,showExcerpt:!0,createNew:()=>(0,t.createElement)(v,{buttonState:n,setButtonState:r,setCreateNewBlockArea:p})}),!0===b&&(0,t.createElement)(N,{setNewBlockAreaName:o,setNextStep:a,setButtonState:r,buttonState:n}))}function T({categorySlug:e,templateSlug:l,allowCategorySelection:o,inheritCategory:a,toggleAllowCategorySelection:n=(()=>{}),setInheritCategory:r=(()=>{}),setCategorySlug:i=(()=>{}),buttonState:u,setButtonState:d,setNextStep:m}){const y=void 0!==l&&l?.includes("category"),b=l?.replace("category-",""),[p,E]=(0,k.useTaxonomy)("category",b),[h,f]=(0,k.useTaxonomy)("category",e);return(0,t.useEffect)((()=>{const t={...u,text:"Next",disabled:!0,onClick:()=>m("query-c")};o?(t.disabled=!a&&!e,t.disabled=!(!y||a||e),t.disabled=!y&&!e,console.log("templateSlug",l)):t.disabled=!1,d(t)}),[o,a,e,l]),(0,t.createElement)("div",null,(0,t.createElement)(S.BaseControl,{label:(0,s.__)("Query by Category?","prc-platform-core")},(0,t.createElement)(S.ToggleControl,{label:(0,s.__)("Query by Category"),checked:o,onChange:()=>n()})),o&&(0,t.createElement)(t.Fragment,null,y&&(0,t.createElement)(S.BaseControl,{label:(0,s.__)("Inherit Category from Template?","prc-platform-core")},(0,t.createElement)(S.ToggleControl,{label:a?(0,s.__)("Yes","prc-platform-core"):(0,s.__)("No","prc-platform-core"),checked:a,onChange:()=>r(!a)})),!0!==a&&(0,t.createElement)(c.WPEntitySearch,{placeholder:(0,s.__)(`Search for a category to filter ${g} by`),searchLabel:(0,s.__)(`Search for a category to filter ${g} by`),entityType:"taxonomy",entitySubType:"category",entityId:p||h||!1,searchValue:E||f||"",onSelect:e=>{console.log("Category Entity: ",e),i(e.slug)},onKeyEnter:()=>{console.log("Enter Key Pressed")},onKeyESC:()=>{console.log("ESC Key Pressed")},perPage:10})))}function M({blockAreaSlug:e,categorySlug:l,inheritCategory:o,newBlockAreaName:a,setAttributes:n,setNextStep:r,buttonState:c,setButtonState:s}){const[i,g]=(0,t.useState)(!1),[y,b]=(0,t.useState)(!1);return(0,t.useEffect)((()=>{const e={...c,text:"Confirm Settings",disabled:!1,onClick:()=>g(!0)};s(e)}),[]),(0,t.useEffect)((()=>{if(i){const e={...c,text:"Insert Block Area",disabled:!1,variant:"primary",onClick:()=>b(!0)};s(e)}}),[i]),(0,t.useEffect)((()=>{if(y){const t={inheritCategory:o};l&&(t.categorySlug=l),a?async function(e){const{saveEntityRecord:t}=(0,u.dispatch)(d.store),l=(0,h.cleanForSlug)(e),o=await t("taxonomy",m,{name:e,slug:l});return!!o&&(console.log("createBlockArea ->",o),o?.slug)}(a).then((e=>{t.blockAreaSlug=e,n(t)})):(e&&(t.blockAreaSlug=e),n(t))}}),[y]),(0,t.createElement)(x,null,(0,t.createElement)("h5",{className:"block-area-edit__review-settings-heading"},"Review Block Area Settings:"),!a&&(0,t.createElement)("p",null,"This area will render the latest public ",(0,t.createElement)("pre",null,"block_module")," that is in the ",(0,t.createElement)("pre",null,e)," block area",l&&(0,t.createElement)("span",null," and ",(0,t.createElement)("pre",null,l)," category"),!0===o&&(0,t.createElement)("span",null," and will ",(0,t.createElement)("pre",null,"inherit the category")," from available context"),"."),a&&(0,t.createElement)("p",null,"This area will render the latest public ",(0,t.createElement)("pre",null,"block_module")," that is in the new ",(0,t.createElement)("pre",null,a)," block area",l&&(0,t.createElement)("span",null," and ",(0,t.createElement)("pre",null,l)," category"),"."))}function P({defaultTitle:e="Block Module",blockAreaId:o,categoryId:a,onCreate:n=(()=>{}),setNextStep:r}){return(0,t.createElement)(l.Fragment,null,(0,t.createElement)(c.EntityCreateNewModal,{defaultTitle:e,onClose:()=>{r("intro")},onSubmit:e=>{f(e,o,a,"publish").then((e=>{console.log("then...",e),n(e.id)}))}}))}function R({onSelect:e=(()=>{}),onClose:l=(()=>{}),selectedId:o=null,clientId:a}){return(0,t.createElement)(c.EntityPatternModal,{title:(0,s.__)("Choose a block module","prc-platform-core"),instructions:(0,s.__)("Choosing a block module will always display it, overriding any block area or category queries.","prc-platform-core"),entityType:b,entityTypeLabel:p,onSelect:e,onClose:l,clientId:a,selectedId:o})}function q({attributes:e,setAttributes:l,blockModules:o,isResolving:a,context:n,clientId:c}){const{templateSlug:i}=n,[u,d]=(0,t.useState)(e?.blockAreaSlug),[m,g]=(0,t.useState)(e?.categorySlug),[y,b]=(0,t.useState)(e?.inheritCategory),[p,k]=(0,t.useState)(!1),[E,h]=(0,t.useState)("intro"),f=e=>{h(e)},[C,w]=(0,t.useState)({variant:"secondary",isLoading:!1,text:"Next",onClick:null,disabled:!1}),[A,_]=(0,t.useState)(!1),x=(0,t.useMemo)((()=>"intro"!==E||null),[E]);return(0,t.createElement)(S.Placeholder,{label:(0,s.__)("Block Area","prc-platform-core"),isColumnLayout:!0,icon:()=>(0,t.createElement)(r,{color:null})},(0,t.createElement)("div",{className:"block-area-edit__placeholder-inner"},["intro","create-a"].includes(E)&&(0,t.createElement)(B,{isResolving:a,blockModules:o,buttonState:C,setButtonState:w,setNextStep:f,isResolving:a}),"query-a"===E&&(0,t.createElement)(I,{blockAreaSlug:u,setBlockAreaSlug:d,newBlockAreaName:A,setNewBlockAreaName:_,setNextStep:f,buttonState:C,setButtonState:w}),"query-b"===E&&(0,t.createElement)(T,{categorySlug:m,setCategorySlug:g,templateSlug:i,allowCategorySelection:p,inheritCategory:y,toggleAllowCategorySelection:()=>{k(!p)},setInheritCategory:b,buttonState:C,setButtonState:w,setNextStep:f}),"query-c"===E&&(0,t.createElement)(M,{blockAreaSlug:u,categorySlug:m,inheritCategory:y,newBlockAreaName:A,setAttributes:l,setNextStep:f,buttonState:C,setButtonState:w}),"select-a"===E&&(0,t.createElement)(R,{clientId:c,onSelect:({id:e})=>{l({ref:e})},onClose:()=>{f("intro")}}),"create-a"===E&&(0,t.createElement)(P,{onCreate:e=>{l({ref:e})},setNextStep:f}),!["intro","create-a"].includes(E)&&(0,t.createElement)("div",{className:"block-area-edit__toolbar"},null!==x&&(0,t.createElement)(S.Button,{variant:"secondary",disabled:!x,onClick:()=>{null!==x&&("intro"===E||"query-a"===E?h("intro"):"query-b"===E?h("query-a"):"query-c"===E?h("query-b"):"create-a"===E?h("intro"):"create-b"===E?h("create-a"):"select-a"===E&&h("intro"))}},"Back"),(0,t.createElement)(S.Button,{variant:C.variant,disabled:C.disabled,onClick:()=>{null!==C.onClick&&C.onClick()}},C.text))))}const F=JSON.parse('{"$schema":"https://schemas.wp.org/trunk/block.json","apiVersion":3,"name":"prc-platform/block-area","version":"3.0.0","title":"Block Area","description":"A block area is like a template part but with greater editorial control.","category":"theme","keywords":["block area","block module","topic lede","featured lede"],"attributes":{"ref":{"type":"integer"},"blockAreaSlug":{"type":"string"},"categorySlug":{"type":"string"},"inheritCategory":{"type":"boolean"}},"supports":{"anchor":true,"html":false},"usesContext":["queryId","query","queryContext","templateSlug","previewPostType"],"textdomain":"prc-block-area","editorScript":"file:./index.js","editorStyle":"file:./index.css"}'),{name:L}=F,K={icon:r,edit:function({attributes:e,setAttributes:o,clientId:a,context:n}){const{ref:r,blockAreaSlug:s,categorySlug:g,inheritCategory:y}=e,{templateSlug:S}=n,[E,h]=(0,t.useState)("publish"),{setPostIds:f}=(0,u.useDispatch)("prc-platform/block-area-context"),w=(0,t.useMemo)((()=>void 0!==S&&S.includes("category-")),[S]),A=(0,t.useMemo)((()=>!0===y&&!g&&w?S.replace("category-",""):g||!1),[y,g,w,S]),{blockAreaName:x,blockAreaId:B,categoryName:v,categoryId:N}=function(e=null,t=null){const[l,o]=(0,k.useTaxonomy)("category",t),[a,n]=(0,k.useTaxonomy)(m,e);return{blockAreaId:a,blockAreaName:n,categoryId:l,categoryName:o}}(s,A),I=(0,t.useMemo)((()=>({id:B,name:x,slug:s})),[B,x,s]),T=(0,t.useMemo)((()=>({id:N,name:v,slug:A})),[N,v,A]),{blockModules:M,hasResolved:P,isResolving:R}=function({blockAreaId:e=null,categoryId:t=null,ref:o=null,excludeId:a=null,enabled:n=!1,args:r={}}){const c={context:"view",orderby:"date",order:"desc",per_page:25};null!==e&&(c[m]=[e]),null!==t&&(c.categories=[t]),e&&t&&(c.tax_relation="AND"),null!==o&&(c.include=[o]),console.log("postStatus",c);const{hasResolved:s,isResolving:i,records:u,status:g}=(0,d.useEntityRecords)("postType","block_module",{...c,...r},{enabled:n});return{blockModules:(0,l.useMemo)((()=>u&&u.filter((e=>e.id!==a))||[]),[u,a]),isResolving:i,hasResolved:s}}({enabled:!0,blockAreaId:I?.id,categoryId:T?.id,ref:r,args:{status:E}}),F=(0,t.useMemo)((()=>M&&M.length?M[0].id:null),[M]),L=(0,t.useMemo)((()=>{if(F){const e=M.find((e=>e.id===F));return console.log("Matching block_module :",e,M),{id:F,name:e?.title?.rendered,slug:e?.slug}}return null}),[F,M]),K=(0,i.useBlockProps)();return(0,t.useMemo)((()=>(console.log("isInSetup",F,r,s,A,e),!(null!==F&&r||s))),[P,F,s,A,r])?(0,t.createElement)("div",{...K},(0,t.createElement)(q,{attributes:e,setAttributes:o,blockModules:M,isResolving:R,clientId:a,context:n,isCategoryTemplate:w})):(0,t.createElement)(c.InnerBlocksAsSyncedContent,{postId:F,postType:b,postTypeLabel:p,blockProps:K,clientId:a,allowDetach:!0,isMissingChildren:()=>(0,t.createElement)(C,{blockAreaId:B,categoryId:N,setAttributes:o}),collector:e=>{if(e){const t=e?._story_item_ids;f(t)}}},(0,t.createElement)(_,{attributes:e,setAttributes:o,clientId:a,blockArea:I,category:T,blockModule:L,postStatus:E,setPostStatus:h}))}};(0,e.registerBlockType)(L,{...F,...K})})();
//# sourceMappingURL=index.js.map