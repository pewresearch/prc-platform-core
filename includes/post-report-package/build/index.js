!function(){"use strict";var e=window.wp.element,t=window.wp.i18n,s=window.wp.plugins,i=window.wp.editPost,n=window.wp.data,o=window.wp.primitives,r=(0,e.createElement)(o.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},(0,e.createElement)(o.Path,{d:"M7 13.8h6v-1.5H7v1.5zM18 16V4c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2zM5.5 16V4c0-.3.2-.5.5-.5h10c.3 0 .5.2.5.5v12c0 .3-.2.5-.5.5H6c-.3 0-.5-.2-.5-.5zM7 10.5h8V9H7v1.5zm0-3.3h8V5.8H7v1.4zM20.2 6v13c0 .7-.6 1.2-1.2 1.2H8v1.5h11c1.5 0 2.7-1.2 2.7-2.8V6h-1.5z"})),a=window.React,l=window.ReactDOM;function h(e){const t=window.getComputedStyle(e);return Math.max(parseInt(t["margin-top"],10),parseInt(t["margin-bottom"],10))+e.getBoundingClientRect().height}function c(e,t=0,s=0){e&&(null!==t&&null!==s?e.style.transform=`translate(${s}px, ${t}px)`:e.style.removeProperty("transform"))}function d(e,t,s){e&&(e.style.transition=`transform ${t}ms${s?` ${s}`:""}`)}const u=e=>{let t=[],s=null;const i=(...i)=>{t=i,s||(s=requestAnimationFrame((()=>{s=null,e(...t)})))};return i.cancel=()=>{s&&cancelAnimationFrame(s)},i};function p(e,t){const s=["input","textarea","select","option","optgroup","video","audio","button","a"],i=["button","link","checkbox","tab"];for(;e!==t;){if(e.getAttribute("data-movable-handle"))return!1;if(s.includes(e.tagName.toLowerCase()))return!0;const t=e.getAttribute("role");if(t&&i.includes(t.toLowerCase()))return!0;if("label"===e.tagName.toLowerCase()&&e.hasAttribute("for"))return!0;e.tagName&&(e=e.parentElement)}return!1}const g=200;class m extends a.Component{constructor(e){super(e),this.listRef=a.createRef(),this.ghostRef=a.createRef(),this.topOffsets=[],this.itemTranslateOffsets=[],this.initialYOffset=0,this.lastScroll=0,this.lastYOffset=0,this.lastListYOffset=0,this.needle=-1,this.afterIndex=-2,this.state={itemDragged:-1,itemDraggedOutOfBounds:-1,selectedItem:-1,initialX:0,initialY:0,targetX:0,targetY:0,targetHeight:0,targetWidth:0,liveText:"",scrollingSpeed:0,scrollWindow:!1},this.doScrolling=()=>{const{scrollingSpeed:e,scrollWindow:t}=this.state,s=this.listRef.current;window.requestAnimationFrame((()=>{t?window.scrollTo(window.pageXOffset,window.pageYOffset+1.5*e):s.scrollTop+=e,0!==e&&this.doScrolling()}))},this.getChildren=()=>this.listRef&&this.listRef.current?Array.from(this.listRef.current.children):(console.warn("No items found in the List container. Did you forget to pass & spread the `props` param in renderList?"),[]),this.calculateOffsets=()=>{this.topOffsets=this.getChildren().map((e=>e.getBoundingClientRect().top)),this.itemTranslateOffsets=this.getChildren().map((e=>h(e)))},this.getTargetIndex=e=>this.getChildren().findIndex((t=>t===e.target||t.contains(e.target))),this.onMouseOrTouchStart=e=>{this.dropTimeout&&this.state.itemDragged>-1&&(window.clearTimeout(this.dropTimeout),this.finishDrop());const t=(s=e).touches&&s.touches.length||s.changedTouches&&s.changedTouches.length;var s;if(!t&&0!==e.button)return;const i=this.getTargetIndex(e);if(-1===i||this.props.values[i]&&this.props.values[i].disabled)return void(-1!==this.state.selectedItem&&(this.setState({selectedItem:-1}),this.finishDrop()));const n=this.getChildren()[i],o=n.querySelector("[data-movable-handle]");if((!o||o.contains(e.target))&&!p(e.target,n)){if(e.preventDefault(),this.props.beforeDrag&&this.props.beforeDrag({elements:this.getChildren(),index:i}),t){const e={passive:!1};n.style.touchAction="none",document.addEventListener("touchend",this.schdOnEnd,e),document.addEventListener("touchmove",this.schdOnTouchMove,e),document.addEventListener("touchcancel",this.schdOnEnd,e)}else{document.addEventListener("mousemove",this.schdOnMouseMove),document.addEventListener("mouseup",this.schdOnEnd);const e=this.getChildren()[this.state.itemDragged];e&&e.style&&(e.style.touchAction="")}this.onStart(n,t?e.touches[0].clientX:e.clientX,t?e.touches[0].clientY:e.clientY,i)}},this.getYOffset=()=>{const e=this.listRef.current?this.listRef.current.scrollTop:0;return window.pageYOffset+e},this.onStart=(e,t,s,i)=>{this.state.selectedItem>-1&&(this.setState({selectedItem:-1}),this.needle=-1);const n=e.getBoundingClientRect(),o=window.getComputedStyle(e);this.calculateOffsets(),this.initialYOffset=this.getYOffset(),this.lastYOffset=window.pageYOffset,this.lastListYOffset=this.listRef.current.scrollTop,this.setState({itemDragged:i,targetX:n.left-parseInt(o["margin-left"],10),targetY:n.top-parseInt(o["margin-top"],10),targetHeight:n.height,targetWidth:n.width,initialX:t,initialY:s})},this.onMouseMove=e=>{e.cancelable&&e.preventDefault(),this.onMove(e.clientX,e.clientY)},this.onTouchMove=e=>{e.cancelable&&e.preventDefault(),this.onMove(e.touches[0].clientX,e.touches[0].clientY)},this.onWheel=e=>{this.state.itemDragged<0||(this.lastScroll=this.listRef.current.scrollTop+=e.deltaY,this.moveOtherItems())},this.onMove=(e,t)=>{if(-1===this.state.itemDragged)return null;c(this.ghostRef.current,t-this.state.initialY,this.props.lockVertically?0:e-this.state.initialX),this.autoScrolling(t),this.moveOtherItems()},this.moveOtherItems=()=>{const e=this.ghostRef.current.getBoundingClientRect(),t=e.top+e.height/2,s=h(this.getChildren()[this.state.itemDragged]),i=this.getYOffset();this.initialYOffset!==i&&(this.topOffsets=this.topOffsets.map((e=>e-(i-this.initialYOffset))),this.initialYOffset=i),this.isDraggedItemOutOfBounds()&&this.props.removableByMove?this.afterIndex=this.topOffsets.length+1:this.afterIndex=function(e,t){let s,i=0,n=e.length-1;for(;i<=n;){if(s=Math.floor((n+i)/2),!e[s+1]||e[s]<=t&&e[s+1]>=t)return s;e[s]<t&&e[s+1]<t?i=s+1:n=s-1}return-1}(this.topOffsets,t),this.animateItems(-1===this.afterIndex?0:this.afterIndex,this.state.itemDragged,s)},this.autoScrolling=e=>{const{top:t,bottom:s,height:i}=this.listRef.current.getBoundingClientRect(),n=window.innerHeight||document.documentElement.clientHeight;if(s>n&&n-e<g)this.setState({scrollingSpeed:Math.round((g-(n-e))/10),scrollWindow:!0});else if(t<0&&e<g)this.setState({scrollingSpeed:Math.round((g-e)/-10),scrollWindow:!0});else if(this.state.scrollWindow&&0!==this.state.scrollingSpeed&&this.setState({scrollingSpeed:0,scrollWindow:!1}),i+20<this.listRef.current.scrollHeight){let i=0;e-t<g?i=Math.round((g-(e-t))/-10):s-e<g&&(i=Math.round((g-(s-e))/10)),this.state.scrollingSpeed!==i&&this.setState({scrollingSpeed:i})}},this.animateItems=(e,t,s,i=!1)=>{this.getChildren().forEach(((n,o)=>{if(d(n,this.props.transitionDuration),t===o&&i){if(t===e)return c(n,null);c(n,t<e?this.itemTranslateOffsets.slice(t+1,e+1).reduce(((e,t)=>e+t),0):-1*this.itemTranslateOffsets.slice(e,t).reduce(((e,t)=>e+t),0))}else c(n,t<e&&o>t&&o<=e?-s:o<t&&t>e&&o>=e?s:null)}))},this.isDraggedItemOutOfBounds=()=>{const e=this.getChildren()[this.state.itemDragged].getBoundingClientRect(),t=this.ghostRef.current.getBoundingClientRect();return Math.abs(e.left-t.left)>t.width?(-1===this.state.itemDraggedOutOfBounds&&this.setState({itemDraggedOutOfBounds:this.state.itemDragged}),!0):(this.state.itemDraggedOutOfBounds>-1&&this.setState({itemDraggedOutOfBounds:-1}),!1)},this.onEnd=e=>{e.cancelable&&e.preventDefault(),document.removeEventListener("mousemove",this.schdOnMouseMove),document.removeEventListener("touchmove",this.schdOnTouchMove),document.removeEventListener("mouseup",this.schdOnEnd),document.removeEventListener("touchup",this.schdOnEnd),document.removeEventListener("touchcancel",this.schdOnEnd);const t=this.props.removableByMove&&this.isDraggedItemOutOfBounds();!t&&this.props.transitionDuration>0&&-2!==this.afterIndex&&u((()=>{d(this.ghostRef.current,this.props.transitionDuration,"cubic-bezier(.2,1,.1,1)"),this.afterIndex<1&&0===this.state.itemDragged?c(this.ghostRef.current,0,0):c(this.ghostRef.current,-(window.pageYOffset-this.lastYOffset)-(this.listRef.current.scrollTop-this.lastListYOffset)+(this.state.itemDragged<this.afterIndex?this.itemTranslateOffsets.slice(this.state.itemDragged+1,this.afterIndex+1).reduce(((e,t)=>e+t),0):-1*this.itemTranslateOffsets.slice(this.afterIndex<0?0:this.afterIndex,this.state.itemDragged).reduce(((e,t)=>e+t),0)),0)}))(),this.dropTimeout=window.setTimeout(this.finishDrop,t||-2===this.afterIndex?0:this.props.transitionDuration)},this.finishDrop=()=>{const e=this.props.removableByMove&&this.isDraggedItemOutOfBounds();(e||this.afterIndex>-2&&this.state.itemDragged!==this.afterIndex)&&this.props.onChange({oldIndex:this.state.itemDragged,newIndex:e?-1:Math.max(this.afterIndex,0),targetRect:this.ghostRef.current.getBoundingClientRect()}),this.getChildren().forEach((e=>{d(e,0),c(e,null),e.style.touchAction=""})),this.setState({itemDragged:-1,scrollingSpeed:0}),this.afterIndex=-2,this.lastScroll>0&&(this.listRef.current.scrollTop=this.lastScroll,this.lastScroll=0)},this.onKeyDown=e=>{const t=this.state.selectedItem,s=this.getTargetIndex(e);if(!p(e.target,e.currentTarget)&&-1!==s){if(" "===e.key&&(e.preventDefault(),t===s?(t!==this.needle&&(this.getChildren().forEach((e=>{d(e,0),c(e,null)})),this.props.onChange({oldIndex:t,newIndex:this.needle,targetRect:this.getChildren()[this.needle].getBoundingClientRect()}),this.getChildren()[this.needle].focus()),this.setState({selectedItem:-1,liveText:this.props.voiceover.dropped(t+1,this.needle+1)}),this.needle=-1):(this.setState({selectedItem:s,liveText:this.props.voiceover.lifted(s+1)}),this.needle=s,this.calculateOffsets())),("ArrowDown"===e.key||"j"===e.key)&&t>-1&&this.needle<this.props.values.length-1){e.preventDefault();const s=h(this.getChildren()[t]);this.needle++,this.animateItems(this.needle,t,s,!0),this.setState({liveText:this.props.voiceover.moved(this.needle+1,!1)})}if(("ArrowUp"===e.key||"k"===e.key)&&t>-1&&this.needle>0){e.preventDefault();const s=h(this.getChildren()[t]);this.needle--,this.animateItems(this.needle,t,s,!0),this.setState({liveText:this.props.voiceover.moved(this.needle+1,!0)})}"Escape"===e.key&&t>-1&&(this.getChildren().forEach((e=>{d(e,0),c(e,null)})),this.setState({selectedItem:-1,liveText:this.props.voiceover.canceled(t+1)}),this.needle=-1),("Tab"===e.key||"Enter"===e.key)&&t>-1&&e.preventDefault()}},this.schdOnMouseMove=u(this.onMouseMove),this.schdOnTouchMove=u(this.onTouchMove),this.schdOnEnd=u(this.onEnd)}componentDidMount(){this.calculateOffsets(),document.addEventListener("touchstart",this.onMouseOrTouchStart,{passive:!1,capture:!1}),document.addEventListener("mousedown",this.onMouseOrTouchStart)}componentDidUpdate(e,t){t.scrollingSpeed!==this.state.scrollingSpeed&&0===t.scrollingSpeed&&this.doScrolling()}componentWillUnmount(){document.removeEventListener("touchstart",this.onMouseOrTouchStart),document.removeEventListener("mousedown",this.onMouseOrTouchStart),this.dropTimeout&&window.clearTimeout(this.dropTimeout),this.schdOnMouseMove.cancel(),this.schdOnTouchMove.cancel(),this.schdOnEnd.cancel()}render(){const e={userSelect:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",boxSizing:"border-box",position:"relative"},t={...e,top:this.state.targetY,left:this.state.targetX,width:this.state.targetWidth,height:this.state.targetHeight,position:"fixed",marginTop:0};return a.createElement(a.Fragment,null,this.props.renderList({children:this.props.values.map(((t,s)=>{const i=s===this.state.itemDragged,n=s===this.state.selectedItem,o={key:s,tabIndex:this.props.values[s]&&this.props.values[s].disabled?-1:0,"aria-roledescription":this.props.voiceover.item(s+1),onKeyDown:this.onKeyDown,style:{...e,visibility:i?"hidden":void 0,zIndex:n?5e3:0}};return this.props.renderItem({value:t,props:o,index:s,isDragged:!1,isSelected:n,isOutOfBounds:!1})})),isDragged:this.state.itemDragged>-1,props:{ref:this.listRef}}),this.state.itemDragged>-1&&l.createPortal(this.props.renderItem({value:this.props.values[this.state.itemDragged],props:{ref:this.ghostRef,style:t,onWheel:this.onWheel},index:this.state.itemDragged,isDragged:!0,isSelected:!1,isOutOfBounds:this.state.itemDraggedOutOfBounds>-1}),this.props.container||document.body),a.createElement("div",{"aria-live":"assertive",role:"log","aria-atomic":"true",style:{position:"absolute",width:"1px",height:"1px",margin:"-1px",border:"0px",padding:"0px",overflow:"hidden",clip:"rect(0px, 0px, 0px, 0px)",clipPath:"inset(100%)"}},this.state.liveText))}}m.defaultProps={transitionDuration:300,lockVertically:!1,removableByMove:!1,voiceover:{item:e=>`You are currently at a draggable item at position ${e}. Press space bar to lift.`,lifted:e=>`You have lifted item at position ${e}. Press j to move down, k to move up, space bar to drop and escape to cancel.`,moved:(e,t)=>`You have moved the lifted item ${t?"up":"down"} to position ${e}. Press j to move down, k to move up, space bar to drop and escape to cancel.`,dropped:(e,t)=>`You have dropped the item. It has moved from position ${e} to ${t}.`,canceled:e=>`You have cancelled the movement. The item has returned to its starting position of ${e}.`}};var f=m,v=window.prcComponents,w=window.wp.components,O={*getItems(){const e=(0,n.select)("core/editor").getEditedPostAttribute("meta"),{multiSectionReport:t}=e,s=e?.back_chapters;console.log("multiSectionReport?",e,t,s),null!==t&&(yield v.listStoreActions.seed(t))}},S={getItems(e){return e}};(0,v.registerListStore)("prc/multi-section-report",O,S);var I=window.prcHooks,x=window.wp.htmlEntities,D=window.wp.url;const{api:E}=window.wp;var y=({hocOnChange:s=!1})=>{const[i,n]=(0,e.useState)(!1),[o,r]=(0,e.useState)(!1),[a,l]=(0,e.useState)(),[h,c]=(0,e.useState)(),d=(0,I.useDebounce)(h,1e3),[u,p]=(0,e.useState)(!1);return(0,e.useEffect)((()=>{console.log("postUrl",d),void 0!==d&&3<=d.length&&(e=>{const t=(0,D.getQueryArg)(e,"post");console.log("fetchPostByEditURL",e),new E.models.Post({id:t}).fetch().then((e=>{console.log("matched?",e),l(e.title.rendered),p(e),n(!0)})).always((()=>{r(!1)}))})(d)}),[d]),(0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{style:{display:"flex",flexDirection:"row"}},(0,e.createElement)("div",{style:{flexGrow:"1"}},(0,e.createElement)(w.TextControl,{autoComplete:"off",onChange:e=>{r(!0),c(e)},placeholder:"Paste post's edit url..."})),(0,e.createElement)("div",null,o&&(0,e.createElement)(w.Spinner,null))),!0===i&&(0,e.createElement)(w.Modal,{title:(0,t.__)("Confirm Post","prc-platform-post-report-package"),onRequestClose:()=>{n(!1)}},(0,e.createElement)("p",null,"Add ",(0,e.createElement)("strong",null,(0,x.decodeEntities)(a))," post as child?"),(0,e.createElement)(w.ButtonGroup,null,(0,e.createElement)(w.Button,{variant:"secondary",onClick:()=>{c(""),p(!1)}},"No"),(0,e.createElement)(w.Button,{variant:"primary",onClick:()=>{const{id:e}=u;new E.models.Post({id:e}).fetch().then((e=>{e.id===u.id?(n(!1),p(!1),!1!==s&&s(e.id)):alert("Uhoh, somethings wrong here. The expected post id does not match the given id.")}))}},"Yes"))))},b=(0,w.withNotices)((function({noticeOperations:t,noticeUI:s}){const{append:i,reorder:o,setItemProp:r}=(0,n.useDispatch)("prc/multi-section-report"),{items:a}=(0,n.useSelect)((e=>({items:e("prc/multi-section-report")?.getItems()})),[]);return(0,e.createElement)(w.PanelBody,{title:"Back Chapters"},(0,e.createElement)(f,{lockVertically:!0,values:a,onChange:({oldIndex:e,newIndex:t})=>o({from:e,to:t}),renderList:({children:t,props:s})=>(0,e.createElement)("div",{...s},t),renderItem:({value:t,props:s,index:i})=>(0,e.createElement)("div",{...s},(0,e.createElement)(v.ListStoreItem,{key:t.key,keyValue:t.postId,defaultLabel:"Child Post",index:i,storeName:"multi-section-report"},null===t.postId&&(0,e.createElement)(y,{hocOnChange:e=>r(i,"postId",e)})))}),(0,e.createElement)(w.Button,{variant:"primary",onClick:()=>{i({key:`_${Math.random().toString(36).substr(2,9)}`,postId:null})}},"Add Post"))}));const C="prc-platform-post-report-package";function T(){const{backChapters:t,materials:s}=(0,n.useSelect)((e=>({backChapters:e("prc/multi-section-report").getItems()})),[]),{editPost:i}=(0,n.useDispatch)("core/editor");return(0,e.useEffect)((()=>{console.log("<ReportPanel> Meta",t);const e={};0!==Object.keys(t).length&&(e.multiSectionReport=t),0!==Object.keys(e).length&&(console.log("toSave!",e),i({meta:{...e}}))}),[t]),(0,e.createElement)("div",null,(0,e.createElement)(b,null))}(0,s.registerPlugin)(C,{render:function(){return(0,e.createElement)(i.PluginSidebar,{name:C,title:"Report Package",icon:r},(0,e.createElement)(T,null))}})}();
//# sourceMappingURL=index.js.map